This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
admin/.gitignore
admin/eslint.config.mjs
admin/next.config.ts
admin/package.json
admin/postcss.config.mjs
admin/public/file.svg
admin/public/globe.svg
admin/public/next.svg
admin/public/vercel.svg
admin/public/window.svg
admin/README.md
admin/src/app/favicon.ico
admin/src/app/globals.css
admin/src/app/layout.tsx
admin/src/app/login/page.tsx
admin/src/app/logs/page.tsx
admin/src/app/orders/[id]/print/page.tsx
admin/src/app/page.tsx
admin/src/app/products/[id]/page.tsx
admin/src/app/products/new/page.tsx
admin/src/app/products/page.tsx
admin/src/app/reports/page.tsx
admin/src/app/series/page.tsx
admin/src/app/settings/page.tsx
admin/src/app/users/page.tsx
admin/src/components/LayoutShell.tsx
admin/src/components/OrderDetailModal.tsx
admin/src/components/Sidebar.tsx
admin/src/lib/api.ts
admin/tsconfig.json
backend/.gitignore
backend/.prettierrc
backend/eslint.config.mjs
backend/nest-cli.json
backend/package.json
backend/README.md
backend/src/announcements/announcements.controller.ts
backend/src/announcements/announcements.module.ts
backend/src/announcements/announcements.service.ts
backend/src/announcements/dto/create-announcement.dto.ts
backend/src/announcements/dto/update-announcement.dto.ts
backend/src/announcements/entities/announcement.entity.ts
backend/src/app.controller.spec.ts
backend/src/app.controller.ts
backend/src/app.module.ts
backend/src/app.service.ts
backend/src/auth/auth.controller.ts
backend/src/auth/auth.module.ts
backend/src/auth/auth.service.ts
backend/src/auth/dto/create-auth.dto.ts
backend/src/auth/dto/update-auth.dto.ts
backend/src/auth/entities/auth.entity.ts
backend/src/auth/jwt-auth.guard.ts
backend/src/auth/jwt.strategy.ts
backend/src/cart/cart.controller.ts
backend/src/cart/cart.module.ts
backend/src/cart/cart.service.ts
backend/src/cart/entities/cart-item.entity.ts
backend/src/logs/entities/audit-log.entity.ts
backend/src/logs/entities/login-log.entity.ts
backend/src/logs/logs.controller.ts
backend/src/logs/logs.module.ts
backend/src/logs/logs.service.ts
backend/src/main.ts
backend/src/notifications/notifications.module.ts
backend/src/notifications/notifications.service.spec.ts
backend/src/notifications/notifications.service.ts
backend/src/orders/dto/create-order.dto.ts
backend/src/orders/dto/update-order.dto.ts
backend/src/orders/entities/order-item.entity.ts
backend/src/orders/entities/order.entity.ts
backend/src/orders/orders.controller.ts
backend/src/orders/orders.module.ts
backend/src/orders/orders.service.ts
backend/src/products/dto/create-product.dto.ts
backend/src/products/dto/update-product.dto.ts
backend/src/products/entities/product.entity.ts
backend/src/products/products.controller.ts
backend/src/products/products.module.ts
backend/src/products/products.service.ts
backend/src/reports/dto/create-report.dto.ts
backend/src/reports/dto/update-report.dto.ts
backend/src/reports/entities/report.entity.ts
backend/src/reports/reports.controller.ts
backend/src/reports/reports.module.ts
backend/src/reports/reports.service.ts
backend/src/series/dto/create-series.dto.ts
backend/src/series/dto/update-series.dto.ts
backend/src/series/entities/series.entity.ts
backend/src/series/series.controller.ts
backend/src/series/series.module.ts
backend/src/series/series.service.ts
backend/src/site-config/entities/site-config.entity.ts
backend/src/site-config/site-config.controller.ts
backend/src/site-config/site-config.module.ts
backend/src/site-config/site-config.service.ts
backend/src/users/dto/create-user.dto.ts
backend/src/users/dto/update-user.dto.ts
backend/src/users/entities/dealer-profile.entity.ts
backend/src/users/entities/trade-category.entity.ts
backend/src/users/entities/user.entity.ts
backend/src/users/trade-categories.controller.ts
backend/src/users/users.controller.ts
backend/src/users/users.module.ts
backend/src/users/users.service.ts
backend/test/app.e2e-spec.ts
backend/test/jest-e2e.json
backend/tsconfig.build.json
backend/tsconfig.json
frontend/.gitignore
frontend/eslint.config.mjs
frontend/forgot-password/page.tsx
frontend/next.config.ts
frontend/package.json
frontend/postcss.config.mjs
frontend/public/file.svg
frontend/public/globe.svg
frontend/public/next.svg
frontend/public/vercel.svg
frontend/public/window.svg
frontend/README.md
frontend/src/app/cart/page.tsx
frontend/src/app/favicon.ico
frontend/src/app/forgot-password/page.tsx
frontend/src/app/globals.css
frontend/src/app/layout.tsx
frontend/src/app/login/page.tsx
frontend/src/app/login/register/page.tsx
frontend/src/app/orders/[id]/print/page.tsx
frontend/src/app/orders/page.tsx
frontend/src/app/page.tsx
frontend/src/app/portal/page.tsx
frontend/src/app/product/[id]/page.tsx
frontend/src/app/profile/page.tsx
frontend/src/app/quotation/preview/page.tsx
frontend/src/app/register/page.tsx
frontend/src/app/reset-password/page.tsx
frontend/src/app/series/[name]/page.tsx
frontend/src/components/blocks/FeaturesBlock.tsx
frontend/src/components/blocks/HeroBlock.tsx
frontend/src/components/blocks/ProductListBlock.tsx
frontend/src/components/MeasurementModal.tsx
frontend/src/components/Modal.tsx
frontend/src/components/Navbar.tsx
frontend/src/context/CartContext.tsx
frontend/src/lib/api.ts
frontend/tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="admin/.gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="admin/next.config.ts">
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
};

export default nextConfig;
</file>

<file path="admin/postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="admin/public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="admin/public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="admin/public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="admin/public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="admin/public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="admin/README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="admin/src/app/globals.css">
@import "tailwindcss";
</file>

<file path="admin/src/app/layout.tsx">
import type { Metadata } from "next";
import "./globals.css";
import LayoutShell from "@/components/LayoutShell";

export const metadata: Metadata = {
  title: "SomaLink Admin",
  description: "B2B å·¥å» ç®¡ç†å¾Œå°",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="zh-TW">
      <body className="bg-gray-100">
        <LayoutShell>
          {children}
        </LayoutShell>
      </body>
    </html>
  );
}
</file>

<file path="admin/src/app/logs/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { ClipboardList, UserCheck, Activity, Search, Loader2 } from 'lucide-react';
import clsx from 'clsx';
import { api } from '@/lib/api';

export default function LogsPage() {
  const [activeTab, setActiveTab] = useState<'login' | 'audit'>('login');
  const [logs, setLogs] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchLogs = async () => {
      setLoading(true);
      try {
        // æ ¹æ“š Tab åˆ‡æ› API
        const endpoint = activeTab === 'login' ? '/logs/login' : '/logs/audit';
        const res = await api.get(endpoint);
        if (Array.isArray(res)) setLogs(res);
        else setLogs([]);
      } catch (err) {
        console.error(err);
        setLogs([]);
      } finally {
        setLoading(false);
      }
    };
    fetchLogs();
  }, [activeTab]);

  return (
    <div className="min-h-screen bg-gray-50 p-8 font-sans">
      <div className="mb-8">
        <h1 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
          <div className="p-2 bg-gray-200 rounded-lg"><ClipboardList className="w-6 h-6 text-gray-700" /></div>
          ç³»çµ±æ—¥èªŒä¸­å¿ƒ
        </h1>
        <p className="text-gray-500 text-sm mt-1">ç›£æ§ä½¿ç”¨è€…ç™»å…¥èˆ‡é—œéµæ“ä½œç´€éŒ„</p>
      </div>

      {/* é ç±¤åˆ‡æ› */}
      <div className="flex space-x-1 rounded-xl bg-gray-200 p-1 mb-6 w-fit">
        <button
          onClick={() => setActiveTab('login')}
          className={clsx(
            'flex items-center gap-2 rounded-lg px-4 py-2.5 text-sm font-medium leading-5 transition-all',
            activeTab === 'login'
              ? 'bg-white text-blue-700 shadow'
              : 'text-gray-600 hover:bg-white/12 hover:text-blue-600' // âœ¨ Fix: [0.12] -> 12
          )}
        >
          <UserCheck className="w-4 h-4" />
          ç™»å…¥ç´€éŒ„
        </button>
        <button
          onClick={() => setActiveTab('audit')}
          className={clsx(
            'flex items-center gap-2 rounded-lg px-4 py-2.5 text-sm font-medium leading-5 transition-all',
            activeTab === 'audit'
              ? 'bg-white text-purple-700 shadow'
              : 'text-gray-600 hover:bg-white/12 hover:text-purple-600' // âœ¨ Fix: [0.12] -> 12
          )}
        >
          <Activity className="w-4 h-4" />
          æ“ä½œç´€éŒ„
        </button>
      </div>

      {/* åˆ—è¡¨å…§å®¹ */}
      <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        {loading ? (
          <div className="p-12 text-center flex justify-center items-center text-gray-500">
            <Loader2 className="animate-spin mr-2" /> è¼‰å…¥ä¸­...
          </div>
        ) : logs.length === 0 ? (
          <div className="p-12 text-center text-gray-500">å°šç„¡ç´€éŒ„</div>
        ) : (
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">æ™‚é–“</th>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">ä½¿ç”¨è€… / å…¬å¸</th>
                {activeTab === 'login' ? (
                  <>
                    <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">ä¾†æº IP</th>
                    <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">è£ç½®è³‡è¨Š (User Agent)</th>
                  </>
                ) : (
                  <>
                    <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">å‹•ä½œé¡å‹</th>
                    <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">ç›®æ¨™å°è±¡</th>
                    <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">è©³ç´°å…§å®¹</th>
                  </>
                )}
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {logs.map((log) => (
                <tr key={log.id} className="hover:bg-gray-50 transition-colors">
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">
                    {new Date(activeTab === 'login' ? log.loginAt : log.createdAt).toLocaleString()}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="text-sm font-bold text-gray-900">{log.user?.dealerProfile?.companyName || log.user?.name || 'æœªçŸ¥ç”¨æˆ¶'}</div>
                    <div className="text-xs text-gray-500">{log.user?.email}</div>
                  </td>
                  
                  {activeTab === 'login' ? (
                    <>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600 font-mono">{log.ip}</td>
                      <td className="px-6 py-4 text-sm text-gray-500 max-w-xs truncate" title={log.userAgent}>
                        {log.userAgent}
                      </td>
                    </>
                  ) : (
                    <>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <span className="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                          {log.action}
                        </span>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        {log.targetEntity} #{log.targetId?.substring(0, 8)}
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">
                        {JSON.stringify(log.details)}
                      </td>
                    </>
                  )}
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>
    </div>
  );
}
</file>

<file path="admin/src/components/LayoutShell.tsx">
'use client';

import { usePathname } from 'next/navigation';
import Sidebar from "@/components/Sidebar";

export default function LayoutShell({ children }: { children: React.ReactNode }) {
  const pathname = usePathname();

  // å®šç¾©ã€Œä¸éœ€è¦å´é‚Šæ¬„ã€çš„é é¢
  // åŒ…å«ç™»å…¥é ã€ä»¥åŠæ‰€æœ‰åˆ—å°é é¢
  const isFullScreenPage = 
    pathname === '/login' || 
    pathname.includes('/print');

  if (isFullScreenPage) {
    // å…¨è¢å¹•æ¨¡å¼ (åªæœ‰å…§å®¹ï¼Œæ²’æœ‰ Sidebar)
    return <div className="w-full h-full">{children}</div>;
  }

  // ä¸€èˆ¬å¾Œå°æ¨¡å¼ (æœ‰ Sidebar)
  return (
    <div className="flex min-h-screen font-sans">
      <Sidebar />
      <div className="flex-1 md:ml-64 transition-all duration-300">
        {children}
      </div>
    </div>
  );
}
</file>

<file path="backend/.prettierrc">
{
  "singleQuote": true,
  "trailingComma": "all"
}
</file>

<file path="backend/eslint.config.mjs">
// @ts-check
import eslint from '@eslint/js';
import eslintPluginPrettierRecommended from 'eslint-plugin-prettier/recommended';
import globals from 'globals';
import tseslint from 'typescript-eslint';

export default tseslint.config(
  {
    ignores: ['eslint.config.mjs'],
  },
  eslint.configs.recommended,
  ...tseslint.configs.recommendedTypeChecked,
  eslintPluginPrettierRecommended,
  {
    languageOptions: {
      globals: {
        ...globals.node,
        ...globals.jest,
      },
      sourceType: 'commonjs',
      parserOptions: {
        projectService: true,
        tsconfigRootDir: import.meta.dirname,
      },
    },
  },
  {
    rules: {
      '@typescript-eslint/no-explicit-any': 'off',
      '@typescript-eslint/no-floating-promises': 'warn',
      '@typescript-eslint/no-unsafe-argument': 'warn',
      "prettier/prettier": ["error", { endOfLine: "auto" }],
    },
  },
);
</file>

<file path="backend/nest-cli.json">
{
  "$schema": "https://json.schemastore.org/nest-cli",
  "collection": "@nestjs/schematics",
  "sourceRoot": "src",
  "compilerOptions": {
    "deleteOutDir": true
  }
}
</file>

<file path="backend/README.md">
<p align="center">
  <a href="http://nestjs.com/" target="blank"><img src="https://nestjs.com/img/logo-small.svg" width="120" alt="Nest Logo" /></a>
</p>

[circleci-image]: https://img.shields.io/circleci/build/github/nestjs/nest/master?token=abc123def456
[circleci-url]: https://circleci.com/gh/nestjs/nest

  <p align="center">A progressive <a href="http://nodejs.org" target="_blank">Node.js</a> framework for building efficient and scalable server-side applications.</p>
    <p align="center">
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/v/@nestjs/core.svg" alt="NPM Version" /></a>
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/l/@nestjs/core.svg" alt="Package License" /></a>
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/dm/@nestjs/common.svg" alt="NPM Downloads" /></a>
<a href="https://circleci.com/gh/nestjs/nest" target="_blank"><img src="https://img.shields.io/circleci/build/github/nestjs/nest/master" alt="CircleCI" /></a>
<a href="https://discord.gg/G7Qnnhy" target="_blank"><img src="https://img.shields.io/badge/discord-online-brightgreen.svg" alt="Discord"/></a>
<a href="https://opencollective.com/nest#backer" target="_blank"><img src="https://opencollective.com/nest/backers/badge.svg" alt="Backers on Open Collective" /></a>
<a href="https://opencollective.com/nest#sponsor" target="_blank"><img src="https://opencollective.com/nest/sponsors/badge.svg" alt="Sponsors on Open Collective" /></a>
  <a href="https://paypal.me/kamilmysliwiec" target="_blank"><img src="https://img.shields.io/badge/Donate-PayPal-ff3f59.svg" alt="Donate us"/></a>
    <a href="https://opencollective.com/nest#sponsor"  target="_blank"><img src="https://img.shields.io/badge/Support%20us-Open%20Collective-41B883.svg" alt="Support us"></a>
  <a href="https://twitter.com/nestframework" target="_blank"><img src="https://img.shields.io/twitter/follow/nestframework.svg?style=social&label=Follow" alt="Follow us on Twitter"></a>
</p>
  <!--[![Backers on Open Collective](https://opencollective.com/nest/backers/badge.svg)](https://opencollective.com/nest#backer)
  [![Sponsors on Open Collective](https://opencollective.com/nest/sponsors/badge.svg)](https://opencollective.com/nest#sponsor)-->

## Description

[Nest](https://github.com/nestjs/nest) framework TypeScript starter repository.

## Project setup

```bash
$ npm install
```

## Compile and run the project

```bash
# development
$ npm run start

# watch mode
$ npm run start:dev

# production mode
$ npm run start:prod
```

## Run tests

```bash
# unit tests
$ npm run test

# e2e tests
$ npm run test:e2e

# test coverage
$ npm run test:cov
```

## Deployment

When you're ready to deploy your NestJS application to production, there are some key steps you can take to ensure it runs as efficiently as possible. Check out the [deployment documentation](https://docs.nestjs.com/deployment) for more information.

If you are looking for a cloud-based platform to deploy your NestJS application, check out [Mau](https://mau.nestjs.com), our official platform for deploying NestJS applications on AWS. Mau makes deployment straightforward and fast, requiring just a few simple steps:

```bash
$ npm install -g @nestjs/mau
$ mau deploy
```

With Mau, you can deploy your application in just a few clicks, allowing you to focus on building features rather than managing infrastructure.

## Resources

Check out a few resources that may come in handy when working with NestJS:

- Visit the [NestJS Documentation](https://docs.nestjs.com) to learn more about the framework.
- For questions and support, please visit our [Discord channel](https://discord.gg/G7Qnnhy).
- To dive deeper and get more hands-on experience, check out our official video [courses](https://courses.nestjs.com/).
- Deploy your application to AWS with the help of [NestJS Mau](https://mau.nestjs.com) in just a few clicks.
- Visualize your application graph and interact with the NestJS application in real-time using [NestJS Devtools](https://devtools.nestjs.com).
- Need help with your project (part-time to full-time)? Check out our official [enterprise support](https://enterprise.nestjs.com).
- To stay in the loop and get updates, follow us on [X](https://x.com/nestframework) and [LinkedIn](https://linkedin.com/company/nestjs).
- Looking for a job, or have a job to offer? Check out our official [Jobs board](https://jobs.nestjs.com).

## Support

Nest is an MIT-licensed open source project. It can grow thanks to the sponsors and support by the amazing backers. If you'd like to join them, please [read more here](https://docs.nestjs.com/support).

## Stay in touch

- Author - [Kamil MyÅ›liwiec](https://twitter.com/kammysliwiec)
- Website - [https://nestjs.com](https://nestjs.com/)
- Twitter - [@nestframework](https://twitter.com/nestframework)

## License

Nest is [MIT licensed](https://github.com/nestjs/nest/blob/master/LICENSE).
</file>

<file path="backend/src/announcements/announcements.controller.ts">
import { Controller, Get, Post, Patch, Delete, Body, Param } from '@nestjs/common';
import { AnnouncementsService } from './announcements.service';

@Controller('announcements')
export class AnnouncementsController { // âœ¨ ç¢ºèªé€™è£¡æœ‰ export
  constructor(private readonly service: AnnouncementsService) {}

  // 1. å‰å°æŠ“å–æœ€æ–°å…¬å‘Š
  @Get('active')
  findActive() {
    return this.service.findActive();
  }

  // 2. å¾Œå°åˆ—è¡¨
  @Get()
  findAll() {
    return this.service.findAll();
  }

  // 3. æ–°å¢
  @Post()
  create(@Body() body: { content: string }) {
    return this.service.create(body.content);
  }

  // 4. åˆ‡æ›ç‹€æ…‹
  @Patch(':id')
  update(@Param('id') id: string, @Body() body: { isActive: boolean }) {
    return this.service.toggle(id, body.isActive);
  }

  // 5. åˆªé™¤
  @Delete(':id')
  remove(@Param('id') id: string) {
    return this.service.remove(id);
  }
}
</file>

<file path="backend/src/announcements/announcements.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { AnnouncementsService } from './announcements.service';
import { AnnouncementsController } from './announcements.controller';
import { Announcement } from './entities/announcement.entity';

@Module({
  imports: [TypeOrmModule.forFeature([Announcement])],
  controllers: [AnnouncementsController],
  providers: [AnnouncementsService],
})
export class AnnouncementsModule {}
</file>

<file path="backend/src/announcements/announcements.service.ts">
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Announcement } from './entities/announcement.entity';

@Injectable()
export class AnnouncementsService {
  constructor(
    @InjectRepository(Announcement)
    private repo: Repository<Announcement>,
  ) {}

  // 1. å»ºç«‹å…¬å‘Š
  create(content: string) {
    const announcement = this.repo.create({ content, isActive: true }); // é è¨­å•Ÿç”¨
    return this.repo.save(announcement);
  }

  // 2. æŸ¥è©¢æ‰€æœ‰ (å¾Œå°ç”¨)
  findAll() {
    return this.repo.find({ order: { createdAt: 'DESC' } });
  }

  // 3. æŸ¥è©¢ã€Œç›®å‰å•Ÿç”¨ã€çš„å…¬å‘Š (å‰å°ç”¨) - åªæŠ“æœ€æ–°çš„ä¸€ç­†
  async findActive() {
    return this.repo.findOne({
      where: { isActive: true },
      order: { createdAt: 'DESC' },
    });
  }

  // 4. åˆ‡æ›ç‹€æ…‹ (é–‹/é—œ)
  async toggle(id: string, isActive: boolean) {
    await this.repo.update(id, { isActive });
    return this.repo.findOneBy({ id });
  }

  // 5. åˆªé™¤
  remove(id: string) {
    return this.repo.delete(id);
  }
}
</file>

<file path="backend/src/announcements/dto/create-announcement.dto.ts">
export class CreateAnnouncementDto {}
</file>

<file path="backend/src/announcements/dto/update-announcement.dto.ts">
import { PartialType } from '@nestjs/mapped-types';
import { CreateAnnouncementDto } from './create-announcement.dto';

export class UpdateAnnouncementDto extends PartialType(CreateAnnouncementDto) {}
</file>

<file path="backend/src/announcements/entities/announcement.entity.ts">
import { Entity, Column, PrimaryGeneratedColumn, CreateDateColumn } from 'typeorm';

@Entity()
export class Announcement {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  content: string; // å…¬å‘Šå…§å®¹

  @Column({ default: false })
  isActive: boolean; // æ˜¯å¦å•Ÿç”¨ (é¡¯ç¤ºåœ¨å‰å°)

  @CreateDateColumn()
  createdAt: Date;
}
</file>

<file path="backend/src/app.controller.spec.ts">
import { Test, TestingModule } from '@nestjs/testing';
import { AppController } from './app.controller';
import { AppService } from './app.service';

describe('AppController', () => {
  let appController: AppController;

  beforeEach(async () => {
    const app: TestingModule = await Test.createTestingModule({
      controllers: [AppController],
      providers: [AppService],
    }).compile();

    appController = app.get<AppController>(AppController);
  });

  describe('root', () => {
    it('should return "Hello World!"', () => {
      expect(appController.getHello()).toBe('Hello World!');
    });
  });
});
</file>

<file path="backend/src/app.controller.ts">
import { Controller, Get } from '@nestjs/common';
import { AppService } from './app.service';

@Controller()
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get()
  getHello(): string {
    return this.appService.getHello();
  }
}
</file>

<file path="backend/src/app.service.ts">
import { Injectable } from '@nestjs/common';

@Injectable()
export class AppService {
  getHello(): string {
    return 'Hello World!';
  }
}
</file>

<file path="backend/src/auth/entities/auth.entity.ts">
export class Auth {}
</file>

<file path="backend/src/auth/jwt-auth.guard.ts">
import { Injectable } from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport';

@Injectable()
export class JwtAuthGuard extends AuthGuard('jwt') {}
</file>

<file path="backend/src/cart/cart.controller.ts">
import { Controller, Get, Post, Delete, Body, Param, UseGuards, Request } from '@nestjs/common';
import { CartService } from './cart.service';
import { JwtAuthGuard } from '../auth/jwt-auth.guard';

@Controller('cart')
@UseGuards(JwtAuthGuard) // ä¿è­·è·¯ç”±ï¼šåªæœ‰ç™»å…¥çš„ä½¿ç”¨è€…æ‰èƒ½å­˜å–è³¼ç‰©è»Š
export class CartController {
  constructor(private readonly cartService: CartService) {}

  // å–å¾—ç›®å‰ä½¿ç”¨è€…çš„è³¼ç‰©è»Šå…§å®¹
  @Get()
  getCart(@Request() req) {
    return this.cartService.getCart(req.user);
  }

  // åŠ å…¥å•†å“åˆ°è³¼ç‰©è»Š
  @Post()
  addToCart(@Request() req, @Body() body: any) {
    return this.cartService.addToCart(req.user, body);
  }

  // ç§»é™¤å–®ä¸€è³¼ç‰©è»Šé …ç›®
  @Delete(':id')
  removeItem(@Request() req, @Param('id') id: string) {
    return this.cartService.removeItem(req.user, id);
  }

  // æ¸…ç©ºæ•´å°è³¼ç‰©è»Š
  @Delete()
  clearCart(@Request() req) {
    return this.cartService.clearCart(req.user);
  }
}
</file>

<file path="backend/src/cart/cart.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { CartService } from './cart.service';
import { CartController } from './cart.controller';
import { CartItem } from './entities/cart-item.entity';

@Module({
  imports: [TypeOrmModule.forFeature([CartItem])],
  controllers: [CartController],
  providers: [CartService],
  exports: [CartService] // åŒ¯å‡º CartService è®“å…¶ä»–æ¨¡çµ„ä¹Ÿèƒ½ä½¿ç”¨
})
export class CartModule {}
</file>

<file path="backend/src/cart/cart.service.ts">
import { Injectable, NotFoundException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { CartItem } from './entities/cart-item.entity';
import { User } from '../users/entities/user.entity';

@Injectable()
export class CartService {
  constructor(
    @InjectRepository(CartItem)
    private cartRepository: Repository<CartItem>,
  ) {}

  // å–å¾—ä½¿ç”¨è€…çš„è³¼ç‰©è»Š
  async getCart(user: User) {
    return this.cartRepository.find({
      where: { user: { id: user.id } },
      relations: ['product'], // é—œè¯ç”¢å“è³‡è¨Šï¼Œä»¥ä¾¿å‰ç«¯é¡¯ç¤ºåœ–ç‰‡èˆ‡åç¨±
      order: { createdAt: 'DESC' }
    });
  }

  // åŠ å…¥è³¼ç‰©è»Š
  async addToCart(user: User, itemDto: any) {
    // å»ºç«‹ CartItem å¯¦é«”ï¼Œä¸¦å¡«å…¥æ‰€æœ‰è©³ç´°è¦æ ¼
    // é€™è£¡ä¸é€²è¡Œåˆä½µé‚è¼¯(Merge)ï¼Œå› ç‚ºå®¢è£½åŒ–è¦æ ¼å¤ªè¤‡é›œï¼Œè¦–ç‚ºæ–°çš„ä¸€ç­†
    const cartItem = this.cartRepository.create({
      user: user,
      product: { id: itemDto.productId },
      
      // è¦æ ¼è³‡æ–™ (ç›´æ¥å¾å‰ç«¯ DTO æ˜ å°„)
      serviceType: itemDto.serviceType,
      widthMatrix: itemDto.widthMatrix,
      heightData: itemDto.heightData,
      isCeilingMounted: itemDto.isCeilingMounted,
      siteConditions: itemDto.siteConditions,
      colorName: itemDto.colorName,
      materialName: itemDto.materialName,
      handleName: itemDto.handleName,
      openingDirection: itemDto.openingDirection,
      hasThreshold: itemDto.hasThreshold,
      
      // æ•¸é‡èˆ‡é‡‘é¡
      quantity: itemDto.quantity,
      subtotal: itemDto.subtotal,
      
      // åƒ¹æ ¼å¿«ç…§ (é‡è¦ï¼šä¿ç•™ç•¶ä¸‹è¨ˆç®—çš„åƒ¹æ ¼ç´°ç¯€)
      priceSnapshot: itemDto.priceSnapshot
    });

    return this.cartRepository.save(cartItem);
  }

  // ç§»é™¤å–®ä¸€é …ç›®
  async removeItem(user: User, id: string) {
    // ç¢ºä¿åªèƒ½åˆªé™¤è‡ªå·±çš„è³¼ç‰©è»Šé …ç›®
    const item = await this.cartRepository.findOne({ 
      where: { id, user: { id: user.id } } 
    });
    
    if (!item) {
      throw new NotFoundException('æ‰¾ä¸åˆ°è©²é …ç›®æˆ–ç„¡æ¬Šé™åˆªé™¤');
    }
    
    return this.cartRepository.remove(item);
  }

  // æ¸…ç©ºè³¼ç‰©è»Š (çµå¸³å¾Œä½¿ç”¨)
  async clearCart(user: User) {
    const items = await this.cartRepository.find({ 
      where: { user: { id: user.id } } 
    });
    
    if (items.length > 0) {
      return this.cartRepository.remove(items);
    }
    
    return { message: 'Cart is already empty' };
  }
}
</file>

<file path="backend/src/cart/entities/cart-item.entity.ts">
import { Entity, Column, PrimaryGeneratedColumn, ManyToOne, CreateDateColumn, UpdateDateColumn } from 'typeorm';
import { User } from '../../users/entities/user.entity';
import { Product } from '../../products/entities/product.entity';

export enum ServiceType {
  MATERIAL = 'material',   
  ASSEMBLED = 'assembled', 
}

@Entity()
export class CartItem {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  // é—œè¯åˆ°ä½¿ç”¨è€… (é€™æ˜¯é—œéµï¼Œè®“è³¼ç‰©è»Šè·Ÿè‘—äººèµ°)
  // onDelete: 'CASCADE' è¡¨ç¤ºå¦‚æœä½¿ç”¨è€…è¢«åˆªé™¤ï¼Œè³¼ç‰©è»Šä¹Ÿæœƒä¸€èµ·åˆªé™¤
  @ManyToOne(() => User, (user) => user.cartItems, { onDelete: 'CASCADE' })
  user: User;

  @ManyToOne(() => Product, { eager: true })
  product: Product;

  @Column({
    type: 'enum',
    enum: ServiceType,
    default: ServiceType.ASSEMBLED
  })
  serviceType: ServiceType;
  
  @Column({ type: 'jsonb' })
  widthMatrix: { top: number; mid: number; bot: number };

  @Column({ type: 'jsonb' })
  heightData: any; 

  @Column({ default: true })
  isCeilingMounted: boolean; 

  @Column({ type: 'jsonb', nullable: true })
  siteConditions: any;

  @Column()
  colorName: string;

  @Column()
  materialName: string;

  // æŠŠæ‰‹åç¨± (æ–°å¢æ¬„ä½)
  @Column({ nullable: true })
  handleName: string;

  @Column()
  openingDirection: string;

  @Column({ default: false })
  hasThreshold: boolean;

  @Column({ type: 'int', default: 1 })
  quantity: number;

  // é€™è£¡å„²å­˜çš„æ˜¯ã€ŒåŠ å…¥è³¼ç‰©è»Šç•¶ä¸‹ã€çš„è©¦ç®—é‡‘é¡
  @Column({ type: 'decimal', precision: 12, scale: 2 })
  subtotal: number; 

  // è©³ç´°åƒ¹æ ¼å¿«ç…§ (æ–¹ä¾¿å¾ŒçºŒè½‰æˆè¨‚å–®æ™‚ç›´æ¥ä½¿ç”¨)
  @Column({ type: 'jsonb' })
  priceSnapshot: {
    basePrice: number;
    sizeSurcharge: number;
    colorSurcharge: number;
    materialSurcharge: number;
    handleSurcharge: number;
    assemblyFee: number;
    thresholdFee: number;
  };

  @CreateDateColumn()
  createdAt: Date;

  @UpdateDateColumn()
  updatedAt: Date;
}
</file>

<file path="backend/src/logs/entities/audit-log.entity.ts">
import { Entity, Column, PrimaryGeneratedColumn, CreateDateColumn, ManyToOne } from 'typeorm';
import { User } from '../../users/entities/user.entity';

@Entity()
export class AuditLog {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @ManyToOne(() => User, { nullable: true, onDelete: 'SET NULL' })
  user: User; // æ“ä½œè€…

  @Column()
  action: string; // e.g. 'UPDATE_PRODUCT', 'DELETE_ORDER'

  @Column()
  targetEntity: string; // e.g. 'Product', 'Order'

  @Column()
  targetId: string; // è¢«æ“ä½œç‰©ä»¶çš„ ID

  @Column({ type: 'jsonb', nullable: true })
  details: any; // æ”¹äº†ä»€éº¼ (èˆŠå€¼/æ–°å€¼ï¼Œæˆ–å‚™è¨»)

  @CreateDateColumn()
  createdAt: Date;
}
</file>

<file path="backend/src/logs/entities/login-log.entity.ts">
import { Entity, Column, PrimaryGeneratedColumn, CreateDateColumn, ManyToOne } from 'typeorm';
import { User } from '../../users/entities/user.entity';

@Entity()
export class LoginLog {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  // é—œè¯åˆ°ä½¿ç”¨è€…
  @ManyToOne(() => User, { onDelete: 'CASCADE' })
  user: User;

  @Column({ nullable: true })
  ip: string; // ç™»å…¥ä¾†æº IP

  @Column({ nullable: true })
  userAgent: string; // ç€è¦½å™¨è³‡è¨Š (Chrome/Safari...)

  @Column({ default: true })
  success: boolean; // æ˜¯å¦æˆåŠŸ (ç›®å‰åªè¨˜æˆåŠŸï¼Œæœªä¾†å¯æ“´å……è¨˜å¤±æ•—)

  @CreateDateColumn()
  loginAt: Date;
}
</file>

<file path="backend/src/logs/logs.controller.ts">
import { Controller, Get, UseGuards } from '@nestjs/common';
import { LogsService } from './logs.service';
import { JwtAuthGuard } from '../auth/jwt-auth.guard';

@Controller('logs')
@UseGuards(JwtAuthGuard) // åªæœ‰ç™»å…¥çš„ç®¡ç†å“¡æ‰èƒ½çœ‹
export class LogsController {
  constructor(private readonly logsService: LogsService) {}

  // å–å¾—ç™»å…¥æ—¥èªŒ
  @Get('login')
  getLoginLogs() {
    return this.logsService.getRecentLogins();
  }

  // å–å¾—æ“ä½œæ—¥èªŒ
  @Get('audit')
  getAuditLogs() {
    return this.logsService.getRecentAuditLogs();
  }
}
</file>

<file path="backend/src/logs/logs.module.ts">
import { Module, Global } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { LogsService } from './logs.service';
import { LogsController } from './logs.controller'; // âœ¨ å¼•å…¥ Controller
import { LoginLog } from './entities/login-log.entity';
import { AuditLog } from './entities/audit-log.entity';

@Global()
@Module({
  imports: [TypeOrmModule.forFeature([LoginLog, AuditLog])],
  controllers: [LogsController], // âœ¨ è¨»å†Š Controller
  providers: [LogsService],
  exports: [LogsService],
})
export class LogsModule {}
</file>

<file path="backend/src/logs/logs.service.ts">
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { LoginLog } from './entities/login-log.entity';
import { AuditLog } from './entities/audit-log.entity';
import { User } from '../users/entities/user.entity';

@Injectable()
export class LogsService {
  constructor(
    @InjectRepository(LoginLog)
    private loginRepo: Repository<LoginLog>,
    @InjectRepository(AuditLog)
    private auditRepo: Repository<AuditLog>,
  ) {}

  // è¨˜éŒ„ç™»å…¥
  async logLogin(user: User, ip: string, userAgent: string) {
    const log = this.loginRepo.create({ user, ip, userAgent, success: true });
    return this.loginRepo.save(log);
  }

  // è¨˜éŒ„æ“ä½œ
  async logAction(user: User, action: string, targetEntity: string, targetId: string, details?: any) {
    const log = this.auditRepo.create({ user, action, targetEntity, targetId, details });
    return this.auditRepo.save(log);
  }

  // æŸ¥è©¢æœ€è¿‘ç™»å…¥ç´€éŒ„
  async getRecentLogins(limit = 50) {
    return this.loginRepo.find({
      relations: ['user', 'user.dealerProfile'],
      order: { loginAt: 'DESC' },
      take: limit,
    });
  }

  // âœ¨âœ¨âœ¨ æ–°å¢ï¼šæŸ¥è©¢æœ€è¿‘æ“ä½œç´€éŒ„ âœ¨âœ¨âœ¨
  async getRecentAuditLogs(limit = 50) {
    return this.auditRepo.find({
      relations: ['user', 'user.dealerProfile'], // é—œè¯ä½¿ç”¨è€…è³‡æ–™
      order: { createdAt: 'DESC' },
      take: limit,
    });
  }
}
</file>

<file path="backend/src/main.ts">
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  
  // ğŸ” è¨ºæ–·ç›£è¦–å™¨ï¼šå°å‡ºç›®å‰è®€åˆ°çš„è³‡æ–™åº«ç¶²å€ (åªå°å‰ 20 å€‹å­—ï¼Œä¿è­·å¯†ç¢¼)
  const dbUrl = process.env.DATABASE_URL;
  console.log('------------------------------------------------');
  console.log('ğŸ” è¨ºæ–·æª¢æŸ¥ä¸­...');
  console.log('è³‡æ–™åº«ç¶²å€è®€å–ç‹€æ…‹:', dbUrl ? 'âœ… è®€åˆ°äº†' : 'âŒ æ˜¯ç©ºçš„ (undefined)');
  if (dbUrl) {
    console.log('ç¶²å€é–‹é ­:', dbUrl.substring(0, 25) + '...');
  }
  console.log('------------------------------------------------');

  app.enableCors();
  await app.listen(4000);
}
bootstrap();
</file>

<file path="backend/src/notifications/notifications.module.ts">
import { Module } from '@nestjs/common';
import { NotificationsService } from './notifications.service';

@Module({
  providers: [NotificationsService],
  // âœ¨ é—œéµä¿®æ­£ï¼šå¿…é ˆæŠŠ Service åŒ¯å‡ºï¼Œåˆ¥çš„æ¨¡çµ„æ‰çœ‹å¾—åˆ°ï¼
  exports: [NotificationsService], 
})
export class NotificationsModule {}
</file>

<file path="backend/src/notifications/notifications.service.spec.ts">
import { Test, TestingModule } from '@nestjs/testing';
import { NotificationsService } from './notifications.service';

describe('NotificationsService', () => {
  let service: NotificationsService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [NotificationsService],
    }).compile();

    service = module.get<NotificationsService>(NotificationsService);
  });

  it('should be defined', () => {
    expect(service).toBeDefined();
  });
});
</file>

<file path="backend/src/products/dto/create-product.dto.ts">
export class CreateProductDto {}
</file>

<file path="backend/src/products/dto/update-product.dto.ts">
import { PartialType } from '@nestjs/mapped-types';
import { CreateProductDto } from './create-product.dto';

export class UpdateProductDto extends PartialType(CreateProductDto) {}
</file>

<file path="backend/src/products/products.controller.ts">
import { Controller, Get, Post, Body, Param, Patch, Delete } from '@nestjs/common'; // âœ¨ è¨˜å¾—å¼•å…¥ Patch, Delete
import { ProductsService } from './products.service';

@Controller('products')
export class ProductsController {
  constructor(private readonly productsService: ProductsService) {}

  @Post()
  create(@Body() createProductDto: any) {
    return this.productsService.create(createProductDto);
  }

  @Get()
  findAll() {
    return this.productsService.findAll();
  }

  @Get(':id')
  findOne(@Param('id') id: string) {
    return this.productsService.findOne(id);
  }

  // âœ¨ æ–°å¢ï¼šæ›´æ–° API (PATCH)
  @Patch(':id')
  update(@Param('id') id: string, @Body() updateProductDto: any) {
    return this.productsService.update(id, updateProductDto);
  }

  // âœ¨ æ–°å¢ï¼šåˆªé™¤ API (DELETE)
  @Delete(':id')
  remove(@Param('id') id: string) {
    return this.productsService.remove(id);
  }
}
</file>

<file path="backend/src/products/products.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { ProductsService } from './products.service';
import { ProductsController } from './products.controller';
import { Product } from './entities/product.entity';

@Module({
  imports: [
    // âœ¨ é—œéµä¿®æ­£ï¼šè¨»å†Š Product å¯¦é«”ï¼Œè®“ TypeORM èªè­˜å®ƒ
    TypeOrmModule.forFeature([Product]),
  ],
  controllers: [ProductsController],
  providers: [ProductsService],
  exports: [ProductsService], // åŒ¯å‡º Serviceï¼Œä»¥é˜²ä¹‹å¾Œ Order éœ€è¦æŸ¥ç”¢å“
})
export class ProductsModule {}
</file>

<file path="backend/src/reports/dto/create-report.dto.ts">
export class CreateReportDto {}
</file>

<file path="backend/src/reports/dto/update-report.dto.ts">
import { PartialType } from '@nestjs/mapped-types';
import { CreateReportDto } from './create-report.dto';

export class UpdateReportDto extends PartialType(CreateReportDto) {}
</file>

<file path="backend/src/reports/entities/report.entity.ts">
export class Report {}
</file>

<file path="backend/src/reports/reports.controller.ts">
import { Controller, Get } from '@nestjs/common';
import { ReportsService } from './reports.service';

@Controller('reports')
export class ReportsController {
  constructor(private readonly reportsService: ReportsService) {}

  @Get('dashboard')
  getStats() {
    return this.reportsService.getDashboardStats();
  }
}
</file>

<file path="backend/src/reports/reports.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { ReportsService } from './reports.service';
import { ReportsController } from './reports.controller';
import { Order } from '../orders/entities/order.entity'; // å¼•å…¥ Order

@Module({
  imports: [TypeOrmModule.forFeature([Order])], // è¨˜å¾—è¨»å†Š Order å¯¦é«”
  controllers: [ReportsController],
  providers: [ReportsService],
})
export class ReportsModule {}
</file>

<file path="backend/src/series/dto/create-series.dto.ts">
export class CreateSeriesDto {}
</file>

<file path="backend/src/series/dto/update-series.dto.ts">
import { PartialType } from '@nestjs/mapped-types';
import { CreateSeriesDto } from './create-series.dto';

export class UpdateSeriesDto extends PartialType(CreateSeriesDto) {}
</file>

<file path="backend/src/series/entities/series.entity.ts">
import { Entity, Column, PrimaryGeneratedColumn } from 'typeorm';

@Entity()
export class Series {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ unique: true })
  name: string; // è­˜åˆ¥åç¨± (ä¾‹å¦‚ï¼šæ¥µç°¡ç³»åˆ—)ï¼Œé€™æœƒè·Ÿç”¢å“çš„ series æ¬„ä½å°æ‡‰

  @Column()
  displayName: string; // å‰å°é¡¯ç¤ºçš„æ¨™é¡Œ (ä¾‹å¦‚ï¼šæ¥µç°¡ç´°æ¡†ç³»åˆ—)

  @Column()
  description: string; // æè¿° (ä¾‹å¦‚ï¼šModern Slim)

  @Column()
  imageUrl: string; // å°é¢åœ–ç¶²å€

  @Column({ type: 'int', default: 0 })
  priceStart: number; // èµ·å§‹åƒ¹æ ¼

  @Column({ default: true })
  isActive: boolean; // æ˜¯å¦é¡¯ç¤º
}
</file>

<file path="backend/src/series/series.controller.ts">
import { Controller, Get, Post, Body, Patch, Param, Delete } from '@nestjs/common';
import { SeriesService } from './series.service';

@Controller('series')
export class SeriesController {
  constructor(private readonly seriesService: SeriesService) {}

  @Post()
  create(@Body() body: any) { return this.seriesService.create(body); }

  @Get()
  findAll() { return this.seriesService.findAll(); }

  @Get(':id')
  findOne(@Param('id') id: string) { return this.seriesService.findOne(id); }

  @Patch(':id')
  update(@Param('id') id: string, @Body() body: any) { return this.seriesService.update(id, body); }

  @Delete(':id')
  remove(@Param('id') id: string) { return this.seriesService.remove(id); }
}
</file>

<file path="backend/src/series/series.module.ts">
import { Module, OnModuleInit } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { SeriesService } from './series.service';
import { SeriesController } from './series.controller';
import { Series } from './entities/series.entity';

@Module({
  imports: [TypeOrmModule.forFeature([Series])],
  controllers: [SeriesController],
  providers: [SeriesService],
})
export class SeriesModule implements OnModuleInit {
  constructor(private readonly service: SeriesService) {}
  
  // âœ¨ å•Ÿå‹•æ™‚è‡ªå‹•å»ºç«‹é è¨­ç³»åˆ—è³‡æ–™ (é¿å…å‰å°ç©ºç©ºçš„)
  async onModuleInit() {
    await this.service.initDefaults();
  }
}
</file>

<file path="backend/src/series/series.service.ts">
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Series } from './entities/series.entity';

@Injectable()
export class SeriesService {
  constructor(
    @InjectRepository(Series)
    private repo: Repository<Series>,
  ) {}

  create(data: any) {
    const series = this.repo.create(data);
    return this.repo.save(series);
  }

  findAll() {
    return this.repo.find({ order: { name: 'ASC' } });
  }

  findOne(id: string) {
    return this.repo.findOneBy({ id });
  }

  async update(id: string, data: any) {
    await this.repo.update(id, data);
    return this.repo.findOneBy({ id });
  }

  remove(id: string) {
    return this.repo.delete(id);
  }

  // åˆå§‹åŒ–é è¨­ç³»åˆ— (æ‡¶äººåŒ…)
  async initDefaults() {
    const count = await this.repo.count();
    if (count === 0) {
      const defaults = [
        { name: 'æ¥µç°¡ç³»åˆ—', displayName: 'æ¥µç°¡ç´°æ¡†ç³»åˆ—', description: 'Modern Slim', priceStart: 5000, imageUrl: 'https://images.unsplash.com/photo-1600607686527-6fb886090705?auto=format&fit=crop&q=80&w=800' },
        { name: 'ç¶“å…¸ç³»åˆ—', displayName: 'ç¶“å…¸å¯¬æ¡†ç³»åˆ—', description: 'Classic Bold', priceStart: 4500, imageUrl: 'https://images.unsplash.com/photo-1584622050111-993a426fbf0a?auto=format&fit=crop&q=80&w=800' },
        { name: 'æ·‹æµ´ç³»åˆ—', displayName: 'æ·‹æµ´æ‹‰é–€ç³»åˆ—', description: 'Shower Doors', priceStart: 8000, imageUrl: 'https://images.unsplash.com/photo-1631679706909-1844bbd07221?auto=format&fit=crop&q=80&w=800' },
        { name: 'æ‡¸æµ®ç³»åˆ—', displayName: 'æ‡¸æµ®ç„¡è»Œç³»åˆ—', description: 'Magnetic Levitation', priceStart: 12000, imageUrl: 'https://images.unsplash.com/photo-1486946255434-2466348c2166?auto=format&fit=crop&q=80&w=800' },
      ];
      for (const s of defaults) await this.repo.save(this.repo.create(s));
    }
  }
}
</file>

<file path="backend/src/site-config/entities/site-config.entity.ts">
import { Entity, Column, PrimaryColumn, UpdateDateColumn } from 'typeorm';

// å®šç¾©ç©æœ¨çš„çµæ§‹ (çµ¦ TypeScript çœ‹çš„)
export interface SiteBlock {
  id: string;       // å”¯ä¸€ ID (ç”¨ä¾†æ’åºå’Œåˆªé™¤)
  type: 'HERO' | 'FEATURES' | 'PRODUCT_LIST' | 'TEXT_BANNER'; // ç©æœ¨é¡å‹
  data: any;        // ç©æœ¨å…§å®¹ (æ¯ç¨®ç©æœ¨ä¸ä¸€æ¨£)
}

@Entity()
export class SiteConfig {
  // æˆ‘å€‘å›ºå®šç”¨ 'homepage' æˆ– 'system_rules' ç•¶ä½œ ID
  @PrimaryColumn()
  key: string;

  // ç”¨æ–¼é¦–é ç©æœ¨
  @Column({ type: 'jsonb', nullable: true })
  blocks: SiteBlock[];

  // âœ¨âœ¨âœ¨ é—œéµä¿®æ­£ï¼šè£œä¸Š settings æ¬„ä½ âœ¨âœ¨âœ¨
  // é€™æ¨£ Service æ‰èƒ½å­˜å– system_rules çš„è¨­å®šå€¼
  @Column({ type: 'jsonb', nullable: true })
  settings: any;

  @UpdateDateColumn()
  updatedAt: Date;
}
</file>

<file path="backend/src/site-config/site-config.controller.ts">
import { Controller, Get, Patch, Body } from '@nestjs/common';
import { SiteConfigService } from './site-config.service';

@Controller('site-config')
export class SiteConfigController {
  constructor(private readonly service: SiteConfigService) {}

  // --- é¦–é é…ç½® ---
  @Get('homepage')
  getHomepage() {
    return this.service.getHomepageConfig();
  }

  @Patch('homepage')
  updateHomepage(@Body() body: any) {
    return this.service.updateHomepageConfig(body);
  }

  // --- âœ¨âœ¨âœ¨ æ–°å¢ï¼šç³»çµ±è¦å‰‡æ¥å£ (è§£æ±º 404 éŒ¯èª¤) âœ¨âœ¨âœ¨ ---
  @Get('rules')
  getSystemRules() {
    return this.service.getSystemRules();
  }

  @Patch('rules')
  updateSystemRules(@Body() body: any) {
    return this.service.updateSystemRules(body); // æ³¨æ„ï¼šå‰ç«¯å‚³ä¾†çš„ body æ‡‰è©²æ˜¯ settings ç‰©ä»¶
  }
}
</file>

<file path="backend/src/site-config/site-config.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { SiteConfigService } from './site-config.service';
import { SiteConfigController } from './site-config.controller';
import { SiteConfig } from './entities/site-config.entity';

@Module({
  imports: [TypeOrmModule.forFeature([SiteConfig])],
  controllers: [SiteConfigController],
  providers: [SiteConfigService],
  exports: [SiteConfigService]
})
export class SiteConfigModule {}
</file>

<file path="backend/src/site-config/site-config.service.ts">
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { SiteConfig, SiteBlock } from './entities/site-config.entity';
import { randomUUID } from 'crypto'; 

@Injectable()
export class SiteConfigService {
  constructor(
    @InjectRepository(SiteConfig)
    private repo: Repository<SiteConfig>,
  ) {}

  // --- é¦–é é…ç½® (Homepage Config) ---
  
  // å–å¾—è¨­å®š (å¦‚æœæ²’æœ‰å°±å»ºç«‹é è¨­å€¼)
  async getHomepageConfig() {
    let config = await this.repo.findOneBy({ key: 'homepage' });
    
    // å¦‚æœæ²’æœ‰è¨­å®šï¼Œåˆå§‹åŒ–é è¨­ç©æœ¨
    if (!config) {
      const defaultBlocks: SiteBlock[] = [
        // 1. Hero ä¸»è¦–è¦ºå€å¡Š
        {
          id: randomUUID(),
          type: 'HERO',
          data: {
            title: 'æ¥µè‡´å·¥è—ï¼Œ\nå®šç¾©ç©ºé–“æ–°ç¶­åº¦ã€‚',
            subtitle: 'å°ˆç‚ºå®¤å…§è¨­è¨ˆå¸«èˆ‡å°ˆæ¥­ç¶“éŠ·å•†æ‰“é€ çš„ B2B æ•¸ä½å·¥å» ã€‚',
            images: ["https://images.unsplash.com/photo-1600607686527-6fb886090705?auto=format&fit=crop&q=80&w=2000"]
          }
        },
        // 2. ç‰¹è‰²ä»‹ç´¹å€å¡Š
        {
          id: randomUUID(),
          type: 'FEATURES',
          data: {
            title: 'ç‚ºä»€éº¼é¸æ“‡æ¾æˆï¼Ÿ',
            items: [
              { title: 'å…­é»çŸ©é™£ä¸ˆé‡', desc: 'ç¨å®¶é–‹ç™¼æ•¸ä½ä¸ˆé‡ç³»çµ±ï¼Œç¢ºä¿å®‰è£å®Œç¾è²¼åˆã€‚' },
              { title: 'é€£å·¥å¸¶æ–™ / ç´”æ–™', desc: 'å½ˆæ€§çš„æœå‹™æ¨¡å¼ï¼Œæ»¿è¶³ä¸åŒå·¥ç­éœ€æ±‚ã€‚' },
              { title: 'å…¨æ•¸ä½åŒ–å±¥æ­·', desc: 'å…¨ç¨‹é€æ˜åŒ–è¿½è¹¤ï¼Œè®“æ‚¨å°æ¥­ä¸»æ›´æœ‰äº¤ä»£ã€‚' }
            ]
          }
        },
        // 3. ç”¢å“åˆ—è¡¨å€å¡Š
        {
          id: randomUUID(),
          type: 'PRODUCT_LIST',
          data: {
            title: 'ç†±é–€ç”¢å“ç³»åˆ—',
            count: 4
          }
        }
      ];

      config = this.repo.create({
        key: 'homepage',
        blocks: defaultBlocks
      });
      await this.repo.save(config);
    }
    return config;
  }

  // æ›´æ–°é¦–é è¨­å®š
  async updateHomepageConfig(data: Partial<SiteConfig>) {
    // ç§»é™¤ key é¿å…è¢«è¦†å¯«ï¼Œç¢ºä¿ key æ°¸é æ˜¯ 'homepage'
    const { key, ...updateData } = data;
    
    // ç¢ºä¿è³‡æ–™åº«æœ‰è³‡æ–™ (å¦‚æœæ²’æœ‰æœƒå…ˆå»ºç«‹é è¨­å€¼)
    await this.getHomepageConfig();
    
    await this.repo.update('homepage', updateData);
    return this.repo.findOneBy({ key: 'homepage' });
  }

  // --- ç³»çµ±è¦å‰‡ (System Rules) ---
  
  async getSystemRules() {
    let config = await this.repo.findOneBy({ key: 'system_rules' });
    
    // å¦‚æœé‚„æ²’æœ‰è¦å‰‡ï¼Œå»ºç«‹é è¨­å€¼
    if (!config) {
      config = this.repo.create({
        key: 'system_rules',
        // é€™è£¡ä¾è³´ Entity ä¸­çš„ settings æ¬„ä½ (JSONB)
        settings: {
          // 1. ç‡Ÿé‹é–‹é—œ
          enable_registration: true, // æ˜¯å¦é–‹æ”¾è¨»å†Š
          maintenance_mode: false,   // æ˜¯å¦ç¶­è­·ä¸­
          allow_guest_view: true,    // æ˜¯å¦å…è¨±è¨ªå®¢ç€è¦½

          // 2. æœƒå“¡åƒ¹æ ¼ç­–ç•¥
          discount_level_A: 0.85,    // A ç´š 85 æŠ˜
          discount_level_B: 0.95,    // B ç´š 95 æŠ˜

          // 3. è¨‚å–®æµæ°´è™Ÿé‡ç½®æ—¥ (æ¯æœˆå¹¾è™Ÿ)
          order_reset_day: 1,

          // 4. å…¬å¸åŸºæœ¬è³‡æ–™ (Footer é¡¯ç¤ºç”¨)
          company_name: 'æ¾æˆæœ‰é™å…¬å¸',
          tax_id: '12345678',
          phone: '(02) 2345-6789',
          address: 'æ–°åŒ—å¸‚ä¸‰é‡å€... (ç¯„ä¾‹åœ°å€)',
          copyright_text: 'Â© 2025 SomaLink. All rights reserved.'
        }
      });
      await this.repo.save(config);
    }
    return config;
  }

  // æ›´æ–°ç³»çµ±è¦å‰‡
  async updateSystemRules(settings: any) {
    // ç¢ºä¿æœ‰è³‡æ–™
    await this.getSystemRules();
    
    // æ›´æ–° settings JSON æ¬„ä½
    await this.repo.update('system_rules', { settings });
    return this.repo.findOneBy({ key: 'system_rules' });
  }
}
</file>

<file path="backend/src/users/entities/trade-category.entity.ts">
import { Entity, Column, PrimaryGeneratedColumn } from 'typeorm';

@Entity()
export class TradeCategory {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  name: string; // é¡¯ç¤ºåç¨± (e.g. å°ˆæ¥­ç»ç’ƒè¡Œ)

  @Column({ unique: true })
  code: string; // ä»£ç¢¼ (e.g. glass)

  @Column({ default: false })
  isUpgradeable: boolean; // èƒ½å¦å‡ç´š B ç´š

  // âœ¨ æ–°å¢ï¼šè©²è¡Œæ¥­åˆ¥çš„é è¨­æŠ˜æ•¸ (1.0 = åŸåƒ¹, 0.7 = 7æŠ˜)
  @Column({ type: 'decimal', precision: 5, scale: 2, default: 1.0 })
  discountRate: number;
}
</file>

<file path="backend/src/users/trade-categories.controller.ts">
import { Controller, Get, Post, Patch, Delete, Body, Param } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { TradeCategory } from './entities/trade-category.entity';

@Controller('trade-categories')
export class TradeCategoriesController {
  constructor(
    @InjectRepository(TradeCategory)
    private repo: Repository<TradeCategory>,
  ) {}

  @Get()
  findAll() {
    return this.repo.find({ order: { id: 'ASC' } });
  }

  // æ–°å¢æ™‚æ¥æ”¶ discountRate
  @Post()
  create(@Body() body: { name: string; code: string; isUpgradeable: boolean; discountRate: number }) {
    const category = this.repo.create({
      ...body,
      discountRate: body.discountRate || 1.0 // é è¨­åŸåƒ¹
    });
    return this.repo.save(category);
  }

  // ä¿®æ”¹æ™‚æ¥æ”¶ discountRate
  @Patch(':id')
  async update(@Param('id') id: string, @Body() body: { isUpgradeable?: boolean; discountRate?: number }) {
    await this.repo.update(id, body);
    return this.repo.findOneBy({ id });
  }

  @Delete(':id')
  delete(@Param('id') id: string) {
    return this.repo.delete(id);
  }
}
</file>

<file path="backend/test/app.e2e-spec.ts">
import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication } from '@nestjs/common';
import request from 'supertest';
import { App } from 'supertest/types';
import { AppModule } from './../src/app.module';

describe('AppController (e2e)', () => {
  let app: INestApplication<App>;

  beforeEach(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    await app.init();
  });

  it('/ (GET)', () => {
    return request(app.getHttpServer())
      .get('/')
      .expect(200)
      .expect('Hello World!');
  });
});
</file>

<file path="backend/test/jest-e2e.json">
{
  "moduleFileExtensions": ["js", "json", "ts"],
  "rootDir": ".",
  "testEnvironment": "node",
  "testRegex": ".e2e-spec.ts$",
  "transform": {
    "^.+\\.(t|j)s$": "ts-jest"
  }
}
</file>

<file path="backend/tsconfig.build.json">
{
  "extends": "./tsconfig.json",
  "exclude": ["node_modules", "test", "dist", "**/*spec.ts"]
}
</file>

<file path="backend/tsconfig.json">
{
  "compilerOptions": {
    "module": "nodenext",
    "moduleResolution": "nodenext",
    "resolvePackageJsonExports": true,
    "esModuleInterop": true,
    "isolatedModules": true,
    "declaration": true,
    "removeComments": true,
    "emitDecoratorMetadata": true,
    "experimentalDecorators": true,
    "allowSyntheticDefaultImports": true,
    "target": "ES2023",
    "sourceMap": true,
    "outDir": "./dist",
    "baseUrl": "./",
    "incremental": true,
    "skipLibCheck": true,
    "strictNullChecks": true,
    "forceConsistentCasingInFileNames": true,
    "noImplicitAny": false,
    "strictBindCallApply": false,
    "noFallthroughCasesInSwitch": false
  }
}
</file>

<file path="frontend/.gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="frontend/forgot-password/page.tsx">
'use client';

import { useState } from 'react';
import { ArrowLeft, Mail, Send } from 'lucide-react';
import Link from 'next/link';

export default function ForgotPasswordPage() {
  const [email, setEmail] = useState('');
  const [isSubmitted, setIsSubmitted] = useState(false);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    // é€™è£¡æœªä¾†å¯ä»¥æ¥å¾Œç«¯ API ç™¼é€é‡è¨­ä¿¡
    // ç›®å‰å…ˆæ¨¡æ“¬æˆåŠŸ
    setIsSubmitted(true);
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 px-4">
      <div className="max-w-md w-full bg-white p-8 rounded-2xl shadow-lg border border-gray-100">
        
        {/* Header */}
        <div className="text-center mb-8">
          <div className="mx-auto h-12 w-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 mb-4">
            <Mail className="h-6 w-6" />
          </div>
          <h2 className="text-2xl font-bold text-gray-900">å¿˜è¨˜å¯†ç¢¼</h2>
          <p className="mt-2 text-sm text-gray-500">
            è«‹è¼¸å…¥æ‚¨è¨»å†Šçš„ Emailï¼Œæˆ‘å€‘å°‡å”åŠ©æ‚¨é‡è¨­å¯†ç¢¼ã€‚
          </p>
        </div>

        {isSubmitted ? (
          <div className="text-center space-y-6 animate-in fade-in">
            <div className="bg-green-50 text-green-700 p-4 rounded-xl text-sm">
              <p className="font-bold mb-1">ç”³è«‹å·²é€å‡ºï¼</p>
              <p>è«‹æª¢æŸ¥æ‚¨çš„ä¿¡ç®±ï¼Œæˆ–ç›´æ¥è¯ç¹«å®¢æœäººå“¡å”åŠ©é‡è¨­ã€‚</p>
            </div>
            <div className="text-sm text-gray-500">
              å®¢æœé›»è©±ï¼š(02) 2345-6789 <br/>
              Line ID: @somalink
            </div>
            <Link href="/login" className="block w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors">
              è¿”å›ç™»å…¥
            </Link>
          </div>
        ) : (
          <form onSubmit={handleSubmit} className="space-y-6">
            <div>
              <label className="block text-sm font-bold text-gray-700 mb-1">Email</label>
              <input 
                type="email" 
                required
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                placeholder="name@company.com"
              />
            </div>

            <button type="submit" className="w-full flex items-center justify-center gap-2 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors shadow-sm">
              <Send className="w-4 h-4" /> ç™¼é€é‡è¨­é€£çµ
            </button>

            <div className="text-center">
              <Link href="/login" className="text-sm text-gray-500 hover:text-gray-700 flex items-center justify-center gap-1">
                <ArrowLeft className="w-4 h-4" /> è¿”å›ç™»å…¥
              </Link>
            </div>
          </form>
        )}
      </div>
    </div>
  );
}
</file>

<file path="frontend/postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="frontend/public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="frontend/public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="frontend/public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="frontend/public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="frontend/public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="frontend/README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="frontend/src/app/forgot-password/page.tsx">
'use client';

import { useState } from 'react';
import { ArrowLeft, Mail, Send, Loader2 } from 'lucide-react';
import Link from 'next/link';
import { api } from '@/lib/api'; // âœ¨ å¼•å…¥çœŸå¯¦ API

export default function ForgotPasswordPage() {
  const [email, setEmail] = useState('');
  const [isSubmitted, setIsSubmitted] = useState(false);
  const [isLoading, setIsLoading] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);
    
    try {
      // âœ¨ å‘¼å«å¾Œç«¯ API
      await api.auth.forgotPassword(email);
      // ç„¡è«– Email æ˜¯å¦å­˜åœ¨ï¼Œéƒ½é¡¯ç¤ºæˆåŠŸ (å®‰å…¨æ€§è€ƒé‡ï¼Œé¿å…æšèˆ‰æ”»æ“Š)
      setIsSubmitted(true);
    } catch (error) {
      console.error(error);
      alert('ç™¼é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 px-4">
      <div className="max-w-md w-full bg-white p-8 rounded-2xl shadow-lg border border-gray-100">
        
        {/* Header */}
        <div className="text-center mb-8">
          <div className="mx-auto h-12 w-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 mb-4">
            <Mail className="h-6 w-6" />
          </div>
          <h2 className="text-2xl font-bold text-gray-900">å¿˜è¨˜å¯†ç¢¼</h2>
          <p className="mt-2 text-sm text-gray-600">
            è«‹è¼¸å…¥æ‚¨è¨»å†Šçš„ Emailï¼Œæˆ‘å€‘å°‡å”åŠ©æ‚¨é‡è¨­å¯†ç¢¼ã€‚
          </p>
        </div>

        {isSubmitted ? (
          <div className="text-center space-y-6 animate-in fade-in zoom-in-95 duration-300">
            <div className="bg-green-50 text-green-700 p-4 rounded-xl text-sm border border-green-100">
              <p className="font-bold mb-1 text-lg">ç”³è«‹å·²é€å‡ºï¼</p>
              <p>è‹¥è©² Email å­˜åœ¨æ–¼ç³»çµ±ä¸­ï¼Œæ‚¨å°‡åœ¨å¹¾åˆ†é˜å…§æ”¶åˆ°é‡è¨­å¯†ç¢¼çš„ä¿¡ä»¶ã€‚</p>
              <p className="text-xs mt-2 text-gray-500">(é–‹ç™¼æ¨¡å¼ï¼šè«‹æŸ¥çœ‹å¾Œç«¯ Terminal å–å¾—é€£çµ)</p>
            </div>
            <div className="text-sm text-gray-500 bg-gray-50 p-4 rounded-xl">
              <p className="font-bold mb-1">æ²’æ”¶åˆ°ä¿¡ï¼Ÿ</p>
              <p>è«‹æª¢æŸ¥åƒåœ¾éƒµä»¶ï¼Œæˆ–è¯ç¹«å®¢æœï¼š</p>
              <p className="mt-1 font-mono text-blue-600">(02) 2345-6789</p>
            </div>
            <Link href="/login" className="block w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors shadow-md">
              è¿”å›ç™»å…¥é é¢
            </Link>
          </div>
        ) : (
          <form onSubmit={handleSubmit} className="space-y-6">
            <div>
              <label className="block text-sm font-bold text-gray-700 mb-1">Email</label>
              <input 
                type="email" 
                required
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                placeholder="name@company.com"
              />
            </div>

            <button 
              type="submit" 
              disabled={isLoading}
              className="w-full flex items-center justify-center gap-2 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors shadow-md disabled:opacity-70 disabled:cursor-not-allowed"
            >
              {isLoading ? <Loader2 className="animate-spin w-5 h-5" /> : <><Send className="w-4 h-4" /> ç™¼é€é‡è¨­é€£çµ</>}
            </button>

            <div className="text-center">
              <Link href="/login" className="text-sm text-gray-500 hover:text-gray-700 flex items-center justify-center gap-1 transition-colors">
                <ArrowLeft className="w-4 h-4" /> è¿”å›ç™»å…¥
              </Link>
            </div>
          </form>
        )}
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/app/globals.css">
@import "tailwindcss";
</file>

<file path="frontend/src/app/login/register/page.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { api } from '@/lib/api';
import { Loader2, UserPlus, Building2, FileText, User, Phone, Mail, Lock, ArrowLeft } from 'lucide-react';
import Link from 'next/link';

export default function RegisterPage() {
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(false);
  
  const [formData, setFormData] = useState({
    email: '',
    password: '',
    companyName: '',
    taxId: '', // çµ±ç·¨
    contactPerson: '',
    phone: '',
    address: ''
  });

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);

    try {
      // å‘¼å«å¾Œç«¯è¨»å†Š API
      // å¾Œç«¯æœƒè‡ªå‹•å»ºç«‹ User + DealerProfile (é è¨­ C ç´š)
      await api.post('/users', formData);
      
      alert('ğŸ‰ è¨»å†ŠæˆåŠŸï¼è«‹ä½¿ç”¨å‰›å»ºç«‹çš„å¸³è™Ÿç™»å…¥ã€‚');
      router.push('/login'); // å°å‘ç™»å…¥é 

    } catch (err: any) {
      console.error(err);
      alert('è¨»å†Šå¤±æ•—ï¼š' + (err.response?.data?.message || 'è«‹æª¢æŸ¥è³‡æ–™æ˜¯å¦æ­£ç¢º'));
    } finally {
      setIsLoading(false);
    }
  };

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
  };

  return (
    <div className="min-h-screen bg-gray-50 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-md w-full space-y-8 bg-white p-8 rounded-2xl shadow-lg border border-gray-100">
        
        <div className="text-center">
          <h2 className="text-3xl font-bold tracking-tight text-gray-900">
            ç”³è«‹æˆç‚ºç¶“éŠ·å•†
          </h2>
          <p className="mt-2 text-sm text-gray-600">
            åŠ å…¥ SomaLinkï¼Œäº«å— B2B å°ˆå±¬åƒ¹æ ¼èˆ‡æœå‹™
          </p>
        </div>

        <form className="mt-8 space-y-4" onSubmit={handleSubmit}>
          
          {/* å¸³è™Ÿå¯†ç¢¼å€ */}
          <div className="space-y-2">
            <div className="relative">
              <Mail className="absolute left-3 top-3 w-5 h-5 text-gray-400" />
              <input name="email" type="email" required placeholder="Email (ç™»å…¥å¸³è™Ÿ)" onChange={handleChange} 
                className="w-full pl-10 p-2.5 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
            <div className="relative">
              <Lock className="absolute left-3 top-3 w-5 h-5 text-gray-400" />
              <input name="password" type="password" required placeholder="è¨­å®šå¯†ç¢¼" onChange={handleChange} 
                className="w-full pl-10 p-2.5 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
          </div>

          <div className="border-t border-gray-100 my-4"></div>

          {/* å…¬å¸è³‡æ–™å€ */}
          <div className="space-y-2">
            <div className="relative">
              <Building2 className="absolute left-3 top-3 w-5 h-5 text-gray-400" />
              <input name="companyName" required placeholder="å…¬å¸åç¨±" onChange={handleChange} 
                className="w-full pl-10 p-2.5 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
            <div className="relative">
              <FileText className="absolute left-3 top-3 w-5 h-5 text-gray-400" />
              <input name="taxId" required placeholder="çµ±ä¸€ç·¨è™Ÿ" onChange={handleChange} 
                className="w-full pl-10 p-2.5 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
            <div className="relative">
              <User className="absolute left-3 top-3 w-5 h-5 text-gray-400" />
              <input name="contactPerson" required placeholder="è¯çµ¡äººå§“å" onChange={handleChange} 
                className="w-full pl-10 p-2.5 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
            <div className="relative">
              <Phone className="absolute left-3 top-3 w-5 h-5 text-gray-400" />
              <input name="phone" required placeholder="è¯çµ¡é›»è©±" onChange={handleChange} 
                className="w-full pl-10 p-2.5 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
          </div>

          <button type="submit" disabled={isLoading}
            className="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 shadow-md transition-all disabled:opacity-70">
            {isLoading ? <Loader2 className="animate-spin" /> : <><UserPlus className="w-5 h-5 mr-2" /> æäº¤ç”³è«‹</>}
          </button>

          <div className="text-center mt-4">
            <Link href="/login" className="text-sm text-blue-600 hover:underline flex items-center justify-center gap-1">
              <ArrowLeft className="w-4 h-4" /> å·²æœ‰å¸³è™Ÿï¼Ÿè¿”å›ç™»å…¥
            </Link>
          </div>

        </form>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/app/profile/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useForm } from 'react-hook-form';
import { Save, User, Building2, Phone, MapPin, Loader2, ArrowLeft } from 'lucide-react';
import Link from 'next/link';
import { api } from '@/lib/api';

export default function ProfilePage() {
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(true);
  const [isSubmitting, setIsSubmitting] = useState(false);

  const { register, handleSubmit, setValue, reset } = useForm({
    defaultValues: {
      name: '',
      email: '',
      companyName: '',
      taxId: '',
      phone: '',
      address: '',
      password: '', // é¸å¡«ï¼šè‹¥å¡«å¯«å‰‡ä¿®æ”¹å¯†ç¢¼
      confirmPassword: ''
    }
  });

  useEffect(() => {
    // è¼‰å…¥ç•¶å‰ä½¿ç”¨è€…è³‡æ–™
    const fetchProfile = async () => {
      try {
        // âœ¨ ä¿®æ­£é‡é»ï¼šåŒæ™‚æª¢æŸ¥ LocalStorage èˆ‡ SessionStorage
        const storedUser = localStorage.getItem('somalink_user') || sessionStorage.getItem('somalink_user');
        
        if (!storedUser) {
          router.push('/login');
          return;
        }
        
        const user = JSON.parse(storedUser);
        
        // å°‡è³‡æ–™å¡«å…¥è¡¨å–®
        reset({
          name: user.dealerProfile?.contactPerson || user.name,
          email: user.email,
          companyName: user.dealerProfile?.companyName,
          taxId: user.dealerProfile?.taxId,
          phone: user.dealerProfile?.phone,
          address: user.dealerProfile?.address,
        });
      } catch (err) {
        console.error(err);
        router.push('/login');
      } finally {
        setIsLoading(false);
      }
    };
    fetchProfile();
  }, [router, reset]);

  const onSubmit = async (data: any) => {
    if (data.password && data.password !== data.confirmPassword) {
      alert('å…©æ¬¡å¯†ç¢¼è¼¸å…¥ä¸ä¸€è‡´');
      return;
    }

    setIsSubmitting(true);
    try {
      // å‘¼å«å¾Œç«¯æ›´æ–°
      const payload = {
        name: data.name, // è¯çµ¡äºº
        password: data.password || undefined, // è‹¥ç‚ºç©ºå‰‡ä¸å‚³
        dealerProfile: {
          companyName: data.companyName,
          taxId: data.taxId,
          contactPerson: data.name,
          phone: data.phone,
          address: data.address
        }
      };

      const updatedUser = await api.patch('/users/profile', payload);
      
      // âœ¨ æ›´æ–°å„²å­˜ç©ºé–“ (éœ€åˆ¤æ–·åŸæœ¬å­˜åœ¨å“ªè£¡ï¼Œä¿æŒç™»å…¥ç‹€æ…‹ä¸€è‡´)
      if (localStorage.getItem('somalink_user')) {
        localStorage.setItem('somalink_user', JSON.stringify(updatedUser));
      } else {
        sessionStorage.setItem('somalink_user', JSON.stringify(updatedUser));
      }
      
      alert('è³‡æ–™æ›´æ–°æˆåŠŸï¼');
      router.refresh();
    } catch (error) {
      console.error(error);
      alert('æ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦');
    } finally {
      setIsSubmitting(false);
    }
  };

  if (isLoading) return <div className="min-h-screen flex justify-center items-center"><Loader2 className="animate-spin text-blue-600" /></div>;

  return (
    <div className="min-h-screen bg-gray-50 py-12 px-4 sm:px-6 lg:px-8 font-sans">
      <div className="max-w-3xl mx-auto">
        <div className="flex items-center gap-4 mb-8">
          <Link href="/" className="p-2 bg-white rounded-full shadow-sm hover:bg-gray-100 transition-colors">
            <ArrowLeft className="w-5 h-5 text-gray-600" />
          </Link>
          <h1 className="text-2xl font-bold text-gray-900">æœƒå“¡è³‡æ–™è¨­å®š</h1>
        </div>

        <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
          
          {/* åŸºæœ¬è³‡æ–™å¡ç‰‡ */}
          <div className="bg-white p-8 rounded-2xl shadow-sm border border-gray-200">
            <h2 className="text-lg font-bold text-gray-900 mb-6 flex items-center gap-2">
              <Building2 className="w-5 h-5 text-blue-600" /> å…¬å¸èˆ‡è¯çµ¡è³‡è¨Š
            </h2>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="md:col-span-2">
                <label className="block text-sm font-bold text-gray-700 mb-1">å…¬å¸åç¨±</label>
                <input {...register('companyName')} className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" />
              </div>
              
              <div>
                <label className="block text-sm font-bold text-gray-700 mb-1">çµ±ä¸€ç·¨è™Ÿ</label>
                <input {...register('taxId')} className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" />
              </div>

              <div>
                <label className="block text-sm font-bold text-gray-700 mb-1">è¯çµ¡äººå§“å</label>
                <input {...register('name')} className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" />
              </div>

              <div>
                <label className="block text-sm font-bold text-gray-700 mb-1">è¯çµ¡é›»è©±</label>
                <input {...register('phone')} className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" />
              </div>

              <div className="md:col-span-2">
                <label className="block text-sm font-bold text-gray-700 mb-1">é€šè¨Šåœ°å€</label>
                <input {...register('address')} className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" />
              </div>
            </div>
          </div>

          {/* å¸³è™Ÿå®‰å…¨å¡ç‰‡ */}
          <div className="bg-white p-8 rounded-2xl shadow-sm border border-gray-200">
            <h2 className="text-lg font-bold text-gray-900 mb-6 flex items-center gap-2">
              <User className="w-5 h-5 text-green-600" /> å¸³è™Ÿå®‰å…¨
            </h2>
            
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-bold text-gray-700 mb-1">ç™»å…¥ Email (ä¸å¯ä¿®æ”¹)</label>
                <input {...register('email')} disabled className="w-full p-3 border border-gray-200 bg-gray-100 rounded-xl text-gray-500 cursor-not-allowed" />
              </div>

              <div className="pt-4 border-t border-gray-100">
                <p className="text-sm text-gray-500 mb-4">è‹¥éœ€ä¿®æ”¹å¯†ç¢¼è«‹å¡«å¯«ä¸‹æ–¹æ¬„ä½ï¼Œå¦å‰‡è«‹ç•™ç©ºã€‚</p>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label className="block text-sm font-bold text-gray-700 mb-1">æ–°å¯†ç¢¼</label>
                    <input type="password" {...register('password')} className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ä¸ä¿®æ”¹è«‹ç•™ç©º" />
                  </div>
                  <div>
                    <label className="block text-sm font-bold text-gray-700 mb-1">ç¢ºèªæ–°å¯†ç¢¼</label>
                    <input type="password" {...register('confirmPassword')} className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼" />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div className="flex justify-end gap-4">
            <Link href="/" className="px-6 py-3 border border-gray-300 text-gray-700 font-bold rounded-xl hover:bg-gray-50 transition-colors">
              å–æ¶ˆ
            </Link>
            <button 
              type="submit" 
              disabled={isSubmitting}
              className="px-8 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 shadow-md flex items-center gap-2 disabled:opacity-70 transition-all"
            >
              {isSubmitting ? <Loader2 className="animate-spin w-5 h-5" /> : <><Save className="w-5 h-5" /> å„²å­˜è®Šæ›´</>}
            </button>
          </div>

        </form>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/app/quotation/preview/page.tsx">
'use client';

import { useEffect, useState } from 'react';
import { Loader2, Printer, MapPin, Phone, User, MessageSquare, FileText } from 'lucide-react';
import { useRouter } from 'next/navigation';

export default function QuotationPreviewPage() {
  const router = useRouter();
  const [cartData, setCartData] = useState<any>(null);
  const [showPrice, setShowPrice] = useState(true);

  useEffect(() => {
    // å¾ SessionStorage è®€å–æš«å­˜çš„å ±åƒ¹è³‡æ–™
    const data = sessionStorage.getItem('soma_quotation_draft');
    if (data) {
      setCartData(JSON.parse(data));
    } else {
      alert('ç„¡å ±åƒ¹è³‡æ–™ï¼Œè«‹å¾è³¼ç‰©è»Šé‡æ–°æ“ä½œ');
      window.close(); // æˆ– router.push('/cart');
    }
  }, []);

  if (!cartData) return <div className="flex justify-center p-12"><Loader2 className="animate-spin w-8 h-8 text-blue-600" /></div>;

  return (
    <div className="min-h-screen bg-gray-100 p-8 print:p-0 print:bg-white">
      
      {/* æ§åˆ¶åˆ— */}
      <div className="max-w-[210mm] mx-auto mb-6 flex justify-between items-center print:hidden bg-white p-4 rounded-lg shadow-sm border border-gray-200">
        <div className="flex items-center gap-3">
          <span className="font-bold text-lg text-blue-800 flex items-center gap-2"><FileText className="w-5 h-5"/> å ±åƒ¹å–®é è¦½</span>
        </div>
        <button 
          onClick={() => window.print()}
          className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-sm transition-colors"
        >
          <Printer className="w-4 h-4" /> åˆ—å° / å­˜ç‚º PDF
        </button>
      </div>

      {/* A4 ç´™å¼µ */}
      <div className="max-w-[210mm] mx-auto bg-white shadow-xl print:shadow-none p-8 print:p-6 text-black font-sans relative box-border print:h-auto print:min-h-0">
        
        {/* Header */}
        <div className="flex justify-between items-start border-b-4 border-black pb-4 mb-4">
          <div className="flex items-center gap-4">
            <div className="w-14 h-14 bg-black text-white flex items-center justify-center text-2xl font-bold rounded-lg print:border print:border-black">S</div>
            <div>
              <h1 className="text-2xl font-extrabold tracking-wider text-black">æ­£å¼å ±åƒ¹å–®</h1>
              <p className="text-sm font-bold mt-1 text-black">æ¾æˆæœ‰é™å…¬å¸</p>
              <div className="flex gap-4 text-xs text-black font-medium mt-0.5">
                <span>çµ±ç·¨ï¼š12345678</span>
                <span>é›»è©±ï¼š(02) 2345-6789</span>
              </div>
            </div>
          </div>
          <div className="text-right">
            <div className="inline-block border-2 border-black px-3 py-1 rounded mb-1">
              <p className="text-[10px] font-bold uppercase tracking-wide text-black">QUOTATION</p>
              <p className="text-lg font-mono font-bold text-black leading-none">{new Date().toISOString().slice(0,10).replace(/-/g,'')}-TEMP</p>
            </div>
            <p className="text-xs mt-1 text-black font-medium">å ±åƒ¹æ—¥æœŸï¼š{new Date().toLocaleDateString()}</p>
          </div>
        </div>

        {/* å®¢æˆ¶è³‡è¨Š */}
        <div className="border-2 border-black rounded p-3 mb-4">
          <h3 className="text-xs font-bold bg-gray-200 px-2 py-0.5 mb-2 inline-block rounded text-black print:border print:border-black">å®¢æˆ¶è³‡è¨Š (Customer)</h3>
          <div className="grid grid-cols-2 gap-4 text-sm text-black">
             <div>
                <p><span className="font-bold w-16 inline-block">æ¡ˆå ´åç¨±ï¼š</span>{cartData.projectName}</p>
                <p><span className="font-bold w-16 inline-block">é€è²¨åœ°å€ï¼š</span>{cartData.shippingAddress}</p>
             </div>
             <div>
                <p><span className="font-bold w-16 inline-block">è¯çµ¡äººï¼š</span>{cartData.siteContactPerson}</p>
                <p><span className="font-bold w-16 inline-block">é›»è©±ï¼š</span>{cartData.siteContactPhone}</p>
             </div>
          </div>
        </div>

        {/* ç”¢å“æ˜ç´° */}
        <div className="mb-4">
          <table className="w-full border-collapse">
            <thead>
              <tr className="bg-gray-200 border-y-2 border-black text-xs text-black">
                <th className="py-1 px-2 text-left w-8 font-bold">#</th>
                <th className="py-1 px-2 text-left font-bold">ç”¢å“åç¨± / è©³ç´°è¦æ ¼</th>
                <th className="py-1 px-2 text-center w-16 font-bold">æ•¸é‡</th>
                <th className="py-1 px-2 text-right w-24 font-bold">å–®åƒ¹</th>
                <th className="py-1 px-2 text-right w-24 font-bold">é‡‘é¡</th>
              </tr>
            </thead>
            <tbody className="text-sm text-black">
              {cartData.items?.map((item: any, index: number) => (
                <tr key={index} className="border-b border-black break-inside-avoid">
                  <td className="py-2 px-2 align-top font-bold text-center">{index + 1}</td>
                  <td className="py-2 px-2 align-top">
                    <p className="font-bold text-sm">{item.productName}</p>
                    <div className="text-black text-[10px] mt-1 grid grid-cols-2 gap-x-2 gap-y-0.5 font-mono font-medium">
                      <p>è¦æ ¼: {item.colorName} / {item.materialName}</p>
                      <p>æ¨¡å¼: {item.serviceType === 'assembled' ? 'é€£å·¥å¸¶æ–™' : 'ç´”ææ–™'}</p>
                      {item.handleName && <p className="col-span-2">æŠŠæ‰‹: {item.handleName}</p>}
                    </div>
                    <div className="mt-1 bg-white px-1.5 py-0.5 rounded inline-block text-[10px] font-mono border border-black font-bold">
                      W: {item.widthMatrix?.mid} x H: {item.heightData?.singleValue || item.heightData?.mid}
                      {item.isCeilingMounted && <span className="ml-1 text-black font-extrabold">(å°é ‚)</span>}
                    </div>
                  </td>
                  <td className="py-2 px-2 text-center align-top font-bold">{item.quantity}</td>
                  <td className="py-2 px-2 text-right align-top font-mono font-medium">${Number(item.unitPrice).toLocaleString()}</td>
                  <td className="py-2 px-2 text-right align-top font-bold font-mono">${Number(item.subtotal).toLocaleString()}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        {/* ç¸½è¨ˆ */}
        <div className="break-inside-avoid">
          <div className="flex justify-end mb-6 border-t-2 border-black pt-2">
            <div className="text-right">
              <p className="text-xs font-bold text-black">å ±åƒ¹ç¸½é‡‘é¡ (æœªç¨…)</p>
              <p className="text-2xl font-extrabold text-black">NT$ {Number(cartData.totalAmount).toLocaleString()}</p>
              <p className="text-[10px] text-gray-500 mt-1">* æ­¤å ±åƒ¹å–®æœ‰æ•ˆæœŸç‚º 7 å¤©ï¼Œæœ€çµ‚åƒ¹æ ¼ä»¥å¯¦éš›ä¸‹å–®ç‚ºæº–ã€‚</p>
            </div>
          </div>
        </div>

      </div>
    </div>
  );
}
</file>

<file path="frontend/src/components/blocks/FeaturesBlock.tsx">
import { Ruler, Hammer, ShieldCheck } from "lucide-react";

export default function FeaturesBlock({ data }: { data: any }) {
  const items = data.items || [];
  const icons = [<Ruler key={0} className="w-7 h-7 text-blue-600" />, <Hammer key={1} className="w-7 h-7 text-blue-600" />, <ShieldCheck key={2} className="w-7 h-7 text-blue-600" />];

  return (
    <section className="py-24 bg-white">
      <div className="max-w-7xl mx-auto px-6">
        <div className="text-center mb-16">
          <h2 className="text-3xl font-bold text-gray-900 mb-4">{data.title}</h2>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-10">
          {items.map((item: any, idx: number) => (
            <div key={idx} className="bg-gray-50 p-8 rounded-3xl border border-gray-100 hover:shadow-lg transition-all">
              <div className="w-14 h-14 bg-blue-100 rounded-2xl flex items-center justify-center mb-6">
                {icons[idx % 3]}
              </div>
              <h3 className="text-xl font-bold text-gray-900 mb-3">{item.title}</h3>
              <p className="text-gray-500 leading-relaxed">{item.desc}</p>
            </div>
          ))}
        </div>
      </div>
    </section>
  );
}
</file>

<file path="frontend/src/components/blocks/ProductListBlock.tsx">
'use client';
import { useState, useEffect } from 'react';
import Link from 'next/link';
import { api } from '@/lib/api';
import { Loader2 } from 'lucide-react';

export default function ProductListBlock({ data }: { data: any }) {
  const [seriesList, setSeriesList] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    api.get('/series').then((res) => {
      const list = Array.isArray(res) ? res : [];
      setSeriesList(list.filter((s: any) => s.isActive).slice(0, data.count || 4));
    }).finally(() => setLoading(false));
  }, [data.count]);

  return (
    <section className="py-20 bg-gray-50 border-t border-gray-100">
      <div className="max-w-7xl mx-auto px-6">
        <div className="text-center mb-12"><h2 className="text-2xl font-bold text-gray-900">{data.title}</h2></div>
        {loading ? <div className="flex justify-center"><Loader2 className="animate-spin text-blue-600" /></div> : (
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            {seriesList.map((series) => (
              <Link 
                key={series.id} 
                href={`/series/${encodeURIComponent(series.name)}`} 
                // âœ¨ ä¿®æ”¹é‡é»ï¼šåŠ å…¥ border-2 border-transparent hover:border-blue-900 (æµ·è»è—é‚Šæ¡†)
                className="group block bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-2xl transition-all duration-300 border-2 border-transparent hover:border-blue-900 hover:-translate-y-1"
              >
                <div className="relative h-48 overflow-hidden bg-gray-100">
                  {/* eslint-disable-next-line @next/next/no-img-element */}
                  <img src={series.imageUrl} alt={series.name} className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" />
                  <div className="absolute inset-0 bg-linear-to-t from-black/70 to-transparent opacity-60" />
                  
                  {/* æ–‡å­—ä¹Ÿç¨å¾®æ”¾å¤§ä¸€é»å¢åŠ å°æ¯” */}
                  <div className="absolute bottom-3 left-3 text-white">
                    <h3 className="text-lg font-bold group-hover:text-blue-100 transition-colors">{series.displayName || series.name}</h3>
                  </div>
                </div>
              </Link>
            ))}
          </div>
        )}
      </div>
    </section>
  );
}
</file>

<file path="frontend/src/components/Modal.tsx">
'use client';

import { X, CheckCircle, AlertCircle, HelpCircle, Info } from 'lucide-react';
import clsx from 'clsx';
import { ReactNode } from 'react';

interface ModalProps {
  isOpen: boolean;
  onClose: () => void;
  title: string;
  message?: ReactNode; // æ”¯æ´æ–‡å­—æˆ– JSX
  type?: 'success' | 'error' | 'warning' | 'info' | 'confirm';
  onConfirm?: () => void;
  confirmText?: string;
  cancelText?: string;
}

export default function Modal({ 
  isOpen, onClose, title, message, type = 'info', onConfirm, confirmText = 'ç¢ºå®š', cancelText = 'å–æ¶ˆ' 
}: ModalProps) {
  if (!isOpen) return null;

  const iconMap = {
    success: <CheckCircle className="w-12 h-12 text-green-500" />,
    error: <AlertCircle className="w-12 h-12 text-red-500" />,
    warning: <AlertCircle className="w-12 h-12 text-orange-500" />,
    info: <Info className="w-12 h-12 text-blue-500" />,
    confirm: <HelpCircle className="w-12 h-12 text-blue-500" />,
  };

  return (
    // âœ¨ Fix: å°‡ z-[999] æ”¹ç‚º z-999 (Tailwind v4 æ¨™æº–å¯«æ³•)
    <div className="fixed inset-0 z-999 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
      <div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl flex flex-col items-center text-center space-y-4 animate-in zoom-in-95 duration-200 relative">
        
        {/* é—œé–‰æŒ‰éˆ• */}
        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
          <X className="w-5 h-5" />
        </button>
        
        {/* åœ–ç¤º */}
        <div className="mb-2 scale-110">
          {iconMap[type]}
        </div>
        
        {/* æ¨™é¡Œèˆ‡å…§å®¹ */}
        <div>
          <h3 className="text-xl font-bold text-gray-900 mb-2">{title}</h3>
          {message && <div className="text-sm text-gray-600 leading-relaxed">{message}</div>}
        </div>
        
        {/* æŒ‰éˆ•å€ */}
        <div className="flex w-full gap-3 mt-4">
          {type === 'confirm' ? (
            <>
              <button 
                onClick={onClose}
                className="flex-1 py-2.5 border border-gray-300 text-gray-700 rounded-xl font-bold hover:bg-gray-50 transition-colors"
              >
                {cancelText}
              </button>
              <button 
                onClick={() => { onConfirm?.(); onClose(); }}
                className="flex-1 py-2.5 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-colors shadow-md"
              >
                {confirmText}
              </button>
            </>
          ) : (
            <button 
              onClick={onClose}
              className={clsx(
                "w-full py-2.5 rounded-xl font-bold text-white transition-colors shadow-md",
                type === 'error' ? "bg-red-600 hover:bg-red-700" : "bg-blue-600 hover:bg-blue-700"
              )}
            >
              {confirmText}
            </button>
          )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="admin/eslint.config.mjs">
import { dirname } from "path";
import { fileURLToPath } from "url";
import { FlatCompat } from "@eslint/eslintrc";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const compat = new FlatCompat({
  baseDirectory: __dirname,
});

const eslintConfig = [
  // ä½¿ç”¨ compat.extends ä¾†è¼‰å…¥ Next.js çš„è¦å‰‡ï¼Œè§£æ±ºè·¯å¾‘è§£æå•é¡Œ
  ...compat.extends("next/core-web-vitals", "next/typescript"),
];

export default eslintConfig;
</file>

<file path="admin/src/app/products/[id]/page.tsx">
'use client';

import { useState, useEffect, use } from 'react';
import { useRouter } from 'next/navigation';
import { useForm, useFieldArray } from 'react-hook-form';
import { ArrowLeft, Save, Plus, Trash2, DollarSign, Ruler, Palette, Layers, MoveHorizontal, Image as ImageIcon, Loader2, UploadCloud, X, Percent } from 'lucide-react';
import Link from 'next/link';
import { api } from '@/lib/api';

const CLOUDINARY_CLOUD_NAME = 'dnibj8za6'; 
const CLOUDINARY_PRESET = 'yasou70731';  

interface ProductFormValues {
  name: string;
  sku: string;
  series: string;
  images: string[]; // å¤šåœ–é™£åˆ—
  basePrice: number;
  requiresMeasurement: boolean;
  standardWidth: number;
  standardHeight: number;
  discountA?: number | null; // âœ¨ æ–°å¢
  discountB?: number | null; // âœ¨ æ–°å¢
  colors: { name: string; colorCode: string; priceSurcharge: number }[];
  materials: { name: string; priceSurcharge: number }[];
  openingOptions: { value: string }[];
}

export default function EditProductPage({ params }: { params: Promise<{ id: string }> }) {
  const { id } = use(params);
  const router = useRouter();
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isUploading, setIsUploading] = useState(false);
  const [isLoading, setIsLoading] = useState(true);

  const { register, control, handleSubmit, watch, setValue, getValues, reset } = useForm<ProductFormValues>({
    defaultValues: {
      name: '', sku: '', series: '', 
      images: [],
      basePrice: 0, requiresMeasurement: true,
      standardWidth: 90, standardHeight: 210,
      discountA: null,
      discountB: null,
      colors: [],
      materials: [],
      openingOptions: []
    }
  });

  const images = watch('images') || [];
  
  const { fields: colorFields, append: appendColor, remove: removeColor } = useFieldArray({ control, name: 'colors' });
  const { fields: materialFields, append: appendMaterial, remove: removeMaterial } = useFieldArray({ control, name: 'materials' });
  const { fields: openingFields, append: appendOpening, remove: removeOpening } = useFieldArray({ control, name: 'openingOptions' });

  // 1. è¼‰å…¥èˆŠè³‡æ–™
  useEffect(() => {
    const fetchProduct = async () => {
      try {
        const data = await api.get(`/products/${id}`);
        if (!data) throw new Error("No data");

        // è³‡æ–™è½‰æ›ï¼šè™•ç†åœ–ç‰‡æ¬„ä½ç›¸å®¹æ€§
        let imgList: string[] = [];
        if (Array.isArray(data.images)) {
          imgList = data.images;
        } else if (data.imageUrl) {
          imgList = [data.imageUrl]; // èˆŠè³‡æ–™åªæœ‰ä¸€å¼µï¼Œè½‰ç‚ºé™£åˆ—
        }

        const formattedData = {
          ...data,
          images: imgList,
          discountA: data.discountA || null,
          discountB: data.discountB || null,
          // ç¢ºä¿é™£åˆ—å­˜åœ¨ï¼Œé¿å… null éŒ¯èª¤
          colors: Array.isArray(data.colors) ? data.colors : [],
          materials: Array.isArray(data.materials) ? data.materials : [],
          openingOptions: Array.isArray(data.openingOptions) 
            ? data.openingOptions.map((v: string) => ({ value: v })) 
            : []
        };
        
        reset(formattedData);
      } catch (err) {
        console.error('è¼‰å…¥å¤±æ•—:', err);
        alert('æ‰¾ä¸åˆ°ç”¢å“è³‡æ–™');
        router.push('/products');
      } finally {
        setIsLoading(false);
      }
    };
    fetchProduct();
  }, [id, reset, router]);

  // å¤šåœ–ä¸Šå‚³è™•ç†
  const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (!files || files.length === 0) return;

    setIsUploading(true);
    const currentImages = getValues('images') || [];
    const newImages = [...currentImages];

    try {
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_PRESET);

        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, { method: 'POST', body: formData });
        const data = await res.json();
        if (data.secure_url) newImages.push(data.secure_url);
      }
      setValue('images', newImages);
    } catch (err) {
      alert('ä¸Šå‚³å¤±æ•—');
    } finally {
      setIsUploading(false);
    }
  };

  // ç§»é™¤å–®å¼µåœ–ç‰‡
  const removeImage = (idx: number) => {
    const current = getValues('images');
    setValue('images', current.filter((_, i) => i !== idx));
  };

  // é€å‡ºæ›´æ–°
  const onSubmit = async (data: ProductFormValues) => {
    setIsSubmitting(true);
    try {
      // éæ¿¾æ‰ id ç­‰ç³»çµ±æ¬„ä½ï¼Œé¿å… 500 éŒ¯èª¤
      const { id: _id, createdAt, updatedAt, ...restData } = data as any;
      
      const payload = {
        ...restData,
        discountA: data.discountA ? Number(data.discountA) : null,
        discountB: data.discountB ? Number(data.discountB) : null,
        openingOptions: data.openingOptions.map((opt) => opt.value).filter((v) => v)
      };
      
      await api.patch(`/products/${id}`, payload);
      alert('ä¿®æ”¹æˆåŠŸï¼');
      router.push('/products');
    } catch (error) {
      console.error(error);
      alert('ä¿®æ”¹å¤±æ•—');
    } finally {
      setIsSubmitting(false);
    }
  };

  if (isLoading) return <div className="min-h-screen flex justify-center items-center"><Loader2 className="animate-spin text-blue-600" /></div>;

  return (
    <div className="min-h-screen bg-gray-50 p-8 font-sans pb-20">
      {/* Header */}
      <div className="max-w-4xl mx-auto flex items-center justify-between mb-8">
        <div className="flex items-center gap-4">
          <Link href="/products" className="p-2 hover:bg-white rounded-full transition-colors text-gray-500">
            <ArrowLeft className="w-6 h-6" />
          </Link>
          <div>
            <h1 className="text-2xl font-bold text-gray-900">ç·¨è¼¯ç”¢å“</h1>
            <p className="text-sm text-gray-500">ä¿®æ”¹ç”¢å“ ID: {id}</p>
          </div>
        </div>
        <button onClick={handleSubmit(onSubmit)} disabled={isSubmitting} className="flex items-center gap-2 px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md font-bold disabled:opacity-50 transition-all">
          <Save className="w-4 h-4" />
          {isSubmitting ? 'å„²å­˜ä¸­...' : 'å„²å­˜ä¿®æ”¹'}
        </button>
      </div>

      <div className="max-w-4xl mx-auto space-y-6">
        
        {/* 1. åŸºæœ¬è³‡è¨Šèˆ‡åœ–ç‰‡ */}
        <section className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <h2 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2"><div className="w-1 h-6 bg-blue-500 rounded-full"></div> åŸºæœ¬è³‡è¨Š</h2>
          <div className="grid grid-cols-2 gap-6">
            <div className="col-span-2"><label className="block text-sm font-medium text-gray-700 mb-1">ç”¢å“åç¨±</label><input {...register('name')} className="w-full p-2 border border-gray-300 rounded-lg outline-none" /></div>
            
            {/* åœ–ç‰‡åˆ—è¡¨ */}
            <div className="col-span-2">
              <label className="block text-sm font-medium text-gray-700 mb-2">ç”¢å“åœ–ç‰‡é›†</label>
              <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-4">
                {images.map((url, idx) => (
                  <div key={idx} className="relative group aspect-square bg-gray-100 rounded-lg overflow-hidden border border-gray-200">
                    {/* eslint-disable-next-line @next/next/no-img-element */}
                    <img src={url} alt={`Product ${idx}`} className="w-full h-full object-cover" />
                    <button type="button" onClick={() => removeImage(idx)} className="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity shadow-sm"><X className="w-3 h-3" /></button>
                    {idx === 0 && <span className="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-[10px] text-center py-1">å°é¢åœ–</span>}
                  </div>
                ))}
                <label className="flex flex-col items-center justify-center aspect-square border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                  {isUploading ? <Loader2 className="w-6 h-6 text-gray-400 animate-spin" /> : <Plus className="w-6 h-6 text-gray-400" />}
                  <span className="text-xs text-gray-500 mt-1">{isUploading ? 'ä¸Šå‚³ä¸­' : 'æ–°å¢åœ–ç‰‡'}</span>
                  <input type="file" className="hidden" accept="image/*" multiple onChange={handleImageUpload} disabled={isUploading} />
                </label>
              </div>
            </div>

            <div><label className="block text-sm font-medium text-gray-700 mb-1">å‹è™Ÿ (SKU)</label><input {...register('sku')} className="w-full p-2 border border-gray-300 rounded-lg outline-none" /></div>
            <div><label className="block text-sm font-medium text-gray-700 mb-1">ç³»åˆ—</label><input {...register('series')} className="w-full p-2 border border-gray-300 rounded-lg outline-none" /></div>
          </div>
        </section>

        {/* 2. åƒ¹æ ¼èˆ‡å°ºå¯¸ */}
        <section className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <h2 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2"><div className="w-1 h-6 bg-green-500 rounded-full"></div> åƒ¹æ ¼èˆ‡å°ºå¯¸</h2>
          <div className="grid grid-cols-3 gap-6">
            <div><label className="block text-sm font-medium text-gray-700 mb-1">åŸºç¤åƒ¹æ ¼</label><input type="number" {...register('basePrice', { valueAsNumber: true })} className="w-full p-2 border border-gray-300 rounded-lg outline-none" /></div>
            <div><label className="block text-sm font-medium text-gray-700 mb-1">æ¨™æº–å¯¬åº¦</label><input type="number" {...register('standardWidth', { valueAsNumber: true })} className="w-full p-2 border border-gray-300 rounded-lg outline-none" /></div>
            <div><label className="block text-sm font-medium text-gray-700 mb-1">æ¨™æº–é«˜åº¦</label><input type="number" {...register('standardHeight', { valueAsNumber: true })} className="w-full p-2 border border-gray-300 rounded-lg outline-none" /></div>
            <div className="col-span-3 flex items-center gap-2 p-3 bg-gray-50 rounded-lg"><input type="checkbox" {...register('requiresMeasurement')} className="w-4 h-4 text-blue-600" /><label className="text-sm text-gray-700">éœ€ä¸ˆé‡ (å‹¾é¸å¾Œå‰å°æœƒé¡¯ç¤ºã€Œä¸ˆé‡ä¸¦åŠ å…¥è³¼ç‰©è»Šã€æŒ‰éˆ•)</label></div>
          </div>
        </section>

        {/* âœ¨âœ¨âœ¨ 3. B2B ç‰¹æ®ŠæŠ˜æ•¸ (æ–°å¢å€å¡Š) âœ¨âœ¨âœ¨ */}
        <section className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <h2 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2"><Percent className="w-5 h-5 text-yellow-500" /> B2B æœƒå“¡å€‹åˆ¥æŠ˜æ•¸ (é¸å¡«)</h2>
          <div className="grid grid-cols-2 gap-6 bg-yellow-50 p-4 rounded-lg border border-yellow-100">
            <div>
              <label className="block text-sm font-bold text-yellow-800 mb-1">A ç´šæœƒå“¡æŠ˜æ•¸</label>
              <input 
                type="number" 
                step="0.01" 
                placeholder="é è¨­ (ç©ºç™½)" 
                {...register('discountA')} 
                className="w-full p-2 border border-yellow-200 rounded-lg outline-none focus:ring-2 focus:ring-yellow-400 bg-white" 
              />
              <p className="text-xs text-yellow-600 mt-1">ä¾‹å¦‚ï¼š0.8 ä»£è¡¨ 8 æŠ˜ã€‚è‹¥ç•™ç©ºå‰‡ä½¿ç”¨ç³»çµ±çµ±ä¸€è¨­å®šã€‚</p>
            </div>
            <div>
              <label className="block text-sm font-bold text-yellow-800 mb-1">B ç´šæœƒå“¡æŠ˜æ•¸</label>
              <input 
                type="number" 
                step="0.01" 
                placeholder="é è¨­ (ç©ºç™½)" 
                {...register('discountB')} 
                className="w-full p-2 border border-yellow-200 rounded-lg outline-none focus:ring-2 focus:ring-yellow-400 bg-white" 
              />
              <p className="text-xs text-yellow-600 mt-1">ä¾‹å¦‚ï¼š0.9 ä»£è¡¨ 9 æŠ˜ã€‚</p>
            </div>
          </div>
        </section>

        {/* 4. é–‹é–€æ–¹å‘ */}
        <section className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <div className="flex justify-between mb-4"><h2 className="text-lg font-bold text-gray-900 flex items-center gap-2"><MoveHorizontal className="w-5 h-5" /> é–‹é–€æ–¹å‘</h2><button type="button" onClick={() => appendOpening({ value: '' })} className="text-blue-600 text-sm flex items-center"><Plus className="w-4 h-4" /> æ–°å¢</button></div>
          <div className="grid grid-cols-2 gap-3">{openingFields.map((f, i) => (<div key={f.id} className="flex gap-2 items-center bg-gray-50 p-2 rounded-lg border"><input {...register(`openingOptions.${i}.value`)} className="flex-1 bg-transparent outline-none text-sm" /><button type="button" onClick={() => removeOpening(i)} className="text-gray-400 hover:text-red-500"><Trash2 className="w-4 h-4" /></button></div>))}</div>
        </section>
        
        {/* 5. é¡è‰² */}
        <section className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <div className="flex justify-between mb-4"><h2 className="text-lg font-bold text-gray-900 flex items-center gap-2"><Palette className="w-5 h-5" /> é¡è‰²</h2><button type="button" onClick={() => appendColor({ name: '', colorCode: '#000000', priceSurcharge: 0 })} className="text-blue-600 text-sm flex items-center"><Plus className="w-4 h-4" /> æ–°å¢</button></div>
          <div className="space-y-3">{colorFields.map((f, i) => (<div key={f.id} className="flex gap-3 items-end bg-gray-50 p-3 rounded-lg"><div className="flex-1"><input {...register(`colors.${i}.name`)} className="w-full p-2 border rounded text-sm" placeholder="åç¨±" /></div><div className="w-24"><input type="color" {...register(`colors.${i}.colorCode`)} className="h-9 w-9 border rounded cursor-pointer" /></div><div className="w-32"><input type="number" {...register(`colors.${i}.priceSurcharge`, { valueAsNumber: true })} className="w-full p-2 border rounded text-sm" placeholder="åŠ åƒ¹" /></div><button type="button" onClick={() => removeColor(i)} className="text-gray-400 hover:text-red-500"><Trash2 className="w-4 h-4" /></button></div>))}</div>
        </section>
        
        {/* 6. æè³ª */}
        <section className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <div className="flex justify-between mb-4"><h2 className="text-lg font-bold text-gray-900 flex items-center gap-2"><Layers className="w-5 h-5" /> æè³ª</h2><button type="button" onClick={() => appendMaterial({ name: '', priceSurcharge: 0 })} className="text-blue-600 text-sm flex items-center"><Plus className="w-4 h-4" /> æ–°å¢</button></div>
          <div className="space-y-3">{materialFields.map((f, i) => (<div key={f.id} className="flex gap-3 items-end bg-gray-50 p-3 rounded-lg"><div className="flex-1"><input {...register(`materials.${i}.name`)} className="w-full p-2 border rounded text-sm" placeholder="åç¨±" /></div><div className="w-32"><input type="number" {...register(`materials.${i}.priceSurcharge`, { valueAsNumber: true })} className="w-full p-2 border rounded text-sm" placeholder="åŠ åƒ¹" /></div><button type="button" onClick={() => removeMaterial(i)} className="text-gray-400 hover:text-red-500"><Trash2 className="w-4 h-4" /></button></div>))}</div>
        </section>

      </div>
    </div>
  );
}
</file>

<file path="admin/src/app/products/new/page.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { useForm, useFieldArray } from 'react-hook-form';
import { ArrowLeft, Save, Plus, Trash2, DollarSign, Ruler, Palette, Layers, MoveHorizontal, Image as ImageIcon, Loader2, UploadCloud, X, Percent } from 'lucide-react';
import Link from 'next/link';
import { api } from '@/lib/api';

const CLOUDINARY_CLOUD_NAME = 'dnibj8za6'; 
const CLOUDINARY_PRESET = 'yasou70731';  

export default function NewProductPage() {
  const router = useRouter();
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isUploading, setIsUploading] = useState(false);

  const { register, control, handleSubmit, watch, setValue, getValues } = useForm({
    defaultValues: {
      name: '', sku: '', series: '', 
      images: [] as string[],
      basePrice: 0, requiresMeasurement: true,
      standardWidth: 90, standardHeight: 210,
      // âœ¨ æ–°å¢å°ºå¯¸åŠ åƒ¹æ¬„ä½é è¨­å€¼
      pricePerUnitWidth: 0,
      pricePerUnitHeight: 0,
      // âœ¨ æ–°å¢æŠ˜æ•¸æ¬„ä½é è¨­å€¼
      discountA: null,
      discountB: null,
      colors: [{ name: 'æ¨™æº–é»‘', colorCode: '#000000', priceSurcharge: 0 }],
      materials: [{ name: '5mm æ¸…ç»', priceSurcharge: 0 }],
      openingOptions: [{ value: 'å·¦å¾€å³é–‹' }, { value: 'å³å¾€å·¦é–‹' }]
    }
  });

  const images = watch('images');
  const { fields: colorFields, append: appendColor, remove: removeColor } = useFieldArray({ control, name: 'colors' });
  const { fields: materialFields, append: appendMaterial, remove: removeMaterial } = useFieldArray({ control, name: 'materials' });
  const { fields: openingFields, append: appendOpening, remove: removeOpening } = useFieldArray({ control, name: 'openingOptions' });

  const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (!files || files.length === 0) return;

    setIsUploading(true);
    const currentImages = getValues('images') || [];
    const newImages = [...currentImages];

    try {
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_PRESET);

        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
          method: 'POST',
          body: formData,
        });
        
        const data = await res.json();
        if (data.secure_url) {
          newImages.push(data.secure_url);
        }
      }
      setValue('images', newImages);
    } catch (err) {
      console.error('ä¸Šå‚³éŒ¯èª¤', err);
      alert('éƒ¨åˆ†åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼');
    } finally {
      setIsUploading(false);
    }
  };

  const removeImage = (indexToRemove: number) => {
    const currentImages = getValues('images');
    setValue('images', currentImages.filter((_, idx) => idx !== indexToRemove));
  };

  const onSubmit = async (data: any) => {
    setIsSubmitting(true);
    try {
      const payload = {
        ...data,
        // å¦‚æœè¼¸å…¥æ¡†æ˜¯ç©ºçš„ï¼Œè½‰ç‚º null (ä»£è¡¨ä½¿ç”¨ç³»çµ±é è¨­)
        discountA: data.discountA ? Number(data.discountA) : null,
        discountB: data.discountB ? Number(data.discountB) : null,
        openingOptions: data.openingOptions.map((opt: any) => opt.value).filter((v: string) => v)
      };
      await api.post('/products', payload);
      alert('ç”¢å“å»ºç«‹æˆåŠŸï¼');
      router.push('/products');
    } catch (error) {
      console.error(error);
      alert('å»ºç«‹å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¾Œç«¯é€£ç·š');
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <div className="min-h-screen bg-gray-50 p-8 font-sans pb-20">
      <div className="max-w-4xl mx-auto flex items-center justify-between mb-8">
        <div className="flex items-center gap-4">
          <Link href="/products" className="p-2 hover:bg-white rounded-full transition-colors text-gray-500">
            <ArrowLeft className="w-6 h-6" />
          </Link>
          <div>
            <h1 className="text-2xl font-bold text-gray-900">æ–°å¢ç”¢å“</h1>
            <p className="text-sm text-gray-500">è¨­å®šç”¢å“è¦æ ¼ã€åƒ¹æ ¼èˆ‡å¤šå¼µå±•ç¤ºåœ–ç‰‡</p>
          </div>
        </div>
        <button onClick={handleSubmit(onSubmit)} disabled={isSubmitting} className="flex items-center gap-2 px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md font-bold disabled:opacity-50 transition-all">
          <Save className="w-4 h-4" />
          {isSubmitting ? 'å„²å­˜ä¸­...' : 'å„²å­˜ä¸Šæ¶'}
        </button>
      </div>

      <div className="max-w-4xl mx-auto space-y-6">
        
        {/* 1. åŸºæœ¬è³‡è¨Šèˆ‡åœ–ç‰‡ */}
        <section className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <h2 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
            <div className="w-1 h-6 bg-blue-500 rounded-full"></div> åŸºæœ¬è³‡è¨Š
          </h2>
          <div className="grid grid-cols-2 gap-6">
            <div className="col-span-2">
              <label className="block text-sm font-medium text-gray-700 mb-1">ç”¢å“åç¨±</label>
              <input {...register('name', { required: true })} className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
            </div>
            
            {/* å¤šåœ–ä¸Šå‚³å€ */}
            <div className="col-span-2">
              <label className="block text-sm font-medium text-gray-700 mb-2">ç”¢å“åœ–ç‰‡é›† (å¯å¤šé¸)</label>
              <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-4">
                {images.map((url, idx) => (
                  <div key={idx} className="relative group aspect-square bg-gray-100 rounded-lg overflow-hidden border border-gray-200">
                    {/* eslint-disable-next-line @next/next/no-img-element */}
                    <img src={url} alt={`Product ${idx}`} className="w-full h-full object-cover" />
                    <button 
                      type="button"
                      onClick={() => removeImage(idx)}
                      className="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity shadow-sm"
                    >
                      <X className="w-3 h-3" />
                    </button>
                    {idx === 0 && <span className="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-[10px] text-center py-1">å°é¢åœ–</span>}
                  </div>
                ))}
                
                <label className="flex flex-col items-center justify-center aspect-square border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                  {isUploading ? <Loader2 className="w-6 h-6 text-gray-400 animate-spin" /> : <Plus className="w-6 h-6 text-gray-400" />}
                  <span className="text-xs text-gray-500 mt-1">{isUploading ? 'ä¸Šå‚³ä¸­' : 'æ–°å¢åœ–ç‰‡'}</span>
                  <input type="file" className="hidden" accept="image/*" multiple onChange={handleImageUpload} disabled={isUploading} />
                </label>
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">ç”¢å“å‹è™Ÿ (SKU)</label>
              <input {...register('sku', { required: true })} className="w-full p-2 border border-gray-300 rounded-lg outline-none" />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">æ‰€å±¬ç³»åˆ—</label>
              <input {...register('series', { required: true })} className="w-full p-2 border border-gray-300 rounded-lg outline-none" />
            </div>
          </div>
        </section>

        {/* 2. åƒ¹æ ¼èˆ‡å°ºå¯¸ */}
        <section className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <h2 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2"><div className="w-1 h-6 bg-green-500 rounded-full"></div> åƒ¹æ ¼èˆ‡å°ºå¯¸</h2>
          <div className="grid grid-cols-3 gap-6">
            <div><label className="block text-sm font-medium text-gray-700 mb-1">åŸºç¤åƒ¹æ ¼</label><input type="number" {...register('basePrice', { valueAsNumber: true })} className="w-full p-2 border border-gray-300 rounded-lg outline-none" /></div>
            <div><label className="block text-sm font-medium text-gray-700 mb-1">æ¨™æº–å¯¬åº¦ (cm)</label><input type="number" {...register('standardWidth', { valueAsNumber: true })} className="w-full p-2 border border-gray-300 rounded-lg outline-none" /></div>
            <div><label className="block text-sm font-medium text-gray-700 mb-1">æ¨™æº–é«˜åº¦ (cm)</label><input type="number" {...register('standardHeight', { valueAsNumber: true })} className="w-full p-2 border border-gray-300 rounded-lg outline-none" /></div>
            
            {/* âœ¨ æ–°å¢ï¼šå°ºå¯¸åŠ åƒ¹è¨­å®š */}
            <div className="bg-gray-50 p-3 rounded-lg border border-gray-200">
              <label className="block text-xs font-bold text-gray-500 mb-1">å¯¬åº¦æ¯å¢ 10cm åŠ åƒ¹ ($)</label>
              <input type="number" {...register('pricePerUnitWidth', { valueAsNumber: true })} className="w-full p-1.5 border border-gray-300 rounded text-sm outline-none" placeholder="0" />
            </div>
            <div className="bg-gray-50 p-3 rounded-lg border border-gray-200">
              <label className="block text-xs font-bold text-gray-500 mb-1">é«˜åº¦æ¯å¢ 10cm åŠ åƒ¹ ($)</label>
              <input type="number" {...register('pricePerUnitHeight', { valueAsNumber: true })} className="w-full p-1.5 border border-gray-300 rounded text-sm outline-none" placeholder="0" />
            </div>
            <div className="flex items-center justify-center p-3">
              <span className="text-xs text-gray-400">è¶…éæ¨™æº–å°ºå¯¸æ‰è¨ˆç®—</span>
            </div>

            <div className="col-span-3 flex items-center gap-2 p-3 bg-gray-50 rounded-lg"><input type="checkbox" {...register('requiresMeasurement')} className="w-4 h-4 text-blue-600" /><label className="text-sm text-gray-700">éœ€ä¸ˆé‡ (å‹¾é¸å¾Œå‰å°æœƒé¡¯ç¤ºã€Œä¸ˆé‡ä¸¦åŠ å…¥è³¼ç‰©è»Šã€æŒ‰éˆ•)</label></div>
          </div>
        </section>

        {/* âœ¨âœ¨âœ¨ 3. B2B ç‰¹æ®ŠæŠ˜æ•¸ (æ–°å¢å€å¡Š) âœ¨âœ¨âœ¨ */}
        <section className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <h2 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2"><Percent className="w-5 h-5 text-yellow-500" /> B2B æœƒå“¡å€‹åˆ¥æŠ˜æ•¸ (é¸å¡«)</h2>
          <div className="grid grid-cols-2 gap-6 bg-yellow-50 p-4 rounded-lg border border-yellow-100">
            <div>
              <label className="block text-sm font-bold text-yellow-800 mb-1">A ç´šæœƒå“¡æŠ˜æ•¸</label>
              <input 
                type="number" 
                step="0.01" 
                placeholder="é è¨­ (ç©ºç™½)" 
                {...register('discountA')} 
                className="w-full p-2 border border-yellow-200 rounded-lg outline-none focus:ring-2 focus:ring-yellow-400 bg-white" 
              />
              <p className="text-xs text-yellow-600 mt-1">ä¾‹å¦‚ï¼š0.8 ä»£è¡¨ 8 æŠ˜ã€‚è‹¥ç•™ç©ºå‰‡ä½¿ç”¨ç³»çµ±çµ±ä¸€è¨­å®šã€‚</p>
            </div>
            <div>
              <label className="block text-sm font-bold text-yellow-800 mb-1">B ç´šæœƒå“¡æŠ˜æ•¸</label>
              <input 
                type="number" 
                step="0.01" 
                placeholder="é è¨­ (ç©ºç™½)" 
                {...register('discountB')} 
                className="w-full p-2 border border-yellow-200 rounded-lg outline-none focus:ring-2 focus:ring-yellow-400 bg-white" 
              />
              <p className="text-xs text-yellow-600 mt-1">ä¾‹å¦‚ï¼š0.9 ä»£è¡¨ 9 æŠ˜ã€‚</p>
            </div>
          </div>
        </section>

        {/* 4. é–‹é–€æ–¹å‘ */}
        <section className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <div className="flex justify-between mb-4"><h2 className="text-lg font-bold text-gray-900 flex items-center gap-2"><MoveHorizontal className="w-5 h-5" /> é–‹é–€æ–¹å‘</h2><button type="button" onClick={() => appendOpening({ value: '' })} className="text-blue-600 text-sm flex items-center"><Plus className="w-4 h-4" /> æ–°å¢</button></div>
          <div className="grid grid-cols-2 gap-3">{openingFields.map((f, i) => (<div key={f.id} className="flex gap-2 items-center bg-gray-50 p-2 rounded-lg border"><input {...register(`openingOptions.${i}.value`)} className="flex-1 bg-transparent outline-none text-sm" /><button type="button" onClick={() => removeOpening(i)} className="text-gray-400 hover:text-red-500"><Trash2 className="w-4 h-4" /></button></div>))}</div>
        </section>
        
        {/* 5. é¡è‰² */}
        <section className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <div className="flex justify-between mb-4"><h2 className="text-lg font-bold text-gray-900 flex items-center gap-2"><Palette className="w-5 h-5" /> é¡è‰²</h2><button type="button" onClick={() => appendColor({ name: '', colorCode: '#000000', priceSurcharge: 0 })} className="text-blue-600 text-sm flex items-center"><Plus className="w-4 h-4" /> æ–°å¢</button></div>
          <div className="space-y-3">{colorFields.map((f, i) => (<div key={f.id} className="flex gap-3 items-end bg-gray-50 p-3 rounded-lg"><div className="flex-1"><input {...register(`colors.${i}.name`)} className="w-full p-2 border rounded text-sm" placeholder="åç¨±" /></div><div className="w-24"><input type="color" {...register(`colors.${i}.colorCode`)} className="h-9 w-9 border rounded cursor-pointer" /></div><div className="w-32"><input type="number" {...register(`colors.${i}.priceSurcharge`, { valueAsNumber: true })} className="w-full p-2 border rounded text-sm" placeholder="åŠ åƒ¹" /></div><button type="button" onClick={() => removeColor(i)} className="text-gray-400 hover:text-red-500"><Trash2 className="w-4 h-4" /></button></div>))}</div>
        </section>
        
        {/* 6. æè³ª */}
        <section className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <div className="flex justify-between mb-4"><h2 className="text-lg font-bold text-gray-900 flex items-center gap-2"><Layers className="w-5 h-5" /> æè³ª</h2><button type="button" onClick={() => appendMaterial({ name: '', priceSurcharge: 0 })} className="text-blue-600 text-sm flex items-center"><Plus className="w-4 h-4" /> æ–°å¢</button></div>
          <div className="space-y-3">{materialFields.map((f, i) => (<div key={f.id} className="flex gap-3 items-end bg-gray-50 p-3 rounded-lg"><div className="flex-1"><input {...register(`materials.${i}.name`)} className="w-full p-2 border rounded text-sm" placeholder="åç¨±" /></div><div className="w-32"><input type="number" {...register(`materials.${i}.priceSurcharge`, { valueAsNumber: true })} className="w-full p-2 border rounded text-sm" placeholder="åŠ åƒ¹" /></div><button type="button" onClick={() => removeMaterial(i)} className="text-gray-400 hover:text-red-500"><Trash2 className="w-4 h-4" /></button></div>))}</div>
        </section>

      </div>
    </div>
  );
}
</file>

<file path="admin/src/app/series/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { Plus, Edit, Trash2, Save, X, Image as ImageIcon, Loader2, UploadCloud, Layers } from 'lucide-react';
import { api } from '@/lib/api';

// âš ï¸ è«‹å¡«å…¥æ‚¨çš„ Cloudinary è³‡è¨Š
const CLOUDINARY_CLOUD_NAME = 'dnibj8za6'; 
const CLOUDINARY_PRESET = 'yasou70731'; 

export default function SeriesPage() {
  const [seriesList, setSeriesList] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);

  // è¡¨å–®æ§åˆ¶
  const { register, handleSubmit, reset, setValue, watch } = useForm({
    defaultValues: {
      name: '',        // ç³»çµ±ä»£ç¢¼
      displayName: '', // é¡¯ç¤ºåç¨±
      description: '', // æè¿°
      priceStart: 0,   // èµ·å§‹åƒ¹
      imageUrl: '',    // å°é¢åœ–
      isActive: true
    }
  });

  const imageUrl = watch('imageUrl');
  const [isUploading, setIsUploading] = useState(false);

  // 1. è¼‰å…¥åˆ—è¡¨
  const fetchSeries = async () => {
    try {
      const res = await api.get('/series');
      // âœ¨ Fix: ç›´æ¥ä½¿ç”¨ resï¼Œä¸¦ç¢ºä¿å®ƒæ˜¯é™£åˆ—
      if (Array.isArray(res)) {
        setSeriesList(res);
      } else {
        console.warn('API å›å‚³æ ¼å¼ç•°å¸¸ (éé™£åˆ—):', res);
        setSeriesList([]);
      }
    } catch (err) {
      console.error(err);
      setSeriesList([]);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => { fetchSeries(); }, []);

  // 2. åœ–ç‰‡ä¸Šå‚³
  const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;
    setIsUploading(true);
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', CLOUDINARY_PRESET);

    try {
      const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, { method: 'POST', body: formData });
      const data = await res.json();
      if (data.secure_url) setValue('imageUrl', data.secure_url);
    } catch (err) {
      alert('åœ–ç‰‡ä¸Šå‚³å¤±æ•—');
    } finally {
      setIsUploading(false);
    }
  };

  // 3. é€å‡ºè¡¨å–® (æ–°å¢æˆ–ä¿®æ”¹)
  const onSubmit = async (data: any) => {
    try {
      if (editingId) {
        await api.patch(`/series/${editingId}`, data);
        alert('ä¿®æ”¹æˆåŠŸ');
      } else {
        await api.post('/series', data);
        alert('æ–°å¢æˆåŠŸ');
      }
      closeModal();
      fetchSeries();
    } catch (err) {
      alert('æ“ä½œå¤±æ•— (åç¨±å¯èƒ½é‡è¤‡)');
    }
  };

  // 4. åˆªé™¤
  const handleDelete = async (id: string) => {
    if (!confirm('ç¢ºå®šåˆªé™¤æ­¤ç³»åˆ—å—ï¼Ÿ(åº•ä¸‹çš„ç”¢å“å¯èƒ½æœƒæ‰¾ä¸åˆ°ç³»åˆ—)')) return;
    try {
      await api.delete(`/series/${id}`);
      fetchSeries();
    } catch (err) { alert('åˆªé™¤å¤±æ•—'); }
  };

  // é–‹å•Ÿç·¨è¼¯
  const openEdit = (series: any) => {
    setEditingId(series.id);
    reset(series);
    setIsModalOpen(true);
  };

  const closeModal = () => {
    setIsModalOpen(false);
    setEditingId(null);
    reset({ name: '', displayName: '', description: '', priceStart: 0, imageUrl: '', isActive: true });
  };

  return (
    <div className="min-h-screen bg-gray-50 p-8 font-sans">
      <div className="flex justify-between items-center mb-8">
        <div>
          <h1 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
            <Layers className="w-6 h-6 text-blue-600" /> ç³»åˆ—ç®¡ç†
          </h1>
          <p className="text-gray-500 text-sm mt-1">ç®¡ç†å‰å°é¦–é é¡¯ç¤ºçš„ç”¢å“ç³»åˆ—èˆ‡å°é¢åœ–</p>
        </div>
        <button onClick={() => setIsModalOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-sm">
          <Plus className="w-5 h-5" /> æ–°å¢ç³»åˆ—
        </button>
      </div>

      {/* åˆ—è¡¨ */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {loading ? <p>è¼‰å…¥ä¸­...</p> : seriesList.map((item) => (
          <div key={item.id} className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden group">
            <div className="relative h-48 bg-gray-100">
              {/* eslint-disable-next-line @next/next/no-img-element */}
              <img src={item.imageUrl} alt={item.name} className="w-full h-full object-cover" />
              <div className="absolute top-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                <button onClick={() => openEdit(item)} className="p-2 bg-white rounded-full shadow hover:text-blue-600"><Edit className="w-4 h-4" /></button>
                <button onClick={() => handleDelete(item.id)} className="p-2 bg-white rounded-full shadow hover:text-red-600"><Trash2 className="w-4 h-4" /></button>
              </div>
            </div>
            <div className="p-4">
              <h3 className="font-bold text-gray-900 text-lg">{item.displayName}</h3>
              <p className="text-xs text-gray-500 mb-2">ç³»çµ±ä»£ç¢¼: {item.name}</p>
              <p className="text-sm text-gray-600 line-clamp-2 mb-3">{item.description}</p>
              <div className="flex justify-between items-center pt-3 border-t border-gray-50">
                <span className="text-blue-600 font-bold">${item.priceStart?.toLocaleString()} èµ·</span>
                <span className={`text-xs px-2 py-1 rounded ${item.isActive ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}`}>
                  {item.isActive ? 'é¡¯ç¤ºä¸­' : 'å·²éš±è—'}
                </span>
              </div>
            </div>
          </div>
        ))}
      </div>

      {/* å½ˆçª— Modal */}
      {isModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-6">
              <h3 className="text-xl font-bold text-gray-900">{editingId ? 'ç·¨è¼¯ç³»åˆ—' : 'æ–°å¢ç³»åˆ—'}</h3>
              <button onClick={closeModal} className="text-gray-400 hover:text-gray-600"><X className="w-5 h-5" /></button>
            </div>
            
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-bold text-gray-700 mb-1">ç³»çµ±ä»£ç¢¼ (Name)</label>
                <input {...register('name', { required: true })} placeholder="ä¾‹å¦‚ï¼šæ¥µç°¡ç³»åˆ— (éœ€èˆ‡ç”¢å“è¨­å®šä¸€è‡´)" className="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" />
                <p className="text-xs text-gray-400 mt-1">â€» æ­¤åç¨±ç”¨æ–¼é—œè¯ç”¢å“ï¼Œè«‹å‹¿éš¨æ„ä¿®æ”¹</p>
              </div>
              <div>
                <label className="block text-sm font-bold text-gray-700 mb-1">é¡¯ç¤ºåç¨± (Display Name)</label>
                <input {...register('displayName', { required: true })} placeholder="ä¾‹å¦‚ï¼šæ¥µç°¡ç´°æ¡†ç³»åˆ—" className="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" />
              </div>
              <div>
                <label className="block text-sm font-bold text-gray-700 mb-1">æè¿°</label>
                <textarea {...register('description')} rows={2} className="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" />
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-bold text-gray-700 mb-1">èµ·å§‹åƒ¹æ ¼</label>
                  <input type="number" {...register('priceStart', { valueAsNumber: true })} className="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                <div className="flex items-center mt-6">
                  <label className="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" {...register('isActive')} className="w-4 h-4 text-blue-600" />
                    <span className="text-sm text-gray-700">å•Ÿç”¨é¡¯ç¤º</span>
                  </label>
                </div>
              </div>

              {/* åœ–ç‰‡ä¸Šå‚³ */}
              <div>
                <label className="block text-sm font-bold text-gray-700 mb-2">å°é¢åœ–ç‰‡</label>
                <div className="flex gap-4 items-start">
                  <label className="flex-1 h-24 border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-gray-50">
                    {isUploading ? <Loader2 className="animate-spin text-gray-400" /> : <UploadCloud className="text-gray-400" />}
                    <span className="text-xs text-gray-500 mt-1">é»æ“Šä¸Šå‚³åœ–ç‰‡</span>
                    <input type="file" hidden accept="image/*" onChange={handleImageUpload} />
                  </label>
                  <div className="w-24 h-24 bg-gray-100 rounded-lg border overflow-hidden shrink-0">
                    {imageUrl ? (
                      // eslint-disable-next-line @next/next/no-img-element
                      <img src={imageUrl} className="w-full h-full object-cover" alt="Preview" />
                    ) : <div className="w-full h-full flex items-center justify-center text-xs text-gray-400">é è¦½</div>}
                  </div>
                </div>
                <input type="hidden" {...register('imageUrl')} />
              </div>

              <button onClick={handleSubmit(onSubmit)} className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 mt-4 flex justify-center items-center gap-2">
                <Save className="w-4 h-4" /> å„²å­˜è¨­å®š
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="admin/tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": false,               // âœ¨ é—œé–‰åš´æ ¼æ¨¡å¼
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./src/*"]
    },
    // âœ¨âœ¨âœ¨ æ–°å¢ä»¥ä¸‹å¯¬é¬†è¨­å®š âœ¨âœ¨âœ¨
    "noImplicitAny": false,
    "noUnusedLocals": false,
    "noUnusedParameters": false,
    "strictNullChecks": false
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
</file>

<file path="backend/.gitignore">
# compiled output
/dist
/node_modules
/build

# Logs
/logs
*.log
npm-debug.log*
pnpm-debug.log*
yarn-debug.log*
yarn-error.log*
lerna-debug.log*

# OS
.DS_Store

# Tests
/coverage
/.nyc_output

# IDEs and editors
/.idea
.project
.classpath
.c9/
*.launch
.settings/
*.sublime-workspace

# IDE - VSCode
.vscode/*
!.vscode/settings.json
!.vscode/tasks.json
!.vscode/launch.json
!.vscode/extensions.json

# dotenv environment variable files
.env
.env.development.local
.env.test.local
.env.production.local
.env.local

# temp directory
.temp
.tmp

# Runtime data
pids
*.pid
*.seed
*.pid.lock

# Diagnostic reports (https://nodejs.org/api/report.html)
report.[0-9]*.[0-9]*.[0-9]*.[0-9]*.json
</file>

<file path="backend/package.json">
{
  "name": "backend",
  "version": "0.0.1",
  "description": "",
  "author": "",
  "private": true,
  "license": "UNLICENSED",
  "scripts": {
    "build": "nest build",
    "format": "prettier --write \"src/**/*.ts\" \"test/**/*.ts\"",
    "start": "nest start",
    "start:dev": "nest start --watch",
    "start:debug": "nest start --debug --watch",
    "start:prod": "node dist/main",
    "lint": "eslint \"{src,apps,libs,test}/**/*.ts\" --fix",
    "test": "jest",
    "test:watch": "jest --watch",
    "test:cov": "jest --coverage",
    "test:debug": "node --inspect-brk -r tsconfig-paths/register -r ts-node/register node_modules/.bin/jest --runInBand",
    "test:e2e": "jest --config ./test/jest-e2e.json"
  },
  "dependencies": {
    "@nestjs/axios": "^4.0.1",
    "@nestjs/common": "^11.0.1",
    "@nestjs/config": "^4.0.2",
    "@nestjs/core": "^11.0.1",
    "@nestjs/jwt": "^11.0.1",
    "@nestjs/mapped-types": "*",
    "@nestjs/passport": "^11.0.5",
    "@nestjs/platform-express": "^11.0.1",
    "@nestjs/typeorm": "^11.0.0",
    "@types/nodemailer": "^7.0.4",
    "axios": "^1.13.2",
    "bcrypt": "^6.0.0",
    "class-transformer": "^0.5.1",
    "class-validator": "^0.14.2",
    "nodemailer": "^7.0.10",
    "passport": "^0.7.0",
    "passport-jwt": "^4.0.1",
    "passport-local": "^1.0.0",
    "pg": "^8.16.3",
    "reflect-metadata": "^0.2.2",
    "rxjs": "^7.8.1",
    "typeorm": "^0.3.27"
  },
  "devDependencies": {
    "@eslint/eslintrc": "^3.2.0",
    "@eslint/js": "^9.18.0",
    "@nestjs/cli": "^11.0.0",
    "@nestjs/schematics": "^11.0.0",
    "@nestjs/testing": "^11.0.1",
    "@types/bcrypt": "^6.0.0",
    "@types/express": "^5.0.0",
    "@types/jest": "^30.0.0",
    "@types/node": "^22.10.7",
    "@types/passport-jwt": "^4.0.1",
    "@types/passport-local": "^1.0.38",
    "@types/supertest": "^6.0.2",
    "eslint": "^9.18.0",
    "eslint-config-prettier": "^10.0.1",
    "eslint-plugin-prettier": "^5.2.2",
    "globals": "^16.0.0",
    "jest": "^30.0.0",
    "prettier": "^3.4.2",
    "source-map-support": "^0.5.21",
    "supertest": "^7.0.0",
    "ts-jest": "^29.2.5",
    "ts-loader": "^9.5.2",
    "ts-node": "^10.9.2",
    "tsconfig-paths": "^4.2.0",
    "typescript": "^5.7.3",
    "typescript-eslint": "^8.20.0"
  },
  "jest": {
    "moduleFileExtensions": [
      "js",
      "json",
      "ts"
    ],
    "rootDir": "src",
    "testRegex": ".*\\.spec\\.ts$",
    "transform": {
      "^.+\\.(t|j)s$": "ts-jest"
    },
    "collectCoverageFrom": [
      "**/*.(t|j)s"
    ],
    "coverageDirectory": "../coverage",
    "testEnvironment": "node"
  }
}
</file>

<file path="backend/src/auth/auth.module.ts">
import { Module } from '@nestjs/common';
import { AuthService } from './auth.service';
import { AuthController } from './auth.controller';
import { UsersModule } from '../users/users.module';
import { JwtModule } from '@nestjs/jwt';
import { ConfigModule, ConfigService } from '@nestjs/config';
import { JwtStrategy } from './jwt.strategy';
// âœ¨ å¼•å…¥ NotificationsModule
import { NotificationsModule } from '../notifications/notifications.module';

@Module({
  imports: [
    ConfigModule,
    UsersModule,
    // âœ¨ è¨»å†Š NotificationsModule
    NotificationsModule,
    JwtModule.registerAsync({
      imports: [ConfigModule],
      useFactory: async (configService: ConfigService) => ({
        secret: configService.get<string>('JWT_SECRET'),
        signOptions: { expiresIn: '1d' },
      }),
      inject: [ConfigService],
    }),
  ],
  controllers: [AuthController],
  providers: [AuthService, JwtStrategy],
})
export class AuthModule {}
</file>

<file path="backend/src/auth/dto/create-auth.dto.ts">
import { IsEmail, IsNotEmpty, IsString, MinLength } from 'class-validator';

export class CreateAuthDto {
  // Define properties for CreateAuthDto here if needed, 
  // or remove if unused. For now, keeping it empty to avoid breaking other imports.
}

// âœ¨ Added 'export' here so it can be imported by auth.service.ts
export class AuthPayloadDto {
  @IsEmail()
  email: string;

  @IsString()
  @IsNotEmpty()
  @MinLength(6)
  password: string;
}
</file>

<file path="backend/src/auth/dto/update-auth.dto.ts">
import { IsEmail, IsNotEmpty, IsString, MinLength } from 'class-validator';

export class CreateAuthDto {
  // Define properties for CreateAuthDto here if needed, 
  // or remove if unused. For now, keeping it empty to avoid breaking other imports.
}

export class AuthPayloadDto {
  @IsEmail()
  email: string;

  @IsString()
  @IsNotEmpty()
  @MinLength(6)
  password: string;
}
</file>

<file path="backend/src/notifications/notifications.service.ts">
import { Injectable } from '@nestjs/common';
import * as nodemailer from 'nodemailer';
import axios from 'axios';

@Injectable()
export class NotificationsService {
  private transporter;

  constructor() {
    // åˆå§‹åŒ– Nodemailer
    // åªæœ‰åœ¨è¨­å®šäº† SMTP_USER æ™‚æ‰å•Ÿç”¨ï¼Œé¿å…é–‹ç™¼ç’°å¢ƒå ±éŒ¯
    if (process.env.SMTP_USER) {
      this.transporter = nodemailer.createTransport({
        host: process.env.SMTP_HOST || 'smtp.gmail.com',
        port: Number(process.env.SMTP_PORT) || 465,
        secure: true, // true for 465, false for other ports
        auth: {
          user: process.env.SMTP_USER,
          pass: process.env.SMTP_PASS,
        },
      });
    }
  }

  // 1. å¯„é€ Email (çµ¦ç¶“éŠ·å•†)
  async sendEmail(to: string, subject: string, text: string, html?: string) {
    // é–‹ç™¼æ¨¡å¼æˆ–æœªè¨­å®š SMTP æ™‚ï¼Œåªå° Log
    if (!this.transporter) {
      console.log('=================================================');
      console.log('ğŸ“§ [æ¨¡æ“¬å¯„ä¿¡] (æœªè¨­å®š SMTP)');
      console.log(`æ”¶ä»¶äºº: ${to}`);
      console.log(`ä¸»æ—¨: ${subject}`);
      console.log(`å…§å®¹: ${text}`);
      console.log('=================================================');
      return true;
    }

    try {
      await this.transporter.sendMail({
        from: process.env.SMTP_FROM || '"SomaLink System" <no-reply@example.com>',
        to,
        subject,
        text, // ç´”æ–‡å­—ç‰ˆæœ¬
        html: html || text.replace(/\n/g, '<br>'), // ç°¡å–®çš„ HTML è½‰æ›
      });
      console.log(`âœ… Email sent to ${to}`);
      return true;
    } catch (error) {
      console.error('âŒ Email sending failed:', error);
      return false;
    }
  }

  // 2. ç™¼é€ Line Notify (ä¿æŒä¸è®Š)
  async sendLineNotify(message: string) {
    const token = process.env.LINE_NOTIFY_TOKEN;
    
    if (!token) {
        console.log('=================================================');
        console.log('ğŸ”” [æ¨¡æ“¬ Line] (æœªè¨­å®š Token)');
        console.log(`è¨Šæ¯: ${message}`);
        console.log('=================================================');
        return true;
    }

    try {
      await axios.post(
        'https://notify-api.line.me/api/notify',
        new URLSearchParams({ message }).toString(),
        { headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/x-www-form-urlencoded' } }
      );
      return true;
    } catch (error) {
      console.error('Line Notify failed:', error);
      return false;
    }
  }
}
</file>

<file path="backend/src/orders/dto/update-order.dto.ts">
import { PartialType } from '@nestjs/mapped-types';
import { CreateOrderDto } from './create-order.dto';
import { IsEnum, IsOptional, IsString } from 'class-validator';
import { OrderStatus } from '../entities/order.entity';

export class UpdateOrderDto extends PartialType(CreateOrderDto) {
  @IsOptional()
  @IsEnum(OrderStatus)
  status?: OrderStatus;

  @IsOptional()
  @IsString()
  adminNote?: string;
}
</file>

<file path="backend/src/products/entities/product.entity.ts">
import { Entity, Column, PrimaryGeneratedColumn, CreateDateColumn, UpdateDateColumn } from 'typeorm';

export class ProductOption {
  name: string;
  priceSurcharge: number; 
}

@Entity()
export class Product {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  name: string;  

  @Column()
  sku: string;   

  @Column()
  series: string; 

  @Column({ type: 'jsonb', nullable: true }) 
  images: string[]; 

  @Column({ type: 'decimal', precision: 10, scale: 2 })
  basePrice: number; 

  @Column({ type: 'decimal', precision: 10, scale: 2, default: 0 })
  assemblyFee: number; 

  @Column({ type: 'decimal', precision: 5, scale: 2, nullable: true })
  discountA: number; 

  @Column({ type: 'decimal', precision: 5, scale: 2, nullable: true })
  discountB: number; 

  @Column({ type: 'int', default: 90 })
  standardWidth: number;  

  @Column({ type: 'int', default: 210 })
  standardHeight: number; 

  @Column({ type: 'int', default: 0 })
  pricePerUnitWidth: number; 

  @Column({ type: 'int', default: 0 })
  pricePerUnitHeight: number; 

  @Column({ default: true })
  requiresMeasurement: boolean; 
  
  @Column({ type: 'jsonb', nullable: true })
  colors: ProductOption[];

  @Column({ type: 'jsonb', nullable: true })
  materials: ProductOption[];

  // âœ¨âœ¨âœ¨ æ–°å¢ï¼šæŠŠæ‰‹é¸é … âœ¨âœ¨âœ¨
  @Column({ type: 'jsonb', nullable: true })
  handles: ProductOption[];

  @Column({ type: 'jsonb', nullable: true })
  openingOptions: string[];

  @Column({ default: true })
  isActive: boolean; 

  @CreateDateColumn()
  createdAt: Date;

  @UpdateDateColumn()
  updatedAt: Date;
}
</file>

<file path="backend/src/products/products.service.ts">
import { Injectable, NotFoundException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Product } from './entities/product.entity';

@Injectable()
export class ProductsService {
  constructor(
    @InjectRepository(Product)
    private productsRepository: Repository<Product>,
  ) {}

  // 1. å»ºç«‹ç”¢å“
  create(createProductDto: any) {
    const product = this.productsRepository.create(createProductDto);
    return this.productsRepository.save(product);
  }

  // 2. æŸ¥è©¢æ‰€æœ‰ç”¢å“
  findAll() {
    return this.productsRepository.find({ order: { createdAt: 'DESC' } });
  }

  // 3. æŸ¥è©¢å–®ä¸€ç”¢å“
  findOne(id: string) {
    return this.productsRepository.findOneBy({ id });
  }

  // âœ¨ 4. æ›´æ–°ç”¢å“ (ä¿®å¾© 500 éŒ¯èª¤ç‰ˆ)
  async update(id: string, updateProductDto: any) {
    // ğŸ” é™¤éŒ¯ç”¨ï¼šå°å‡ºæ”¶åˆ°ä»€éº¼è³‡æ–™
    console.log('ğŸ‘‰ [Backend] æ”¶åˆ°æ›´æ–°è«‹æ±‚ ID:', id);
    console.log('ğŸ“¦ [Backend] åŸå§‹è³‡æ–™:', JSON.stringify(updateProductDto));

    // ğŸ›‘ å¼·åˆ¶ç§»é™¤ä¸å¯æ›´æ–°çš„ç³»çµ±æ¬„ä½ (ç”±å¾Œç«¯æŠŠé—œæœ€å®‰å…¨)
    delete updateProductDto.id;
    delete updateProductDto.createdAt;
    delete updateProductDto.updatedAt;

    // ç¢ºä¿æ•¸å€¼æ¬„ä½çœŸçš„æ˜¯æ•¸å­— (é˜²æ­¢å‰ç«¯å‚³ä¾†å­—ä¸²å°è‡´è³‡æ–™åº«å ±éŒ¯)
    if (updateProductDto.basePrice) updateProductDto.basePrice = Number(updateProductDto.basePrice);
    if (updateProductDto.standardWidth) updateProductDto.standardWidth = Number(updateProductDto.standardWidth);
    if (updateProductDto.standardHeight) updateProductDto.standardHeight = Number(updateProductDto.standardHeight);

    try {
      // åŸ·è¡Œæ›´æ–°
      await this.productsRepository.update(id, updateProductDto);
      
      console.log('âœ… [Backend] æ›´æ–°æˆåŠŸ');
      return this.productsRepository.findOneBy({ id });
    } catch (error) {
      console.error('âŒ [Backend] æ›´æ–°å¤±æ•— (SQL Error):', error);
      // é€™è£¡ä¸ throwï¼Œè®“ Controller æ•æ‰æˆ–æ˜¯å›å‚³æ›´å…·é«”çš„éŒ¯èª¤
      throw error;
    }
  }

  // 5. åˆªé™¤ç”¢å“
  async remove(id: string) {
    await this.productsRepository.delete(id);
    return { deleted: true };
  }
}
</file>

<file path="backend/src/users/dto/create-user.dto.ts">
import { IsString, IsEmail, IsOptional, ValidateNested, IsNotEmpty } from 'class-validator';
import { Type } from 'class-transformer';

// å®šç¾©ç¶“éŠ·å•†è³‡æ–™çµæ§‹ (å…§åµŒæ–¼ User DTO)
class CreateDealerProfileDto {
  @IsString()
  @IsNotEmpty()
  companyName: string;

  @IsString()
  @IsOptional()
  taxId?: string;

  @IsString()
  @IsNotEmpty()
  contactPerson: string;

  @IsString()
  @IsNotEmpty()
  phone: string;

  @IsString()
  @IsNotEmpty()
  address: string;
}

export class CreateUserDto {
  @IsEmail()
  email: string;

  @IsString()
  @IsNotEmpty()
  password: string;

  @IsString()
  @IsNotEmpty()
  name: string; // è¯çµ¡äººå§“å

  // å…è¨± tradeCategoryId ç‚ºå­—ä¸²æˆ– undefined (è™•ç†å‰ç«¯å‚³ä¾†çš„ç©ºå€¼)
  @IsOptional()
  @IsString()
  tradeCategoryId?: string;

  @IsOptional()
  @ValidateNested()
  @Type(() => CreateDealerProfileDto)
  dealerProfile?: CreateDealerProfileDto;
}
</file>

<file path="backend/src/users/users.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { UsersService } from './users.service';
import { UsersController } from './users.controller';
import { TradeCategoriesController } from './trade-categories.controller'; 
import { User } from './entities/user.entity';
import { DealerProfile } from './entities/dealer-profile.entity';
import { TradeCategory } from './entities/trade-category.entity';
import { NotificationsModule } from '../notifications/notifications.module';
// âœ¨ ä¿®æ­£ï¼šè·¯å¾‘æ”¹ç‚º ../cart (åŸæœ¬æ˜¯ ../../cart)
import { CartItem } from '../cart/entities/cart-item.entity';

@Module({
  imports: [
    // å°‡ CartItem åŠ å…¥ forFeature
    TypeOrmModule.forFeature([User, DealerProfile, TradeCategory, CartItem]),
    NotificationsModule,
  ],
  controllers: [
    UsersController, 
    TradeCategoriesController 
  ],
  providers: [UsersService],
  exports: [UsersService], 
})
export class UsersModule {}
</file>

<file path="frontend/next.config.ts">
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'images.unsplash.com',
      },
      {
        protocol: 'https',
        hostname: 'res.cloudinary.com',
      },
    ],
  },
};

export default nextConfig;
</file>

<file path="frontend/src/app/login/page.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { api } from '@/lib/api';
import { Loader2, Lock, Mail, AlertCircle } from 'lucide-react';
import Link from 'next/link';

export default function LoginPage() {
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(false);
  const [errorMsg, setErrorMsg] = useState<string | null>(null);
  
  // âœ¨ æ–°å¢ï¼šè¨˜ä½æˆ‘ç‹€æ…‹
  const [rememberMe, setRememberMe] = useState(false);
  
  const [formData, setFormData] = useState({ email: '', password: '' });

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);
    setErrorMsg(null);

    try {
      const data = await api.post('/auth/login', formData);
      const { access_token, user } = data;

      // âœ¨ æ ¹æ“šã€Œè¨˜ä½æˆ‘ã€é¸æ“‡å„²å­˜ä½ç½®
      if (rememberMe) {
        // å­˜å…¥ LocalStorage (æ°¸ä¹…)
        localStorage.setItem('somalink_token', access_token);
        localStorage.setItem('somalink_user', JSON.stringify(user));
        // æ¸…é™¤ Session ä»¥é˜²è¬ä¸€
        sessionStorage.removeItem('somalink_token');
        sessionStorage.removeItem('somalink_user');
      } else {
        // å­˜å…¥ SessionStorage (é—œé–‰åˆ†é å³å¤±æ•ˆ)
        sessionStorage.setItem('somalink_token', access_token);
        sessionStorage.setItem('somalink_user', JSON.stringify(user));
        // æ¸…é™¤ Local
        localStorage.removeItem('somalink_token');
        localStorage.removeItem('somalink_user');
      }

      router.push('/');
    } catch (err: any) {
      console.error('ç™»å…¥å¤±æ•—:', err);
      if (err.response?.status === 401) {
        setErrorMsg('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤');
      } else {
        setErrorMsg('ç³»çµ±é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¢ºèªå¾Œç«¯æ˜¯å¦å·²å•Ÿå‹•');
      }
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 px-4 sm:px-6 lg:px-8">
      <div className="max-w-md w-full space-y-8 bg-white p-8 rounded-2xl shadow-lg border border-gray-100">
        
        <div className="text-center">
          <div className="mx-auto h-12 w-12 bg-blue-600 rounded-xl flex items-center justify-center text-white font-bold text-2xl mb-4 shadow-blue-200 shadow-md">
            S
          </div>
          <h2 className="text-3xl font-bold tracking-tight text-gray-900">
            ç¶“éŠ·å•†ç™»å…¥
          </h2>
          <p className="mt-2 text-sm text-gray-600">
            æ­¡è¿å›åˆ° æ¾æˆæœ‰é™å…¬å¸ æ•¸ä½å·¥å» 
          </p>
        </div>

        {errorMsg && (
          <div className="bg-red-50 border border-red-200 rounded-lg p-4 flex items-start gap-3 animate-pulse">
            <AlertCircle className="w-5 h-5 text-red-600 mt-0.5 shrink-0" />
            <p className="text-sm text-red-700 font-medium">{errorMsg}</p>
          </div>
        )}

        <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-bold text-gray-700 mb-1">Email å¸³è™Ÿ</label>
              <div className="relative">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><Mail className="h-5 w-5 text-gray-400" /></div>
                <input type="email" required className="block w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" placeholder="your@company.com" value={formData.email} onChange={(e) => setFormData({...formData, email: e.target.value})} />
              </div>
            </div>
            <div>
              <label className="block text-sm font-bold text-gray-700 mb-1">å¯†ç¢¼</label>
              <div className="relative">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><Lock className="h-5 w-5 text-gray-400" /></div>
                <input type="password" required className="block w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" value={formData.password} onChange={(e) => setFormData({...formData, password: e.target.value})} />
              </div>
            </div>
          </div>

          {/* âœ¨ æ–°å¢ï¼šè¨˜ä½æˆ‘ & å¿˜è¨˜å¯†ç¢¼ */}
          <div className="flex items-center justify-between">
            <div className="flex items-center">
              <input
                id="remember-me"
                name="remember-me"
                type="checkbox"
                checked={rememberMe}
                onChange={(e) => setRememberMe(e.target.checked)}
                className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded cursor-pointer"
              />
              <label htmlFor="remember-me" className="ml-2 block text-sm text-gray-900 cursor-pointer select-none">
                è¨˜ä½æˆ‘
              </label>
            </div>

            <div className="text-sm">
              <Link href="/forgot-password" className="font-medium text-blue-600 hover:text-blue-500">
                å¿˜è¨˜å¯†ç¢¼ï¼Ÿ
              </Link>
            </div>
          </div>

          <button type="submit" disabled={isLoading} className="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-70 disabled:cursor-not-allowed transition-all shadow-md hover:shadow-lg">
            {isLoading ? <Loader2 className="animate-spin -ml-1 mr-2 h-5 w-5" /> : 'ç™»å…¥ç³»çµ±'}
          </button>

          <div className="text-center space-y-3 mt-6 border-t border-gray-100 pt-6">
            <Link href="/register" className="block text-sm font-bold text-blue-600 hover:text-blue-800 hover:underline transition-colors">é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿé»æ­¤ç”³è«‹æˆç‚ºç¶“éŠ·å•†</Link>
            <Link href="/" className="block text-sm text-gray-400 hover:text-gray-600 transition-colors">â† å…ˆå›é¦–é é€›é€›</Link>
          </div>
        </form>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/app/portal/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import Link from "next/link";
import Image from 'next/image'; // âœ¨ å¼•å…¥
import { ArrowRight, Megaphone, X, Loader2 } from "lucide-react";
import { api } from '../../lib/api'; 

export default function HomePage() {
  const [announcement, setAnnouncement] = useState<string | null>(null);
  const [showBanner, setShowBanner] = useState(true);
  
  const [seriesList, setSeriesList] = useState<any[]>([]);
  const [loadingSeries, setLoadingSeries] = useState(true);

  useEffect(() => {
    const fetchData = async () => {
      try {
        const annRes = await api.get('/announcements/active');
        if (annRes && annRes.content) setAnnouncement(annRes.content);

        const seriesRes = await api.get('/series');
        const data = Array.isArray(seriesRes) ? seriesRes : [];
        const activeSeries = data.filter((s: any) => s.isActive);
        setSeriesList(activeSeries);
      } catch (err) { 
        console.error('ç„¡æ³•å–å¾—é¦–é è³‡æ–™', err); 
        setSeriesList([]); 
      } finally {
        setLoadingSeries(false);
      }
    };
    fetchData();
  }, []);

  return (
    <div className="min-h-screen bg-gray-50">
      
      {announcement && showBanner && (
        <div className="bg-blue-600 text-white px-4 py-2.5 relative flex justify-center items-center text-xs sm:text-sm font-medium animate-in slide-in-from-top">
          <div className="flex items-center gap-2"><Megaphone className="w-4 h-4 animate-pulse" /><span>{announcement}</span></div>
          <button onClick={() => setShowBanner(false)} className="absolute right-2 top-1/2 -translate-y-1/2 p-1 hover:bg-blue-700 rounded-full transition-colors opacity-80 hover:opacity-100"><X className="w-4 h-4" /></button>
        </div>
      )}

      <div className="bg-white border-b border-gray-200">
        <div className="max-w-7xl mx-auto px-4 py-10 sm:py-12">
          <h1 className="text-2xl sm:text-3xl font-bold text-gray-900 mb-2">æ­¡è¿ä¾†åˆ° æ¾æˆæœ‰é™å…¬å¸ æ•¸ä½å·¥å» </h1>
          <p className="text-gray-500">è«‹é¸æ“‡ä¸‹æ–¹ç”¢å“ç³»åˆ—ï¼Œé–‹å§‹å»ºç«‹æ‚¨çš„å®¢è£½åŒ–å ±åƒ¹å–®</p>
        </div>
      </div>

      <main className="max-w-7xl mx-auto px-4 py-8">
        {loadingSeries ? (
          <div className="flex justify-center py-20"><Loader2 className="animate-spin w-10 h-10 text-blue-600" /></div>
        ) : seriesList.length === 0 ? (
          <div className="text-center py-20 text-gray-500">å°šç„¡ä¸Šæ¶ç³»åˆ—ï¼Œè«‹è‡³å¾Œå°æ–°å¢ã€‚</div>
        ) : (
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            {seriesList.map((series) => (
              <Link 
                key={series.id} 
                href={`/series/${encodeURIComponent(series.name)}`} 
                className="group bg-white rounded-2xl overflow-hidden border border-gray-200 hover:shadow-xl hover:border-blue-300 transition-all duration-300 flex flex-col"
              >
                <div className="relative h-52 overflow-hidden bg-gray-100">
                  {/* âœ¨ æ”¹ç”¨ Next.js Image */}
                  <Image 
                    src={series.imageUrl || "https://images.unsplash.com/photo-1600607686527-6fb886090705?auto=format&fit=crop&q=80&w=800"} 
                    alt={series.name}
                    fill
                    className="object-cover group-hover:scale-110 transition-transform duration-500"
                    sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 25vw"
                  />
                  <div className="absolute inset-0 bg-linear-to-t from-black/60 to-transparent opacity-60" />
                  <div className="absolute bottom-4 left-4 text-white">
                    <p className="text-xs font-medium opacity-90 tracking-wider uppercase">{series.description}</p>
                    <h3 className="text-lg font-bold">{series.displayName || series.name}</h3>
                  </div>
                </div>

                <div className="p-5 flex-1 flex flex-col justify-between">
                  <div>
                    <div className="flex items-center justify-between mb-2">
                      <span className="px-2.5 py-0.5 rounded-full bg-blue-50 text-blue-700 text-xs font-bold border border-blue-100">B2B å°ˆå±¬</span>
                    </div>
                    <p className="text-gray-500 text-sm line-clamp-2">æ”¯æ´é«˜åº¦å®¢è£½åŒ–å°ºå¯¸ã€é¡è‰²èˆ‡ç»ç’ƒé…ç½®ã€‚</p>
                  </div>
                  <div className="mt-4 pt-4 border-t border-gray-50 flex items-center justify-between">
                    <div><p className="text-xs text-gray-400">åŸºç¤åƒ¹æ ¼</p><p className="text-blue-600 font-bold text-lg">${series.priceStart?.toLocaleString()} <span className="text-xs text-gray-400 font-normal ml-1">èµ·</span></p></div>
                    <div className="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center group-hover:bg-blue-600 group-hover:text-white transition-colors"><ArrowRight className="w-5 h-5" /></div>
                  </div>
                </div>
              </Link>
            ))}
          </div>
        )}
      </main>
    </div>
  );
}
</file>

<file path="frontend/src/app/reset-password/page.tsx">
'use client';

import { useState, useEffect, Suspense } from 'react'; // âœ¨ å¼•å…¥ Suspense
import { useRouter, useSearchParams } from 'next/navigation';
import { Lock, Loader2, CheckCircle } from 'lucide-react';
import Link from 'next/link';
import { api } from '@/lib/api';

// âœ¨ 1. å°‡åŸæœ¬çš„é é¢é‚è¼¯æ‹†åˆ†åˆ°é€™å€‹å­å…ƒä»¶ä¸­
function ResetPasswordContent() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const token = searchParams.get('token');

  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [isSuccess, setIsSuccess] = useState(false);
  const [errorMsg, setErrorMsg] = useState('');

  // å¦‚æœç¶²å€æ²’æœ‰ Tokenï¼Œè¸¢å›ç™»å…¥é 
  useEffect(() => {
    if (!token) {
      router.replace('/login');
    }
  }, [token, router]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setErrorMsg('');

    if (password !== confirmPassword) {
      setErrorMsg('å…©æ¬¡å¯†ç¢¼è¼¸å…¥ä¸ä¸€è‡´');
      return;
    }
    
    if (!token) return;

    setIsLoading(true);
    try {
      await api.auth.resetPassword(token, password);
      setIsSuccess(true);
    } catch (err: any) {
      console.error(err);
      setErrorMsg(err.response?.data?.message || 'é‡è¨­å¤±æ•—ï¼Œé€£çµå¯èƒ½å·²éæœŸæˆ–ç„¡æ•ˆ');
    } finally {
      setIsLoading(false);
    }
  };

  if (!token) return null;

  return (
    <div className="max-w-md w-full bg-white p-8 rounded-2xl shadow-lg border border-gray-100">
      
      <div className="text-center mb-8">
        <div className="mx-auto h-12 w-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 mb-4">
          <Lock className="h-6 w-6" />
        </div>
        <h2 className="text-2xl font-bold text-gray-900">é‡è¨­å¯†ç¢¼</h2>
        <p className="mt-2 text-sm text-gray-600">
          è«‹è¼¸å…¥æ‚¨çš„æ–°å¯†ç¢¼ä»¥æ¢å¾©å¸³è™Ÿå­˜å–æ¬Šã€‚
        </p>
      </div>

      {isSuccess ? (
        <div className="text-center space-y-6 animate-in fade-in">
          <div className="bg-green-50 text-green-700 p-4 rounded-xl text-sm border border-green-100 flex flex-col items-center">
            <CheckCircle className="w-8 h-8 mb-2" />
            <p className="font-bold text-lg">å¯†ç¢¼é‡è¨­æˆåŠŸï¼</p>
            <p>æ‚¨ç¾åœ¨å¯ä»¥ä½¿ç”¨æ–°å¯†ç¢¼ç™»å…¥äº†ã€‚</p>
          </div>
          <Link href="/login" className="block w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors shadow-md text-center">
            å‰å¾€ç™»å…¥
          </Link>
        </div>
      ) : (
        <form onSubmit={handleSubmit} className="space-y-6">
          
          {errorMsg && (
            <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm font-medium border border-red-100 flex items-center gap-2">
              âš ï¸ {errorMsg}
            </div>
          )}

          <div className="space-y-4">
            <div>
              <label className="block text-sm font-bold text-gray-700 mb-1">æ–°å¯†ç¢¼</label>
              <input 
                type="password" 
                required
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼ (è‡³å°‘ 6 ç¢¼)"
                minLength={6}
              />
            </div>
            <div>
              <label className="block text-sm font-bold text-gray-700 mb-1">ç¢ºèªæ–°å¯†ç¢¼</label>
              <input 
                type="password" 
                required
                value={confirmPassword}
                onChange={(e) => setConfirmPassword(e.target.value)}
                className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                placeholder="å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼"
                minLength={6}
              />
            </div>
          </div>

          <button 
            type="submit" 
            disabled={isLoading}
            className="w-full flex items-center justify-center gap-2 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors shadow-md disabled:opacity-70 disabled:cursor-not-allowed"
          >
            {isLoading ? <Loader2 className="animate-spin w-5 h-5" /> : 'ç¢ºèªé‡è¨­'}
          </button>
        </form>
      )}
    </div>
  );
}

// âœ¨ 2. ä¸»é é¢å…ƒä»¶ï¼šåªè² è²¬ Suspense åŒ…è£¹èˆ‡ä½ˆå±€
export default function ResetPasswordPage() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 px-4 font-sans">
      <Suspense fallback={<Loader2 className="animate-spin w-10 h-10 text-blue-600" />}>
        <ResetPasswordContent />
      </Suspense>
    </div>
  );
}
</file>

<file path="frontend/src/app/series/[name]/page.tsx">
'use client';

import { useState, useEffect, use } from 'react';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { ArrowLeft, Search, ShoppingCart, Lock } from 'lucide-react'; // âœ¨ æ–°å¢ Lock åœ–ç¤º
import { api } from '@/lib/api';
import Modal from '@/components/Modal'; // âœ¨ å¼•å…¥å½ˆçª—

export default function SeriesListPage({ params }: { params: Promise<{ name: string }> }) {
  const { name } = use(params);
  const seriesName = decodeURIComponent(name);
  const router = useRouter();

  const [products, setProducts] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  
  // âœ¨ ç™»å…¥æç¤ºå½ˆçª—ç‹€æ…‹
  const [showLoginModal, setShowLoginModal] = useState(false);

  useEffect(() => {
    const fetchProducts = async () => {
      try {
        const res = await api.get('/products');
        const data = Array.isArray(res) ? res : [];
        const filtered = data.filter((p: any) => p.series === seriesName);
        setProducts(filtered);
      } catch (err) {
        console.error(err);
        setProducts([]);
      } finally {
        setLoading(false);
      }
    };
    fetchProducts();
  }, [seriesName]);

  // âœ¨âœ¨âœ¨ é»æ“Šå•†å“æ™‚çš„æª¢æŸ¥é‚è¼¯ âœ¨âœ¨âœ¨
  const handleProductClick = (productId: string) => {
    // æª¢æŸ¥ LocalStorage æˆ– SessionStorage æ˜¯å¦æœ‰ Token
    const token = localStorage.getItem('somalink_token') || sessionStorage.getItem('somalink_token');
    
    if (!token) {
      // æ²’ç™»å…¥ -> è·³å‡ºå½ˆçª—
      setShowLoginModal(true);
    } else {
      // æœ‰ç™»å…¥ -> æ­£å¸¸è·³è½‰
      router.push(`/product/${productId}`);
    }
  };

  return (
    <div className="min-h-screen bg-gray-50">
      
      {/* âœ¨ æç¤ºå½ˆçª— */}
      <Modal 
        isOpen={showLoginModal} 
        title="æœƒå“¡å°ˆå±¬æ¬Šé™"
        message="æœ¬ç«™æ¡æœƒå“¡åˆ¶ï¼Œè«‹å…ˆç™»å…¥æœƒå“¡å¸³è™Ÿï¼Œå³å¯æŸ¥çœ‹å®Œæ•´ç”¢å“è¦æ ¼èˆ‡å°ˆå±¬å„ªæƒ åƒ¹æ ¼ã€‚"
        type="confirm"
        confirmText="å‰å¾€ç™»å…¥"
        cancelText="ç¨å¾Œå†èªª"
        onClose={() => setShowLoginModal(false)}
        onConfirm={() => router.push('/login')}
      />

      {/* Header */}
      <header className="bg-white shadow-sm border-b border-gray-100 h-16 flex items-center px-4 sticky top-0 z-10">
        <div className="max-w-7xl mx-auto w-full flex items-center gap-4">
          <Link href="/" className="p-2 hover:bg-gray-100 rounded-full transition-colors">
            <ArrowLeft className="w-5 h-5 text-gray-600" />
          </Link>
          <h1 className="text-lg font-bold text-gray-900">{seriesName}</h1>
        </div>
      </header>

      {/* Content */}
      <main className="max-w-7xl mx-auto px-4 py-8">
        {loading ? (
          <div className="text-center py-12 text-gray-500">è¼‰å…¥ç”¢å“ä¸­...</div>
        ) : products.length === 0 ? (
          <div className="text-center py-12">
            <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <Search className="w-8 h-8 text-gray-400" />
            </div>
            <h3 className="text-lg font-bold text-gray-900">æ­¤ç³»åˆ—å°šç„¡ç”¢å“</h3>
            <p className="text-gray-500 mt-1">è«‹è‡³å¾Œå°æ–°å¢ç”¢å“ï¼Œä¸¦ç¢ºèªç³»åˆ—åç¨±ç‚ºã€Œ{seriesName}ã€</p>
          </div>
        ) : (
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            {products.map((product) => {
              const thumb = (product.images && product.images.length > 0) 
                ? product.images[0] 
                : (product.imageUrl || "https://images.unsplash.com/photo-1584622050111-993a426fbf0a?auto=format&fit=crop&q=80&w=800");

              return (
                <div 
                  key={product.id} 
                  // âœ¨ æ”¹ç”¨ onClick è§¸ç™¼æª¢æŸ¥ï¼Œè€Œä¸æ˜¯ç›´æ¥ Link
                  onClick={() => handleProductClick(product.id)}
                  className="group bg-white rounded-xl overflow-hidden border border-gray-200 hover:shadow-lg hover:border-blue-300 transition-all duration-300 flex flex-col cursor-pointer relative"
                >
                  <div className="relative h-48 bg-gray-100 overflow-hidden">
                    {/* eslint-disable-next-line @next/next/no-img-element */}
                    <img 
                      src={thumb} 
                      alt={product.name} 
                      className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" 
                    />
                  </div>
                  
                  <div className="p-4">
                    <h3 className="font-bold text-gray-900 mb-1 group-hover:text-blue-600 transition-colors">{product.name}</h3>
                    <p className="text-xs text-gray-500 font-mono mb-3">{product.sku}</p>
                    <div className="flex items-center justify-between mt-auto">
                      <span className="text-blue-600 font-bold flex items-center gap-1">
                        ${Number(product.basePrice).toLocaleString()} èµ·
                      </span>
                      <button className="p-2 bg-gray-50 rounded-full group-hover:bg-blue-600 group-hover:text-white transition-colors">
                        <ShoppingCart className="w-4 h-4" />
                      </button>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </main>
    </div>
  );
}
</file>

<file path="frontend/src/components/blocks/HeroBlock.tsx">
'use client';
import { useState, useEffect } from 'react';
import Link from "next/link";
import Image from 'next/image'; // âœ¨ 1. å¼•å…¥ Next.js Image å…ƒä»¶
import { ArrowRight } from "lucide-react";

export default function HeroBlock({ data }: { data: any }) {
  const [currentImageIndex, setCurrentImageIndex] = useState(0);
  const images = data.images || [];

  useEffect(() => {
    if (images.length <= 1) return;
    const timer = setInterval(() => {
      setCurrentImageIndex((prev) => (prev + 1) % images.length);
    }, 5000);
    return () => clearInterval(timer);
  }, [images]);

  return (
    <div className="relative h-[85vh] w-full overflow-hidden bg-gray-900">
      {images.map((src: string, index: number) => (
        // âœ¨ 2. ä½¿ç”¨ div åŒ…è£¹ Image è™•ç†æ·¡å…¥æ·¡å‡º (transition-opacity)
        <div 
          key={index} 
          className={`absolute inset-0 w-full h-full transition-opacity duration-1000 ${index === currentImageIndex ? 'opacity-100' : 'opacity-0'}`}
        >
          {/* âœ¨ 3. ä½¿ç”¨ <Image /> å–ä»£ <img> */}
          <Image
            src={src} 
            alt="Hero"
            fill // è‡ªå‹•å¡«æ»¿çˆ¶å±¤ div
            className="object-cover" // ä¿æŒæ¯”ä¾‹è£åˆ‡
            priority={index === 0} // ç¬¬ä¸€å¼µåœ–å„ªå…ˆè¼‰å…¥ (æå‡æ•ˆèƒ½åˆ†æ•¸)
            sizes="100vw" // å‘Šè¨´ç€è¦½å™¨é€™å¼µåœ–ä½”æ»¿è¦–çª—å¯¬åº¦
          />
        </div>
      ))}
      
      {/* é»‘è‰²é®ç½© */}
      <div className="absolute inset-0 bg-black/40" />
      
      {/* æ–‡å­—å…§å®¹ */}
      <div className="relative z-10 h-full max-w-7xl mx-auto px-6 flex flex-col justify-center items-start text-white">
        <span className="bg-blue-600 text-white px-4 py-1 rounded-full text-sm font-bold mb-6">SOMA æ¾æˆæœ‰é™å…¬å¸</span>
        <h1 className="text-5xl md:text-7xl font-bold leading-tight mb-6 whitespace-pre-wrap">{data.title}</h1>
        <p className="text-lg md:text-xl text-gray-100 max-w-xl mb-10">{data.subtitle}</p>
        <div className="flex gap-4">
          <Link href="/portal" className="px-8 py-4 bg-white text-gray-900 rounded-full font-bold hover:bg-gray-100 flex items-center gap-2">é€²å…¥ç¶“éŠ·ç³»çµ± <ArrowRight className="w-5 h-5" /></Link>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/components/MeasurementModal.tsx">
'use client';

import { useState, useEffect } from 'react';
import { X, Info, Check, AlertTriangle } from 'lucide-react';
import clsx from 'clsx';

export interface MeasurementData {
  width: { top: number; mid: number; bot: number };
  height: { left: number; mid: number; right: number; singleValue?: number };
  isCeilingMounted: boolean;
  floorError?: { diff: number; description?: string };
}

interface MeasurementModalProps {
  isOpen: boolean;
  onClose: () => void;
  onConfirm: (data: MeasurementData) => void;
}

export default function MeasurementModal({ isOpen, onClose, onConfirm }: MeasurementModalProps) {
  const [step, setStep] = useState(1); // 1: å°ºå¯¸è¼¸å…¥, 2: ç’°å¢ƒè©•ä¼°
  
  // å°ºå¯¸æ•¸æ“š
  const [width, setWidth] = useState({ top: '', mid: '', bot: '' });
  const [height, setHeight] = useState({ left: '', mid: '', right: '' });
  const [isCeilingMounted, setIsCeilingMounted] = useState(true);

  // ç’°å¢ƒæ•¸æ“š
  // âœ¨ ä¿®æ­£ï¼šé è¨­ç‚º false (ä»£è¡¨ç„¡èª¤å·®)ï¼Œåªæœ‰å‹¾é¸æœ‰èª¤å·®æ™‚æ‰éœ€è¦è¼¸å…¥
  const [hasFloorError, setHasFloorError] = useState(false); 
  const [floorDiff, setFloorDiff] = useState('');

  // åˆå§‹åŒ– / é‡ç½®
  useEffect(() => {
    if (isOpen) {
      setStep(1);
      setWidth({ top: '', mid: '', bot: '' });
      setHeight({ left: '', mid: '', right: '' });
      setIsCeilingMounted(true);
      setHasFloorError(false); // é è¨­ç‚ºå®Œç¾ç‹€æ³
      setFloorDiff('');
    }
  }, [isOpen]);

  if (!isOpen) return null;

  const handleNext = () => {
    // ç°¡å–®é©—è­‰å°ºå¯¸æ˜¯å¦å¡«å¯«
    if (!width.top || !width.mid || !width.bot || !height.left || !height.mid || !height.right) {
      alert('è«‹å¡«å¯«å®Œæ•´çš„å¯¬åº¦èˆ‡é«˜åº¦æ•¸æ“š (å…± 6 å€‹æ¬„ä½)');
      return;
    }
    setStep(2);
  };

  const handleConfirm = () => {
    // âœ¨ é©—è­‰é‚è¼¯ä¿®æ­£ï¼šåªæœ‰åœ¨ã€Œæœ‰èª¤å·®ã€ä¸”ã€Œæœªå¡«å¯«æ•¸å€¼ã€æ™‚æ‰æ“‹ä¸‹
    if (hasFloorError && !floorDiff) {
      alert('æ‚¨å‹¾é¸äº†æœ‰åœ°é¢é«˜ä½å·®ï¼Œè«‹è¼¸å…¥èª¤å·®æ•¸å€¼');
      return;
    }

    const data: MeasurementData = {
      width: {
        top: Number(width.top),
        mid: Number(width.mid),
        bot: Number(width.bot),
      },
      height: {
        left: Number(height.left),
        mid: Number(height.mid),
        right: Number(height.right),
      },
      isCeilingMounted,
      // å¦‚æœç„¡èª¤å·®ï¼ŒfloorError å°±çµ¦ undefined
      floorError: hasFloorError ? { diff: Number(floorDiff) } : undefined
    };

    onConfirm(data);
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
      <div className="bg-white rounded-2xl w-full max-w-lg overflow-hidden shadow-2xl flex flex-col max-h-[90vh]">
        
        {/* æ¨™é¡Œåˆ— */}
        <div className="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50">
          <h3 className="font-bold text-lg text-gray-900">
            {step === 1 ? 'æ­¥é©Ÿ 1/2ï¼šè¼¸å…¥ä¸ˆé‡å°ºå¯¸' : 'æ­¥é©Ÿ 2/2ï¼šç’°å¢ƒè©•ä¼°'}
          </h3>
          <button onClick={onClose} className="p-2 text-gray-400 hover:bg-gray-200 rounded-full transition-colors">
            <X className="w-5 h-5" />
          </button>
        </div>

        {/* å…§å®¹å€ */}
        <div className="p-6 overflow-y-auto space-y-6">
          
          {step === 1 && (
            <>
              {/* å¯¬åº¦è¼¸å…¥å€ */}
              <div className="space-y-3">
                <label className="block text-sm font-bold text-gray-700">å¯¬åº¦æ¸¬é‡ (Width) <span className="text-red-500">*</span></label>
                <div className="grid grid-cols-3 gap-3">
                  {['top', 'mid', 'bot'].map((pos) => (
                    <div key={pos}>
                      <input 
                        type="number" 
                        placeholder={pos === 'top' ? 'ä¸Š' : pos === 'mid' ? 'ä¸­' : 'ä¸‹'}
                        value={width[pos as keyof typeof width]}
                        onChange={(e) => setWidth({ ...width, [pos]: e.target.value })}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-center focus:ring-2 focus:ring-blue-500 outline-none transition-all placeholder:text-gray-300"
                      />
                    </div>
                  ))}
                </div>
                <p className="text-xs text-gray-500">è«‹åˆ†åˆ¥æ¸¬é‡ ä¸Š/ä¸­/ä¸‹ ä¸‰é»å¯¬åº¦ (å–®ä½: cm)</p>
              </div>

              {/* é«˜åº¦è¼¸å…¥å€ */}
              <div className="space-y-3">
                <div className="flex justify-between items-center">
                  <label className="block text-sm font-bold text-gray-700">é«˜åº¦æ¸¬é‡ (Height) <span className="text-red-500">*</span></label>
                  <label className="flex items-center gap-2 cursor-pointer select-none">
                    <input 
                      type="checkbox" 
                      checked={isCeilingMounted}
                      onChange={(e) => setIsCeilingMounted(e.target.checked)}
                      className="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                    />
                    <span className="text-xs font-bold text-blue-700 bg-blue-50 px-2 py-0.5 rounded border border-blue-100">å°é ‚å®‰è£</span>
                  </label>
                </div>
                <div className="grid grid-cols-3 gap-3">
                  {['left', 'mid', 'right'].map((pos) => (
                    <div key={pos}>
                      <input 
                        type="number" 
                        placeholder={pos === 'left' ? 'å·¦' : pos === 'mid' ? 'ä¸­' : 'å³'}
                        value={height[pos as keyof typeof height]}
                        onChange={(e) => setHeight({ ...height, [pos]: e.target.value })}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-center focus:ring-2 focus:ring-blue-500 outline-none transition-all placeholder:text-gray-300"
                      />
                    </div>
                  ))}
                </div>
                <p className="text-xs text-gray-500">è«‹åˆ†åˆ¥æ¸¬é‡ å·¦/ä¸­/å³ ä¸‰é»é«˜åº¦ (å–®ä½: cm)</p>
              </div>
            </>
          )}

          {step === 2 && (
            <div className="space-y-6">
              <div className="bg-blue-50 p-4 rounded-xl flex items-start gap-3 text-blue-800 text-sm border border-blue-100">
                <Info className="w-5 h-5 shrink-0 mt-0.5" />
                <p>è«‹ç¢ºèªç¾å ´åœ°é¢æ˜¯å¦æœ‰é«˜ä½å·®ã€‚è‹¥ç‰†é¢/åœ°é¢å‚ç›´æ°´å¹³è‰¯å¥½ï¼Œè«‹é¸æ“‡ç¬¬ä¸€é …ã€‚</p>
              </div>

              <div className="space-y-3">
                
                {/* é¸é … 1: å®Œç¾ç„¡èª¤å·® (é è¨­) */}
                <label className={clsx(
                  "flex items-center gap-4 p-4 border rounded-xl cursor-pointer transition-all",
                  !hasFloorError ? "border-green-500 bg-green-50 ring-1 ring-green-500" : "border-gray-200 hover:bg-gray-50"
                )}>
                  <input 
                    type="radio" 
                    name="floor_condition"
                    checked={!hasFloorError}
                    onChange={() => {
                      setHasFloorError(false);
                      setFloorDiff('');
                    }}
                    className="w-5 h-5 text-green-600 border-gray-300 focus:ring-green-500"
                  />
                  <div className="flex-1">
                    <span className="font-bold text-gray-900 block">âœ… å‚ç›´æ°´å¹³è‰¯å¥½ (ç„¡èª¤å·®)</span>
                    <span className="text-xs text-gray-500">ç¾å ´æ¢ä»¶æ¨™æº–ï¼Œä¸éœ€è¦ç‰¹æ®Šèª¿æ•´</span>
                  </div>
                </label>

                {/* é¸é … 2: æœ‰èª¤å·® */}
                <label className={clsx(
                  "flex items-start gap-4 p-4 border rounded-xl cursor-pointer transition-all",
                  hasFloorError ? "border-orange-500 bg-orange-50 ring-1 ring-orange-500" : "border-gray-200 hover:bg-gray-50"
                )}>
                  <input 
                    type="radio" 
                    name="floor_condition"
                    checked={hasFloorError}
                    onChange={() => setHasFloorError(true)}
                    className="w-5 h-5 text-orange-600 border-gray-300 focus:ring-orange-500 mt-1"
                  />
                  <div className="flex-1">
                    <span className="font-bold text-gray-900 block">âš ï¸ æœ‰åœ°é¢é«˜ä½å·® (æ°´å¹³èª¤å·®)</span>
                    <span className="text-xs text-gray-500 mb-2 block">å·¦å³é«˜åº¦ä¸ä¸€è‡´ï¼Œéœ€å¡«å¯«èª¤å·®å€¼</span>
                    
                    {/* è¼¸å…¥æ¡†åªåœ¨å‹¾é¸æ™‚å‡ºç¾ */}
                    {hasFloorError && (
                      <div className="mt-3 flex items-center gap-2 animate-in fade-in slide-in-from-top-2">
                        <label className="text-sm font-bold text-gray-700 whitespace-nowrap">é«˜ä½è½å·®ï¼š</label>
                        <input 
                          type="number" 
                          value={floorDiff}
                          onChange={(e) => setFloorDiff(e.target.value)}
                          placeholder="0.5"
                          className="w-24 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none bg-white"
                          autoFocus
                        />
                        <span className="text-sm text-gray-500">cm</span>
                      </div>
                    )}
                  </div>
                </label>

              </div>
            </div>
          )}

        </div>

        {/* åº•éƒ¨æŒ‰éˆ• */}
        <div className="p-5 border-t border-gray-100 flex justify-end gap-3 bg-gray-50">
          {step === 2 && (
            <button 
              onClick={() => setStep(1)}
              className="px-5 py-2.5 rounded-xl font-bold text-gray-600 hover:bg-gray-200 transition-colors"
            >
              ä¸Šä¸€æ­¥
            </button>
          )}
          <button 
            onClick={step === 1 ? handleNext : handleConfirm}
            className="px-8 py-2.5 bg-gray-900 hover:bg-black text-white rounded-xl font-bold transition-colors shadow-lg flex items-center gap-2"
          >
            {step === 1 ? 'ä¸‹ä¸€æ­¥' : <><Check className="w-4 h-4" /> å®Œæˆä¸¦åŠ å…¥</>}
          </button>
        </div>

      </div>
    </div>
  );
}
</file>

<file path="frontend/src/components/Navbar.tsx">
'use client';

import Link from 'next/link';
import { useRouter, usePathname } from 'next/navigation'; // âœ¨ æ–°å¢ usePathname
import { useState, useEffect } from 'react';
// å¼•å…¥åœ–ç¤º
import { ShoppingCart, Search, User, LogOut, History, Wallet, UserCog, Package, Menu, X, AlertTriangle, ShieldAlert } from 'lucide-react';
import { useCart } from '@/context/CartContext';
import Modal from '@/components/Modal';

export default function Navbar() {
  const router = useRouter();
  const pathname = usePathname(); // âœ¨ å–å¾—ç•¶å‰è·¯å¾‘
  const { cartCount, clearCart } = useCart();
  const [mounted, setMounted] = useState(false);
  const [user, setUser] = useState<any>(null);
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  
  const [showLogoutModal, setShowLogoutModal] = useState(false);
  const [showPendingModal, setShowPendingModal] = useState(false);

  useEffect(() => {
    setMounted(true);
    
    // âœ¨ æŠ½å–å‡ºæª¢æŸ¥é‚è¼¯ï¼Œä¸¦ç¢ºä¿æ¯æ¬¡è·¯å¾‘æ”¹è®Šæ™‚éƒ½åŸ·è¡Œ
    const checkAuth = () => {
      const storedUser = localStorage.getItem('somalink_user') || sessionStorage.getItem('somalink_user');
      if (storedUser) {
        try { 
          setUser(JSON.parse(storedUser)); 
        } catch (e) {
          setUser(null);
        }
      } else {
        setUser(null); // ç¢ºä¿ç™»å‡ºå¾Œç‹€æ…‹å³æ™‚æ¸…ç©º
      }
    };

    checkAuth();
  }, [pathname]); // âœ¨ é—œéµä¿®æ­£ï¼šå°‡ pathname åŠ å…¥ä¾è³´ï¼Œåˆ‡æ›é é¢æ™‚è‡ªå‹•æ›´æ–°ç‹€æ…‹

  const handleLogout = () => {
    localStorage.removeItem('somalink_token');
    localStorage.removeItem('somalink_user');
    sessionStorage.removeItem('somalink_token');
    sessionStorage.removeItem('somalink_user');
    
    clearCart();

    setUser(null);
    setShowLogoutModal(false);
    router.push('/login'); 
  };

  // å—ä¿è­·çš„å°èˆªè™•ç† (å¢åŠ å¯©æ ¸ç‹€æ…‹æª¢æŸ¥)
  const handleProtectedNav = (path: string) => {
    if (!user) {
      router.push('/login');
      return;
    }

    // å¦‚æœå¸³è™Ÿå°šæœªé–‹é€š (isActive ç‚º false)ï¼Œé˜»æ­¢é€²å…¥ä¸¦é¡¯ç¤ºæç¤º
    if (user.isActive === false) {
      setShowPendingModal(true);
      return;
    }

    router.push(path);
  };

  if (!mounted) return <div className="h-16 bg-white border-b border-gray-200"></div>;

  return (
    <>
      <nav className="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm h-16">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-full">
          <div className="flex justify-between items-center h-full gap-4">
            
            {/* 1. å·¦å´ LOGO */}
            <Link href={user ? "/portal" : "/"} className="flex items-center gap-2 shrink-0 hover:opacity-80 transition-opacity">
              <div className="bg-blue-600 w-8 h-8 rounded-lg flex items-center justify-center text-white font-bold text-lg shadow-blue-200 shadow-md">
                S
              </div>
              <span className="font-bold text-xl tracking-tight text-gray-900 hidden sm:block">SomaLink</span>
            </Link>

            {/* 2. ä¸­é–“ æœå°‹æ¡† */}
            <div className="flex-1 max-w-md hidden md:block relative">
              <input 
                type="text" 
                placeholder="æœå°‹ç”¢å“å‹è™Ÿ..." 
                className="w-full pl-10 pr-4 py-2 bg-gray-50 border border-gray-300 rounded-full text-sm shadow-sm focus:bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all outline-none placeholder:text-gray-400 text-gray-800" 
              />
              <Search className="w-4 h-4 text-gray-500 absolute left-3 top-2.5" />
            </div>

            {/* 3. å³å´ åŠŸèƒ½é¸å–® (é›»è…¦ç‰ˆ) */}
            <div className="hidden md:flex items-center gap-3 sm:gap-5">
              
              {/* æ­·å²è¨‚å–® */}
              <button 
                onClick={() => handleProtectedNav('/orders')}
                className="flex flex-col items-center text-gray-500 hover:text-blue-600 transition-colors group"
              >
                <History className="w-5 h-5 mb-0.5" />
                <span className="text-[10px] font-medium">æ­·å²è¨‚å–®</span>
              </button>

              {/* è³¼ç‰©è»Š */}
              <button 
                onClick={() => handleProtectedNav('/cart')}
                className="relative flex flex-col items-center text-gray-500 hover:text-blue-600 transition-colors group"
              >
                <div className="relative">
                  <ShoppingCart className="w-5 h-5" />
                  {user && cartCount > 0 && (
                    <span className="absolute -top-1.5 -right-1.5 inline-flex items-center justify-center w-4 h-4 text-[10px] font-bold text-white bg-red-500 rounded-full border-2 border-white animate-in zoom-in duration-300">
                      {cartCount}
                    </span>
                  )}
                </div>
                <span className="text-[10px] font-medium mt-0.5">è³¼ç‰©è»Š</span>
              </button>

              <div className="h-8 w-px bg-gray-200 mx-1"></div>

              {/* æœƒå“¡å€åŸŸ */}
              {user ? (
                <div className="flex items-center gap-2">
                  
                  {/* éŒ¢åŒ…é¤˜é¡ (åƒ… A/B ç´šé¡¯ç¤º) */}
                  {(user.dealerProfile?.level === 'A' || user.dealerProfile?.level === 'B') && (
                    <div className="flex flex-col items-end mr-2 px-3 py-1 bg-blue-50 rounded-lg border border-blue-100">
                      <span className="text-[10px] text-gray-500 flex items-center gap-1 font-medium">
                        <Wallet className="w-3 h-3 text-blue-500" /> éŒ¢åŒ…é¤˜é¡
                      </span>
                      <span className="text-sm font-bold text-blue-700 font-mono">
                        ${Number(user.dealerProfile?.walletBalance || 0).toLocaleString()}
                      </span>
                    </div>
                  )}

                  {/* å…¬å¸åç¨± + Email */}
                  <div className="text-right mr-2">
                    <div className="flex items-center justify-end gap-1">
                      <p className="text-xs font-bold text-gray-900 truncate max-w-[150px]">
                        {user.dealerProfile?.companyName || 'æœªè¨­å®šå…¬å¸åç¨±'}
                      </p>
                      {/* è‹¥æœªé–‹é€šï¼Œé¡¯ç¤ºæ¨™ç±¤ */}
                      {user.isActive === false && (
                        <span className="text-[10px] px-1.5 py-0.5 bg-yellow-100 text-yellow-700 rounded font-bold border border-yellow-200 flex items-center gap-0.5">
                          <AlertTriangle className="w-3 h-3" /> å¯©æ ¸ä¸­
                        </span>
                      )}
                    </div>
                    <p className="text-[10px] text-gray-500 truncate max-w-[150px]">
                      {user.email}
                    </p>
                  </div>

                  <Link href="/profile" className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-colors" title="æœƒå“¡è³‡æ–™è¨­å®š">
                    <UserCog className="w-5 h-5" />
                  </Link>

                  <button onClick={() => setShowLogoutModal(true)} className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full transition-colors" title="ç™»å‡º">
                    <LogOut className="w-5 h-5" />
                  </button>
                </div>
              ) : (
                <div className="flex items-center gap-2">
                  <Link href="/login" className="flex items-center gap-1 text-gray-600 hover:text-gray-900 font-bold text-sm px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors">
                    <User className="w-4 h-4" />
                    ç™»å…¥
                  </Link>
                  <Link href="/register" className="bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-black transition-colors shadow-md">
                    è¨»å†Šç¶“éŠ·
                  </Link>
                </div>
              )}
            </div>

            {/* æ‰‹æ©Ÿç‰ˆæ¼¢å ¡é¸å–®æŒ‰éˆ• */}
            <div className="flex items-center md:hidden">
                <button onClick={() => setIsMenuOpen(!isMenuOpen)} className="p-2 text-gray-500 hover:bg-gray-100 rounded-lg">
                  {isMenuOpen ? <X className="w-6 h-6" /> : <Menu className="w-6 h-6" />}
                </button>
            </div>
          </div>
        </div>

        {/* æ‰‹æ©Ÿç‰ˆä¸‹æ‹‰é¸å–® */}
        {isMenuOpen && (
            <div className="md:hidden bg-white border-t border-gray-100 p-4 space-y-4 shadow-lg absolute w-full z-50">
              <Link href="/portal" className="block text-gray-600 font-medium py-2 px-2 hover:bg-gray-50 rounded-lg">
                ç”¢å“ç³»åˆ—
              </Link>
              {user ? (
                <>
                  <button onClick={() => handleProtectedNav('/orders')} className="w-full flex items-center gap-2 text-gray-600 font-medium py-2 px-2 hover:bg-gray-50 rounded-lg text-left">
                    <History className="w-4 h-4" /> æ­·å²è¨‚å–®
                  </button>
                  <button onClick={() => handleProtectedNav('/cart')} className="w-full flex items-center gap-2 text-gray-600 font-medium py-2 px-2 hover:bg-gray-50 rounded-lg text-left">
                    <ShoppingCart className="w-4 h-4" /> è³¼ç‰©è»Š ({cartCount})
                  </button>
                  <Link href="/profile" className="flex items-center gap-2 text-gray-600 font-medium py-2 px-2 hover:bg-gray-50 rounded-lg">
                    <UserCog className="w-4 h-4" /> æœƒå“¡è³‡æ–™
                  </Link>
                  
                  <div className="pt-4 border-t border-gray-100">
                    <div className="flex items-center gap-3 mb-4 px-2">
                      <div className="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold">
                        {user.name?.[0] || 'U'}
                      </div>
                      <div>
                        <div className="flex items-center gap-2">
                          <p className="text-sm font-bold text-gray-900">{user.dealerProfile?.companyName || user.name}</p>
                          {user.isActive === false && (
                            <span className="text-[10px] px-1.5 py-0.5 bg-yellow-100 text-yellow-700 rounded border border-yellow-200">
                              å¾…å¯©æ ¸
                            </span>
                          )}
                        </div>
                        <p className="text-xs text-gray-500">{user.email}</p>
                      </div>
                    </div>
                    <button 
                      onClick={() => setShowLogoutModal(true)} 
                      className="w-full text-left flex items-center gap-2 text-red-500 text-sm font-bold py-2 px-2 hover:bg-red-50 rounded-lg"
                    >
                      <LogOut className="w-4 h-4" /> ç™»å‡ºç³»çµ±
                    </button>
                  </div>
                </>
              ) : (
                <div className="grid grid-cols-2 gap-3 pt-2">
                  <Link href="/login" className="text-center py-2.5 border border-gray-300 rounded-xl font-bold text-gray-700">
                    ç™»å…¥
                  </Link>
                  <Link href="/register" className="text-center py-2.5 bg-blue-600 text-white rounded-xl font-bold">
                    è¨»å†Š
                  </Link>
                </div>
              )}
            </div>
        )}
      </nav>

      {/* ç™»å‡ºç¢ºèªå½ˆçª— */}
      <Modal 
        isOpen={showLogoutModal} 
        onClose={() => setShowLogoutModal(false)}
        type="confirm"
        title="ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ"
        message="ç™»å‡ºå¾Œç³»çµ±å°‡è‡ªå‹•æ¸…ç©ºæ‚¨çš„è³¼ç‰©è»Šã€‚"
        confirmText="ç¢ºèªç™»å‡º"
        onConfirm={handleLogout}
      />

      {/* å¸³è™Ÿå¯©æ ¸ä¸­æç¤ºå½ˆçª— */}
      <Modal 
        isOpen={showPendingModal}
        onClose={() => setShowPendingModal(false)}
        type="warning"
        title="å¸³è™Ÿå¯©æ ¸ä¸­"
        message={
          <div className="text-center">
            <p className="mb-2">æ‚¨çš„ç¶“éŠ·å•†è³‡æ ¼ç›®å‰æ­£åœ¨å¯©æ ¸ä¸­ã€‚</p>
            <p className="text-gray-500 text-xs">é–‹é€šå¾Œæ‚¨å°‡æœƒæ”¶åˆ° Email é€šçŸ¥ï¼Œå±†æ™‚å³å¯ä½¿ç”¨è³¼ç‰©è»Šèˆ‡è¨‚å–®åŠŸèƒ½ã€‚</p>
            <div className="mt-4 p-3 bg-gray-50 rounded-lg text-xs text-gray-600 text-left">
              <p className="font-bold mb-1">è¯çµ¡å®¢æœåŠ é€Ÿå¯©æ ¸ï¼š</p>
              <p>é›»è©±ï¼š(02) 2345-6789</p>
              <p>Line IDï¼š@somalink</p>
            </div>
          </div>
        }
        confirmText="äº†è§£"
      />
    </>
  );
}
</file>

<file path="frontend/tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": false,               // âœ¨ é—œé–‰åš´æ ¼æ¨¡å¼
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./src/*"]
    },
    // âœ¨âœ¨âœ¨ æ–°å¢ä»¥ä¸‹å¯¬é¬†è¨­å®š âœ¨âœ¨âœ¨
    "noImplicitAny": false,        // å…è¨±éš±å«çš„ any
    "noUnusedLocals": false,       // å…è¨±æœªä½¿ç”¨çš„è®Šæ•¸
    "noUnusedParameters": false,   // å…è¨±æœªä½¿ç”¨çš„åƒæ•¸
    "strictNullChecks": false      // é—œé–‰åš´æ ¼çš„ null æª¢æŸ¥
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
</file>

<file path="admin/src/app/login/page.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { api } from '@/lib/api';
import { Loader2, Lock, ShieldCheck, AlertCircle } from 'lucide-react';

export default function AdminLoginPage() {
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(false);
  const [errorMsg, setErrorMsg] = useState<string | null>(null);
  
  const [formData, setFormData] = useState({
    email: '',
    password: ''
  });

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);
    setErrorMsg(null);

    try {
      // 1. å‘¼å«å¾Œç«¯ç™»å…¥
      // âœ¨ Fix: api.post å·²ç¶“å›å‚³ dataï¼Œæ‰€ä»¥ç›´æ¥è§£æ§‹å³å¯ï¼Œä¸éœ€è¦å†å¯« .data
      const data = await api.post('/auth/login', formData);
      const { access_token, user } = data;

      // 2. æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
      // âœ¨ Fix: åŒæ™‚å…è¨±å¤§å¯« ADMIN (å¾Œç«¯é è¨­) èˆ‡å°å¯« admin
      if (user.role !== 'ADMIN' && user.role !== 'admin') {
        setErrorMsg('æ¬Šé™ä¸è¶³ï¼šæ‚¨ä¸æ˜¯ç³»çµ±ç®¡ç†å“¡');
        setIsLoading(false);
        return;
      }

      // 3. å„²å­˜ Token
      localStorage.setItem('somalink_admin_token', access_token);
      localStorage.setItem('somalink_admin_user', JSON.stringify(user));
      
      // 4. é€²å…¥æˆ°æƒ…å®¤
      router.push('/');

    } catch (err: any) {
      console.error('ç™»å…¥å¤±æ•—:', err);
      if (err.response?.status === 401) {
        setErrorMsg('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤');
      } else {
        // é¡¯ç¤ºå…·é«”çš„éŒ¯èª¤è¨Šæ¯ï¼Œæ–¹ä¾¿é™¤éŒ¯
        setErrorMsg(err.message || 'ç³»çµ±é€£ç·šéŒ¯èª¤');
      }
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-slate-900 px-4 font-sans">
      <div className="max-w-md w-full space-y-8 bg-white p-10 rounded-2xl shadow-2xl">
        
        <div className="text-center">
          <div className="mx-auto h-16 w-16 bg-slate-800 rounded-xl flex items-center justify-center text-white mb-6 shadow-lg">
            <ShieldCheck className="w-8 h-8" />
          </div>
          <h2 className="text-3xl font-extrabold text-slate-900">
            æ¾æˆæœ‰é™å…¬å¸
          </h2>
          <p className="mt-2 text-sm text-slate-500 font-medium tracking-wide uppercase">
            å·¥å» ç®¡ç†å¾Œå°
          </p>
        </div>

        {errorMsg && (
          <div className="bg-red-50 border border-red-200 rounded-lg p-4 flex items-start gap-3">
            <AlertCircle className="w-5 h-5 text-red-600 mt-0.5 shrink-0" />
            <p className="text-sm text-red-700 font-medium">{errorMsg}</p>
          </div>
        )}

        <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
          <div className="space-y-5">
            <div>
              <label className="block text-sm font-bold text-slate-700 mb-1">ç®¡ç†å“¡å¸³è™Ÿ</label>
              <input
                type="email"
                required
                className="block w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none transition-all"
                placeholder="admin@somalink.com"
                value={formData.email}
                onChange={(e) => setFormData({...formData, email: e.target.value})}
              />
            </div>

            <div>
              <label className="block text-sm font-bold text-slate-700 mb-1">å¯†ç¢¼</label>
              <div className="relative">
                <input
                  type="password"
                  required
                  className="block w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none transition-all"
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                  value={formData.password}
                  onChange={(e) => setFormData({...formData, password: e.target.value})}
                />
                <Lock className="absolute right-3 top-3.5 w-5 h-5 text-gray-400" />
              </div>
            </div>
          </div>

          <button
            type="submit"
            disabled={isLoading}
            className="w-full flex justify-center py-3.5 px-4 border border-transparent rounded-xl text-sm font-bold text-white bg-slate-900 hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 disabled:opacity-70 transition-all shadow-lg"
          >
            {isLoading ? <Loader2 className="animate-spin" /> : 'é€²å…¥å¾Œå°ç³»çµ±'}
          </button>
        </form>
        
        <div className="text-center text-xs text-gray-400 mt-4">
          æ­¤å€åŸŸåƒ…é™æˆæ¬Šäººå“¡é€²å…¥ï¼ŒIP ä½ç½®å°‡è¢«è¨˜éŒ„ã€‚
        </div>
      </div>
    </div>
  );
}
</file>

<file path="admin/src/app/orders/[id]/print/page.tsx">
'use client';

import { useEffect, useState, use } from 'react';
import { api } from '@/lib/api';
import { Loader2, Printer, MapPin, Phone, User, MessageSquare } from 'lucide-react';

export default function PrintDeliveryNotePage({ params }: { params: Promise<{ id: string }> }) {
  const { id } = use(params);
  const [order, setOrder] = useState<any>(null);
  const [showPrice, setShowPrice] = useState(true); 

  useEffect(() => {
    api.get(`/orders/${id}`).then(res => setOrder(res)).catch(console.error);
  }, [id]);

  if (!order) return <div className="flex justify-center p-12"><Loader2 className="animate-spin w-8 h-8 text-blue-600" /></div>;

  return (
    <div className="min-h-screen bg-gray-100 p-8 print:p-0 print:bg-white">
      
      {/* æ§åˆ¶åˆ— (åˆ—å°æ™‚éš±è—) */}
      <div className="max-w-[210mm] mx-auto mb-6 flex justify-between items-center print:hidden bg-white p-4 rounded-lg shadow-sm border border-gray-200">
        <div className="flex items-center gap-3">
          <label className="flex items-center gap-2 cursor-pointer select-none">
            <input 
              type="checkbox" 
              checked={showPrice} 
              onChange={(e) => setShowPrice(e.target.checked)}
              className="w-4 h-4 text-blue-600 rounded cursor-pointer" 
            />
            <span className="text-sm text-gray-700 font-medium">é¡¯ç¤ºé‡‘é¡</span>
          </label>
          <span className="text-xs text-gray-400">| (çµ¦å¸æ©Ÿæˆ–ç¾å ´çœ‹çš„å–®æ“šå¯å–æ¶ˆå‹¾é¸)</span>
        </div>
        <button 
          onClick={() => window.print()}
          className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-sm transition-colors"
        >
          <Printer className="w-4 h-4" /> åˆ—å° / å­˜ç‚º PDF
        </button>
      </div>

      {/* A4 ç´™å¼µå€åŸŸ - çœç´™æ¨¡å¼ï¼šç§»é™¤å›ºå®šé«˜åº¦ï¼Œæ”¹ç‚ºè‡ªå‹•é©æ‡‰å…§å®¹ */}
      <div className="max-w-[210mm] mx-auto bg-white shadow-xl print:shadow-none p-8 print:p-6 text-black font-sans relative box-border print:h-auto print:min-h-0">
        
        {/* Header */}
        <div className="flex justify-between items-start border-b-4 border-black pb-4 mb-4">
          <div className="flex items-center gap-4">
            <div className="w-14 h-14 bg-black text-white flex items-center justify-center text-2xl font-bold rounded-lg print:border print:border-black">S</div>
            <div>
              <h1 className="text-2xl font-extrabold tracking-wider text-black">å‡ºè²¨å–®</h1>
              <p className="text-sm font-bold mt-1 text-black">æ¾æˆæœ‰é™å…¬å¸</p>
              <div className="flex gap-4 text-xs text-black font-medium mt-0.5">
                <span>çµ±ç·¨ï¼š12345678</span>
                <span>é›»è©±ï¼š(02) 2345-6789</span>
              </div>
            </div>
          </div>
          <div className="text-right">
            <div className="inline-block border-2 border-black px-3 py-1 rounded mb-1">
              <p className="text-[10px] font-bold uppercase tracking-wide text-black">å‡ºè²¨å–®è™Ÿ NO.</p>
              <p className="text-lg font-mono font-bold text-black leading-none">{order.orderNumber}</p>
            </div>
            <p className="text-xs mt-1 text-black font-medium">åˆ—å°æ—¥æœŸï¼š{new Date().toLocaleDateString()}</p>
          </div>
        </div>

        {/* å®¢æˆ¶èˆ‡é€è²¨è³‡è¨Š */}
        <div className="grid grid-cols-2 gap-4 mb-4 break-inside-avoid">
          <div className="border-2 border-black rounded p-3">
            <h3 className="text-xs font-bold bg-gray-200 px-2 py-0.5 mb-2 inline-block rounded text-black print:border print:border-black">è¨‚è³¼ç¶“éŠ·å•† (Bill To)</h3>
            <div className="space-y-0.5 text-sm text-black">
              <p><span className="font-bold w-16 inline-block">å…¬å¸åç¨±ï¼š</span><span className="font-bold">{order.user?.dealerProfile?.companyName}</span></p>
              <p><span className="font-bold w-16 inline-block">è¯çµ¡äººï¼š</span>{order.user?.dealerProfile?.contactPerson}</p>
              <p><span className="font-bold w-16 inline-block">é›»è©±ï¼š</span>{order.user?.dealerProfile?.phone}</p>
            </div>
          </div>
          <div className="border-2 border-black rounded p-3">
            <h3 className="text-xs font-bold bg-gray-200 px-2 py-0.5 mb-2 inline-block rounded text-black print:border print:border-black">é€è²¨è³‡è¨Š (Ship To)</h3>
            <div className="space-y-0.5 text-sm text-black">
              <div className="mb-1">
                <p className="text-[10px] font-bold text-black">æ¡ˆå ´åç¨±</p>
                <p className="font-bold text-base leading-tight">{order.projectName}</p>
              </div>
              <div className="flex items-start gap-1 mb-1">
                <MapPin className="w-3.5 h-3.5 mt-0.5 text-black shrink-0" />
                <span className="font-bold border-b border-black pb-0 text-sm leading-tight">{order.shippingAddress || 'æœªæŒ‡å®šåœ°å€ (åŒç¶“éŠ·å•†)'}</span>
              </div>
              <div className="grid grid-cols-2 gap-1 text-xs">
                <p className="flex items-center font-medium"><User className="w-3 h-3 mr-1 text-black" /> {order.siteContactPerson || order.user?.dealerProfile?.contactPerson}</p>
                <p className="flex items-center font-medium"><Phone className="w-3 h-3 mr-1 text-black" /> {order.siteContactPhone || order.user?.dealerProfile?.phone}</p>
              </div>
            </div>
          </div>
        </div>

        {/* è¨‚å–®å‚™è¨» */}
        {order.customerNote && (
          <div className="mb-4 border-2 border-black bg-gray-50 p-2 rounded text-sm flex items-start gap-2 break-inside-avoid">
            <MessageSquare className="w-4 h-4 text-black mt-0.5 shrink-0" />
            <div className="text-black">
              <span className="font-bold mr-2">è¨‚å–®å‚™è¨»ï¼š</span>
              <span className="font-medium">{order.customerNote}</span>
            </div>
          </div>
        )}

        {/* ç”¢å“æ˜ç´° - ä¸å†å¼·åˆ¶æ¨åˆ°åº•éƒ¨ */}
        <div className="mb-4">
          <table className="w-full border-collapse">
            <thead>
              <tr className="bg-gray-200 border-y-2 border-black text-xs text-black">
                <th className="py-1 px-2 text-left w-8 font-bold">#</th>
                <th className="py-1 px-2 text-left font-bold">ç”¢å“åç¨± / è©³ç´°è¦æ ¼</th>
                <th className="py-1 px-2 text-center w-16 font-bold">æ•¸é‡</th>
                {showPrice && <th className="py-1 px-2 text-right w-24 font-bold">å–®åƒ¹</th>}
                {showPrice && <th className="py-1 px-2 text-right w-24 font-bold">é‡‘é¡</th>}
              </tr>
            </thead>
            <tbody className="text-sm text-black">
              {order.items?.map((item: any, index: number) => (
                <tr key={index} className="border-b border-black break-inside-avoid">
                  <td className="py-2 px-2 align-top font-bold text-center">{index + 1}</td>
                  <td className="py-2 px-2 align-top">
                    <p className="font-bold text-sm">{item.product?.name}</p>
                    <div className="text-black text-[10px] mt-1 grid grid-cols-2 gap-x-2 gap-y-0.5 font-mono font-medium">
                      <p>å‹è™Ÿ: {item.product?.sku}</p>
                      <p>é¡è‰²: {item.colorName}</p>
                      <p>æè³ª: {item.materialName}</p>
                      <p>é–‹å‘: {item.openingDirection}</p>
                      <p>æ¨¡å¼: {item.serviceType === 'assembled' ? 'é€£å·¥å¸¶æ–™' : 'ç´”ææ–™'}</p>
                      {item.handleName && <p className="col-span-2 font-bold text-blue-900">æŠŠæ‰‹: {item.handleName}</p>}
                    </div>
                    <div className="mt-1 bg-white px-1.5 py-0.5 rounded inline-block text-[10px] font-mono border border-black font-bold">
                      W: {item.widthMatrix?.mid} x H: {item.heightData?.singleValue || item.heightData?.mid}
                      {item.isCeilingMounted && <span className="ml-1 text-black font-extrabold">(å°é ‚)</span>}
                    </div>
                  </td>
                  <td className="py-2 px-2 text-center align-top font-bold">{item.quantity}</td>
                  {showPrice && <td className="py-2 px-2 text-right align-top font-mono font-medium">${Number(item.unitPrice || item.subtotal / item.quantity).toLocaleString()}</td>}
                  {showPrice && <td className="py-2 px-2 text-right align-top font-bold font-mono">${Number(item.subtotal).toLocaleString()}</td>}
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        {/* ç¸½è¨ˆèˆ‡ç°½å - ç¢ºä¿è·Ÿéš¨å…§å®¹ */}
        <div className="break-inside-avoid">
          {showPrice && (
            <div className="flex justify-end mb-6 border-t-2 border-black pt-2">
              <div className="text-right">
                <p className="text-xs font-bold text-black">ç¸½è¨ˆé‡‘é¡ (å«ç¨…)</p>
                <p className="text-2xl font-extrabold text-black">NT$ {Number(order.totalAmount).toLocaleString()}</p>
              </div>
            </div>
          )}

          <div className="mt-4 pt-4 border-t border-dashed border-gray-400">
            <div className="grid grid-cols-3 gap-8">
              <div className="text-center">
                <p className="text-xs font-bold mb-6 text-black">å€‰ç®¡å‚™è²¨</p>
                <div className="border-b-2 border-black w-3/4 mx-auto"></div>
              </div>
              <div className="text-center">
                <p className="text-xs font-bold mb-6 text-black">å¸æ©Ÿé…é€</p>
                <div className="border-b-2 border-black w-3/4 mx-auto"></div>
              </div>
              <div className="text-center">
                <p className="text-xs font-bold mb-6 text-black">å®¢æˆ¶ç°½æ”¶</p>
                <div className="border-b-2 border-black w-3/4 mx-auto"></div>
                <p className="text-[9px] text-black font-bold mt-1">æœ¬äººç¢ºèªä¸Šè¿°è¦æ ¼èˆ‡æ•¸é‡ç„¡èª¤</p>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  );
}
</file>

<file path="admin/src/app/products/page.tsx">
'use client';

import { useEffect, useState } from 'react';
import { Plus, Package, Edit, Trash2, Search, Image as ImageIcon } from 'lucide-react';
import Link from 'next/link';
import { api } from '@/lib/api';

export default function ProductsPage() {
  const [products, setProducts] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');

  const fetchProducts = async () => {
    try {
      // âœ¨ ä¿®æ­£ï¼šç›´æ¥ä½¿ç”¨ resï¼Œä¸è¦å†å¯« .data (å› ç‚º api.ts å·²è™•ç†)
      const res = await api.get('/products');
      
      if (Array.isArray(res)) {
        setProducts(res);
      } else {
        console.warn('API å›å‚³æ ¼å¼ç•°å¸¸:', res);
        setProducts([]);
      }
    } catch (err) { 
      console.error('ç„¡æ³•å–å¾—ç”¢å“åˆ—è¡¨:', err);
      setProducts([]); 
    } finally { 
      setLoading(false); 
    }
  };

  useEffect(() => { fetchProducts(); }, []);

  const handleDelete = async (id: string) => {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç”¢å“å—ï¼Ÿ(æ­¤æ“ä½œç„¡æ³•å¾©åŸ)')) return;
    try {
      await api.delete(`/products/${id}`);
      alert('åˆªé™¤æˆåŠŸ');
      fetchProducts(); // é‡æ•´åˆ—è¡¨
    } catch (err) {
      alert('åˆªé™¤å¤±æ•—');
    }
  };

  // ç°¡å–®çš„å‰ç«¯æœå°‹éæ¿¾
  const filteredProducts = products.filter(p => 
    p.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
    p.sku.toLowerCase().includes(searchTerm.toLowerCase())
  );

  return (
    <div className="min-h-screen bg-gray-50 p-8 font-sans">
      <div className="flex justify-between items-center mb-8">
        <div>
          <h1 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
            <Package className="w-6 h-6 text-blue-600" /> ç”¢å“ç®¡ç†
          </h1>
          <p className="text-gray-500 text-sm mt-1">ç®¡ç†æ‰€æœ‰ä¸Šæ¶çš„é–€æ¬¾ã€åƒ¹æ ¼èˆ‡å®¢è£½åŒ–é¸é …</p>
        </div>
        <Link href="/products/new" className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-sm font-bold">
          <Plus className="w-5 h-5" /> æ–°å¢ç”¢å“
        </Link>
      </div>

      <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div className="p-4 border-b border-gray-100 bg-gray-50/50">
          <div className="relative max-w-sm">
            <Search className="absolute left-3 top-2.5 w-4 h-4 text-gray-400" />
            <input 
              type="text" 
              placeholder="æœå°‹ç”¢å“åç¨±æˆ–å‹è™Ÿ..." 
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" 
            />
          </div>
        </div>

        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">åœ–ç‰‡</th>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">ç”¢å“è³‡è¨Š</th>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">ç³»åˆ—</th>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">åŸºç¤åƒ¹æ ¼</th>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">å°ºå¯¸è¦æ ¼</th>
              <th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-gray-200">
            {loading ? (
              <tr><td colSpan={6} className="text-center py-12 text-gray-500">è¼‰å…¥ä¸­...</td></tr>
            ) : filteredProducts.length === 0 ? (
              <tr><td colSpan={6} className="text-center py-12 text-gray-500">å°šç„¡ç”¢å“</td></tr>
            ) : (
              filteredProducts.map((product) => {
                // âœ¨ åœ–ç‰‡é¡¯ç¤ºé‚è¼¯ï¼šå„ªå…ˆç”¨æ–°é™£åˆ—çš„ç¬¬ä¸€å¼µï¼Œæ²’æœ‰å°±ç”¨èˆŠæ¬„ä½ï¼Œå†æ²’æœ‰å°±é¡¯ç¤ºåœ–ç¤º
                const thumb = product.images?.[0] || product.imageUrl;

                return (
                  <tr key={product.id} className="hover:bg-blue-50/30 transition-colors group">
                    <td className="px-6 py-4">
                      <div className="w-12 h-12 bg-gray-100 rounded-lg border border-gray-200 overflow-hidden flex items-center justify-center">
                        {thumb ? (
                          // eslint-disable-next-line @next/next/no-img-element
                          <img src={thumb} alt={product.name} className="w-full h-full object-cover" />
                        ) : (
                          <ImageIcon className="w-5 h-5 text-gray-400" />
                        )}
                      </div>
                    </td>
                    <td className="px-6 py-4">
                      <div>
                        <div className="font-bold text-gray-900">{product.name}</div>
                        <div className="text-xs text-gray-500 font-mono">{product.sku}</div>
                      </div>
                    </td>
                    <td className="px-6 py-4">
                      <span className="px-2 py-1 rounded bg-gray-100 text-xs text-gray-600 border border-gray-200">
                        {product.series}
                      </span>
                    </td>
                    <td className="px-6 py-4 font-bold text-blue-600 font-mono">
                      ${Number(product.basePrice).toLocaleString()}
                    </td>
                    <td className="px-6 py-4 text-sm text-gray-600 font-mono">
                      {product.standardWidth} x {product.standardHeight}
                      {product.requiresMeasurement && <span className="ml-2 text-xs text-orange-500 bg-orange-50 px-1 rounded">å®¢è£½</span>}
                    </td>
                    <td className="px-6 py-4 text-right">
                      <div className="flex justify-end gap-3">
                        <Link href={`/products/${product.id}`} className="text-gray-400 hover:text-blue-600 transition-colors" title="ç·¨è¼¯">
                          <Edit className="w-4 h-4" />
                        </Link>
                        <button onClick={() => handleDelete(product.id)} className="text-gray-400 hover:text-red-600 transition-colors" title="åˆªé™¤">
                          <Trash2 className="w-4 h-4" />
                        </button>
                      </div>
                    </td>
                  </tr>
                );
              })
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}
</file>

<file path="admin/src/app/reports/page.tsx">
'use client';

import { useEffect, useState } from 'react';
import { BarChart3, TrendingUp, DollarSign, Package, Trophy, Palette, Loader2 } from 'lucide-react';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, PieChart, Pie, Cell, Legend } from 'recharts';
import { api } from '@/lib/api';

const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8'];

const STATUS_LABEL: Record<string, string> = {
  pending: 'å¾…å¯©æ ¸',
  processing: 'ç”Ÿç”¢ä¸­',
  shipped: 'å·²å‡ºè²¨',
  completed: 'å·²å®Œæˆ',
  cancelled: 'å·²å–æ¶ˆ'
};

export default function ReportsPage() {
  const [data, setData] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  
  // âœ¨ æ–°å¢ï¼šç”¨æ–¼å»¶é²æ¸²æŸ“åœ–è¡¨ï¼Œç›´åˆ°çµ„ä»¶æ›è¼‰å®Œæˆ
  const [isChartReady, setIsChartReady] = useState(false);

  useEffect(() => {
    // å»¶é²è¨­å®š isChartReady ç‚º trueï¼Œçµ¦ç€è¦½å™¨è¶³å¤ æ™‚é–“è¨ˆç®— CSS ä½ˆå±€
    const timer = setTimeout(() => {
      setIsChartReady(true);
    }, 50); // 50ms å»¶é²è¶³å¤ è§£æ±ºå¤§éƒ¨åˆ†æ¸²æŸ“æ™‚åºå•é¡Œ

    const fetchData = async () => {
      try {
        const res = await api.get('/reports/dashboard');
        setData(res);
      } catch (err) {
        console.error(err);
      } finally {
        setLoading(false);
      }
    };
    fetchData();

    return () => clearTimeout(timer);
  }, []);

  if (loading) return <div className="p-12 text-center text-gray-500 min-h-screen flex items-center justify-center"><Loader2 className="animate-spin w-10 h-10 text-blue-600" /></div>;
  
  if (!data) return <div className="p-12 text-center text-gray-500">æš«ç„¡æ•¸æ“š (ç„¡æ³•è®€å– API å›å‚³å€¼)</div>;

  const pieData = data.statusDist?.map((item: any) => ({
    name: STATUS_LABEL[item.status] || item.status,
    value: Number(item.count)
  })) || [];

  return (
    <div className="min-h-screen bg-gray-50 p-8 font-sans">
      
      <div className="mb-8">
        <h1 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
          <div className="p-2 bg-indigo-100 rounded-lg"><BarChart3 className="w-6 h-6 text-indigo-600" /></div>
          ç‡Ÿé‹å ±è¡¨ä¸­å¿ƒ
        </h1>
        <p className="text-gray-500 text-sm mt-1">å³æ™‚åˆ†æå·¥å» ç‡Ÿæ”¶èˆ‡è¨‚å–®åˆ†ä½ˆ</p>
      </div>

      {/* 1. æ ¸å¿ƒæŒ‡æ¨™ (KPI) */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <div className="flex items-center gap-3 mb-2">
            <div className="p-2 bg-green-100 rounded-full"><DollarSign className="w-5 h-5 text-green-600" /></div>
            <h3 className="text-gray-500 font-bold text-sm">ç¸½ç‡Ÿæ¥­é¡ (Revenue)</h3>
          </div>
          <p className="text-4xl font-bold text-gray-900">${Number(data.totalRevenue || 0).toLocaleString()}</p>
        </div>

        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <div className="flex items-center gap-3 mb-2">
            <div className="p-2 bg-blue-100 rounded-full"><Package className="w-5 h-5 text-blue-600" /></div>
            <h3 className="text-gray-500 font-bold text-sm">ç¸½è¨‚å–®æ•¸ (Orders)</h3>
          </div>
          <p className="text-4xl font-bold text-gray-900">{data.totalOrders || 0}</p>
        </div>

        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <div className="flex items-center gap-3 mb-2">
            <div className="p-2 bg-purple-100 rounded-full"><TrendingUp className="w-5 h-5 text-purple-600" /></div>
            <h3 className="text-gray-500 font-bold text-sm">å¹³å‡å®¢å–®åƒ¹</h3>
          </div>
          <p className="text-4xl font-bold text-gray-900">
            ${(data.totalOrders > 0 ? Math.round(data.totalRevenue / data.totalOrders) : 0).toLocaleString()}
          </p>
        </div>
      </div>

      {/* 2. åœ–è¡¨å€ - ç¢ºä¿å°ºå¯¸ç©©å®šæ€§ */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        
        {/* ç‡Ÿæ”¶è¶¨å‹¢åœ– (Bar Chart) */}
        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 min-w-0">
          <h3 className="text-lg font-bold text-gray-900 mb-6">è¿‘ 6 å€‹æœˆç‡Ÿæ”¶è¶¨å‹¢</h3>
          <div className="h-80 w-full"> 
            {isChartReady ? (
              <ResponsiveContainer width="100%" height="100%">
                <BarChart data={data.trendData || []}>
                  <CartesianGrid strokeDasharray="3 3" vertical={false} />
                  <XAxis dataKey="name" axisLine={false} tickLine={false} />
                  <YAxis axisLine={false} tickLine={false} />
                  <Tooltip 
                    formatter={(value: number) => [`$${value.toLocaleString()}`, 'ç‡Ÿæ”¶']}
                    contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 12px rgba(0,0,0,0.1)' }}
                  />
                  <Bar dataKey="total" fill="#4F46E5" radius={[4, 4, 0, 0]} barSize={40} />
                </BarChart>
              </ResponsiveContainer>
            ) : (
              <div className='flex items-center justify-center h-full'><Loader2 className='animate-spin text-gray-300' /></div>
            )}
          </div>
        </div>

        {/* è¨‚å–®ç‹€æ…‹åˆ†ä½ˆ (Pie Chart) */}
        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 min-w-0">
          <h3 className="text-lg font-bold text-gray-900 mb-6">è¨‚å–®ç‹€æ…‹åˆ†ä½ˆ</h3>
          <div className="h-80 w-full flex justify-center items-center"> 
            {isChartReady ? (
              <ResponsiveContainer width="100%" height="100%">
                <PieChart>
                  <Pie
                    data={pieData}
                    cx="50%"
                    cy="50%"
                    innerRadius={60}
                    outerRadius={100}
                    fill="#8884d8"
                    paddingAngle={5}
                    dataKey="value"
                    label={({name, percent}) => `${name} ${((percent || 0) * 100).toFixed(0)}%`}
                  >
                    {pieData.map((entry: any, index: number) => (
                      <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                    ))}
                  </Pie>
                  <Tooltip />
                  <Legend verticalAlign="bottom" height={36} />
                </PieChart>
              </ResponsiveContainer>
            ) : (
              <div className='flex items-center justify-center h-full'><Loader2 className='animate-spin text-gray-300' /></div>
            )}
          </div>
        </div>
      </div>

      {/* 3. ç†±éŠ·æ’è¡Œæ¦œ (Top 5) */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        {/* ç†±éŠ·ç”¢å“ (è¡¨æ ¼éƒ¨åˆ†ä¸éœ€è¦ isChartReady æ§åˆ¶) */}
        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden min-w-0">
          <div className="p-6 border-b border-gray-100 flex items-center gap-2">
            <Trophy className="w-5 h-5 text-yellow-500" />
            <h3 className="text-lg font-bold text-gray-900">ç†±éŠ·ç”¢å“æ’è¡Œ (Top 5)</h3>
          </div>
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">æ’å</th>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">ç”¢å“åç¨±</th>
                <th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">éŠ·å”®æ•¸é‡</th>
                <th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">ç¸½ç‡Ÿæ”¶</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-200">
              {data.productStats?.map((item: any, index: number) => (
                <tr key={index} className="hover:bg-gray-50">
                  <td className="px-6 py-4 text-sm text-gray-500 font-bold">#{index + 1}</td>
                  <td className="px-6 py-4 text-sm text-gray-900 font-medium">{item.name || 'æœªçŸ¥ç”¢å“'}</td>
                  <td className="px-6 py-4 text-sm text-gray-900 text-right">{item.count}</td>
                  <td className="px-6 py-4 text-sm text-blue-600 font-bold text-right">${Number(item.revenue).toLocaleString()}</td>
                </tr>
              ))}
              {(!data.productStats || data.productStats.length === 0) && <tr><td colSpan={4} className="p-4 text-center text-gray-400 text-sm">æš«ç„¡æ•¸æ“š</td></tr>}
            </tbody>
          </table>
        </div>

        {/* ç†±éŠ·é¡è‰² */}
        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden min-w-0">
          <div className="p-6 border-b border-gray-100 flex items-center gap-2">
            <Palette className="w-5 h-5 text-pink-500" />
            <h3 className="text-lg font-bold text-gray-900">ç†±éŠ·é¡è‰²æ’è¡Œ (Top 5)</h3>
          </div>
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">æ’å</th>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">é¡è‰²åç¨±</th>
                <th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">é¸æ“‡æ¬¡æ•¸</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-200">
              {data.colorStats?.map((item: any, index: number) => (
                <tr key={index} className="hover:bg-gray-50">
                  <td className="px-6 py-4 text-sm text-gray-500 font-bold">#{index + 1}</td>
                  <td className="px-6 py-4 text-sm text-gray-900 font-medium">{item.name || 'æœªé¸è‰²'}</td>
                  <td className="px-6 py-4 text-sm text-gray-900 text-right">{item.count}</td>
                </tr>
              ))}
              {(!data.colorStats || data.colorStats.length === 0) && <tr><td colSpan={3} className="p-4 text-center text-gray-400 text-sm">æš«ç„¡æ•¸æ“š</td></tr>}
            </tbody>
          </table>
        </div>

      </div>
    </div>
  );
}
</file>

<file path="admin/src/app/settings/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { Save, Plus, Trash2, Briefcase, Ruler, Megaphone, LayoutTemplate, Loader2, UploadCloud, X, ArrowUp, ArrowDown, Edit, List, Image as ImageIcon, Settings as SettingsIcon, ShieldAlert, Lock, Globe, Percent, CalendarClock, Building } from 'lucide-react';
import clsx from 'clsx';
import { api } from '@/lib/api';

const CLOUDINARY_CLOUD_NAME = 'dnibj8za6'; 
const CLOUDINARY_PRESET = 'yasou70731'; 

interface Category { id: string; name: string; code: string; isUpgradeable: boolean; discountRate: number; }
interface Announcement { id: string; content: string; isActive: boolean; createdAt: string; }

export default function SettingsPage() {
  const [activeTab, setActiveTab] = useState('category');
  
  // è³‡æ–™ç‹€æ…‹
  const [categories, setCategories] = useState<Category[]>([]);
  const [announcements, setAnnouncements] = useState<Announcement[]>([]);
  const [siteConfig, setSiteConfig] = useState<any>({ blocks: [] });
  
  // ç³»çµ±è¦å‰‡ç‹€æ…‹
  const [systemRules, setSystemRules] = useState<any>({
    enable_registration: true,
    maintenance_mode: false,
    allow_guest_view: true,
    discount_level_A: 0.85,
    discount_level_B: 0.95,
    order_reset_day: 1,
    company_name: '',
    tax_id: '',
    phone: '',
    address: '',
    copyright_text: ''
  });

  const [isConfigLoading, setIsConfigLoading] = useState(false);
  const [editingBlock, setEditingBlock] = useState<any>(null); // æ­£åœ¨ç·¨è¼¯çš„ç©æœ¨
  const [isUploading, setIsUploading] = useState(false);

  // è¼‰å…¥è³‡æ–™
  const fetchCategories = async () => { try { const res = await api.get('/trade-categories'); setCategories(res.data || res); } catch (e) {} };
  const fetchAnnouncements = async () => { try { const res = await api.get('/announcements'); setAnnouncements(res.data || res); } catch (e) {} };
  const fetchSiteConfig = async () => {
    setIsConfigLoading(true);
    try { const res = await api.get('/site-config/homepage'); if (!res.blocks) res.blocks = []; setSiteConfig(res); } catch (e) {}
    finally { setIsConfigLoading(false); }
  };
  const fetchSystemRules = async () => {
    try { const res = await api.get('/site-config/rules'); if (res.settings) setSystemRules(res.settings); } catch (e) {}
  };

  useEffect(() => {
    if (activeTab === 'category') fetchCategories();
    if (activeTab === 'announcement') fetchAnnouncements();
    if (activeTab === 'homepage') fetchSiteConfig();
    if (activeTab === 'rules') fetchSystemRules();
  }, [activeTab]);

  // --- 1. ç‡Ÿæ¥­é¡åˆ¥æ“ä½œ ---
  const handleAddCategory = async () => {
    const name = prompt('è«‹è¼¸å…¥åˆ†é¡åç¨±'); if (!name) return;
    const code = prompt('è«‹è¼¸å…¥ä»£ç¢¼'); if (!code) return;
    const rateStr = prompt('é è¨­æŠ˜æ•¸', '1.0');
    try { await api.post('/trade-categories', { name, code, discountRate: parseFloat(rateStr || '1.0'), isUpgradeable: false }); fetchCategories(); } 
    catch (e) { alert('æ–°å¢å¤±æ•—'); }
  };
  const handleDeleteCategory = async (id: string) => { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { await api.delete(`/trade-categories/${id}`); fetchCategories(); } };
  const handleToggleCategory = async (id: string, val: boolean) => { await api.patch(`/trade-categories/${id}`, { isUpgradeable: !val }); fetchCategories(); };
  const handleRateChange = async (id: string, val: number) => { await api.patch(`/trade-categories/${id}`, { discountRate: val }); };
  
  // --- 2. å…¬å‘Šæ“ä½œ ---
  const handleAddAnnouncement = async () => { const content = prompt('å…§å®¹ï¼š'); if(content) { await api.post('/announcements', { content }); fetchAnnouncements(); } };
  const handleToggleAnnouncement = async (id: string, val: boolean) => { await api.patch(`/announcements/${id}`, { isActive: !val }); fetchAnnouncements(); };
  const handleDeleteAnnouncement = async (id: string) => { if(confirm('åˆªé™¤?')) { await api.delete(`/announcements/${id}`); fetchAnnouncements(); }};

  // --- 3. é¦–é ç©æœ¨æ“ä½œ ---
  const addBlock = (type: string) => {
    const newBlock = {
      id: crypto.randomUUID(),
      type,
      data: type === 'HERO' ? { title: 'æ–°æ¨™é¡Œ', subtitle: 'å‰¯æ¨™é¡Œ', images: [] } :
            type === 'FEATURES' ? { title: 'ç‰¹è‰²ä»‹ç´¹', items: [{title:'ç‰¹è‰²1', desc:'æè¿°'},{title:'ç‰¹è‰²2', desc:'æè¿°'},{title:'ç‰¹è‰²3', desc:'æè¿°'}] } :
            { title: 'ç”¢å“åˆ—è¡¨', count: 4 }
    };
    setSiteConfig({ ...siteConfig, blocks: [...(siteConfig.blocks || []), newBlock] });
  };
  const removeBlock = (id: string) => { if(!confirm('ç¢ºå®šç§»é™¤æ­¤å€å¡Šï¼Ÿ')) return; setSiteConfig({ ...siteConfig, blocks: siteConfig.blocks.filter((b: any) => b.id !== id) }); };
  const moveBlock = (index: number, direction: -1 | 1) => {
    const newBlocks = [...siteConfig.blocks];
    if (index + direction < 0 || index + direction >= newBlocks.length) return;
    const temp = newBlocks[index];
    newBlocks[index] = newBlocks[index + direction];
    newBlocks[index + direction] = temp;
    setSiteConfig({ ...siteConfig, blocks: newBlocks });
  };
  const saveConfig = async () => { try { await api.patch('/site-config/homepage', siteConfig); alert('å„²å­˜æˆåŠŸï¼å‰å°é¦–é å·²æ›´æ–°ã€‚'); } catch (e) { alert('å„²å­˜å¤±æ•—'); } };
  
  const handleEditImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (!files?.length) return;
    setIsUploading(true);
    const newImages = [...(editingBlock.data.images || [])];
    try {
      for (let i = 0; i < files.length; i++) {
        const formData = new FormData();
        formData.append('file', files[i]);
        formData.append('upload_preset', CLOUDINARY_PRESET);
        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, { method: 'POST', body: formData });
        const data = await res.json();
        if (data.secure_url) newImages.push(data.secure_url);
      }
      setEditingBlock({ ...editingBlock, data: { ...editingBlock.data, images: newImages } });
    } finally { setIsUploading(false); }
  };

  // --- 4. ç³»çµ±è¦å‰‡æ“ä½œ ---
  const saveRules = async () => {
    try {
      await api.patch('/site-config/rules', systemRules);
      alert('ç³»çµ±è¦å‰‡å·²æ›´æ–°ï¼');
    } catch (e) { alert('å„²å­˜å¤±æ•—'); }
  };

  return (
    <div className="min-h-screen bg-gray-50 p-8 font-sans">
      <div className="mb-8">
        <h1 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
          <div className="p-2 bg-gray-200 rounded-lg"><Briefcase className="w-6 h-6 text-gray-700" /></div>
          ç³»çµ±è¨­å®š
        </h1>
        <p className="text-gray-500 text-sm mt-1">å…¨åŸŸåƒæ•¸é…ç½®ä¸­å¿ƒ</p>
      </div>

      <div className="flex flex-col lg:flex-row gap-8">
        {/* å·¦å´é¸å–® */}
        <div className="w-full lg:w-64 shrink-0 space-y-2">
          <button onClick={() => setActiveTab('category')} className={clsx("w-full text-left px-4 py-3 rounded-lg font-medium flex items-center gap-3 transition-all", activeTab === 'category' ? "bg-white shadow-sm text-blue-600 border border-blue-100" : "text-gray-600 hover:bg-white hover:shadow-sm")}><Briefcase className="w-5 h-5" /> ç‡Ÿæ¥­é¡åˆ¥ç®¡ç†</button>
          <button onClick={() => setActiveTab('params')} className={clsx("w-full text-left px-4 py-3 rounded-lg font-medium flex items-center gap-3 transition-all", activeTab === 'params' ? "bg-white shadow-sm text-blue-600 border border-blue-100" : "text-gray-600 hover:bg-white hover:shadow-sm")}><Ruler className="w-5 h-5" /> æ–½å·¥åƒæ•¸è¨­å®š</button>
          <button onClick={() => setActiveTab('announcement')} className={clsx("w-full text-left px-4 py-3 rounded-lg font-medium flex items-center gap-3 transition-all", activeTab === 'announcement' ? "bg-white shadow-sm text-blue-600 border border-blue-100" : "text-gray-600 hover:bg-white hover:shadow-sm")}><Megaphone className="w-5 h-5" /> ç¶²ç«™å…¬å‘Š</button>
          <button onClick={() => setActiveTab('homepage')} className={clsx("w-full text-left px-4 py-3 rounded-lg font-medium flex items-center gap-3 transition-all", activeTab === 'homepage' ? "bg-white shadow-sm text-blue-600 border border-blue-100" : "text-gray-600 hover:bg-white hover:shadow-sm")}><LayoutTemplate className="w-5 h-5" /> é¦–é ç©æœ¨é…ç½®</button>
          <button onClick={() => setActiveTab('rules')} className={clsx("w-full text-left px-4 py-3 rounded-lg font-medium flex items-center gap-3 transition-all", activeTab === 'rules' ? "bg-white shadow-sm text-blue-600 border border-blue-100" : "text-gray-600 hover:bg-white hover:shadow-sm")}><SettingsIcon className="w-5 h-5" /> ç³»çµ±è¦å‰‡è¨­å®š</button>
        </div>

        {/* å³å´å…§å®¹ */}
        <div className="flex-1">
          
          {/* Tab 1: ç‡Ÿæ¥­é¡åˆ¥ (å®Œæ•´é‚è¼¯) */}
          {activeTab === 'category' && (
            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
              <div className="p-6 border-b border-gray-100 flex justify-between items-center">
                <h3 className="text-lg font-bold text-gray-900">ç‡Ÿæ¥­é¡åˆ¥ç®¡ç†</h3>
                <button onClick={handleAddCategory} className="flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 font-bold text-sm"><Plus className="w-4 h-4" /> æ–°å¢</button>
              </div>
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                  <tr><th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">åç¨±</th><th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">é è¨­æŠ˜æ•¸</th><th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">å‡ç´šè³‡æ ¼</th><th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">æ“ä½œ</th></tr>
                </thead>
                <tbody className="divide-y divide-gray-200">
                  {categories.map((cat) => (
                    <tr key={cat.id} className="hover:bg-gray-50">
                      <td className="px-6 py-4 text-sm font-bold text-gray-900">{cat.name} <span className="text-gray-400 text-xs">({cat.code})</span></td>
                      <td className="px-6 py-4"><input type="number" step="0.01" defaultValue={cat.discountRate} onBlur={(e) => handleRateChange(cat.id, parseFloat(e.target.value))} className="w-16 p-1 border rounded text-center font-mono text-sm" /></td>
                      <td className="px-6 py-4"><button onClick={() => handleToggleCategory(cat.id, cat.isUpgradeable)} className={clsx("relative inline-flex h-6 w-11 items-center rounded-full transition-colors", cat.isUpgradeable ? "bg-green-500" : "bg-gray-200")}><span className={clsx("inline-block h-4 w-4 transform rounded-full bg-white transition-transform", cat.isUpgradeable ? "translate-x-6" : "translate-x-1")}/></button></td>
                      <td className="px-6 py-4 text-right"><button onClick={() => handleDeleteCategory(cat.id)} className="text-gray-400 hover:text-red-500"><Trash2 className="w-4 h-4" /></button></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}

          {/* Tab 2: æ–½å·¥åƒæ•¸ (ä¿ç•™ä½”ä½) */}
          {activeTab === 'params' && (
            <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-8 text-center text-gray-500">æ–½å·¥åƒæ•¸è¨­å®šåŠŸèƒ½é–‹ç™¼ä¸­...</div>
          )}

          {/* Tab 3: ç¶²ç«™å…¬å‘Š (å®Œæ•´é‚è¼¯) */}
          {activeTab === 'announcement' && (
            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
              <div className="p-6 border-b border-gray-100 flex justify-between items-center">
                <h3 className="text-lg font-bold text-gray-900">ç¶²ç«™å…¬å‘Šç™¼å¸ƒ</h3>
                <button onClick={handleAddAnnouncement} className="flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 font-bold text-sm"><Plus className="w-4 h-4" /> ç™¼å¸ƒå…¬å‘Š</button>
              </div>
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50"><tr><th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">å…¬å‘Šå…§å®¹</th><th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">ç‹€æ…‹</th><th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">æ“ä½œ</th></tr></thead>
                <tbody className="divide-y divide-gray-200">
                  {announcements.map((item) => (
                    <tr key={item.id} className="hover:bg-gray-50">
                      <td className="px-6 py-4 text-sm text-gray-900">{item.content}</td>
                      <td className="px-6 py-4"><button onClick={() => handleToggleAnnouncement(item.id, item.isActive)} className={clsx("px-2 py-1 rounded text-xs font-bold", item.isActive ? "bg-green-100 text-green-700" : "bg-gray-100 text-gray-500")}>{item.isActive ? 'é¡¯ç¤ºä¸­' : 'å·²éš±è—'}</button></td>
                      <td className="px-6 py-4 text-right"><button onClick={() => handleDeleteAnnouncement(item.id)} className="text-gray-400 hover:text-red-500"><Trash2 className="w-4 h-4" /></button></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}

          {/* Tab 4: é¦–é ç©æœ¨é…ç½® (å®Œæ•´é‚è¼¯) */}
          {activeTab === 'homepage' && (
            <div className="flex gap-8 items-start">
              <div className="w-1/3 bg-white p-4 rounded-xl shadow-sm border border-gray-200 space-y-4">
                <h3 className="font-bold text-gray-700 border-b pb-2 mb-2">å€å¡Šæ’åºèˆ‡ç®¡ç†</h3>
                {isConfigLoading ? <div className="text-center py-4"><Loader2 className="animate-spin w-6 h-6 text-blue-600 mx-auto" /></div> : (
                  <div className="space-y-3">
                    {siteConfig.blocks?.map((block: any, idx: number) => (
                      <div key={block.id} className="flex items-center justify-between p-3 bg-gray-50 border border-gray-200 rounded-lg group hover:border-blue-300 transition-colors">
                        <div className="flex items-center gap-3">
                          <span className="w-6 h-6 bg-blue-100 text-blue-600 rounded flex items-center justify-center text-xs font-bold">{idx + 1}</span>
                          <span className="font-medium text-gray-700 text-sm">
                            {block.type === 'HERO' ? 'ä¸»è¦–è¦ºè¼ªæ’­' : block.type === 'FEATURES' ? 'ç‰¹è‰²ä»‹ç´¹' : 'ç”¢å“åˆ—è¡¨'}
                          </span>
                        </div>
                        <div className="flex items-center gap-1 opacity-60 group-hover:opacity-100 transition-opacity">
                          <button onClick={() => moveBlock(idx, -1)} disabled={idx === 0} className="p-1 hover:bg-gray-200 rounded disabled:opacity-30"><ArrowUp className="w-4 h-4" /></button>
                          <button onClick={() => moveBlock(idx, 1)} disabled={idx === siteConfig.blocks.length - 1} className="p-1 hover:bg-gray-200 rounded disabled:opacity-30"><ArrowDown className="w-4 h-4" /></button>
                          <button onClick={() => setEditingBlock(block)} className="p-1 hover:bg-blue-100 text-blue-600 rounded"><Edit className="w-4 h-4" /></button>
                          <button onClick={() => removeBlock(block.id)} className="p-1 hover:bg-red-100 text-red-600 rounded"><Trash2 className="w-4 h-4" /></button>
                        </div>
                      </div>
                    ))}
                    {siteConfig.blocks?.length === 0 && <div className="text-center text-gray-400 py-4 text-sm">ç›®å‰ç„¡å€å¡Š</div>}
                  </div>
                )}

                <div className="grid grid-cols-3 gap-2 pt-2 border-t mt-4">
                  <button onClick={() => addBlock('HERO')} className="p-2 bg-gray-50 border border-dashed border-gray-300 rounded hover:border-blue-500 hover:text-blue-600 flex flex-col items-center gap-1 text-[10px] font-medium transition-colors"><ImageIcon className="w-4 h-4" />+ ä¸»è¦–è¦º</button>
                  <button onClick={() => addBlock('FEATURES')} className="p-2 bg-gray-50 border border-dashed border-gray-300 rounded hover:border-blue-500 hover:text-blue-600 flex flex-col items-center gap-1 text-[10px] font-medium transition-colors"><List className="w-4 h-4" />+ ç‰¹è‰²æ¬„</button>
                  <button onClick={() => addBlock('PRODUCT_LIST')} className="p-2 bg-gray-50 border border-dashed border-gray-300 rounded hover:border-blue-500 hover:text-blue-600 flex flex-col items-center gap-1 text-[10px] font-medium transition-colors"><LayoutTemplate className="w-4 h-4" />+ ç”¢å“åˆ—</button>
                </div>

                <button onClick={saveConfig} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold shadow hover:bg-blue-700 transition-colors flex items-center justify-center gap-2"><Save className="w-4 h-4" /> å„²å­˜ç™¼å¸ƒ</button>
              </div>

              <div className="flex-1 bg-white rounded-xl border border-gray-200 p-8 flex flex-col items-center justify-center text-gray-400 min-h-[400px]">
                <LayoutTemplate className="w-16 h-16 mb-4 text-gray-200" />
                <p className="text-lg font-medium text-gray-500">é»æ“Šå·¦å´ã€Œç­†ã€åœ–ç¤ºé–‹å§‹ç·¨è¼¯</p>
                <p className="text-sm mt-2">æ‚¨å¯ä»¥æ–°å¢å¤šå€‹å€å¡Šï¼Œä¸¦è‡ªç”±æ‹–æ›³æ’åºã€‚</p>
              </div>
            </div>
          )}

          {/* âœ¨ Tab 5: ç³»çµ±è¦å‰‡è¨­å®š (å®Œæ•´é‚è¼¯) */}
          {activeTab === 'rules' && (
            <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6 space-y-8">
              <div className="border-b border-gray-100 pb-4">
                <h3 className="text-lg font-bold text-gray-900">ç³»çµ±ç‡Ÿé‹è¦å‰‡</h3>
                <p className="text-sm text-gray-500">æ§åˆ¶ç¶²ç«™çš„å…¨åŸŸé–‹é—œèˆ‡æ¬Šé™</p>
              </div>

              <div className="space-y-4">
                <h4 className="text-sm font-bold text-gray-900 flex items-center gap-2"><Building className="w-4 h-4" /> å…¬å¸è³‡è¨Šèˆ‡é å°¾è¨­å®š</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg border border-gray-200">
                  <div className="col-span-1 md:col-span-2"><label className="block text-sm font-medium text-gray-700 mb-1">å…¬å¸åç¨±</label><input type="text" value={systemRules.company_name || ''} onChange={(e) => setSystemRules({...systemRules, company_name: e.target.value})} className="w-full p-2 border border-gray-300 rounded-lg outline-none" /></div>
                  <div><label className="block text-sm font-medium text-gray-700 mb-1">çµ±ä¸€ç·¨è™Ÿ</label><input type="text" value={systemRules.tax_id || ''} onChange={(e) => setSystemRules({...systemRules, tax_id: e.target.value})} className="w-full p-2 border border-gray-300 rounded-lg outline-none" /></div>
                  <div><label className="block text-sm font-medium text-gray-700 mb-1">è¯çµ¡é›»è©±</label><input type="text" value={systemRules.phone || ''} onChange={(e) => setSystemRules({...systemRules, phone: e.target.value})} className="w-full p-2 border border-gray-300 rounded-lg outline-none" /></div>
                  <div className="col-span-1 md:col-span-2"><label className="block text-sm font-medium text-gray-700 mb-1">å…¬å¸åœ°å€</label><input type="text" value={systemRules.address || ''} onChange={(e) => setSystemRules({...systemRules, address: e.target.value})} className="w-full p-2 border border-gray-300 rounded-lg outline-none" /></div>
                  <div className="col-span-1 md:col-span-2"><label className="block text-sm font-medium text-gray-700 mb-1">ç‰ˆæ¬Šå®£å‘Š (Copyright)</label><input type="text" value={systemRules.copyright_text || ''} onChange={(e) => setSystemRules({...systemRules, copyright_text: e.target.value})} className="w-full p-2 border border-gray-300 rounded-lg outline-none" /></div>
                </div>
              </div>
              
              <div className="border-t border-gray-100 my-4"></div>

              <div className="bg-blue-50 border border-blue-100 rounded-xl p-4 flex items-start gap-3">
                <ShieldAlert className="w-6 h-6 text-blue-600 mt-0.5" />
                <div>
                  <h4 className="font-bold text-blue-900 mb-1">ğŸ”’ æ ¸å¿ƒé‡‘æµè¦å‰‡ (å·²ç¡¬ç·¨ç¢¼å¯«æ­»)</h4>
                  <ul className="text-sm text-blue-800 space-y-1 list-disc list-inside">
                    <li>A ç´šæœƒå“¡å„²å€¼ä¸Šé™ï¼š<span className="font-mono font-bold">NT$ 200,000</span></li>
                    <li>B ç´šæœƒå“¡å„²å€¼ä¸Šé™ï¼š<span className="font-mono font-bold">NT$ 100,000</span></li>
                  </ul>
                </div>
              </div>

              <div className="space-y-4">
                <h4 className="text-sm font-bold text-gray-900 flex items-center gap-2"><Percent className="w-4 h-4" /> æœƒå“¡åƒ¹æ ¼ç­–ç•¥</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg border border-gray-200">
                  <div><label className="block text-sm font-medium text-gray-700 mb-1">A ç´šæœƒå“¡é è¨­æŠ˜æ•¸</label><input type="number" step="0.01" value={systemRules.discount_level_A} onChange={(e) => setSystemRules({...systemRules, discount_level_A: parseFloat(e.target.value)})} className="w-full p-2 border border-gray-300 rounded-lg outline-none font-mono" /></div>
                  <div><label className="block text-sm font-medium text-gray-700 mb-1">B ç´šæœƒå“¡é è¨­æŠ˜æ•¸</label><input type="number" step="0.01" value={systemRules.discount_level_B} onChange={(e) => setSystemRules({...systemRules, discount_level_B: parseFloat(e.target.value)})} className="w-full p-2 border border-gray-300 rounded-lg outline-none font-mono" /></div>
                </div>
              </div>

              <div className="space-y-4 pt-4 border-t border-gray-100">
                <h4 className="text-sm font-bold text-gray-900 flex items-center gap-2"><CalendarClock className="w-4 h-4" /> è¨‚å–®æµæ°´è™Ÿè¨­å®š</h4>
                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                  <label className="block text-sm font-medium text-gray-700 mb-1">æµæ°´è™Ÿé‡ç½®æ—¥ (æ¯æœˆå¹¾è™Ÿ)</label>
                  <input type="number" min="1" max="31" value={systemRules.order_reset_day || 1} onChange={(e) => setSystemRules({...systemRules, order_reset_day: parseInt(e.target.value)})} className="w-full p-2 border border-gray-300 rounded-lg outline-none font-mono" />
                </div>
              </div>

              <div className="space-y-6 pt-4 border-t border-gray-100">
                <h4 className="text-sm font-bold text-gray-900 flex items-center gap-2"><SettingsIcon className="w-4 h-4" /> åŠŸèƒ½é–‹é—œ</h4>
                <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200">
                  <div className="flex items-center gap-3"><div className="p-2 bg-white rounded-full border"><Lock className="w-5 h-5 text-gray-600" /></div><div><div className="font-bold text-gray-900">é–‹æ”¾ç¶“éŠ·å•†è¨»å†Š</div><div className="text-xs text-gray-500">é—œé–‰å¾Œï¼Œå‰å°è¨»å†ŠåŠŸèƒ½å°‡éš±è—ã€‚</div></div></div>
                  <label className="relative inline-flex items-center cursor-pointer"><input type="checkbox" checked={systemRules.enable_registration} onChange={(e) => setSystemRules({...systemRules, enable_registration: e.target.checked})} className="sr-only peer" /><div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
                </div>
                <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200">
                  <div className="flex items-center gap-3"><div className="p-2 bg-white rounded-full border"><ShieldAlert className="w-5 h-5 text-orange-600" /></div><div><div className="font-bold text-gray-900">ç³»çµ±ç¶­è­·æ¨¡å¼</div><div className="text-xs text-gray-500">é–‹å•Ÿå¾Œï¼Œå‰å°å°‡é¡¯ç¤ºã€Œç³»çµ±ç¶­è­·ä¸­ã€ã€‚</div></div></div>
                  <label className="relative inline-flex items-center cursor-pointer"><input type="checkbox" checked={systemRules.maintenance_mode} onChange={(e) => setSystemRules({...systemRules, maintenance_mode: e.target.checked})} className="sr-only peer" /><div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-orange-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div></label>
                </div>
              </div>

              <button onClick={saveRules} className="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-sm transition-all mt-4">å„²å­˜ç³»çµ±è¨­å®š</button>
            </div>
          )}

        </div>
      </div>

      {/* ç©æœ¨ç·¨è¼¯ Modal */}
      {editingBlock && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-xl p-6 max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-6 pb-4 border-b">
              <h3 className="text-xl font-bold text-gray-900">ç·¨è¼¯å€å¡Š</h3>
              <button onClick={() => setEditingBlock(null)} className="text-gray-400 hover:text-gray-600"><X className="w-5 h-5" /></button>
            </div>
            <div className="space-y-5">
              {editingBlock.type === 'HERO' && (
                <>
                  <div><label className="block text-sm font-bold mb-1 text-gray-700">ä¸»æ¨™é¡Œ</label><textarea rows={2} value={editingBlock.data.title} onChange={(e) => setEditingBlock({...editingBlock, data: {...editingBlock.data, title: e.target.value}})} className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" /></div>
                  <div><label className="block text-sm font-bold mb-1 text-gray-700">å‰¯æ¨™é¡Œ</label><input type="text" value={editingBlock.data.subtitle} onChange={(e) => setEditingBlock({...editingBlock, data: {...editingBlock.data, subtitle: e.target.value}})} className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" /></div>
                  <div>
                    <label className="block text-sm font-bold mb-2 text-gray-700">è¼ªæ’­åœ–ç‰‡</label>
                    <div className="grid grid-cols-3 gap-3 mb-2">
                      {editingBlock.data.images?.map((url: string, i: number) => (
                        <div key={i} className="relative aspect-video bg-gray-100 rounded-lg overflow-hidden group border">
                          <img src={url} className="w-full h-full object-cover" alt="slide" />
                          <button onClick={() => {
                            const newImgs = editingBlock.data.images.filter((_:any, idx:number) => idx !== i);
                            setEditingBlock({...editingBlock, data: {...editingBlock.data, images: newImgs}});
                          }} className="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"><X className="w-3 h-3"/></button>
                        </div>
                      ))}
                      <label className="flex flex-col items-center justify-center border-2 border-dashed rounded-lg cursor-pointer h-full hover:bg-gray-50 transition-colors">
                        {isUploading ? <Loader2 className="animate-spin w-5 h-5 text-gray-400"/> : <Plus className="w-6 h-6 text-gray-400"/>}
                        <span className="text-xs text-gray-500 mt-1">ä¸Šå‚³</span>
                        <input type="file" hidden multiple accept="image/*" onChange={handleEditImageUpload} disabled={isUploading} />
                      </label>
                    </div>
                  </div>
                </>
              )}
              {editingBlock.type === 'FEATURES' && (
                <>
                  <div><label className="block text-sm font-bold mb-1 text-gray-700">å€å¡Šæ¨™é¡Œ</label><input type="text" value={editingBlock.data.title} onChange={(e) => setEditingBlock({...editingBlock, data: {...editingBlock.data, title: e.target.value}})} className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" /></div>
                  <div className="space-y-3">
                    {editingBlock.data.items.map((item: any, i: number) => (
                      <div key={i} className="p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <div className="text-xs font-bold text-gray-500 mb-2 uppercase tracking-wider">ç‰¹è‰²é‡é» {i + 1}</div>
                        <input type="text" value={item.title} onChange={(e) => { const newItems = [...editingBlock.data.items]; newItems[i].title = e.target.value; setEditingBlock({...editingBlock, data: {...editingBlock.data, items: newItems}}); }} className="w-full p-2 border rounded mb-2 text-sm bg-white" placeholder="æ¨™é¡Œ" />
                        <textarea rows={2} value={item.desc} onChange={(e) => { const newItems = [...editingBlock.data.items]; newItems[i].desc = e.target.value; setEditingBlock({...editingBlock, data: {...editingBlock.data, items: newItems}}); }} className="w-full p-2 border rounded text-sm bg-white" placeholder="æè¿°å…§å®¹" />
                      </div>
                    ))}
                  </div>
                </>
              )}
              {editingBlock.type === 'PRODUCT_LIST' && (
                <>
                  <div><label className="block text-sm font-bold mb-1 text-gray-700">åˆ—è¡¨æ¨™é¡Œ</label><input type="text" value={editingBlock.data.title} onChange={(e) => setEditingBlock({...editingBlock, data: {...editingBlock.data, title: e.target.value}})} className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" /></div>
                  <div><label className="block text-sm font-bold mb-1 text-gray-700">é¡¯ç¤ºæ•¸é‡</label><input type="number" value={editingBlock.data.count} onChange={(e) => setEditingBlock({...editingBlock, data: {...editingBlock.data, count: Number(e.target.value)}})} className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" /></div>
                </>
              )}
              <div className="pt-4 border-t mt-4 flex gap-3">
                <button onClick={() => setEditingBlock(null)} className="flex-1 py-2.5 border border-gray-300 text-gray-700 rounded-lg font-bold hover:bg-gray-50 transition-colors">å–æ¶ˆ</button>
                <button onClick={() => { const newBlocks = siteConfig.blocks.map((b: any) => b.id === editingBlock.id ? editingBlock : b); setSiteConfig({ ...siteConfig, blocks: newBlocks }); setEditingBlock(null); }} className="flex-1 py-2.5 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors shadow-sm">ç¢ºèªä¿®æ”¹</button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="admin/src/app/users/page.tsx">
'use client';

import { useEffect, useState, useMemo } from 'react';
import { Users, Search, Wallet, AlertCircle, ChevronDown, ArrowUpCircle, Filter, CheckCircle, XCircle, Power, Trash2 } from 'lucide-react';
import { api } from '@/lib/api';
import clsx from 'clsx';

export default function UsersPage() {
  const [users, setUsers] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');
  
  const [selectedUser, setSelectedUser] = useState<any>(null);
  const [modalMode, setModalMode] = useState<'deposit' | 'level'>('deposit'); 
  const [depositAmount, setDepositAmount] = useState('');
  const [newLevel, setNewLevel] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);

  const fetchUsers = async () => {
    try {
      const res = await api.get('/users');
      // âœ¨ Fix: ç›´æ¥ä½¿ç”¨ resï¼Œä¸¦ç¢ºä¿å®ƒæ˜¯é™£åˆ—
      if (Array.isArray(res)) {
        setUsers(res);
      } else {
        console.warn('API å›å‚³æ ¼å¼ç•°å¸¸ (éé™£åˆ—):', res);
        setUsers([]);
      }
    } catch (err) {
      console.error(err);
      setUsers([]);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchUsers();
  }, []);

  // é–‹é€š/åœæ¬Š
  const handleToggleActive = async (user: any) => {
    const action = user.isActive ? 'åœæ¬Š' : 'é–‹é€š';
    if (!confirm(`ç¢ºå®šè¦${action} ${user.dealerProfile.companyName} å—ï¼Ÿ`)) return;

    try {
      await api.patch(`/users/${user.id}/status`, { isActive: !user.isActive });
      alert(`${action}æˆåŠŸï¼`);
      fetchUsers();
    } catch (err) {
      alert('æ“ä½œå¤±æ•—ï¼Œè«‹æª¢æŸ¥å¾Œç«¯é€£ç·š');
    }
  };

  // åˆªé™¤æœƒå“¡
  const handleDeleteUser = async (user: any) => {
    if (!confirm(`âš ï¸ è­¦å‘Šï¼šç¢ºå®šè¦åˆªé™¤æœƒå“¡ã€${user.dealerProfile.companyName}ã€‘å—ï¼Ÿ\n\næ­¤æ“ä½œå°‡æ°¸ä¹…åˆªé™¤è©²å¸³è™ŸåŠå…¶æ‰€æœ‰è³‡æ–™ï¼Œä¸”ç„¡æ³•å¾©åŸï¼`)) return;
    
    try {
      await api.delete(`/users/${user.id}`);
      alert('åˆªé™¤æˆåŠŸï¼');
      fetchUsers();
    } catch (err) {
      console.error(err);
      alert('åˆªé™¤å¤±æ•—');
    }
  };

  const filteredUsers = useMemo(() => {
    return (users || []).filter(user => {
      if (!user) return false;
      const term = searchTerm.toLowerCase();
      const profile = user.dealerProfile;
      return (
        (profile?.companyName || '').toLowerCase().includes(term) ||
        (profile?.taxId || '').includes(term) ||
        (profile?.contactPerson || '').toLowerCase().includes(term) ||
        (user.email || '').toLowerCase().includes(term)
      );
    });
  }, [users, searchTerm]);

  const handleDeposit = async () => {
    if (!depositAmount || Number(depositAmount) <= 0) return alert('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡');
    setIsSubmitting(true);
    try {
      await api.post(`/users/${selectedUser.id}/deposit`, { amount: Number(depositAmount) });
      alert('ğŸ‰ å„²å€¼æˆåŠŸï¼');
      closeModal();
      fetchUsers();
    } catch (err: any) {
      alert(err.response?.data?.message || 'å„²å€¼å¤±æ•—');
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleLevelChange = async () => {
    if (!newLevel) return;
    setIsSubmitting(true);
    try {
       await api.patch(`/users/${selectedUser.id}/level`, { level: newLevel });
       alert('ç­‰ç´šä¿®æ”¹æˆåŠŸï¼');
       closeModal();
       fetchUsers();
    } catch (err: any) {
      alert('ä¿®æ”¹å¤±æ•—');
    } finally {
      setIsSubmitting(false);
    }
  };

  const openModal = (user: any, mode: 'deposit' | 'level') => {
    setSelectedUser(user);
    setModalMode(mode);
    setDepositAmount('');
    setNewLevel(user.dealerProfile?.level || 'C');
  };

  const closeModal = () => {
    setSelectedUser(null);
  };

  return (
    <div className="min-h-screen bg-gray-50 p-8 font-sans">
      
      {/* Header */}
      <div className="flex justify-between items-center mb-8">
        <div>
          <h1 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
            <Users className="w-6 h-6 text-blue-600" />
            æœƒå“¡ç®¡ç†
          </h1>
          <p className="text-gray-500 text-sm mt-1">ç®¡ç†ç¶“éŠ·å•†ç­‰ç´šã€å¯©æ ¸é–‹é€šèˆ‡éŒ¢åŒ…å„²å€¼</p>
        </div>
      </div>

      {/* åˆ—è¡¨å¡ç‰‡ */}
      <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        
        <div className="p-5 border-b border-gray-100 bg-gray-50/50 flex items-center gap-4">
          <div className="relative w-72">
            <Search className="absolute left-3 top-2.5 w-4 h-4 text-gray-400" />
            <input type="text" placeholder="æœå°‹å…¬å¸åã€çµ±ç·¨ã€è¯çµ¡äºº..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all" />
          </div>
          <div className="text-sm text-gray-500">å…± {filteredUsers.length} ä½æœƒå“¡</div>
        </div>

        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">ç‹€æ…‹</th>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">å…¬å¸åç¨± / çµ±ç·¨</th>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">è¯çµ¡äºº</th>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">ç­‰ç´š</th>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">éŒ¢åŒ…é¤˜é¡</th>
              <th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-gray-200">
            {loading ? <tr><td colSpan={6} className="text-center py-12 text-gray-500">è¼‰å…¥ä¸­...</td></tr> : 
              filteredUsers.map((user) => {
                const profile = user.dealerProfile;
                return (
                  <tr key={user.id} className={clsx("transition-colors", user.isActive ? "hover:bg-gray-50" : "bg-red-50 hover:bg-red-100")}>
                    
                    <td className="px-6 py-4">
                      <button 
                        onClick={() => handleToggleActive(user)}
                        className={clsx(
                          "flex items-center gap-1 px-2 py-1 rounded-full text-xs font-bold border transition-all",
                          user.isActive 
                            ? "bg-green-100 text-green-700 border-green-200 hover:bg-green-200" 
                            : "bg-red-100 text-red-700 border-red-200 hover:bg-red-200"
                        )}
                        title="é»æ“Šåˆ‡æ›ç‹€æ…‹"
                      >
                        {user.isActive ? <CheckCircle className="w-3 h-3" /> : <Power className="w-3 h-3" />}
                        {user.isActive ? 'å·²é–‹é€š' : 'å¾…å¯©æ ¸'}
                      </button>
                    </td>

                    <td className="px-6 py-4">
                      <div className="font-bold text-gray-900">{profile?.companyName}</div>
                      <div className="text-xs text-gray-500 font-mono">{profile?.taxId}</div>
                      <div className="text-[10px] text-gray-400 mt-1">{profile?.tradeType}</div>
                    </td>
                    <td className="px-6 py-4">
                      <div className="text-sm text-gray-900">{profile?.contactPerson}</div>
                      <div className="text-xs text-gray-400">{user.email}</div>
                    </td>
                    <td className="px-6 py-4">
                      <div className="flex items-center gap-2">
                        <span className={clsx("px-2 py-1 rounded text-xs font-bold border", profile?.level === 'A' ? "bg-yellow-100 text-yellow-800 border-yellow-200" : profile?.level === 'B' ? "bg-blue-100 text-blue-800 border-blue-200" : "bg-gray-100 text-gray-600 border-gray-200")}>
                          {profile?.level} ç´šå¤¥ä¼´
                        </span>
                        <button onClick={() => openModal(user, 'level')} className="text-gray-400 hover:text-blue-600 transition-colors" title="ä¿®æ”¹ç­‰ç´š"><ArrowUpCircle className="w-4 h-4" /></button>
                      </div>
                    </td>
                    <td className="px-6 py-4">
                      <div className="flex items-center gap-2">
                        <Wallet className="w-4 h-4 text-gray-400" />
                        <span className="font-mono font-bold text-gray-900">${Number(profile?.walletBalance).toLocaleString()}</span>
                      </div>
                    </td>
                    <td className="px-6 py-4 text-right">
                      <div className="flex items-center justify-end gap-2">
                        {profile?.level !== 'C' ? (
                          <button onClick={() => openModal(user, 'deposit')} className="text-blue-600 hover:bg-blue-50 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors border border-blue-100">å„²å€¼</button>
                        ) : <span className="text-xs text-gray-400 bg-gray-50 px-2 py-1 rounded">ä¸å¯å„²å€¼</span>}
                        
                        <button 
                          onClick={() => handleDeleteUser(user)} 
                          className="text-gray-400 hover:text-red-600 hover:bg-red-50 p-1.5 rounded-lg transition-colors"
                          title="åˆªé™¤æœƒå“¡"
                        >
                          <Trash2 className="w-4 h-4" />
                        </button>
                      </div>
                    </td>
                  </tr>
                );
              })
            }
          </tbody>
        </table>
      </div>

      {selectedUser && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            
            {modalMode === 'deposit' && (
              <>
                <h3 className="text-xl font-bold text-gray-900 mb-1">éŒ¢åŒ…å„²å€¼</h3>
                <p className="text-sm text-gray-500 mb-6">æ­£åœ¨ç‚º <span className="font-bold text-blue-600">{selectedUser.dealerProfile.companyName}</span> å„²å€¼</p>
                <div className="space-y-4">
                  <div><label className="block text-sm font-medium text-gray-700 mb-1">å„²å€¼é‡‘é¡ (NT$)</label><input type="number" autoFocus className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-lg font-mono" placeholder="ä¾‹å¦‚ï¼š100000" value={depositAmount} onChange={(e) => setDepositAmount(e.target.value)} /><p className="text-xs text-gray-500 mt-1 flex items-center gap-1"><AlertCircle className="w-3 h-3" /> å–®ç­†ä¸Šé™ï¼š{selectedUser.dealerProfile.level === 'A' ? '20è¬' : '10è¬'}</p></div>
                  <div className="flex gap-3 mt-6"><button onClick={closeModal} className="flex-1 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">å–æ¶ˆ</button><button onClick={handleDeposit} disabled={isSubmitting} className="flex-1 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold disabled:opacity-70">{isSubmitting ? 'è™•ç†ä¸­...' : 'ç¢ºèªå„²å€¼'}</button></div>
                </div>
              </>
            )}

            {modalMode === 'level' && (
              <>
                <h3 className="text-xl font-bold text-gray-900 mb-1">ä¿®æ”¹æœƒå“¡ç­‰ç´š</h3>
                <p className="text-sm text-gray-500 mb-6">èª¿æ•´ <span className="font-bold text-blue-600">{selectedUser.dealerProfile.companyName}</span> çš„æ¬Šé™</p>
                <div className="space-y-4">
                  <div><label className="block text-sm font-medium text-gray-700 mb-2">é¸æ“‡æ–°ç­‰ç´š</label><div className="grid grid-cols-3 gap-3">{['A', 'B', 'C'].map(lvl => (<button key={lvl} onClick={() => setNewLevel(lvl)} className={clsx("py-3 border-2 rounded-xl font-bold text-lg transition-all", newLevel === lvl ? "border-blue-600 bg-blue-50 text-blue-700" : "border-gray-200 hover:border-gray-300 text-gray-600")}>{lvl} ç´š</button>))}</div></div>
                  <div className="flex gap-3 mt-6"><button onClick={closeModal} className="flex-1 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">å–æ¶ˆ</button><button onClick={handleLevelChange} disabled={isSubmitting} className="flex-1 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold disabled:opacity-70">{isSubmitting ? 'å„²å­˜ä¸­...' : 'ç¢ºèªä¿®æ”¹'}</button></div>
                </div>
              </>
            )}
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="admin/src/components/Sidebar.tsx">
'use client';

import Link from "next/link";
import { useRouter } from "next/navigation";
import { LayoutDashboard, Package, Users, Settings, LogOut, Layers, BarChart3, ClipboardList } from "lucide-react"; // âœ¨ æ–°å¢ ClipboardList

export default function Sidebar() {
  const router = useRouter();

  const handleLogout = () => {
    if (confirm('ç¢ºå®šè¦ç™»å‡ºç®¡ç†å¾Œå°å—ï¼Ÿ')) {
      localStorage.removeItem('somalink_admin_token');
      localStorage.removeItem('somalink_admin_user');
      window.location.href = '/login';
    }
  };

  return (
    <aside className="w-64 bg-slate-900 text-white shrink-0 hidden md:flex flex-col fixed inset-y-0 left-0 z-50">
      
      {/* Logo å€ */}
      <div className="h-16 flex items-center px-6 border-b border-slate-800 shadow-md bg-slate-900">
        <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center font-bold text-lg mr-3 shadow-blue-900/20">
          S
        </div>
        <span className="font-bold text-lg tracking-wide">æ¾æˆæœ‰é™å…¬å¸</span>
      </div>

      {/* é¸å–®é€£çµå€ */}
      <nav className="flex-1 py-6 space-y-2 px-3 overflow-y-auto">
        <Link 
          href="/" 
          className="flex items-center px-3 py-3 text-slate-300 hover:text-white hover:bg-slate-800 rounded-lg transition-colors group"
        >
          <LayoutDashboard className="w-5 h-5 mr-3 group-hover:text-blue-400 transition-colors" />
          è®¢å–®æˆ°æƒ…å®¤
        </Link>

        <Link 
          href="/reports" 
          className="flex items-center px-3 py-3 text-slate-300 hover:text-white hover:bg-slate-800 rounded-lg transition-colors group"
        >
          <BarChart3 className="w-5 h-5 mr-3 group-hover:text-blue-400 transition-colors" />
          ç‡Ÿé‹å ±è¡¨
        </Link>

        <Link 
          href="/products" 
          className="flex items-center px-3 py-3 text-slate-300 hover:text-white hover:bg-slate-800 rounded-lg transition-colors group"
        >
          <Package className="w-5 h-5 mr-3 group-hover:text-blue-400 transition-colors" />
          ç”¢å“ç®¡ç†
        </Link>

        <Link 
          href="/series" 
          className="flex items-center px-3 py-3 text-slate-300 hover:text-white hover:bg-slate-800 rounded-lg transition-colors group"
        >
          <Layers className="w-5 h-5 mr-3 group-hover:text-blue-400 transition-colors" />
          ç³»åˆ—ç®¡ç†
        </Link>

        <Link 
          href="/users" 
          className="flex items-center px-3 py-3 text-slate-300 hover:text-white hover:bg-slate-800 rounded-lg transition-colors group"
        >
          <Users className="w-5 h-5 mr-3 group-hover:text-blue-400 transition-colors" />
          æœƒå“¡ç®¡ç†
        </Link>

        {/* âœ¨ æ–°å¢ï¼šç³»çµ±æ—¥èªŒ */}
        <Link 
          href="/logs" 
          className="flex items-center px-3 py-3 text-slate-300 hover:text-white hover:bg-slate-800 rounded-lg transition-colors group"
        >
          <ClipboardList className="w-5 h-5 mr-3 group-hover:text-blue-400 transition-colors" />
          ç³»çµ±æ—¥èªŒ
        </Link>

        <div className="pt-4 mt-4 border-t border-slate-800">
          <Link 
            href="/settings" 
            className="flex items-center px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors"
          >
            <Settings className="w-5 h-5 mr-3" />
            ç³»çµ±è¨­å®š
          </Link>
        </div>
      </nav>

      {/* åº•éƒ¨ä½¿ç”¨è€…è³‡è¨Š & ç™»å‡ºæŒ‰éˆ• */}
      <div className="p-4 border-t border-slate-800 bg-slate-900">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-full bg-linear-to-tr from-blue-500 to-purple-500 flex items-center justify-center shadow-lg font-bold text-sm">
            A
          </div>
          <div className="flex-1 min-w-0">
            <p className="text-sm font-medium truncate">Admin</p>
            <p className="text-xs text-slate-500 truncate">è¶…ç´šç®¡ç†å“¡</p>
          </div>
          <button 
            onClick={handleLogout}
            className="text-slate-400 hover:text-red-400 hover:bg-slate-800 p-2 rounded-md transition-all"
            title="ç™»å‡ºç³»çµ±"
          >
            <LogOut className="w-5 h-5" />
          </button>
        </div>
      </div>
    </aside>
  );
}
</file>

<file path="backend/src/auth/auth.controller.ts">
import { Controller, Post, Body, UnauthorizedException, Req, Ip } from '@nestjs/common';
import { AuthService } from './auth.service';

@Controller('auth')
export class AuthController {
  constructor(private readonly authService: AuthService) {}

  @Post('login')
  async login(@Body() body: any, @Req() req: any, @Ip() ip: string) {
    // 1. é©—è­‰å¸³è™Ÿå¯†ç¢¼
    const user = await this.authService.validateUser(body.email, body.password);
    
    if (!user) {
      throw new UnauthorizedException('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤');
    }

    // 2. å–å¾—å®¢æˆ¶ç«¯è³‡è¨Š (IP & User Agent)
    // å¦‚æœæœ‰ç¶“éåå‘ä»£ç† (å¦‚ Render/Vercel)ï¼ŒçœŸå¯¦ IP é€šå¸¸åœ¨ x-forwarded-for
    const realIp = req.headers['x-forwarded-for'] || ip || req.socket.remoteAddress;
    const userAgent = req.headers['user-agent'] || 'unknown';

    // 3. ç™¼æ”¾ Token ä¸¦è¨˜éŒ„æ—¥èªŒ
    return this.authService.login(user, realIp, userAgent);
  }

  // âœ¨âœ¨âœ¨ æ–°å¢ï¼šå¿˜è¨˜å¯†ç¢¼è«‹æ±‚ âœ¨âœ¨âœ¨
  // å‰ç«¯å‘¼å«æ­¤ API ä¾†ç”³è«‹é‡è¨­ä¿¡ä»¶
  @Post('forgot-password')
  async forgotPassword(@Body() body: { email: string }) {
    return this.authService.forgotPassword(body.email);
  }

  // âœ¨âœ¨âœ¨ æ–°å¢ï¼šåŸ·è¡Œé‡è¨­å¯†ç¢¼ âœ¨âœ¨âœ¨
  // å‰ç«¯åœ¨é‡è¨­é é¢è¼¸å…¥æ–°å¯†ç¢¼å¾Œï¼Œå‘¼å«æ­¤ API (éœ€å¸¶å…¥ç¶²å€ä¸Šçš„ token)
  @Post('reset-password')
  async resetPassword(@Body() body: { token: string; password: string }) {
    return this.authService.resetPassword(body.token, body.password);
  }
}
</file>

<file path="backend/src/auth/jwt.strategy.ts">
// æª”æ¡ˆä½ç½®: backend/src/auth/jwt.strategy.ts

import { ExtractJwt, Strategy } from 'passport-jwt';
import { PassportStrategy } from '@nestjs/passport';
import { Injectable, UnauthorizedException } from '@nestjs/common';
import { ConfigService } from '@nestjs/config'; // 1. æ–°å¢å¼•å…¥
import { UsersService } from '../users/users.service';

@Injectable()
export class JwtStrategy extends PassportStrategy(Strategy) {
  constructor(
    private usersService: UsersService,
    private configService: ConfigService, // 2. æ³¨å…¥ ConfigService
  ) {
    super({
      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
      ignoreExpiration: false,
      // 3. ä¿®æ­£ï¼šå¾ç’°å¢ƒè®Šæ•¸è®€å–å¯†é‘°ï¼Œå¦‚æœè®€ä¸åˆ°å‰‡ä½¿ç”¨é è¨­å€¼ (å»ºè­°æ­£å¼ç’°å¢ƒä¸€å®šè¦è¨­å®šç’°å¢ƒè®Šæ•¸)
      secretOrKey: configService.get<string>('JWT_SECRET') || 'secretKey',
    });
  }

  async validate(payload: any) {
    const user = await this.usersService.findByEmail(payload.email);
    if (!user) {
      throw new UnauthorizedException();
    }
    return user;
  }
}
</file>

<file path="backend/src/orders/entities/order-item.entity.ts">
import { Entity, Column, PrimaryGeneratedColumn, ManyToOne } from 'typeorm';
import { Order } from './order.entity';
import { Product } from '../../products/entities/product.entity';

export enum ServiceType {
  MATERIAL = 'material',   
  ASSEMBLED = 'assembled', 
}

@Entity()
export class OrderItem {
  @PrimaryGeneratedColumn('uuid')
  id: string;
  
  // é—œè¯å›è¨‚å–®ä¸»æª” (å¤šå°ä¸€)
  // onDelete: 'CASCADE' è¡¨ç¤ºå¦‚æœè¨‚å–®è¢«åˆªé™¤ï¼Œåº•ä¸‹çš„é …ç›®ä¹Ÿæœƒä¸€èµ·åˆªé™¤
  @ManyToOne(() => Order, (order) => order.items, { onDelete: 'CASCADE' }) 
  order: Order;

  @ManyToOne(() => Product, { eager: true })
  product: Product;

  @Column({
    type: 'enum',
    enum: ServiceType,
    default: ServiceType.ASSEMBLED
  })
  serviceType: ServiceType;
  
  @Column({ type: 'jsonb' })
  widthMatrix: { top: number; mid: number; bot: number };

  @Column({ type: 'jsonb' })
  heightData: any; 

  @Column({ default: true })
  isCeilingMounted: boolean; 

  @Column({ type: 'jsonb', nullable: true })
  siteConditions: any;

  @Column()
  colorName: string;

  @Column()
  materialName: string;

  // âœ¨âœ¨âœ¨ æ–°å¢ï¼šæŠŠæ‰‹åç¨± (èˆ‡è³¼ç‰©è»Šä¸€è‡´) âœ¨âœ¨âœ¨
  @Column({ nullable: true })
  handleName: string;

  @Column()
  openingDirection: string;

  @Column({ default: false })
  hasThreshold: boolean;

  @Column({ type: 'int', default: 1 })
  quantity: number;

  @Column({ type: 'decimal', precision: 12, scale: 2 })
  subtotal: number; 

  // âœ¨âœ¨âœ¨ è©³ç´°åƒ¹æ ¼å¿«ç…§ (ç¢ºä¿èˆ‡è³¼ç‰©è»Šçµæ§‹ä¸€è‡´) âœ¨âœ¨âœ¨
  @Column({ type: 'jsonb' })
  priceSnapshot: {
    basePrice: number;
    sizeSurcharge: number;
    colorSurcharge: number;
    materialSurcharge: number;
    handleSurcharge: number;
    assemblyFee: number;
    thresholdFee: number;
  };
}
</file>

<file path="backend/src/orders/orders.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { OrdersService } from './orders.service';
import { OrdersController } from './orders.controller';
import { Order } from './entities/order.entity';
import { OrderItem } from './entities/order-item.entity';
import { User } from '../users/entities/user.entity';
import { NotificationsModule } from '../notifications/notifications.module';
// âœ¨âœ¨âœ¨ å¼•å…¥ SiteConfigModule âœ¨âœ¨âœ¨
import { SiteConfigModule } from '../site-config/site-config.module';

@Module({
  imports: [
    TypeOrmModule.forFeature([Order, OrderItem, User]), 
    NotificationsModule,
    // âœ¨âœ¨âœ¨ è¨»å†Š âœ¨âœ¨âœ¨
    SiteConfigModule
  ],
  controllers: [OrdersController],
  providers: [OrdersService],
  exports: [OrdersService], 
})
export class OrdersModule {}
</file>

<file path="backend/src/users/dto/update-user.dto.ts">
import { PartialType } from '@nestjs/mapped-types';
import { CreateUserDto } from './create-user.dto';
import { IsBoolean, IsOptional, IsEnum } from 'class-validator';
import { UserRole } from '../entities/user.entity'; // âœ¨ ä¿®æ­£å¼•ç”¨è·¯å¾‘

export class UpdateUserDto extends PartialType(CreateUserDto) {
  @IsOptional()
  @IsBoolean()
  isActive?: boolean;

  @IsOptional()
  @IsEnum(UserRole)
  role?: UserRole;
}
</file>

<file path="frontend/eslint.config.mjs">
import { dirname } from "path";
import { fileURLToPath } from "url";
import { FlatCompat } from "@eslint/eslintrc";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const compat = new FlatCompat({
  baseDirectory: __dirname,
});

const eslintConfig = [
  // 1. ç¹¼æ‰¿ Next.js é è¨­è¦å‰‡
  ...compat.extends("next/core-web-vitals", "next/typescript"),
  
  // 2. âœ¨âœ¨âœ¨ æ–°å¢ï¼šè‡ªå®šç¾©è¦å‰‡ (é—œé–‰åš´æ ¼æª¢æŸ¥) âœ¨âœ¨âœ¨
  {
    rules: {
      // å…è¨±ä½¿ç”¨ any å‹åˆ¥
      "@typescript-eslint/no-explicit-any": "off",
      // å…è¨±å®£å‘Šæœªä½¿ç”¨çš„è®Šæ•¸ (å¦‚ catch(e) çš„ e)
      "@typescript-eslint/no-unused-vars": "off",
      // (é¸ç”¨) é—œé–‰ React Hook ä¾è³´æª¢æŸ¥è­¦å‘Šï¼Œé¿å… yellow lines
      "react-hooks/exhaustive-deps": "off" 
    },
  },
];

export default eslintConfig;
</file>

<file path="frontend/src/app/layout.tsx">
import './globals.css';
import type { Metadata } from 'next';
import { Inter } from 'next/font/google';
import Navbar from '@/components/Navbar';
import { CartProvider } from '@/context/CartContext';

const inter = Inter({ subsets: ['latin'] });

export const metadata: Metadata = {
  title: 'æ¾æˆæœ‰é™å…¬å¸ B2B æ•¸ä½å·¥å» ',
  description: 'ç¶“éŠ·å•†å°ˆå±¬å®¢è£½åŒ–é–€æ‰‡èˆ‡å»ºææ¡è³¼å¹³å°',
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="zh-TW">
      {/* ä½¿ç”¨ Inter å­—é«” */}
      <body className={inter.className}>
        {/* è³¼ç‰©è»Šç‹€æ…‹æä¾›è€…ï¼ŒåŒ…è£¹æ•´å€‹æ‡‰ç”¨ç¨‹å¼ */}
        <CartProvider>
          {/* å°è¦½åˆ—ï¼Œé¡¯ç¤ºåœ¨æ‰€æœ‰é é¢é ‚éƒ¨ */}
          <Navbar />
          
          {/* é é¢å…§å®¹ (ä¾‹å¦‚ /page.tsx, /product/[id]/page.tsx) */}
          <main>
            {children}
          </main>
        </CartProvider>
      </body>
    </html>
  )
}
</file>

<file path="frontend/src/app/orders/[id]/print/page.tsx">
'use client';

import { useEffect, useState, use } from 'react';
import { useRouter } from 'next/navigation'; 
import { api } from '@/lib/api';
import { Loader2, Printer, MapPin, Phone, User, MessageSquare } from 'lucide-react';

export default function PrintDeliveryNotePage({ params }: { params: Promise<{ id: string }> }) {
  const { id } = use(params);
  const router = useRouter(); 
  const [order, setOrder] = useState<any>(null);
  const [showPrice, setShowPrice] = useState(true); 
  const [isReady, setIsReady] = useState(false);

  useEffect(() => {
    if (typeof window !== 'undefined') {
      const searchParams = new URLSearchParams(window.location.search);
      const tokenFromUrl = searchParams.get('t');
      if (tokenFromUrl) {
        sessionStorage.setItem('somalink_token', tokenFromUrl);
      }
    }
    setIsReady(true);
  }, []);

  useEffect(() => {
    if (!isReady) return;
    api.get(`/orders/${id}`)
      .then(res => setOrder(res))
      .catch(err => {
        console.error(err);
        if (err.response?.status === 401) {
          alert('æ‚¨çš„ç™»å…¥æ†‘è­‰å·²éæœŸæˆ–ç„¡æ•ˆï¼Œè«‹é‡æ–°ç™»å…¥ã€‚');
          router.push('/login'); 
        }
      });
  }, [id, isReady, router]);

  if (!order) return <div className="flex justify-center p-12"><Loader2 className="animate-spin w-8 h-8 text-blue-600" /></div>;

  return (
    <div className="min-h-screen bg-gray-100 p-8 print:p-0 print:bg-white">
      
      {/* æ§åˆ¶åˆ— (åˆ—å°æ™‚éš±è—) */}
      <div className="max-w-[210mm] mx-auto mb-6 flex justify-between items-center print:hidden bg-white p-4 rounded-lg shadow-sm border border-gray-200">
        <div className="flex items-center gap-3">
          <label className="flex items-center gap-2 cursor-pointer select-none">
            <input 
              type="checkbox" 
              checked={showPrice} 
              onChange={(e) => setShowPrice(e.target.checked)}
              className="w-4 h-4 text-blue-600 rounded cursor-pointer" 
            />
            <span className="text-sm text-gray-700 font-medium">é¡¯ç¤ºé‡‘é¡</span>
          </label>
          <span className="text-xs text-gray-400">| (çµ¦å¸æ©Ÿæˆ–ç¾å ´çœ‹çš„å–®æ“šå¯å–æ¶ˆå‹¾é¸)</span>
        </div>
        <button 
          onClick={() => window.print()}
          className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-sm transition-colors"
        >
          <Printer className="w-4 h-4" /> åˆ—å° / å­˜ç‚º PDF
        </button>
      </div>

      {/* A4 ç´™å¼µå€åŸŸ 
          âœ¨ ä¿®æ”¹ 1: ç§»é™¤ min-h-[297mm]ï¼Œæ”¹ç”¨ min-h-screen æˆ– autoï¼Œä¸¦åœ¨ print æ™‚è¨­ç‚º h-auto
          âœ¨ ä¿®æ”¹ 2: ç§»é™¤ flex flex-colï¼Œæ”¹ç”¨ block è®“å…§å®¹è‡ªç„¶æµå‹•
      */}
      <div className="max-w-[210mm] mx-auto bg-white shadow-xl print:shadow-none p-8 print:p-6 text-black font-sans relative box-border print:h-auto print:min-h-0">
        
        {/* Header */}
        <div className="flex justify-between items-start border-b-4 border-black pb-4 mb-4">
          <div className="flex items-center gap-4">
            <div className="w-14 h-14 bg-black text-white flex items-center justify-center text-2xl font-bold rounded-lg print:border print:border-black">S</div>
            <div>
              <h1 className="text-2xl font-extrabold tracking-wider text-black">å‡ºè²¨å–®</h1>
              <p className="text-sm font-bold mt-1 text-black">æ¾æˆæœ‰é™å…¬å¸</p>
              <div className="flex gap-4 text-xs text-black font-medium mt-0.5">
                <span>çµ±ç·¨ï¼š12345678</span>
                <span>é›»è©±ï¼š(02) 2345-6789</span>
              </div>
            </div>
          </div>
          <div className="text-right">
            <div className="inline-block border-2 border-black px-3 py-1 rounded mb-1">
              <p className="text-[10px] font-bold uppercase tracking-wide text-black">å‡ºè²¨å–®è™Ÿ NO.</p>
              <p className="text-lg font-mono font-bold text-black leading-none">{order.orderNumber}</p>
            </div>
            <p className="text-xs mt-1 text-black font-medium">åˆ—å°æ—¥æœŸï¼š{new Date().toLocaleDateString()}</p>
          </div>
        </div>

        {/* å®¢æˆ¶èˆ‡é€è²¨è³‡è¨Š */}
        <div className="grid grid-cols-2 gap-4 mb-4 break-inside-avoid">
          
          <div className="border-2 border-black rounded p-3">
            <h3 className="text-xs font-bold bg-gray-200 px-2 py-0.5 mb-2 inline-block rounded text-black print:border print:border-black">è¨‚è³¼ç¶“éŠ·å•† (Bill To)</h3>
            <div className="space-y-0.5 text-sm text-black">
              <p><span className="font-bold w-16 inline-block">å…¬å¸åç¨±ï¼š</span><span className="font-bold">{order.user?.dealerProfile?.companyName}</span></p>
              <p><span className="font-bold w-16 inline-block">è¯çµ¡äººï¼š</span>{order.user?.dealerProfile?.contactPerson}</p>
              <p><span className="font-bold w-16 inline-block">é›»è©±ï¼š</span>{order.user?.dealerProfile?.phone}</p>
            </div>
          </div>

          <div className="border-2 border-black rounded p-3">
            <h3 className="text-xs font-bold bg-gray-200 px-2 py-0.5 mb-2 inline-block rounded text-black print:border print:border-black">é€è²¨è³‡è¨Š (Ship To)</h3>
            <div className="space-y-0.5 text-sm text-black">
              <div className="mb-1">
                <p className="text-[10px] font-bold text-black">æ¡ˆå ´åç¨±</p>
                <p className="font-bold text-base leading-tight">{order.projectName}</p>
              </div>
              
              <div className="flex items-start gap-1 mb-1">
                <MapPin className="w-3.5 h-3.5 mt-0.5 text-black shrink-0" />
                <span className="font-bold border-b border-black pb-0 text-sm leading-tight">
                  {order.shippingAddress || 'æœªæŒ‡å®šåœ°å€ (åŒç¶“éŠ·å•†)'}
                </span>
              </div>

              <div className="grid grid-cols-2 gap-1 text-xs">
                <p className="flex items-center font-medium">
                  <User className="w-3 h-3 mr-1 text-black" /> 
                  {order.siteContactPerson || order.user?.dealerProfile?.contactPerson}
                </p>
                <p className="flex items-center font-medium">
                  <Phone className="w-3 h-3 mr-1 text-black" /> 
                  {order.siteContactPhone || order.user?.dealerProfile?.phone}
                </p>
              </div>
            </div>
          </div>
        </div>

        {/* è¨‚å–®å‚™è¨» */}
        {order.customerNote && (
          <div className="mb-4 border-2 border-black bg-gray-50 p-2 rounded text-sm flex items-start gap-2 break-inside-avoid">
            <MessageSquare className="w-4 h-4 text-black mt-0.5 shrink-0" />
            <div className="text-black">
              <span className="font-bold mr-2">è¨‚å–®å‚™è¨»ï¼š</span>
              <span className="font-medium">{order.customerNote}</span>
            </div>
          </div>
        )}

        {/* ç”¢å“æ˜ç´° - âœ¨ ä¿®æ”¹ 3: ç§»é™¤ flex-1ï¼Œè®“å®ƒè‡ªç„¶ä½”ç”¨é«˜åº¦ */}
        <div className="mb-4">
          <table className="w-full border-collapse">
            <thead>
              <tr className="bg-gray-200 border-y-2 border-black text-xs text-black">
                <th className="py-1 px-2 text-left w-8 font-bold">#</th>
                <th className="py-1 px-2 text-left font-bold">ç”¢å“åç¨± / è©³ç´°è¦æ ¼</th>
                <th className="py-1 px-2 text-center w-16 font-bold">æ•¸é‡</th>
                {showPrice && <th className="py-1 px-2 text-right w-24 font-bold">å–®åƒ¹</th>}
                {showPrice && <th className="py-1 px-2 text-right w-24 font-bold">é‡‘é¡</th>}
              </tr>
            </thead>
            <tbody className="text-sm text-black">
              {order.items?.map((item: any, index: number) => (
                <tr key={index} className="border-b border-black break-inside-avoid">
                  <td className="py-2 px-2 align-top font-bold text-center">{index + 1}</td>
                  <td className="py-2 px-2 align-top">
                    <p className="font-bold text-sm">{item.product?.name}</p>
                    <div className="text-black text-[10px] mt-1 grid grid-cols-2 gap-x-2 gap-y-0.5 font-mono font-medium">
                      <p>å‹è™Ÿ: {item.product?.sku}</p>
                      <p>é¡è‰²: {item.colorName}</p>
                      <p>æè³ª: {item.materialName}</p>
                      <p>é–‹å‘: {item.openingDirection}</p>
                      <p>æ¨¡å¼: {item.serviceType === 'assembled' ? 'é€£å·¥å¸¶æ–™' : 'ç´”ææ–™'}</p>
                      {item.handleName && <p className="col-span-2 font-bold text-blue-900">æŠŠæ‰‹: {item.handleName}</p>}
                    </div>
                    <div className="mt-1 bg-white px-1.5 py-0.5 rounded inline-block text-[10px] font-mono border border-black font-bold">
                      W: {item.widthMatrix?.mid} x H: {item.heightData?.singleValue || item.heightData?.mid}
                      {item.isCeilingMounted && <span className="ml-1 text-black font-extrabold">(å°é ‚)</span>}
                    </div>
                  </td>
                  <td className="py-2 px-2 text-center align-top font-bold">{item.quantity}</td>
                  {showPrice && <td className="py-2 px-2 text-right align-top font-mono font-medium">${Number(item.unitPrice || item.subtotal / item.quantity).toLocaleString()}</td>}
                  {showPrice && <td className="py-2 px-2 text-right align-top font-bold font-mono">${Number(item.subtotal).toLocaleString()}</td>}
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        {/* ç¸½è¨ˆèˆ‡ç°½å - âœ¨ ä¿®æ”¹ 4: ç¢ºä¿è·Ÿéš¨å…§å®¹ï¼Œä¸è¢«æ¨åˆ°åº•éƒ¨ */}
        <div className="break-inside-avoid">
          {showPrice && (
            <div className="flex justify-end mb-6 border-t-2 border-black pt-2">
              <div className="text-right">
                <p className="text-xs font-bold text-black">ç¸½è¨ˆé‡‘é¡ (å«ç¨…)</p>
                <p className="text-2xl font-extrabold text-black">NT$ {Number(order.totalAmount).toLocaleString()}</p>
              </div>
            </div>
          )}

          <div className="mt-4 pt-4 border-t border-dashed border-gray-400">
            <div className="grid grid-cols-3 gap-8">
              <div className="text-center">
                <p className="text-xs font-bold mb-6 text-black">å€‰ç®¡å‚™è²¨</p>
                <div className="border-b-2 border-black w-3/4 mx-auto"></div>
              </div>
              <div className="text-center">
                <p className="text-xs font-bold mb-6 text-black">å¸æ©Ÿé…é€</p>
                <div className="border-b-2 border-black w-3/4 mx-auto"></div>
              </div>
              <div className="text-center">
                <p className="text-xs font-bold mb-6 text-black">å®¢æˆ¶ç°½æ”¶</p>
                <div className="border-b-2 border-black w-3/4 mx-auto"></div>
                <p className="text-[9px] text-black font-bold mt-1">æœ¬äººç¢ºèªä¸Šè¿°è¦æ ¼èˆ‡æ•¸é‡ç„¡èª¤</p>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  );
}
</file>

<file path="frontend/src/app/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { Megaphone, X, Loader2 } from "lucide-react";
import { api } from '@/lib/api';
import HeroBlock from '@/components/blocks/HeroBlock';
import FeaturesBlock from '@/components/blocks/FeaturesBlock';
import ProductListBlock from '@/components/blocks/ProductListBlock';

export default function HomePage() {
  const [announcement, setAnnouncement] = useState<string | null>(null);
  const [showBanner, setShowBanner] = useState(true);
  const [blocks, setBlocks] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  
  // âœ¨ ç³»çµ±è¦å‰‡ (å«å…¬å¸è³‡è¨Š)
  const [systemRules, setSystemRules] = useState<any>(null);

  useEffect(() => {
    const fetchData = async () => {
      try {
        const annRes = await api.get('/announcements/active');
        if (annRes?.content) setAnnouncement(annRes.content);

        const configRes = await api.get('/site-config/homepage');
        if (configRes?.blocks) setBlocks(configRes.blocks);

        // âœ¨ æŠ“å–ç³»çµ±è¦å‰‡ (å…¬å¸è³‡è¨Š)
        const rulesRes = await api.get('/site-config/rules');
        if (rulesRes?.settings) setSystemRules(rulesRes.settings);

      } catch (err) {
        console.error('ç„¡æ³•å–å¾—é¦–é è³‡æ–™', err);
      } finally {
        setLoading(false);
      }
    };
    fetchData();
  }, []);

  if (loading) return <div className="h-screen flex items-center justify-center bg-gray-50"><div className="flex flex-col items-center gap-3"><Loader2 className="animate-spin text-blue-600 w-10 h-10" /><p className="text-gray-500 text-sm">è¼‰å…¥é¦–é ä¸­...</p></div></div>;

  return (
    <div className="min-h-screen bg-gray-50 font-sans">
      {announcement && showBanner && (
        <div className="bg-blue-600 text-white px-4 py-2.5 relative flex justify-center items-center text-sm z-50 animate-in slide-in-from-top">
          <div className="flex items-center gap-2"><Megaphone className="w-4 h-4 animate-pulse" /><span>{announcement}</span></div>
          <button onClick={() => setShowBanner(false)} className="absolute right-2 p-1 hover:bg-blue-700 rounded-full transition-colors"><X className="w-4 h-4" /></button>
        </div>
      )}

      {blocks.length === 0 ? (
        <div className="py-20 text-center text-gray-400">
          <p>é¦–é ç›®å‰æ²’æœ‰å…§å®¹ï¼Œè«‹è‡³å¾Œå° [ç³»çµ±è¨­å®š] &rarr; [é¦–é ç‰ˆé¢é…ç½®] æ–°å¢ç©æœ¨ã€‚</p>
        </div>
      ) : (
        blocks.map((block) => {
          switch (block.type) {
            case 'HERO': return <HeroBlock key={block.id} data={block.data} />;
            case 'FEATURES': return <FeaturesBlock key={block.id} data={block.data} />;
            case 'PRODUCT_LIST': return <ProductListBlock key={block.id} data={block.data} />;
            default: return null;
          }
        })
      )}

      {/* âœ¨âœ¨âœ¨ å‹•æ…‹ Footer âœ¨âœ¨âœ¨ */}
      <footer className="bg-gray-900 text-white py-12">
        <div className="max-w-7xl mx-auto px-6 flex flex-col md:flex-row justify-between items-center gap-6">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center font-bold text-lg">S</div>
            <div>
              <span className="text-xl font-bold block">{systemRules?.company_name || 'æ¾æˆæœ‰é™å…¬å¸'}</span>
              <span className="text-xs text-gray-400">çµ±ä¸€ç·¨è™Ÿï¼š{systemRules?.tax_id || '12345678'}</span>
            </div>
          </div>
          <div className="text-center md:text-right text-sm text-gray-400">
            <p>åœ°å€ï¼š{systemRules?.address || 'æ–°åŒ—å¸‚ä¸‰é‡å€...'}</p>
            <p className="mt-1">é›»è©±ï¼š{systemRules?.phone || '(02) 2345-6789'}</p>
            <p className="mt-4 text-xs text-gray-600">{systemRules?.copyright_text || 'Â© 2025 SomaLink. All rights reserved.'}</p>
          </div>
        </div>
      </footer>
    </div>
  );
}
</file>

<file path="frontend/src/app/product/[id]/page.tsx">
'use client';

import { useState, useEffect, use } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { Ruler, Loader2, Hammer, Package, ArrowLeft, GripHorizontal, CheckCircle, BadgePercent } from 'lucide-react';
import clsx from 'clsx';
import MeasurementModal, { MeasurementData } from '@/components/MeasurementModal';
import { useCart, CartItem } from '@/context/CartContext';
import { api } from '@/lib/api';

export default function ProductDetailPage({ params }: { params: Promise<{ id: string }> }) {
  const { id } = use(params);
  const router = useRouter();
  const { addToCart } = useCart();

  const [product, setProduct] = useState<any>(null);
  const [systemRules, setSystemRules] = useState<any>(null); 
  const [userLevel, setUserLevel] = useState<string>('C');   
  
  const [loading, setLoading] = useState(true);
  const [authChecking, setAuthChecking] = useState(true);

  const [activeImageIndex, setActiveImageIndex] = useState(0);

  // é¸é …ç‹€æ…‹
  const [selectedColor, setSelectedColor] = useState<string>('');
  const [selectedMaterial, setSelectedMaterial] = useState<string>('');
  const [selectedHandle, setSelectedHandle] = useState<string>('');
  const [openingDirection, setOpeningDirection] = useState<string>('');
  const [serviceType, setServiceType] = useState<'material' | 'assembled'>('assembled'); 
  
  const [isMeasureOpen, setIsMeasureOpen] = useState(false);
  const [showSuccessModal, setShowSuccessModal] = useState(false);
  const [successMsg, setSuccessMsg] = useState('');

  const [quantity] = useState(1);
  const [isSubmitting, setIsSubmitting] = useState(false);

  // 1. è¼‰å…¥è³‡æ–™ (å«æ¬Šé™æª¢æŸ¥)
  useEffect(() => {
    // âœ¨âœ¨âœ¨ æª¢æŸ¥æ˜¯å¦ç™»å…¥ (é˜²æ­¢ç›´æ¥è¼¸å…¥ç¶²å€é€²å…¥) âœ¨âœ¨âœ¨
    const token = localStorage.getItem('somalink_token') || sessionStorage.getItem('somalink_token');
    if (!token) {
      // æœªç™»å…¥ç›´æ¥å°å›ç™»å…¥é 
      router.replace('/login');
      return;
    }
    setAuthChecking(false);

    const fetchData = async () => {
      try {
        // A. æŠ“ç”¢å“
        const prodRes = await api.get(`/products/${id}`);
        const prodData = prodRes.data || prodRes; 
        
        // åœ–ç‰‡é˜²å‘†è™•ç†
        if (!prodData.images || !Array.isArray(prodData.images) || prodData.images.length === 0) {
            if (prodData.imageUrl) prodData.images = [prodData.imageUrl];
            else prodData.images = ["https://images.unsplash.com/photo-1600607686527-6fb886090705?auto=format&fit=crop&q=80&w=800"];
        }
        setProduct(prodData);
        
        // è¨­å®šé è¨­é¸é … (é˜²å‘†ï¼šç¢ºèªé™£åˆ—å­˜åœ¨æ‰å–å€¼)
        if (Array.isArray(prodData.colors) && prodData.colors.length > 0) setSelectedColor(prodData.colors[0].name);
        if (Array.isArray(prodData.materials) && prodData.materials.length > 0) setSelectedMaterial(prodData.materials[0].name);
        if (Array.isArray(prodData.handles) && prodData.handles.length > 0) setSelectedHandle(prodData.handles[0].name);
        if (Array.isArray(prodData.openingOptions) && prodData.openingOptions.length > 0) setOpeningDirection(prodData.openingOptions[0]);

        // B. æŠ“ç³»çµ±è¦å‰‡ (ç‚ºäº†å…¨åŸŸæŠ˜æ•¸)
        try {
          const ruleRes = await api.get('/site-config/rules');
          if (ruleRes?.settings) setSystemRules(ruleRes.settings);
        } catch (e) { console.error('ç„¡æ³•è®€å–ç³»çµ±è¦å‰‡ (ä½¿ç”¨é è¨­å€¼)', e); }

        // C. æŠ“æœƒå“¡ç­‰ç´š
        const storedUser = localStorage.getItem('somalink_user') || sessionStorage.getItem('somalink_user');
        if (storedUser) {
          try {
            const u = JSON.parse(storedUser);
            if (u.dealerProfile?.level) setUserLevel(u.dealerProfile.level);
          } catch (e) { console.error('è§£ææœƒå“¡è³‡æ–™å¤±æ•—'); }
        }

      } catch (err) {
        console.error('è³‡æ–™è¼‰å…¥å¤±æ•—', err);
      } finally {
        setLoading(false);
      }
    };
    fetchData();
  }, [id, router]);

  // å¦‚æœæ­£åœ¨æª¢æŸ¥æ¬Šé™æˆ–è¼‰å…¥ä¸­ï¼Œé¡¯ç¤º Loading
  if (authChecking || loading) return <div className="min-h-screen flex justify-center items-center"><Loader2 className="animate-spin text-blue-600" /></div>;
  if (!product) return <div className="min-h-screen flex justify-center items-center">æ‰¾ä¸åˆ°ç”¢å“</div>;

  // âœ¨âœ¨âœ¨ 2. è¨ˆç®—æŠ˜æ•¸èˆ‡åƒ¹æ ¼ (å„ªå…ˆæ¬Šé‚è¼¯) âœ¨âœ¨âœ¨
  
  let discountMultiplier = 1.0; // é è¨­åŸåƒ¹
  // ç¢ºä¿æ•¸å€¼å‹åˆ¥
  const productDiscountA = product.discountA != null ? Number(product.discountA) : null;
  const productDiscountB = product.discountB != null ? Number(product.discountB) : null;
  const systemDiscountA = systemRules?.discount_level_A ? Number(systemRules.discount_level_A) : 1.0;
  const systemDiscountB = systemRules?.discount_level_B ? Number(systemRules.discount_level_B) : 1.0;

  if (userLevel === 'A') {
    // å„ªå…ˆæ¬Šï¼šç”¢å“å€‹åˆ¥è¨­å®š > ç³»çµ±å…¨åŸŸè¨­å®š > åŸåƒ¹
    discountMultiplier = productDiscountA ?? systemDiscountA;
  } else if (userLevel === 'B') {
    discountMultiplier = productDiscountB ?? systemDiscountB;
  }

  // åŸºç¤é…ç½®åŠ ç¸½ (å®‰å…¨ç‰ˆï¼šåŠ ä¸Š || 0 é¿å… NaN)
  const currentColorObj = product.colors?.find((c: any) => c.name === selectedColor);
  const currentMaterialObj = product.materials?.find((m: any) => m.name === selectedMaterial);
  const currentHandleObj = product.handles?.find((h: any) => h.name === selectedHandle);

  let rawUnitPrice = Number(product.basePrice || 0) + 
                     (Number(currentColorObj?.priceSurcharge) || 0) + 
                     (Number(currentMaterialObj?.priceSurcharge) || 0) +
                     (Number(currentHandleObj?.priceSurcharge) || 0);
  
  const assemblyFee = Number(product.assemblyFee) || 3000; // é è¨­ 3000
  if (serviceType === 'assembled') rawUnitPrice += assemblyFee;

  // æœ€çµ‚å–®åƒ¹ (æ‰“æŠ˜å¾Œ)
  const finalUnitPrice = Math.round(rawUnitPrice * discountMultiplier);

  // 3. åŠ å…¥è³¼ç‰©è»Šé‚è¼¯
  const handleAddToCart = (measureData?: MeasurementData) => {
    setIsSubmitting(true);

    let sizeSurcharge = 0;
    // å®‰å…¨è®€å–å°ºå¯¸åŠ åƒ¹åƒæ•¸
    const pricePerW = Number(product.pricePerUnitWidth) || 0;
    const pricePerH = Number(product.pricePerUnitHeight) || 0;
    const stdW = Number(product.standardWidth) || 90;
    const stdH = Number(product.standardHeight) || 210;

    if (measureData && product.requiresMeasurement) {
      const wValues = [measureData.width.top, measureData.width.mid, measureData.width.bot];
      const maxW = Math.max(...wValues); 
      const hValues = [measureData.height.left, measureData.height.mid, measureData.height.right];
      const maxH = measureData.height.singleValue || Math.max(...hValues); 

      if (maxW > stdW) sizeSurcharge += Math.ceil((maxW - stdW) / 10) * pricePerW;
      if (maxH > stdH) sizeSurcharge += Math.ceil((maxH - stdH) / 10) * pricePerH;
    }

    // å°ºå¯¸åŠ åƒ¹ä¹Ÿæ‰“æŠ˜
    const finalSizeSurcharge = Math.round(sizeSurcharge * discountMultiplier);
    
    const totalUnitPrice = finalUnitPrice + finalSizeSurcharge;
    const totalSubtotal = totalUnitPrice * quantity;

    const newItem: CartItem = {
      internalId: crypto.randomUUID(),
      productId: product.id,
      productName: product.name,
      unitPrice: totalUnitPrice, // ä½¿ç”¨æ‰“æŠ˜å¾Œçš„æœ€çµ‚å–®åƒ¹
      quantity: quantity,
      subtotal: totalSubtotal,
      serviceType: serviceType, 
      colorName: selectedColor || 'æ¨™æº–',
      materialName: selectedMaterial || 'æ¨™æº–',
      handleName: selectedHandle || 'ç„¡',
      openingDirection: openingDirection || 'ç„¡',
      hasThreshold: false,
      widthMatrix: measureData?.width || { top: 0, mid: 0, bot: 0 },
      heightData: measureData?.height || { left: 0, mid: 0, right: 0 },
      isCeilingMounted: measureData?.isCeilingMounted ?? false,
      siteConditions: measureData?.floorError ? { floor: measureData.floorError } : undefined,
      priceSnapshot: {
        basePrice: Number(product.basePrice || 0),
        sizeSurcharge: finalSizeSurcharge, 
        colorSurcharge: Number(currentColorObj?.priceSurcharge) || 0,
        materialSurcharge: Number(currentMaterialObj?.priceSurcharge) || 0,
        handleSurcharge: Number(currentHandleObj?.priceSurcharge) || 0,
        assemblyFee: serviceType === 'assembled' ? assemblyFee : 0,
        thresholdFee: 0
      }
    };

    addToCart(newItem);

    setTimeout(() => {
      setIsSubmitting(false);
      setIsMeasureOpen(false);
      let msg = '';
      if (finalSizeSurcharge > 0) msg = `(å«å°ºå¯¸åŠ åƒ¹ $${finalSizeSurcharge.toLocaleString()})`;
      setSuccessMsg(msg);
      setShowSuccessModal(true);
    }, 500);
  };

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-6xl mx-auto px-4">
        <div className="mb-6">
          <Link href={product.series ? `/series/${encodeURIComponent(product.series)}` : "/"} className="inline-flex items-center gap-2 text-gray-500 hover:text-blue-600 transition-colors font-medium">
            <ArrowLeft className="w-5 h-5" /> è¿”å› {product.series || 'é¦–é '}
          </Link>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-10">
          
          {/* å·¦å´åœ–ç‰‡ç•«å»Š */}
          <div className="space-y-4">
            <div className="aspect-square bg-white rounded-2xl border border-gray-200 overflow-hidden shadow-sm relative group">
               {/* eslint-disable-next-line @next/next/no-img-element */}
              <img src={product.images[activeImageIndex]} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" alt={product.name} />
            </div>
            {product.images.length > 1 && (
              <div className="flex gap-3 overflow-x-auto pb-2 snap-x">
                {product.images.map((img: string, idx: number) => (
                  <button key={idx} onClick={() => setActiveImageIndex(idx)} className={clsx("relative w-20 h-20 rounded-lg overflow-hidden border-2 shrink-0 transition-all snap-start", activeImageIndex === idx ? "border-blue-600 ring-2 ring-blue-100" : "border-transparent hover:border-gray-300")}>
                    {/* eslint-disable-next-line @next/next/no-img-element */}
                    <img src={img} alt={`Thumbnail ${idx}`} className="w-full h-full object-cover" />
                  </button>
                ))}
              </div>
            )}
          </div>

          <div className="space-y-8">
            
            <div className="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm relative overflow-hidden">
              
              {/* æœƒå“¡ç­‰ç´šæ¨™ç±¤ */}
              {discountMultiplier < 1 && (
                <div className="absolute top-4 right-4 flex items-center gap-1 bg-red-100 text-red-700 px-3 py-1 rounded-full text-xs font-bold shadow-sm border border-red-200">
                  <BadgePercent className="w-4 h-4" />
                  {userLevel} ç´šæœƒå“¡å°ˆå±¬å„ªæƒ  ({(discountMultiplier * 10).toFixed(1)}æŠ˜)
                </div>
              )}

              <h1 className="text-2xl font-bold text-gray-900">{product.name}</h1>
              <p className="text-gray-500 text-sm mt-1">{product.series} / {product.sku}</p>
              
              <div className="mt-4 flex items-end gap-3">
                <div className="flex items-baseline gap-2">
                  <span className="text-4xl font-bold text-blue-600">${finalUnitPrice.toLocaleString()}</span>
                  <span className="text-sm text-gray-500">/ {serviceType === 'assembled' ? 'é€£å·¥å¸¶æ–™' : 'ç´”ææ–™'}</span>
                </div>
                {discountMultiplier < 1 && (
                  <span className="text-sm text-gray-400 line-through mb-1">åŸåƒ¹ ${rawUnitPrice.toLocaleString()}</span>
                )}
              </div>
              
              {product.requiresMeasurement && <p className="text-xs text-orange-600 mt-2 bg-orange-50 px-2 py-1 rounded inline-block">* å¯¦éš›åƒ¹æ ¼å°‡æ–¼è¼¸å…¥ä¸ˆé‡å°ºå¯¸å¾Œè¨ˆç®— (æ¨™æº– {product.standardWidth}x{product.standardHeight}cm å…§ä¸åŠ åƒ¹)</p>}
            </div>

            {/* æœå‹™æ¨¡å¼ */}
            <div>
              <h3 className="text-sm font-bold text-gray-900 mb-3">æœå‹™æ¨¡å¼</h3>
              <div className="grid grid-cols-2 gap-3">
                <button onClick={() => setServiceType('material')} className={clsx("flex items-center justify-center gap-2 py-3 px-4 rounded-xl text-sm font-bold border-2 transition-all", serviceType === 'material' ? "border-gray-600 bg-gray-100 text-gray-900 ring-1 ring-gray-600" : "border-gray-200 bg-white hover:border-gray-300 text-gray-500")}><Package className="w-4 h-4" /> ç´”ææ–™ (DIY)</button>
                <button onClick={() => setServiceType('assembled')} className={clsx("flex items-center justify-center gap-2 py-3 px-4 rounded-xl text-sm font-bold border-2 transition-all", serviceType === 'assembled' ? "border-blue-600 bg-blue-50 text-blue-900 ring-1 ring-blue-600" : "border-gray-200 bg-white hover:border-gray-300 text-gray-500")}><Hammer className="w-4 h-4" /> é€£å·¥å¸¶æ–™ (å«å®‰è£)</button>
              </div>
              {serviceType === 'assembled' && <p className="text-xs text-blue-600 mt-2 ml-1">* å·²åŒ…å«æ¨™æº–å®‰è£è²» ${assemblyFee.toLocaleString()}</p>}
            </div>

            {/* é¡è‰²é¸æ“‡ */}
            {product.colors && product.colors.length > 0 && (
              <div>
                <h3 className="text-sm font-bold text-gray-900 mb-3 flex items-center justify-between"><span>é‹æ¡†é¡è‰²</span><span className="text-xs text-gray-500 font-normal">å·²é¸ï¼š{selectedColor}</span></h3>
                <div className="grid grid-cols-3 gap-3">
                  {product.colors.map((color: any, idx: number) => (
                    <button key={idx} onClick={() => setSelectedColor(color.name)} className={clsx("relative flex items-center gap-3 p-3 rounded-xl border-2 transition-all", selectedColor === color.name ? "border-blue-600 bg-blue-50 ring-1 ring-blue-600" : "border-gray-200 bg-white hover:border-gray-300 hover:bg-gray-50")}><span className="w-6 h-6 rounded-full border border-gray-300 shadow-sm" style={{ backgroundColor: color.colorCode || '#000' }} /><span className={clsx("text-sm font-medium", selectedColor === color.name ? "text-blue-900" : "text-gray-700")}>{color.name}</span>{Number(color.priceSurcharge) > 0 && <span className="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full shadow-sm font-bold">+${color.priceSurcharge}</span>}</button>
                  ))}
                </div>
              </div>
            )}

            {/* æè³ªé¸æ“‡ */}
            {product.materials && product.materials.length > 0 && (
              <div>
                <h3 className="text-sm font-bold text-gray-900 mb-3 flex items-center justify-between"><span>ç»ç’ƒ/æ¿æ</span><span className="text-xs text-gray-500 font-normal">å·²é¸ï¼š{selectedMaterial}</span></h3>
                <div className="grid grid-cols-2 gap-3">
                  {product.materials.map((mat: any, idx: number) => (
                    <button key={idx} onClick={() => setSelectedMaterial(mat.name)} className={clsx("relative p-3 rounded-xl border-2 transition-all text-left", selectedMaterial === mat.name ? "border-blue-600 bg-blue-50 ring-1 ring-blue-600" : "border-gray-200 bg-white hover:border-gray-300 hover:bg-gray-50")}><span className={clsx("text-sm font-medium block", selectedMaterial === mat.name ? "text-blue-900" : "text-gray-700")}>{mat.name}</span>{Number(mat.priceSurcharge) > 0 && <span className="text-xs text-red-500 font-medium block mt-1">+${mat.priceSurcharge}</span>}</button>
                  ))}
                </div>
              </div>
            )}

            {/* æŠŠæ‰‹é¸æ“‡ */}
            {product.handles && product.handles.length > 0 && (
              <div>
                <h3 className="text-sm font-bold text-gray-900 mb-3 flex items-center justify-between"><span>æŠŠæ‰‹é…ä»¶</span><span className="text-xs text-gray-500 font-normal">å·²é¸ï¼š{selectedHandle}</span></h3>
                <div className="grid grid-cols-2 gap-3">
                  {product.handles.map((h: any, idx: number) => (
                    <button key={idx} onClick={() => setSelectedHandle(h.name)} className={clsx("relative p-3 rounded-xl border-2 transition-all flex items-center gap-3", selectedHandle === h.name ? "border-blue-600 bg-blue-50 ring-1 ring-blue-600" : "border-gray-200 bg-white hover:border-gray-300 hover:bg-gray-50")}>
                      <GripHorizontal className={clsx("w-5 h-5", selectedHandle === h.name ? "text-blue-600" : "text-gray-400")} />
                      <span className={clsx("text-sm font-medium flex-1 text-left", selectedHandle === h.name ? "text-blue-900" : "text-gray-700")}>{h.name}</span>
                      {Number(h.priceSurcharge) > 0 && <span className="text-xs text-red-500 font-medium">+${h.priceSurcharge}</span>}
                    </button>
                  ))}
                </div>
              </div>
            )}

            {/* é–‹é–€æ–¹å‘ */}
            {product.openingOptions && product.openingOptions.length > 0 && (
              <div>
                <h3 className="text-sm font-bold text-gray-900 mb-3">é–‹é–€æ–¹å‘</h3>
                <div className="grid grid-cols-2 gap-3">
                  {product.openingOptions.map((opt: string, idx: number) => (
                    <button key={idx} onClick={() => setOpeningDirection(opt)} className={clsx("py-3 px-4 rounded-xl text-sm font-bold border-2 transition-all flex items-center justify-center", openingDirection === opt ? "border-blue-600 bg-blue-50 text-blue-900 ring-1 ring-blue-600" : "border-gray-200 bg-white hover:border-gray-300 text-gray-500")}>{opt}</button>
                  ))}
                </div>
              </div>
            )}

            <hr className="border-gray-100" />

            {product.requiresMeasurement ? (
              <div className="bg-yellow-50 border border-yellow-200 rounded-xl p-5">
                <div className="flex items-start gap-3 mb-4"><div className="p-2 bg-yellow-100 rounded-lg text-yellow-700"><Ruler className="w-6 h-6" /></div><div><h4 className="text-yellow-900 font-bold">æ­¤ç”¢å“éœ€è¼¸å…¥ä¸ˆé‡æ•¸æ“š</h4><p className="text-sm text-yellow-700 mt-1">è«‹æº–å‚™å¥½ç¾å ´å¯¬åº¦èˆ‡é«˜åº¦æ•¸æ“šã€‚</p></div></div>
                <button onClick={() => setIsMeasureOpen(true)} disabled={isSubmitting} className="w-full py-3.5 bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold rounded-xl transition-colors shadow-sm flex items-center justify-center gap-2 disabled:opacity-70">{isSubmitting ? <Loader2 className="animate-spin" /> : <><Ruler className="w-5 h-5" /> ä¸ˆé‡ä¸¦åŠ å…¥è³¼ç‰©è»Š</>}</button>
              </div>
            ) : (
              <button onClick={() => handleAddToCart()} disabled={isSubmitting} className="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl transition-all shadow-md">{isSubmitting ? 'è™•ç†ä¸­...' : 'åŠ å…¥è³¼ç‰©è»Š'}</button>
            )}

            <MeasurementModal isOpen={isMeasureOpen} onClose={() => setIsMeasureOpen(false)} onConfirm={(data) => handleAddToCart(data)} />

            {/* æˆåŠŸå½ˆçª— */}
            {showSuccessModal && (
              <div className="fixed inset-0 z-60 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
                <div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl flex flex-col items-center text-center space-y-4 animate-in zoom-in-95 duration-200">
                  <div className="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-2"><CheckCircle className="w-8 h-8" /></div>
                  <h3 className="text-xl font-bold text-gray-900">æˆåŠŸåŠ å…¥è³¼ç‰©è»Šï¼</h3>
                  <p className="text-sm text-gray-600">{product.name} {successMsg && <span className="block mt-1 font-medium text-orange-600">{successMsg}</span>}</p>
                  <div className="flex flex-col w-full gap-3 mt-2">
                    <button onClick={() => router.push('/cart')} className="w-full py-3.5 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-colors shadow-md flex items-center justify-center gap-2">å‰å¾€çµå¸³</button>
                    <button onClick={() => setShowSuccessModal(false)} className="w-full py-3.5 bg-gray-100 text-gray-700 rounded-xl font-bold hover:bg-gray-200 transition-colors">ç¹¼çºŒè³¼ç‰©</button>
                  </div>
                </div>
              </div>
            )}

          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/app/register/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { Building2, Mail, Lock, User, Phone, MapPin, FileText, Loader2, AlertCircle } from 'lucide-react';
import { api } from '@/lib/api';

// å®šç¾©ç‡Ÿæ¥­é¡åˆ¥å‹åˆ¥
interface TradeCategory {
  id: string;
  name: string;
}

export default function RegisterPage() {
  const router = useRouter();
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [categories, setCategories] = useState<TradeCategory[]>([]);
  const [errorMsg, setErrorMsg] = useState('');

  // è¡¨å–®ç‹€æ…‹
  const [formData, setFormData] = useState({
    email: '',
    password: '',
    confirmPassword: '',
    name: '', // è¯çµ¡äººå§“å
    companyName: '',
    taxId: '',
    phone: '',
    address: '',
    tradeCategoryId: '',
  });

  // âœ¨ ä¿®æ­£ï¼šè¼‰å…¥çœŸå¯¦çš„ç‡Ÿæ¥­é¡åˆ¥
  useEffect(() => {
    const fetchCategories = async () => {
      try {
        // å¾å¾Œç«¯ API å–å¾—è³‡æ–™ (é€™æ¨£æ‰æœƒæ‹¿åˆ°æ­£ç¢ºçš„ UUID)
        const res = await api.get('/trade-categories');
        // å…¼å®¹ API å›å‚³å¯èƒ½æ˜¯é™£åˆ—æˆ– { data: [] } çš„æ ¼å¼
        const data = Array.isArray(res) ? res : (res.data || []);
        setCategories(data);
      } catch (err) {
        console.error('Failed to fetch categories', err);
        // å¦‚æœæŠ“ä¸åˆ°è³‡æ–™ (ä¾‹å¦‚å¾Œç«¯æ²’é–‹æ”¾æ¬Šé™)ï¼Œè‡³å°‘çµ¦ä¸€å€‹ç©ºé™£åˆ—ï¼Œä¸è¦ç”¨å‡è³‡æ–™å®³è‡ªå·±
        setCategories([]); 
      }
    };
    fetchCategories();
  }, []);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setErrorMsg('');

    if (formData.password !== formData.confirmPassword) {
      setErrorMsg('å…©æ¬¡å¯†ç¢¼è¼¸å…¥ä¸ä¸€è‡´');
      return;
    }

    setIsSubmitting(true);

    try {
      // æ§‹å»ºå‚³é€çµ¦å¾Œç«¯çš„è³‡æ–™
      const payload = {
        email: formData.email,
        password: formData.password,
        name: formData.name,
        // âœ¨ é—œéµä¿®æ­£ï¼šå¦‚æœæ˜¯ç©ºå­—ä¸²ï¼Œè½‰ç‚º undefinedï¼Œé¿å…å¾Œç«¯æŸ¥è©¢å‡ºéŒ¯
        tradeCategoryId: formData.tradeCategoryId || undefined,
        dealerProfile: {
          companyName: formData.companyName,
          taxId: formData.taxId,
          contactPerson: formData.name,
          phone: formData.phone,
          address: formData.address,
        },
      };

      await api.post('/users', payload);
      
      alert('ğŸ‰ è¨»å†ŠæˆåŠŸï¼\nè«‹ç­‰å¾…ç®¡ç†å“¡å¯©æ ¸é–‹é€šå¸³è™Ÿã€‚');
      router.push('/login');

    } catch (error: any) {
      console.error(error);
      const message = error.response?.data?.message || 'è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
      setErrorMsg(Array.isArray(message) ? message[0] : message);
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <div className="min-h-screen bg-gray-50 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-md w-full space-y-8 bg-white p-8 rounded-2xl shadow-lg border border-gray-100">
        
        {/* Header */}
        <div className="text-center">
          <div className="mx-auto h-12 w-12 bg-blue-100 rounded-xl flex items-center justify-center mb-4">
            <User className="h-6 w-6 text-blue-600" />
          </div>
          <h2 className="text-3xl font-extrabold text-gray-900">è¨»å†Šç¶“éŠ·å•†å¸³è™Ÿ</h2>
          <p className="mt-2 text-sm text-gray-600">
            åŠ å…¥ SomaLinkï¼Œäº«å— B2B æ•¸ä½å·¥å» æœå‹™
          </p>
        </div>

        {/* Error Message */}
        {errorMsg && (
          <div className="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-xl flex items-center gap-2 text-sm animate-pulse">
            <AlertCircle className="w-4 h-4" />
            {errorMsg}
          </div>
        )}

        <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
          <div className="space-y-4">
            
            {/* å¸³è™Ÿè³‡è¨Š */}
            <div className="grid grid-cols-2 gap-4">
              <div className="col-span-2">
                <label className="block text-sm font-medium text-gray-700 mb-1">Email (ç™»å…¥å¸³è™Ÿ)</label>
                <div className="relative">
                  <Mail className="absolute left-3 top-2.5 h-5 w-5 text-gray-400" />
                  <input
                    name="email"
                    type="email"
                    required
                    className="pl-10 w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500"
                    placeholder="your@email.com"
                    onChange={handleChange}
                  />
                </div>
              </div>
              
              <div className="col-span-1">
                <label className="block text-sm font-medium text-gray-700 mb-1">å¯†ç¢¼</label>
                <div className="relative">
                  <Lock className="absolute left-3 top-2.5 h-5 w-5 text-gray-400" />
                  <input
                    name="password"
                    type="password"
                    required
                    className="pl-10 w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500"
                    placeholder="******"
                    onChange={handleChange}
                  />
                </div>
              </div>

              <div className="col-span-1">
                <label className="block text-sm font-medium text-gray-700 mb-1">ç¢ºèªå¯†ç¢¼</label>
                <input
                  name="confirmPassword"
                  type="password"
                  required
                  className="w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500"
                  placeholder="******"
                  onChange={handleChange}
                />
              </div>
            </div>

            <div className="relative flex py-2 items-center">
              <div className="grow border-t border-gray-200"></div>
              <span className="shrink-0 mx-4 text-gray-400 text-xs">å…¬å¸è³‡æ–™</span>
              <div className="grow border-t border-gray-200"></div>
            </div>

            {/* å…¬å¸è³‡è¨Š */}
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">å…¬å¸åç¨±</label>
                <div className="relative">
                  <Building2 className="absolute left-3 top-2.5 h-5 w-5 text-gray-400" />
                  <input
                    name="companyName"
                    type="text"
                    required
                    className="pl-10 w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500"
                    placeholder="ä¾‹å¦‚ï¼šæ¾æˆæœ‰é™å…¬å¸"
                    onChange={handleChange}
                  />
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">è¯çµ¡äººå§“å</label>
                  <input
                    name="name"
                    type="text"
                    required
                    className="w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500"
                    placeholder="ç‹å°æ˜"
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">è¯çµ¡é›»è©±</label>
                  <div className="relative">
                    <Phone className="absolute left-3 top-2.5 h-5 w-5 text-gray-400" />
                    <input
                      name="phone"
                      type="tel"
                      required
                      className="pl-10 w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500"
                      placeholder="0912-345-678"
                      onChange={handleChange}
                    />
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">çµ±ä¸€ç·¨è™Ÿ (é¸å¡«)</label>
                  <div className="relative">
                    <FileText className="absolute left-3 top-2.5 h-5 w-5 text-gray-400" />
                    <input
                      name="taxId"
                      type="text"
                      className="pl-10 w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500"
                      placeholder="8ç¢¼çµ±ç·¨"
                      onChange={handleChange}
                    />
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">ç‡Ÿæ¥­é¡åˆ¥</label>
                  <select
                    name="tradeCategoryId"
                    className="w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 bg-white"
                    onChange={handleChange}
                    value={formData.tradeCategoryId}
                  >
                    <option value="">è«‹é¸æ“‡...</option>
                    {categories.map(c => (
                      <option key={c.id} value={c.id}>{c.name}</option>
                    ))}
                  </select>
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">å…¬å¸åœ°å€</label>
                <div className="relative">
                  <MapPin className="absolute left-3 top-2.5 h-5 w-5 text-gray-400" />
                  <input
                    name="address"
                    type="text"
                    required
                    className="pl-10 w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500"
                    placeholder="è«‹è¼¸å…¥å®Œæ•´åœ°å€"
                    onChange={handleChange}
                  />
                </div>
              </div>

            </div>

          </div>

          <button
            type="submit"
            disabled={isSubmitting}
            className="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-xl text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-70 transition-colors shadow-lg hover:shadow-xl"
          >
            {isSubmitting ? (
              <Loader2 className="animate-spin h-5 w-5" />
            ) : (
              'è¨»å†Šå¸³è™Ÿ'
            )}
          </button>

          <div className="text-center">
            <Link href="/login" className="font-medium text-blue-600 hover:text-blue-500 text-sm">
              å·²ç¶“æœ‰å¸³è™Ÿï¼Ÿè¿”å›ç™»å…¥
            </Link>
          </div>
        </form>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/context/CartContext.tsx">
'use client';

import { createContext, useContext, useState, useEffect, ReactNode } from 'react';
import { api } from '@/lib/api';

// å®šç¾©è³¼ç‰©è»Šé …ç›®çš„è³‡æ–™çµæ§‹
export interface CartItem {
  internalId: string; // å‰ç«¯è­˜åˆ¥ID (æœ¬åœ°ç«¯ç‚º UUIDï¼Œä¼ºæœå™¨ç«¯ç‚ºè³‡æ–™åº« ID)
  productId: string;
  productName: string; 
  unitPrice: number;   
  
  serviceType: string;
  widthMatrix: { top: number; mid: number; bot: number };
  heightData: any;
  isCeilingMounted: boolean;
  siteConditions?: any;
  colorName: string;
  materialName: string;
  handleName: string;
  openingDirection: string;
  hasThreshold: boolean;
  
  quantity: number;
  subtotal: number;
  priceSnapshot: any; 
}

interface CartContextType {
  items: CartItem[];
  addToCart: (item: CartItem) => void;
  removeFromCart: (internalId: string) => void;
  clearCart: () => void;
  cartCount: number;
  cartTotal: number;
}

const CartContext = createContext<CartContextType | undefined>(undefined);

export function CartProvider({ children }: { children: ReactNode }) {
  const [items, setItems] = useState<CartItem[]>([]);
  const [isLoggedIn, setIsLoggedIn] = useState(false);

  // 1. åˆå§‹åŒ–ï¼šæª¢æŸ¥ç™»å…¥ç‹€æ…‹ä¸¦è¼‰å…¥å°æ‡‰çš„è³¼ç‰©è»Š
  useEffect(() => {
    const checkAuth = () => {
      // åŒæ™‚æª¢æŸ¥ LocalStorage èˆ‡ SessionStorage
      const token = localStorage.getItem('somalink_token') || sessionStorage.getItem('somalink_token');
      const hasAuth = !!token;
      setIsLoggedIn(hasAuth);
      return hasAuth;
    };

    const authenticated = checkAuth();

    if (authenticated) {
      // A. å·²ç™»å…¥ï¼šå¾ä¼ºæœå™¨æŠ“å– (Server-side Cart)
      fetchServerCart();
    } else {
      // B. æœªç™»å…¥ï¼šå¾ LocalStorage æŠ“å– (Client-side Cart)
      const saved = localStorage.getItem('soma_cart');
      if (saved) {
        try {
          setItems(JSON.parse(saved));
        } catch (e) {
          console.error('Failed to parse local cart', e);
        }
      }
    }
  }, []);

  // åƒ…åœ¨ã€Œæœªç™»å…¥ã€æ™‚ï¼Œå°‡ items è®ŠåŒ–åŒæ­¥å› LocalStorage
  // (å·²ç™»å…¥æ™‚ï¼Œè³‡æ–™æ˜¯ç›´æ¥å¯«å…¥å¾Œç«¯ DBï¼Œä¸éœ€è¦å­˜ LocalStorage)
  useEffect(() => {
    if (!isLoggedIn) {
      localStorage.setItem('soma_cart', JSON.stringify(items));
    }
  }, [items, isLoggedIn]);

  // --- æ ¸å¿ƒåŠŸèƒ½ï¼šå¾å¾Œç«¯åŒæ­¥è³¼ç‰©è»Š ---
  const fetchServerCart = async () => {
    try {
      const serverItems = await api.cart.list();
      
      // å°‡å¾Œç«¯è³‡æ–™æ ¼å¼è½‰æ›ç‚ºå‰ç«¯ CartItem æ ¼å¼
      // æ³¨æ„ï¼šå¾Œç«¯å›å‚³çš„çµæ§‹å¯èƒ½èˆ‡å‰ç«¯ä¸å®Œå…¨ä¸€æ¨£ï¼Œé€™è£¡è¦åš Mapping
      const formattedItems: CartItem[] = serverItems.map((item: any) => ({
        internalId: item.id, // ä½¿ç”¨å¾Œç«¯è³‡æ–™åº« ID
        productId: item.product?.id,
        productName: item.product?.name || 'æœªçŸ¥å•†å“',
        
        // è‹¥å¾Œç«¯æ²’å­˜å–®åƒ¹ï¼Œå¯ç”¨ç¸½åƒ¹åæ¨æˆ–ä¾è³´å¿«ç…§
        unitPrice: Number(item.subtotal) / item.quantity, 
        quantity: item.quantity,
        subtotal: Number(item.subtotal),
        
        // è¦æ ¼é‚„åŸ
        serviceType: item.serviceType,
        widthMatrix: item.widthMatrix,
        heightData: item.heightData,
        isCeilingMounted: item.isCeilingMounted,
        siteConditions: item.siteConditions,
        colorName: item.colorName,
        materialName: item.materialName,
        handleName: item.handleName,
        openingDirection: item.openingDirection,
        hasThreshold: item.hasThreshold,
        priceSnapshot: item.priceSnapshot
      }));
      setItems(formattedItems);
    } catch (error) {
      console.error('ç„¡æ³•åŒæ­¥ä¼ºæœå™¨è³¼ç‰©è»Š', error);
      // å¦‚æœ Token éæœŸå°è‡´å¤±æ•—ï¼Œå¯ä»¥é¸æ“‡ä¸è™•ç†ï¼Œæˆ–è€…æ¸…ç©ºè³¼ç‰©è»Š
    }
  };

  // --- å‹•ä½œï¼šåŠ å…¥è³¼ç‰©è»Š ---
  const addToCart = async (newItem: CartItem) => {
    if (isLoggedIn) {
      // A. å·²ç™»å…¥ï¼šå‘¼å« API å¯«å…¥è³‡æ–™åº«
      try {
        await api.cart.add({
          // å‚³é€ç¬¦åˆå¾Œç«¯ DTO çš„è³‡æ–™
          productId: newItem.productId,
          quantity: newItem.quantity,
          subtotal: newItem.subtotal,
          serviceType: newItem.serviceType,
          widthMatrix: newItem.widthMatrix,
          heightData: newItem.heightData,
          isCeilingMounted: newItem.isCeilingMounted,
          siteConditions: newItem.siteConditions,
          colorName: newItem.colorName,
          materialName: newItem.materialName,
          handleName: newItem.handleName,
          openingDirection: newItem.openingDirection,
          hasThreshold: newItem.hasThreshold,
          priceSnapshot: newItem.priceSnapshot
        });
        // åŠ å…¥å¾Œé‡æ–°æŠ“å–ï¼Œç¢ºä¿è³‡æ–™èˆ‡å¾Œç«¯ä¸€è‡´
        await fetchServerCart();
      } catch (err) {
        console.error(err);
        alert('åŠ å…¥è³¼ç‰©è»Šå¤±æ•— (ä¼ºæœå™¨éŒ¯èª¤)ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    } else {
      // B. æœªç™»å…¥ï¼šæ“ä½œæœ¬åœ°ç‹€æ…‹
      setItems((prev) => [...prev, newItem]);
    }
  };

  // --- å‹•ä½œï¼šç§»é™¤é …ç›® ---
  const removeFromCart = async (internalId: string) => {
    if (isLoggedIn) {
      // A. å·²ç™»å…¥ï¼šå‘¼å« API åˆªé™¤
      try {
        await api.cart.remove(internalId);
        // æ¨‚è§€æ›´æ–° (Optimistic Update)ï¼šå…ˆå¾ UI ç§»é™¤ï¼Œé«”é©—æ¯”è¼ƒå¿«
        setItems((prev) => prev.filter((item) => item.internalId !== internalId));
      } catch (err) {
        console.error(err);
        alert('ç§»é™¤å¤±æ•—');
        fetchServerCart(); // å¤±æ•—æ™‚å›å¾©ç‹€æ…‹
      }
    } else {
      // B. æœªç™»å…¥ï¼šæ“ä½œæœ¬åœ°ç‹€æ…‹
      setItems((prev) => prev.filter((item) => item.internalId !== internalId));
    }
  };

  // --- å‹•ä½œï¼šæ¸…ç©ºè³¼ç‰©è»Š ---
  const clearCart = async () => {
    if (isLoggedIn) {
      // A. å·²ç™»å…¥ï¼šå‘¼å« API æ¸…ç©º
      try {
        await api.cart.clear();
        setItems([]);
      } catch (err) { 
        console.error(err);
      }
    } else {
      // B. æœªç™»å…¥ï¼šæ¸…ç©º LocalStorage
      setItems([]);
      localStorage.removeItem('soma_cart');
    }
  };

  const cartTotal = items.reduce((sum, item) => sum + item.subtotal, 0);

  return (
    <CartContext.Provider 
      value={{ 
        items, 
        addToCart, 
        removeFromCart, 
        clearCart,
        cartCount: items.length,
        cartTotal
      }}
    >
      {children}
    </CartContext.Provider>
  );
}

export function useCart() {
  const context = useContext(CartContext);
  if (context === undefined) {
    throw new Error('useCart must be used within a CartProvider');
  }
  return context;
}
</file>

<file path="backend/src/orders/dto/create-order.dto.ts">
import { IsString, IsBoolean, IsArray, IsNumber, ValidateNested, IsOptional, IsObject } from 'class-validator';
import { Type } from 'class-transformer';

export class CreateOrderItemDto {
  @IsString()
  productId: string;

  @IsString()
  serviceType: string;

  @IsObject()
  widthMatrix: { top: number; mid: number; bot: number };

  @IsObject()
  heightData: any;

  @IsBoolean()
  isCeilingMounted: boolean;

  @IsObject()
  @IsOptional()
  siteConditions?: any;

  @IsString()
  colorName: string;

  @IsString()
  materialName: string;

  // âœ¨âœ¨âœ¨ æ–°å¢ï¼šæŠŠæ‰‹åç¨± (é¸å¡«) âœ¨âœ¨âœ¨
  @IsString()
  @IsOptional()
  handleName?: string;

  @IsString()
  openingDirection: string;

  @IsBoolean()
  hasThreshold: boolean;

  @IsNumber()
  quantity: number;

  @IsNumber()
  subtotal: number;

  @IsObject()
  priceSnapshot: any;
}

export class CreateOrderDto {
  @IsString()
  projectName: string;

  // âœ¨âœ¨âœ¨ æ”¶è²¨è³‡è¨Šæ¬„ä½ âœ¨âœ¨âœ¨
  @IsString()
  @IsOptional()
  shippingAddress?: string;

  @IsString()
  @IsOptional()
  siteContactPerson?: string;

  @IsString()
  @IsOptional()
  siteContactPhone?: string;

  // âœ¨âœ¨âœ¨ é™„ä»¶æ¬„ä½ (å­—ä¸²é™£åˆ—) âœ¨âœ¨âœ¨
  @IsArray()
  @IsOptional()
  @IsString({ each: true })
  attachments?: string[];

  @IsBoolean()
  agreedToDisclaimer: boolean;

  @IsOptional()
  @IsString()
  customerNote?: string;

  @IsArray()
  @ValidateNested({ each: true })
  @Type(() => CreateOrderItemDto)
  items: CreateOrderItemDto[];
}
</file>

<file path="backend/src/orders/orders.controller.ts">
import { Controller, Get, Post, Body, Patch, Param, Delete, UseGuards, Request } from '@nestjs/common';
import { OrdersService } from './orders.service';
import { CreateOrderDto } from './dto/create-order.dto';
import { UpdateOrderDto } from './dto/update-order.dto';
import { JwtAuthGuard } from '../auth/jwt-auth.guard';
import { UserRole } from '../users/entities/user.entity'; // âœ¨ è¨˜å¾—å¼•å…¥ UserRole

@Controller('orders')
export class OrdersController {
  constructor(private readonly ordersService: OrdersService) {}

  // 1. å»ºç«‹è¨‚å–®
  @Post()
  @UseGuards(JwtAuthGuard)
  create(@Body() createOrderDto: CreateOrderDto, @Request() req) {
    return this.ordersService.create(createOrderDto, req.user);
  }

  // âœ¨ 2. æŸ¥è©¢è¨‚å–®åˆ—è¡¨ (ä¿®æ­£æ¬Šé™é‚è¼¯)
  @Get()
  @UseGuards(JwtAuthGuard)
  findAll(@Request() req) {
    // åˆ¤æ–·è§’è‰²ï¼šå¦‚æœæ˜¯ç®¡ç†å“¡ï¼Œå°±å‘¼å« findAll (æŸ¥å…¨éƒ¨)
    // å…¼å®¹å¤§å°å¯« (ADMIN æˆ– admin)
    if (req.user.role === UserRole.ADMIN || req.user.role === 'admin' || req.user.role === 'ADMIN') {
      return this.ordersService.findAll();
    }
    // å¦‚æœæ˜¯ç¶“éŠ·å•†ï¼ŒåªæŸ¥è‡ªå·±çš„
    return this.ordersService.findAllByUser(req.user);
  }

  // é¿å… /orders/all è¢«ç•¶æˆ id
  @Get('all')
  @UseGuards(JwtAuthGuard)
  findAllAlias(@Request() req) {
    if (req.user.role === UserRole.ADMIN || req.user.role === 'admin') {
      return this.ordersService.findAll();
    }
    return this.ordersService.findAllByUser(req.user);
  }

  // 3. æŸ¥è©¢å–®ä¸€è¨‚å–®
  @Get(':id')
  @UseGuards(JwtAuthGuard)
  findOne(@Param('id') id: string) {
    return this.ordersService.findOne(id);
  }

  // 4. æ›´æ–°è¨‚å–®ç‹€æ…‹
  @Patch(':id')
  @UseGuards(JwtAuthGuard)
  update(@Param('id') id: string, @Body() updateOrderDto: UpdateOrderDto) {
    return this.ordersService.updateStatus(id, updateOrderDto.status, updateOrderDto.adminNote);
  }

  // 5. åˆªé™¤è¨‚å–®
  @Delete(':id')
  @UseGuards(JwtAuthGuard)
  remove(@Param('id') id: string, @Request() req) {
    return this.ordersService.remove(id, req.user);
  }
}
</file>

<file path="backend/src/orders/orders.service.ts">
import { Injectable, NotFoundException, ForbiddenException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository, Like } from 'typeorm';
import { Order, OrderStatus } from './entities/order.entity';
import { OrderItem } from './entities/order-item.entity';
import { User } from '../users/entities/user.entity';
import { NotificationsService } from '../notifications/notifications.service';
import { CreateOrderDto } from './dto/create-order.dto';
import { SiteConfigService } from '../site-config/site-config.service'; 

@Injectable()
export class OrdersService {
  constructor(
    @InjectRepository(Order)
    private ordersRepository: Repository<Order>,
    @InjectRepository(User)
    private usersRepository: Repository<User>,
    private notificationsService: NotificationsService,
    private siteConfigService: SiteConfigService, 
  ) {}

  // 1. æŸ¥è©¢æ‰€æœ‰è¨‚å–® (ç®¡ç†å“¡ç”¨)
  async findAll() {
    return this.ordersRepository.find({
      relations: ['user', 'user.dealerProfile', 'items', 'items.product'],
      order: { createdAt: 'DESC' },
    });
  }

  // 2. æŸ¥è©¢ç‰¹å®šä½¿ç”¨è€…çš„è¨‚å–® (ç¶“éŠ·å•†ç”¨)
  async findAllByUser(user: User) {
    return this.ordersRepository.find({
      where: { user: { id: user.id } },
      relations: ['items', 'items.product'],
      order: { createdAt: 'DESC' },
    });
  }

  // 3. æŸ¥è©¢å–®ä¸€è¨‚å–®
  async findOne(id: string) {
    const order = await this.ordersRepository.findOne({
      where: { id },
      relations: ['user', 'user.dealerProfile', 'items', 'items.product'],
    });
    if (!order) {
      throw new NotFoundException(`æ‰¾ä¸åˆ°è¨‚å–® #${id}`);
    }
    return order;
  }

  // 4. å»ºç«‹è¨‚å–® (å«æœˆåˆ·åˆ¶æµæ°´è™Ÿé‚è¼¯)
  async create(createOrderDto: CreateOrderDto, user: User) {
    const order = new Order();
    order.user = user;
    order.projectName = createOrderDto.projectName;
    
    // æ”¶è²¨è³‡è¨Š
    order.shippingAddress = createOrderDto.shippingAddress || '';
    order.siteContactPerson = createOrderDto.siteContactPerson || '';
    order.siteContactPhone = createOrderDto.siteContactPhone || '';
    
    // é™„ä»¶
    order.attachments = createOrderDto.attachments || [];

    order.agreedToDisclaimer = createOrderDto.agreedToDisclaimer;
    order.customerNote = createOrderDto.customerNote;
    
    // âœ¨âœ¨âœ¨ æµæ°´è™Ÿç”Ÿæˆé‚è¼¯ (æœˆåˆ·åˆ¶) âœ¨âœ¨âœ¨
    
    // 1. è®€å–å¾Œå°è¨­å®šçš„ã€Œé‡ç½®æ—¥ã€
    const rules = await this.siteConfigService.getSystemRules();
    const resetDay = rules.settings?.order_reset_day || 1; // é è¨­æ¯æœˆ 1 è™Ÿé‡ç½®

    // 2. è¨ˆç®—ç•¶å‰æ‰€å±¬çš„é€±æœŸ (Cycle)
    const today = new Date();
    let cycleYear = today.getFullYear();
    let cycleMonth = today.getMonth(); // 0-11 (æ³¨æ„ï¼š0æ˜¯1æœˆ)

    // å¦‚æœä»Šå¤©é‚„æ²’åˆ°é‡ç½®æ—¥ (ä¾‹å¦‚è¨­å®š 25 è™Ÿï¼Œä»Šå¤©æ˜¯ 20 è™Ÿ)ï¼Œå‰‡æ­¸å±¬åˆ°ã€Œä¸Šå€‹æœˆã€çš„å¸³å‹™é€±æœŸ
    if (today.getDate() < resetDay) {
      cycleMonth -= 1;
    }

    // è™•ç†è·¨å¹´ (ä¾‹å¦‚ 1æœˆå¾€å‰æ¨è®Šæˆå»å¹´çš„ 12æœˆ)
    if (cycleMonth < 0) {
      cycleMonth = 11;
      cycleYear -= 1;
    }

    // 3. ç”Ÿæˆå‰ç¶´å­—ä¸²ï¼šORD-YYYYMM- (ä¾‹å¦‚ ORD-202511-)
    const dateStr = `${cycleYear}${String(cycleMonth + 1).padStart(2, '0')}`; 
    const prefix = `ORD-${dateStr}`;

    // 4. æ‰¾å‡ºè©²é€±æœŸçš„æœ€å¾Œä¸€ç­†è¨‚å–®ï¼Œä»¥æ±ºå®šåºè™Ÿ
    const lastOrder = await this.ordersRepository.findOne({
      where: { orderNumber: Like(`${prefix}%`) }, 
      order: { orderNumber: 'DESC' },
    });

    let sequence = 1;
    if (lastOrder) {
      const parts = lastOrder.orderNumber.split('-');
      // ç¢ºä¿æ ¼å¼æ­£ç¢º (ORD-YYYYMM-XXX)
      if (parts.length === 3) {
        const lastSeq = parseInt(parts[2], 10);
        if (!isNaN(lastSeq)) {
          sequence = lastSeq + 1;
        }
      }
    }

    // è£œé›¶ (001, 002...)
    const sequenceStr = sequence.toString().padStart(3, '0'); 
    order.orderNumber = `${prefix}-${sequenceStr}`;
    order.status = OrderStatus.PENDING;

    // å»ºç«‹è¨‚å–®é …ç›®
    order.items = createOrderDto.items.map(itemDto => {
      const item = new OrderItem();
      item.product = { id: itemDto.productId } as any; 
      item.serviceType = itemDto.serviceType as any; 
      item.widthMatrix = itemDto.widthMatrix;
      item.heightData = itemDto.heightData;
      item.isCeilingMounted = itemDto.isCeilingMounted;
      item.siteConditions = itemDto.siteConditions;
      item.colorName = itemDto.colorName;
      item.materialName = itemDto.materialName;
      // âœ¨âœ¨âœ¨ å¯«å…¥æŠŠæ‰‹åç¨± âœ¨âœ¨âœ¨
      item.handleName = itemDto.handleName || '';
      item.openingDirection = itemDto.openingDirection;
      item.hasThreshold = itemDto.hasThreshold;
      item.quantity = itemDto.quantity;
      item.subtotal = itemDto.subtotal;
      item.priceSnapshot = itemDto.priceSnapshot;
      return item;
    });

    // è¨ˆç®—ç¸½é‡‘é¡
    order.totalAmount = order.items.reduce((sum, item) => sum + Number(item.subtotal), 0);

    const savedOrder = await this.ordersRepository.save(order);

    // ç™¼é€é€šçŸ¥
    const dealerName = user.dealerProfile?.companyName || user.email;
    const firstItemName = savedOrder.items[0]?.product?.name || 'å®¢è£½åŒ–é–€æ‰‡'; 
    const itemCount = savedOrder.items.length;
    const attachmentHint = order.attachments.length > 0 ? ` (å« ${order.attachments.length} å€‹é™„ä»¶)` : '';
    
    try {
        const msg = `ğŸ”¥ æ–°è¨‚å–®é€šçŸ¥${attachmentHint}ï¼\nå–®è™Ÿï¼š${savedOrder.orderNumber}\nå®¢æˆ¶ï¼š${dealerName}\nåœ°é»ï¼š${order.shippingAddress}\nå…§å®¹ï¼š${firstItemName} ç­‰ ${itemCount} ä»¶`;
        this.notificationsService.sendLineNotify(msg).catch(err => console.log('Line é€šçŸ¥ç•¥é'));
    } catch (e) {
        // å¿½ç•¥é€šçŸ¥éŒ¯èª¤
    }

    return savedOrder;
  }

  // 5. æ›´æ–°ç‹€æ…‹
  async updateStatus(id: string, status?: OrderStatus, adminNote?: string) {
    const updateData: any = {};
    if (status !== undefined) updateData.status = status;
    if (adminNote !== undefined) updateData.adminNote = adminNote;

    if (Object.keys(updateData).length > 0) {
      await this.ordersRepository.update(id, updateData);
    }
    
    const updatedOrder = await this.ordersRepository.findOne({
      where: { id },
      relations: ['user', 'items', 'items.product']
    });

    if (updatedOrder && status) {
        let subject = '';
        let body = '';

        if (status === OrderStatus.PROCESSING) {
            subject = `ã€SomaLinkã€‘è¨‚å–® ${updatedOrder.orderNumber} å·²å¯©æ ¸é€šé`;
            body = `æ‚¨çš„è¨‚å–®å·²é€šéå¯©æ ¸ï¼Œå·¥å» å°‡é–‹å§‹æ’ç¨‹ç”Ÿç”¢ã€‚`;
        } else if (status === OrderStatus.SHIPPED) {
            subject = `ã€SomaLinkã€‘è¨‚å–® ${updatedOrder.orderNumber} å·²å‡ºè²¨`;
            body = `æ‚¨çš„è¨‚å–®å·²å®Œæˆç”Ÿç”¢ä¸¦å®‰æ’å‡ºè²¨ï¼Œè«‹ç•™æ„ç‰©æµé€šçŸ¥ã€‚`;
        } else if (status === OrderStatus.COMPLETED) {
             subject = `ã€SomaLinkã€‘è¨‚å–® ${updatedOrder.orderNumber} å·²çµæ¡ˆ`;
             body = `æ„Ÿè¬æ‚¨çš„è¨‚è³¼ï¼ŒæœŸå¾…å†æ¬¡ç‚ºæ‚¨æœå‹™ã€‚`;
        }

        if (subject) {
            this.notificationsService.sendEmail(updatedOrder.user.email, subject, body)
                .catch(err => console.log('Email é€šçŸ¥ç•¥é'));
        }
    }

    return updatedOrder;
  }

  // 6. åˆªé™¤è¨‚å–®
  async remove(id: string, user: User) {
    const order = await this.findOne(id);

    if (order.user.id !== user.id) {
      throw new ForbiddenException('æ‚¨ç„¡æ¬Šåˆªé™¤æ­¤è¨‚å–®');
    }

    if (order.status !== OrderStatus.PENDING) {
      throw new ForbiddenException('è¨‚å–®å·²é€²å…¥ç”Ÿç”¢æµç¨‹ï¼Œç„¡æ³•åˆªé™¤ã€‚è«‹è¯ç¹«å®¢æœã€‚');
    }

    return this.ordersRepository.remove(order);
  }
}
</file>

<file path="backend/src/reports/reports.service.ts">
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Order } from '../orders/entities/order.entity';

@Injectable()
export class ReportsService {
  constructor(
    @InjectRepository(Order)
    private ordersRepo: Repository<Order>,
  ) {}

  async getDashboardStats() {
    // 1. ç¸½ç‡Ÿæ”¶ (æ’é™¤å·²å–æ¶ˆ)
    const revenueResult = await this.ordersRepo.createQueryBuilder('order')
      .select('SUM(order.totalAmount)', 'sum')
      .where('order.status != :status', { status: 'cancelled' })
      .getRawOne();
    const totalRevenue = Number(revenueResult.sum || 0);

    // 2. è¨‚å–®ç¸½æ•¸
    const totalOrders = await this.ordersRepo.count();

    // 3. ä¾ç‹€æ…‹åˆ†ä½ˆ (Pie Chart)
    const statusDist = await this.ordersRepo.createQueryBuilder('order')
      .select('order.status', 'status')
      .addSelect('COUNT(order.id)', 'count')
      .groupBy('order.status')
      .getRawMany();

    // 4. æœ€è¿‘ 6 å€‹æœˆç‡Ÿæ”¶è¶¨å‹¢ (Bar Chart)
    const allOrders = await this.ordersRepo.find({ 
      where: {  }, 
      select: ['totalAmount', 'createdAt', 'status'],
      order: { createdAt: 'ASC' }
    });

    const monthlyStats: any = {};
    allOrders.forEach(o => {
      if (o.status === 'cancelled') return;
      const month = new Date(o.createdAt).toISOString().slice(0, 7); // YYYY-MM
      if (!monthlyStats[month]) monthlyStats[month] = 0;
      monthlyStats[month] += Number(o.totalAmount);
    });

    const trendData = Object.keys(monthlyStats).map(month => ({
      name: month,
      total: monthlyStats[month]
    })).slice(-6); 

    // âœ¨ Fix 5: ç†±éŠ·ç”¢å“æ’è¡Œ (ä¿®æ­£é—œè¯è·¯å¾‘: Order -> OrderItem -> Product)
    const productStats = await this.ordersRepo.createQueryBuilder('order')
      .leftJoin('order.items', 'item')      // å…ˆé€£åˆ° items
      .leftJoin('item.product', 'product')  // å†å¾ item é€£åˆ° product
      .select('product.name', 'name')
      .addSelect('COUNT(order.id)', 'count')
      .addSelect('SUM(order.totalAmount)', 'revenue')
      .where('order.status != :status', { status: 'cancelled' })
      .groupBy('product.name')
      .orderBy('count', 'DESC')
      .limit(5)
      .getRawMany();

    // âœ¨ Fix 6: ç†±éŠ·é¡è‰²æ’è¡Œ (ä¿®æ­£ç‚ºå¾ OrderItem çµ±è¨ˆé¡è‰²)
    const colorStats = await this.ordersRepo.createQueryBuilder('order')
      .leftJoin('order.items', 'item')      // é¡è‰²è³‡è¨Šåœ¨ item ä¸Š
      .select('item.colorName', 'name')
      .addSelect('COUNT(order.id)', 'count')
      .where('order.status != :status', { status: 'cancelled' })
      .groupBy('item.colorName')
      .orderBy('count', 'DESC')
      .limit(5)
      .getRawMany();

    return {
      totalRevenue,
      totalOrders,
      statusDist,
      trendData,
      productStats,
      colorStats,
    };
  }
}
</file>

<file path="backend/src/users/users.controller.ts">
import { Controller, Get, Post, Patch, Delete, Body, Param, HttpException, HttpStatus, Query, UseGuards, Request } from '@nestjs/common';
import { UsersService } from './users.service';
import { JwtAuthGuard } from '../auth/jwt-auth.guard'; // è¨˜å¾—å¼•å…¥ Guard

@Controller('users')
export class UsersController {
  constructor(private readonly usersService: UsersService) {}

  // ... (Create, FindAll ä¿æŒåŸæ¨£) ...
  @Post()
  create(@Body() createUserDto: any) { return this.usersService.create(createUserDto); }

  @Get()
  findAll() { return this.usersService.findAll(); }

  // âœ¨âœ¨âœ¨ æ–°å¢ï¼šå–å¾—ç•¶å‰ä½¿ç”¨è€…è³‡æ–™ âœ¨âœ¨âœ¨
  @Get('profile')
  @UseGuards(JwtAuthGuard)
  async getProfile(@Request() req) {
    return this.usersService.findOne(req.user.id);
  }

  // âœ¨âœ¨âœ¨ æ–°å¢ï¼šæ›´æ–°ç•¶å‰ä½¿ç”¨è€…è³‡æ–™ âœ¨âœ¨âœ¨
  @Patch('profile')
  @UseGuards(JwtAuthGuard)
  async updateProfile(@Request() req, @Body() body: any) {
    try {
      // å¼·åˆ¶ä½¿ç”¨ Token è£¡çš„ IDï¼Œé˜²æ­¢ä¿®æ”¹ä»–äººè³‡æ–™
      return await this.usersService.updateProfile(req.user.id, body);
    } catch (error: any) {
      throw new HttpException(error.message, HttpStatus.BAD_REQUEST);
    }
  }

  // ... (å…¶ä»–ç®¡ç†å“¡ç”¨çš„ API ä¿æŒåŸæ¨£ï¼šstatus, level, deposit, make-admin, remove) ...
  @Patch(':id/status')
  async updateStatus(@Param('id') id: string, @Body() body: { isActive: boolean }) { return this.usersService.toggleActive(id, body.isActive); }

  @Patch(':id/level')
  async updateLevel(@Param('id') id: string, @Body() body: { level: any }) { return this.usersService.updateLevel(id, body.level); }

  @Post(':id/deposit')
  async deposit(@Param('id') id: string, @Body() body: { amount: number }) { return this.usersService.deposit(id, body.amount); }

  @Get('make-admin')
  async makeAdmin(@Query('email') email: string) { return this.usersService.makeAdmin(email); }

  @Delete(':id')
  async remove(@Param('id') id: string) { return this.usersService.remove(id); }
}
</file>

<file path="frontend/src/app/cart/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
// âœ¨ æ–°å¢ Printer åœ–ç¤º
import { Trash2, ArrowRight, Loader2, ShoppingBag, AlertCircle, Hammer, Package, MessageSquare, MapPin, Building2, User, Phone, Copy, UploadCloud, FileText, X, Printer } from 'lucide-react';
import { useCart } from '@/context/CartContext';
import { api } from '@/lib/api';
import Modal from '@/components/Modal'; 

const CLOUDINARY_CLOUD_NAME = 'dnibj8za6'; 
const CLOUDINARY_PRESET = 'yasou70731';  

export default function CartPage() {
  const router = useRouter();
  const { items, removeFromCart, clearCart, cartTotal } = useCart();
  
  const [mounted, setMounted] = useState(false);
  const [currentUser, setCurrentUser] = useState<any>(null);
  const [authChecking, setAuthChecking] = useState(true);

  const [modalConfig, setModalConfig] = useState({
    isOpen: false,
    title: '',
    message: '',
    type: 'info' as 'success' | 'error' | 'info' | 'warning',
    redirect: '' 
  });

  useEffect(() => {
    const token = localStorage.getItem('somalink_token') || sessionStorage.getItem('somalink_token');
    if (!token) {
      router.replace('/login');
      return;
    }
    setAuthChecking(false);

    setMounted(true);
    const stored = localStorage.getItem('somalink_user') || sessionStorage.getItem('somalink_user');
    if (stored) {
      try { setCurrentUser(JSON.parse(stored)); } catch(e) {}
    }
  }, [router]);

  const [projectName, setProjectName] = useState('');
  const [shippingAddress, setShippingAddress] = useState(''); 
  const [siteContactPerson, setSiteContactPerson] = useState(''); 
  const [siteContactPhone, setSiteContactPhone] = useState(''); 
  const [customerNote, setCustomerNote] = useState(''); 
  
  const [attachments, setAttachments] = useState<string[]>([]);
  const [isUploading, setIsUploading] = useState(false);

  const [agreed, setAgreed] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);

  const showAlert = (title: string, message: string, type: 'error' | 'success' | 'info' | 'warning' = 'error', redirect = '') => {
    setModalConfig({ isOpen: true, title, message, type, redirect });
  };

  const fillMemberInfo = () => {
    if (currentUser && currentUser.dealerProfile) {
      const { address, contactPerson, phone } = currentUser.dealerProfile;
      if (address) setShippingAddress(address);
      if (contactPerson) setSiteContactPerson(contactPerson);
      if (phone) setSiteContactPhone(phone);
    } else {
      showAlert('æç¤º', 'ç„¡æ³•è®€å–æœƒå“¡è³‡æ–™ï¼Œè«‹ç¢ºèªæ‚¨å·²ç™»å…¥ã€‚', 'info');
    }
  };

  const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (!files || files.length === 0) return;

    setIsUploading(true);
    const newAttachments = [...attachments];

    try {
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_PRESET);

        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
          method: 'POST',
          body: formData,
        });
        
        const data = await res.json();
        if (data.secure_url) {
          newAttachments.push(data.secure_url);
        }
      }
      setAttachments(newAttachments);
    } catch (err) {
      console.error('ä¸Šå‚³å¤±æ•—', err);
      showAlert('ä¸Šå‚³å¤±æ•—', 'éƒ¨åˆ†æª”æ¡ˆä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æª”æ¡ˆå¤§å°ã€‚', 'error');
    } finally {
      setIsUploading(false);
    }
  };

  const removeAttachment = (index: number) => {
    setAttachments(prev => prev.filter((_, i) => i !== index));
  };

  // âœ¨âœ¨âœ¨ æ–°å¢ï¼šç”¢ç”Ÿå ±åƒ¹å–®é‚è¼¯ âœ¨âœ¨âœ¨
  const handlePrintQuotation = () => {
    if (!projectName.trim()) { showAlert('æ¬„ä½æœªå¡«', 'è«‹è¼¸å…¥æ¡ˆå ´åç¨±ï¼Œä»¥ä¾¿é¡¯ç¤ºåœ¨å ±åƒ¹å–®ä¸Š', 'warning'); return; }
    
    // 1. æ‰“åŒ…ç›®å‰è³¼ç‰©è»Šè³‡æ–™
    const quotationData = {
      projectName,
      shippingAddress,
      siteContactPerson,
      siteContactPhone,
      items,
      totalAmount: cartTotal,
      createdAt: new Date().toISOString()
    };

    // 2. å­˜å…¥ SessionStorage (æš«å­˜)
    sessionStorage.setItem('soma_quotation_draft', JSON.stringify(quotationData));

    // 3. é–‹å•Ÿé è¦½é 
    window.open('/quotation/preview', '_blank');
  };

  const handleSubmit = async () => {
    if (!projectName.trim()) { showAlert('æ¬„ä½æœªå¡«', 'è«‹è¼¸å…¥æ¡ˆå ´åç¨±', 'warning'); return; }
    if (!shippingAddress.trim()) { showAlert('æ¬„ä½æœªå¡«', 'è«‹è¼¸å…¥æ–½å·¥/é€è²¨åœ°å€', 'warning'); return; }
    if (!siteContactPerson.trim()) { showAlert('æ¬„ä½æœªå¡«', 'è«‹è¼¸å…¥ç¾å ´è¯çµ¡äºº', 'warning'); return; }
    if (!siteContactPhone.trim()) { showAlert('æ¬„ä½æœªå¡«', 'è«‹è¼¸å…¥ç¾å ´é›»è©±', 'warning'); return; }
    if (!agreed) { showAlert('è«‹åŒæ„æ¢æ¬¾', 'è«‹å‹¾é¸ã€Œæˆ‘å·²ç¢ºèªä¸Šè¿°è¦æ ¼ç„¡èª¤ï¼Œä¸¦åŒæ„æœå‹™æ¢æ¬¾ã€', 'warning'); return; }

    setIsSubmitting(true);

    try {
      const payload = {
        projectName,
        shippingAddress,
        siteContactPerson,
        siteContactPhone,
        customerNote,
        attachments,
        agreedToDisclaimer: agreed,
        items: items.map(item => ({
          productId: item.productId,
          serviceType: item.serviceType,
          widthMatrix: item.widthMatrix,
          heightData: item.heightData,
          isCeilingMounted: item.isCeilingMounted,
          siteConditions: item.siteConditions,
          colorName: item.colorName,
          materialName: item.materialName,
          handleName: item.handleName,
          openingDirection: item.openingDirection,
          hasThreshold: item.hasThreshold,
          quantity: item.quantity,
          subtotal: item.subtotal,
          priceSnapshot: item.priceSnapshot
        }))
      };

      await api.post('/orders', payload);
      clearCart();
      
      showAlert('è¨‚å–®å·²é€å‡ºï¼', 'æ‚¨çš„è¨‚å–®å·²æˆåŠŸå»ºç«‹ï¼Œè«‹è‡³ã€Œæ­·å²è¨‚å–®ã€æŸ¥çœ‹é€²åº¦ã€‚', 'success', '/orders');

    } catch (error: any) {
      console.error(error);
      if (error.response?.status === 401) {
        showAlert('æ¬Šé™éŒ¯èª¤', 'è«‹å…ˆç™»å…¥æœƒå“¡å¾Œå†è©¦ã€‚', 'error', '/login');
      } else {
        showAlert('çµå¸³å¤±æ•—', 'ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡ã€‚', 'error');
      }
    } finally {
      setIsSubmitting(false);
    }
  };

  if (authChecking) return <div className="min-h-screen flex justify-center items-center bg-gray-50"><Loader2 className="animate-spin text-blue-600" /></div>;
  if (!mounted) return null;

  if (items.length === 0) {
    return (
      <div className="min-h-[60vh] flex flex-col items-center justify-center p-8 text-center">
        <div className="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-6">
          <ShoppingBag className="w-10 h-10 text-gray-400" />
        </div>
        <h2 className="text-2xl font-bold text-gray-900 mb-2">è³¼ç‰©è»Šæ˜¯ç©ºçš„</h2>
        <p className="text-gray-500 mb-8 max-w-sm">çœ‹èµ·ä¾†æ‚¨é‚„æ²’æœ‰åŠ å…¥ä»»ä½•é–€æ‰‡ã€‚å»é€›é€›æˆ‘å€‘çš„ç”¢å“ç³»åˆ—ï¼Œé–‹å§‹æ‚¨çš„æ•¸ä½å·¥å» ä¹‹æ—…å§ï¼</p>
        <Link href="/" className="px-8 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition-colors">
          å‰å¾€é¸è³¼
        </Link>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 py-12">
      <Modal 
        isOpen={modalConfig.isOpen}
        title={modalConfig.title}
        message={modalConfig.message}
        type={modalConfig.type}
        onClose={() => {
          setModalConfig(prev => ({ ...prev, isOpen: false }));
          if (modalConfig.redirect) router.push(modalConfig.redirect);
        }}
        confirmText="ç¢ºå®š"
      />

      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 className="text-3xl font-bold text-gray-900 mb-8">ç¢ºèªè¨‚å–®å…§å®¹</h1>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-10">
          
          {/* å·¦å´ï¼šå•†å“åˆ—è¡¨ */}
          <div className="lg:col-span-2 space-y-6">
            {items.map((item) => (
              <div key={item.internalId} className="bg-white rounded-2xl border border-gray-200 p-6 shadow-sm flex flex-col sm:flex-row gap-6 relative group">
                <button 
                  onClick={() => removeFromCart(item.internalId)}
                  className="absolute top-4 right-4 p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors"
                >
                  <Trash2 className="w-5 h-5" />
                </button>
                <div className="w-24 h-24 bg-gray-100 rounded-xl shrink-0 overflow-hidden">
                   {/* eslint-disable-next-line @next/next/no-img-element */}
                   <img src="https://images.unsplash.com/photo-1600607686527-6fb886090705?auto=format&fit=crop&q=80&w=200" alt={item.productName} className="w-full h-full object-cover" />
                </div>
                <div className="flex-1">
                  <div className="flex flex-wrap items-center gap-2 mb-1">
                    <h3 className="text-lg font-bold text-gray-900">{item.productName}</h3>
                    {item.serviceType === 'material' ? (
                      <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-bold bg-gray-100 text-gray-700 border border-gray-200"><Package className="w-3 h-3" /> ç´”ææ–™</span>
                    ) : (
                      <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-bold bg-blue-50 text-blue-700 border border-blue-100"><Hammer className="w-3 h-3" /> é€£å·¥å¸¶æ–™</span>
                    )}
                  </div>
                  <div className="mt-2 space-y-1 text-sm text-gray-600">
                    <p><span className="font-medium">è¦æ ¼ï¼š</span>{item.colorName} / {item.materialName} / {item.handleName || 'ç„¡æŠŠæ‰‹'} / {item.openingDirection}</p>
                    <p><span className="font-medium">å°ºå¯¸ï¼š</span>W {item.widthMatrix.mid}cm x H {item.heightData.singleValue || item.heightData.mid || 'N/A'}cm {item.isCeilingMounted && <span className="ml-2 px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded-full">å°é ‚</span>}</p>
                    {item.siteConditions?.floor && <p className="text-orange-600 text-xs flex items-center gap-1"><AlertCircle className="w-3 h-3" /> åœ°é¢æ°´å¹³èª¤å·®: {item.siteConditions.floor.diff}cm</p>}
                  </div>
                  <div className="mt-4 flex items-center justify-between">
                    <div className="flex items-baseline gap-2">
                      <span className="text-2xl font-bold text-blue-600">${item.subtotal.toLocaleString()}</span>
                      <span className="text-xs text-gray-400">({item.serviceType === 'material' ? 'ææ–™è²·æ–·åƒ¹' : 'å«å·¥è³‡æ‰“åŒ…åƒ¹'})</span>
                    </div>
                    <span className="text-sm text-gray-400">æ•¸é‡: {item.quantity}</span>
                  </div>
                </div>
              </div>
            ))}
          </div>

          {/* å³å´ï¼šçµå¸³é¢æ¿ */}
          <div className="lg:col-span-1">
            <div className="bg-white rounded-2xl border border-gray-200 p-6 shadow-sm sticky top-24">
              <h2 className="text-xl font-bold text-gray-900 mb-6">è¨‚å–®æ‘˜è¦</h2>
              <div className="space-y-4 mb-6">
                <div className="flex justify-between text-gray-600"><span>å•†å“ç¸½æ•¸</span><span>{items.length} ä»¶</span></div>
                <div className="flex justify-between text-lg font-bold text-gray-900 pt-4 border-t border-gray-100"><span>ç¸½é‡‘é¡</span><span>${cartTotal.toLocaleString()}</span></div>
              </div>

              <div className="mb-6 flex justify-between items-center">
                <span className="text-xs font-bold text-gray-500 uppercase tracking-wider">æ”¶è²¨èˆ‡è¯çµ¡è³‡è¨Š</span>
                <button onClick={fillMemberInfo} className="text-xs text-blue-600 hover:bg-blue-50 px-2 py-1 rounded flex items-center gap-1 transition-colors"><Copy className="w-3 h-3" /> åŒæœƒå“¡è³‡æ–™</button>
              </div>

              <div className="space-y-4 mb-6">
                <div>
                  <label className="flex items-center gap-1 text-sm font-medium text-gray-700 mb-1"><Building2 className="w-3.5 h-3.5" /> æ¡ˆå ´åç¨± *</label>
                  <input type="text" value={projectName} onChange={(e) => setProjectName(e.target.value)} placeholder="ä¾‹ï¼šå°åŒ—å¸å¯¶ A æ£Ÿ" className="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none text-sm" />
                </div>
                <div>
                  <label className="flex items-center gap-1 text-sm font-medium text-gray-700 mb-1"><MapPin className="w-3.5 h-3.5" /> æ–½å·¥/é€è²¨åœ°å€ *</label>
                  <input type="text" value={shippingAddress} onChange={(e) => setShippingAddress(e.target.value)} placeholder="å®Œæ•´åœ°å€" className="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none text-sm" />
                </div>
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="flex items-center gap-1 text-sm font-medium text-gray-700 mb-1"><User className="w-3.5 h-3.5" /> ç¾å ´è¯çµ¡äºº *</label>
                    <input type="text" value={siteContactPerson} onChange={(e) => setSiteContactPerson(e.target.value)} placeholder="ç‹å…ˆç”Ÿ" className="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none text-sm" />
                  </div>
                  <div>
                    <label className="flex items-center gap-1 text-sm font-medium text-gray-700 mb-1"><Phone className="w-3.5 h-3.5" /> ç¾å ´é›»è©± *</label>
                    <input type="tel" value={siteContactPhone} onChange={(e) => setSiteContactPhone(e.target.value)} placeholder="0912..." className="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none text-sm" />
                  </div>
                </div>
              </div>

              <div className="mb-6">
                <label className="flex items-center gap-1 text-sm font-medium text-gray-700 mb-2"><UploadCloud className="w-3.5 h-3.5" /> é™„ä»¶ä¸Šå‚³ (ç¾å ´ç…§/CADåœ–) é¸å¡«</label>
                <div className="flex flex-wrap gap-2 mb-2">
                  {attachments.map((url, index) => (
                    <div key={index} className="relative group">
                      <div className="w-12 h-12 bg-gray-100 rounded-lg border border-gray-200 flex items-center justify-center overflow-hidden">
                        {url.match(/\.(jpeg|jpg|gif|png)$/i) ? (
                          // eslint-disable-next-line @next/next/no-img-element
                          <img src={url} alt="attachment" className="w-full h-full object-cover" />
                        ) : (
                          <FileText className="w-6 h-6 text-gray-400" />
                        )}
                      </div>
                      <button onClick={() => removeAttachment(index)} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity shadow-sm"><X className="w-3 h-3" /></button>
                    </div>
                  ))}
                  <label className="w-12 h-12 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center cursor-pointer hover:bg-gray-50 hover:border-blue-400 transition-colors">
                    {isUploading ? <Loader2 className="w-5 h-5 text-blue-500 animate-spin" /> : <UploadCloud className="w-5 h-5 text-gray-400" />}
                    <input type="file" multiple onChange={handleFileUpload} className="hidden" disabled={isUploading} />
                  </label>
                </div>
                <p className="text-xs text-gray-400">æ”¯æ´åœ–ç‰‡èˆ‡ PDFï¼Œå–®æª”è«‹å‹¿è¶…é 10MBã€‚</p>
              </div>

              <div className="mb-6">
                <label className="flex items-center gap-1 text-sm font-medium text-gray-700 mb-2"><MessageSquare className="w-3.5 h-3.5" /> è¨‚å–®å‚™è¨» (é¸å¡«)</label>
                <textarea value={customerNote} onChange={(e) => setCustomerNote(e.target.value)} placeholder="å…¶ä»–éœ€æ±‚..." className="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none h-20 resize-none text-sm" />
              </div>

              <label className="flex items-start gap-3 mb-6 cursor-pointer p-3 rounded-lg hover:bg-gray-50 transition-colors">
                <input type="checkbox" checked={agreed} onChange={(e) => setAgreed(e.target.checked)} className="mt-1 w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500" />
                <span className="text-sm text-gray-600 leading-relaxed">æˆ‘å·²ç¢ºèªä¸Šè¿°è¦æ ¼ç„¡èª¤ï¼Œä¸¦åŒæ„æœå‹™æ¢æ¬¾ã€‚</span>
              </label>

              {/* âœ¨âœ¨âœ¨ æ–°å¢æŒ‰éˆ•å€åŸŸ (åŒ…å«å ±åƒ¹å–®ä¸‹è¼‰) âœ¨âœ¨âœ¨ */}
              <div className="space-y-3">
                <button 
                  onClick={handlePrintQuotation}
                  className="w-full py-3 bg-white border-2 border-blue-600 text-blue-600 font-bold rounded-xl hover:bg-blue-50 transition-all flex items-center justify-center gap-2"
                >
                  <Printer className="w-5 h-5" /> ä¸‹è¼‰ / åˆ—å°å ±åƒ¹å–®
                </button>

                <button 
                  onClick={handleSubmit} 
                  disabled={isSubmitting} 
                  className="w-full py-4 bg-gray-900 hover:bg-black text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2 disabled:opacity-70"
                >
                  {isSubmitting ? <Loader2 className="animate-spin w-5 h-5" /> : <>ç¢ºèªä¸‹å–® <ArrowRight className="w-5 h-5" /></>}
                </button>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/app/orders/page.tsx">
'use client';

import { useEffect, useState } from 'react';
// âœ¨ ä¿®æ­£ï¼šç¢ºä¿é€™è£¡æœ‰å°å…¥ Link
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { Package, Clock, Truck, CheckCircle, Trash2, Hammer, XCircle, RefreshCw, Loader2, Printer } from 'lucide-react';
import { api } from '@/lib/api';
import Modal from '@/components/Modal';
import { useCart, CartItem } from '@/context/CartContext';

// å®šç¾©ä»‹é¢ (èˆ‡ API å›å‚³ä¸€è‡´)
interface OrderItem {
  productId: string; 
  product: { 
    id: string; 
    name: string; 
    basePrice?: number; 
    assemblyFee?: number;
  };
  quantity: number;
  serviceType: 'material' | 'assembled';
  widthMatrix: any;
  heightData: any;
  isCeilingMounted: boolean;
  siteConditions: any;
  colorName: string;
  materialName: string;
  handleName: string;
  openingDirection: string;
  hasThreshold: boolean;
  subtotal: number;
  priceSnapshot: any;
}

interface Order {
  id: string;
  orderNumber: string;
  status: 'pending' | 'processing' | 'shipped' | 'completed' | 'cancelled';
  totalAmount: number;
  createdAt: string;
  projectName: string;
  items: OrderItem[];
}

export default function OrdersPage() {
  const router = useRouter();
  const { addToCart } = useCart(); 
  const [orders, setOrders] = useState<Order[]>([]);
  const [loading, setLoading] = useState(true);
  
  // æ¬Šé™æª¢æŸ¥ç‹€æ…‹
  const [authChecking, setAuthChecking] = useState(true);

  // å½ˆçª—ç‹€æ…‹
  const [deleteModal, setDeleteModal] = useState({ isOpen: false, orderId: '' });
  const [reorderModal, setReorderModal] = useState({ isOpen: false, order: null as Order | null });
  const [isDeleting, setIsDeleting] = useState(false);

  useEffect(() => {
    // æª¢æŸ¥æ˜¯å¦ç™»å…¥
    const token = localStorage.getItem('somalink_token') || sessionStorage.getItem('somalink_token');
    if (!token) {
      router.replace('/login');
      return;
    }
    setAuthChecking(false);

    const fetchOrders = async () => {
      try {
        const data = await api.get('/orders');
        setOrders(data);
      } catch (error) {
        console.error('Failed to fetch orders', error);
      } finally {
        setLoading(false);
      }
    };
    fetchOrders();
  }, [router]);

  // --- åˆªé™¤é‚è¼¯ ---
  const confirmDelete = (orderId: string) => {
    setDeleteModal({ isOpen: true, orderId });
  };

  const handleDelete = async () => {
    if (!deleteModal.orderId) return;
    setIsDeleting(true);
    try {
      await api.delete(`/orders/${deleteModal.orderId}`);
      setOrders((prev) => prev.filter((o) => o.id !== deleteModal.orderId));
    } catch (error) {
      console.error(error);
      alert('åˆªé™¤å¤±æ•—ï¼šå¯èƒ½è¨‚å–®å·²é€²å…¥ç”Ÿç”¢æµç¨‹ï¼Œè«‹è¯ç¹«å®¢æœã€‚');
    } finally {
      setIsDeleting(false);
      setDeleteModal({ isOpen: false, orderId: '' });
    }
  };

  // --- å†æ¬¡è³¼è²·é‚è¼¯ ---
  const confirmReorder = (order: Order) => {
    setReorderModal({ isOpen: true, order });
  };

  const handleReorder = () => {
    const order = reorderModal.order;
    if (!order) return;

    order.items.forEach(item => {
      const cartItem: CartItem = {
        internalId: crypto.randomUUID(), 
        productId: item.product?.id,     
        productName: item.product?.name || 'æœªçŸ¥å•†å“',
        // ä½¿ç”¨ç•¶æ™‚çš„å¿«ç…§åƒ¹æ ¼é‡æ–°è¨ˆç®—å–®åƒ¹ (æˆ–æ ¹æ“šæ‚¨çš„éœ€æ±‚æŠ“å–æœ€æ–°åƒ¹æ ¼)
        unitPrice: Number(item.priceSnapshot?.basePrice || 0) + 
                   Number(item.priceSnapshot?.sizeSurcharge || 0) +
                   Number(item.priceSnapshot?.colorSurcharge || 0) +
                   Number(item.priceSnapshot?.materialSurcharge || 0) +
                   Number(item.priceSnapshot?.handleSurcharge || 0) +
                   (item.serviceType === 'assembled' ? Number(item.priceSnapshot?.assemblyFee || 0) : 0),
        quantity: item.quantity,
        subtotal: Number(item.subtotal),
        serviceType: item.serviceType,
        widthMatrix: item.widthMatrix,
        heightData: item.heightData,
        isCeilingMounted: item.isCeilingMounted,
        siteConditions: item.siteConditions,
        colorName: item.colorName,
        materialName: item.materialName,
        handleName: item.handleName || '',
        openingDirection: item.openingDirection,
        hasThreshold: item.hasThreshold,
        priceSnapshot: item.priceSnapshot
      };
      addToCart(cartItem);
    });
    
    setReorderModal({ isOpen: false, order: null });
    router.push('/cart');
  };

  // è™•ç†åˆ—å°é–‹å•Ÿ (å‚³é Token)
  const handlePrint = (orderId: string) => {
    const token = localStorage.getItem('somalink_token') || sessionStorage.getItem('somalink_token');
    if (token) {
      window.open(`/orders/${orderId}/print?t=${token}`, '_blank');
    } else {
      alert('è«‹å…ˆç™»å…¥');
      router.push('/login');
    }
  };

  const getStatusDisplay = (status: string) => {
    switch (status) {
      case 'pending': return { label: 'å¾…å¯©æ ¸', color: 'bg-yellow-100 text-yellow-800', icon: <Clock className="w-4 h-4" /> };
      case 'processing': return { label: 'ç”Ÿç”¢ä¸­', color: 'bg-blue-100 text-blue-800', icon: <Hammer className="w-4 h-4" /> };
      case 'shipped': return { label: 'å·²å‡ºè²¨', color: 'bg-purple-100 text-purple-800', icon: <Truck className="w-4 h-4" /> };
      case 'completed': return { label: 'å·²å®Œæˆ', color: 'bg-green-100 text-green-800', icon: <CheckCircle className="w-4 h-4" /> };
      case 'cancelled': return { label: 'å·²å–æ¶ˆ', color: 'bg-gray-100 text-gray-600', icon: <XCircle className="w-4 h-4" /> };
      default: return { label: status, color: 'bg-gray-100 text-gray-600', icon: null };
    }
  };

  if (authChecking || loading) return <div className="min-h-screen bg-gray-50 flex items-center justify-center"><Loader2 className="animate-spin text-blue-600 w-10 h-10" /></div>;

  return (
    <div className="min-h-screen bg-gray-50 py-12">
      
      {/* åˆªé™¤ç¢ºèªå½ˆçª— */}
      <Modal 
        isOpen={deleteModal.isOpen}
        onClose={() => setDeleteModal({ isOpen: false, orderId: '' })}
        type="confirm" 
        title="å–æ¶ˆè¨‚å–®"
        message="ç¢ºå®šè¦å–æ¶ˆä¸¦åˆªé™¤é€™ç­†è¨‚å–®å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼Œä¸”åƒ…èƒ½åœ¨ã€Œå¾…å¯©æ ¸ã€ç‹€æ…‹ä¸‹åŸ·è¡Œã€‚"
        confirmText={isDeleting ? "åˆªé™¤ä¸­..." : "ç¢ºèªå–æ¶ˆ"}
        cancelText="ä¿ç•™è¨‚å–®"
        onConfirm={handleDelete}
      />

      {/* å†æ¬¡è³¼è²·ç¢ºèªå½ˆçª— */}
      <Modal 
        isOpen={reorderModal.isOpen}
        onClose={() => setReorderModal({ isOpen: false, order: null })}
        type="confirm" 
        title="å†æ¬¡è³¼è²·"
        message={`ç¢ºå®šè¦å°‡è¨‚å–® ${reorderModal.order?.orderNumber} çš„æ‰€æœ‰å•†å“è¦æ ¼è¤‡è£½åˆ°è³¼ç‰©è»Šå—ï¼Ÿ`}
        confirmText="åŠ å…¥è³¼ç‰©è»Š"
        cancelText="å–æ¶ˆ"
        onConfirm={handleReorder}
      />

      <div className="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
        <div className="flex justify-between items-end mb-8">
          <div><h1 className="text-3xl font-bold text-gray-900">æˆ‘çš„è¨‚å–®</h1><p className="text-gray-500 mt-2">è¿½è¹¤æ‚¨çš„è¨‚è£½é–€æ‰‡ç”Ÿç”¢é€²åº¦</p></div>
          <Link href="/" className="bg-blue-600 text-white px-6 py-2.5 rounded-xl font-bold hover:bg-blue-700 transition-colors shadow-sm flex items-center gap-2"><Package className="w-5 h-5" /> æ–°å¢è¨‚å–®</Link>
        </div>

        <div className="space-y-6">
          {orders.length === 0 ? (
            <div className="text-center py-20 bg-white rounded-3xl border border-gray-200"><Package className="w-16 h-16 text-gray-300 mx-auto mb-4" /><h3 className="text-xl font-bold text-gray-900">ç›®å‰æ²’æœ‰è¨‚å–®</h3><p className="text-gray-500 mt-2">é–‹å§‹æ‚¨çš„ç¬¬ä¸€å€‹æ•¸ä½å·¥å» å°ˆæ¡ˆå§ï¼</p></div>
          ) : (
            orders.map((order) => {
              const statusInfo = getStatusDisplay(order.status);
              return (
                <div key={order.id} className="bg-white rounded-2xl border border-gray-200 p-6 shadow-sm hover:shadow-md transition-shadow relative group">
                  <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <div className="flex items-center gap-3">
                      <div className="bg-gray-100 p-2 rounded-lg"><Package className="w-6 h-6 text-gray-600" /></div>
                      <div>
                        <div className="font-mono font-bold text-gray-900 text-lg">{order.orderNumber}</div>
                        <div className="text-sm text-gray-500 flex items-center gap-2"><span>{new Date(order.createdAt).toLocaleDateString()}</span><span className="w-1 h-1 bg-gray-300 rounded-full"></span><span>{order.projectName}</span></div>
                      </div>
                    </div>
                    <div className={`px-4 py-1.5 rounded-full text-sm font-bold flex items-center gap-2 ${statusInfo.color}`}>{statusInfo.icon}{statusInfo.label}</div>
                  </div>

                  <div className="bg-gray-50 rounded-xl p-4 mb-6">
                    <div className="flex justify-between items-center text-sm text-gray-600 mb-2"><span>è¨‚è³¼é …ç›®ï¼š</span><span className="font-bold text-gray-900">{order.items?.length || 0} ä»¶å•†å“</span></div>
                    <div className="space-y-1">
                      {order.items?.slice(0, 2).map((item, idx) => (
                        <div key={idx} className="text-sm text-gray-500 flex justify-between items-center">
                           <div className="flex items-center gap-2"><span>- {item.product?.name}</span>{item.serviceType === 'material' ? <span className="text-[10px] px-1.5 py-0.5 bg-gray-200 text-gray-600 rounded flex items-center gap-1"><Package className="w-3 h-3" /> ç´”æ–™</span> : <span className="text-[10px] px-1.5 py-0.5 bg-blue-100 text-blue-600 rounded flex items-center gap-1"><Hammer className="w-3 h-3" /> ä»£å·¥</span>}</div><span>x{item.quantity}</span>
                        </div>
                      ))}
                      {(order.items?.length || 0) > 2 && <div className="text-xs text-gray-400 pl-2">...é‚„æœ‰ {(order.items?.length || 0) - 2} é …</div>}
                    </div>
                    <div className="border-t border-gray-200 mt-3 pt-3 flex justify-between items-center"><span className="font-bold text-gray-900">ç¸½é‡‘é¡</span><span className="text-xl font-bold text-blue-600">${Number(order.totalAmount).toLocaleString()}</span></div>
                  </div>

                  <div className="flex justify-end items-center gap-3">
                    {/* âœ¨ ä¿®æ­£ï¼šé€™è£¡æ”¹ç‚ºå‘¼å« confirmReorder (è§¸ç™¼å½ˆçª—)ï¼Œè€Œä¸æ˜¯ handleReorder (åŸ·è¡Œå‹•ä½œ) */}
                    <button 
                      onClick={() => confirmReorder(order)}
                      className="text-blue-600 hover:text-blue-800 hover:bg-blue-50 px-4 py-2 rounded-lg text-sm font-bold transition-colors flex items-center gap-2 border border-blue-200"
                    >
                      <RefreshCw className="w-4 h-4" /> å†æ¬¡è³¼è²·
                    </button>
                    
                    {order.status === 'pending' && (
                      <button 
                        onClick={() => confirmDelete(order.id)}
                        disabled={isDeleting && deleteModal.orderId === order.id}
                        className="text-red-500 hover:text-red-700 hover:bg-red-50 px-4 py-2 rounded-lg text-sm font-bold transition-colors flex items-center gap-2"
                      >
                        {isDeleting && deleteModal.orderId === order.id ? 'åˆªé™¤ä¸­...' : <><Trash2 className="w-4 h-4" /> å–æ¶ˆ</>}
                      </button>
                    )}
                    
                    <button 
                      onClick={() => handlePrint(order.id)}
                      className="bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 px-4 py-2 rounded-lg font-bold text-sm transition-colors flex items-center gap-2"
                    >
                      <Printer className="w-4 h-4" /> åˆ—å°å·¥å–®
                    </button>
                  </div>
                </div>
              );
            })
          )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/lib/api.ts">
import axios from 'axios';

// å„ªå…ˆè®€å–ç’°å¢ƒè®Šæ•¸ï¼Œå¦å‰‡ä½¿ç”¨é è¨­å€¼ (Render Backend)
const API_URL = process.env.NEXT_PUBLIC_API_URL || 'https://somalink-backend.onrender.com';

// å®šç¾©å–®ä¸€å“é …çš„ä»‹é¢
export interface OrderItem {
  id: string;
  product: { 
    name: string;
    images?: string[];
    imageUrl?: string; 
  };
  serviceType: 'material' | 'assembled';
  widthMatrix: { top: number; mid: number; bot: number };
  heightData: any;
  isCeilingMounted: boolean;
  siteConditions?: any;
  colorName: string;
  materialName: string;
  // âœ¨âœ¨âœ¨ æ–°å¢æŠŠæ‰‹æ¬„ä½ âœ¨âœ¨âœ¨
  handleName?: string;
  openingDirection: string;
  hasThreshold: boolean;
  quantity: number;
  subtotal: number;
  priceSnapshot: any;
}

// å®šç¾©è¨‚å–®ç‹€æ…‹ Enum
export enum OrderStatus {
  PENDING = 'pending',       
  PROCESSING = 'processing', 
  SHIPPED = 'shipped',       
  COMPLETED = 'completed',   
  CANCELLED = 'cancelled',   
}

// å®šç¾©å®Œæ•´è¨‚å–®ä»‹é¢
export interface Order {
  id: string;
  orderNumber: string;
  status: OrderStatus;
  totalAmount: number;
  createdAt: string;
  projectName: string;
  
  // æ”¶è²¨èˆ‡è¯çµ¡è³‡è¨Š
  shippingAddress?: string;
  siteContactPerson?: string;
  siteContactPhone?: string;
  
  // é™„ä»¶
  attachments?: string[];

  customerNote?: string;
  adminNote?: string;
  items: OrderItem[]; 
}

// å»ºç«‹ Axios å¯¦ä¾‹
const axiosInstance = axios.create({
  baseURL: API_URL,
  headers: {
    'Content-Type': 'application/json',
  },
});

// è«‹æ±‚æ””æˆªå™¨ï¼šè‡ªå‹•å¸¶å…¥ Token
axiosInstance.interceptors.request.use((config) => {
  if (typeof window !== 'undefined') {
    // å‰å°ä½¿ç”¨çš„æ˜¯ 'somalink_token'
    // åŒæ™‚æª¢æŸ¥ LocalStorage å’Œ SessionStorage (è¨˜ä½æˆ‘åŠŸèƒ½)
    const token = localStorage.getItem('somalink_token') || sessionStorage.getItem('somalink_token');
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
  }
  return config;
});

export const api = {
  get: async (url: string) => {
    const response = await axiosInstance.get(url);
    return response.data;
  },
  post: async (url: string, data: any) => {
    const response = await axiosInstance.post(url, data);
    return response.data;
  },
  patch: async (url: string, data: any) => {
    const response = await axiosInstance.patch(url, data);
    return response.data;
  },
  delete: async (url: string) => {
    const response = await axiosInstance.delete(url);
    return response.data;
  },
  
  // âœ¨âœ¨âœ¨ æ–°å¢ï¼šèªè­‰ç›¸é—œ API (å¿˜è¨˜å¯†ç¢¼/é‡è¨­å¯†ç¢¼) âœ¨âœ¨âœ¨
  auth: {
    // ç”³è«‹é‡è¨­
    forgotPassword: async (email: string) => {
      const response = await axiosInstance.post('/auth/forgot-password', { email });
      return response.data;
    },
    // åŸ·è¡Œé‡è¨­
    resetPassword: async (token: string, password: string) => {
      const response = await axiosInstance.post('/auth/reset-password', { token, password });
      return response.data;
    },
  },

  // âœ¨âœ¨âœ¨ æ–°å¢ï¼šè³¼ç‰©è»Šå°ˆç”¨ API âœ¨âœ¨âœ¨
  cart: {
    // å–å¾—è³¼ç‰©è»Š
    list: async () => {
      const response = await axiosInstance.get('/cart');
      return response.data;
    },
    // åŠ å…¥è³¼ç‰©è»Š
    add: async (item: any) => {
      const response = await axiosInstance.post('/cart', item);
      return response.data;
    },
    // ç§»é™¤å–®é …
    remove: async (id: string) => {
      const response = await axiosInstance.delete(`/cart/${id}`);
      return response.data;
    },
    // æ¸…ç©ºè³¼ç‰©è»Š
    clear: async () => {
      const response = await axiosInstance.delete('/cart');
      return response.data;
    }
  }
};
</file>

<file path="admin/package.json">
{
  "name": "admin",
  "version": "0.1.1",
  "private": true,
  "scripts": {
    "dev": "next dev -p 3001",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "axios": "^1.13.2",
    "clsx": "^2.1.1",
    "lucide-react": "^0.554.0",
    "next": "15.1.9",
    "react": "19.0.0",
    "react-dom": "19.0.0",
    "react-hook-form": "^7.66.1",
    "recharts": "^3.4.1",
    "tailwind-merge": "^3.4.0",
    "xlsx": "^0.18.5"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "15.1.9",
    "tailwindcss": "^4",
    "typescript": "^5"
  }
}
</file>

<file path="admin/src/components/OrderDetailModal.tsx">
'use client';

import { X, Printer, Package, Ruler, AlertCircle, Trash2, Hammer, MessageSquare, Truck, CheckCircle, User, Phone, MapPin, Paperclip, ExternalLink, Image as ImageIcon } from 'lucide-react';
import { Order, api } from '@/lib/api';
import { useState } from 'react';
import Link from 'next/link';

interface OrderDetailModalProps {
  order: Order | null;
  isOpen: boolean;
  onClose: () => void;
  onStatusUpdate: () => void;
}

export default function OrderDetailModal({ order, isOpen, onClose, onStatusUpdate }: OrderDetailModalProps) {
  const [isUpdating, setIsUpdating] = useState(false);

  if (!isOpen || !order) return null;

  const handleStatusChange = async (newStatus: string) => {
    let confirmMsg = `ç¢ºå®šè¦å°‡ç‹€æ…‹è®Šæ›´ç‚º ${newStatus} å—ï¼Ÿ`;
    if (newStatus === 'processing') confirmMsg = `âœ… å¯©æ ¸é€šéç¢ºèª\n\nç¢ºå®šæ¥å—æ­¤è¨‚å–®ä¸¦é–‹å§‹ç”Ÿç”¢ï¼Ÿ`;
    else if (newStatus === 'shipped') confirmMsg = `ğŸšš å‡ºè²¨ç¢ºèª\n\nç¢ºå®šå°‡è¨‚å–®æ¨™è¨˜ç‚ºã€Œå·²å‡ºè²¨ã€ï¼Ÿ`;
    else if (newStatus === 'completed') confirmMsg = `ğŸ‰ å®Œå·¥çµæ¡ˆ\n\nç¢ºå®šå°‡è¨‚å–®æ¨™è¨˜ç‚ºã€Œå·²å®Œæˆã€ï¼Ÿ`;

    if (!confirm(confirmMsg)) return;
    setIsUpdating(true);
    try {
      await api.patch(`/orders/${order.id}`, { status: newStatus });
      onStatusUpdate();
      onClose();
    } catch (error) {
      console.error(error);
      alert('æ›´æ–°å¤±æ•—');
    } finally {
      setIsUpdating(false);
    }
  };

  const handleDelete = async () => {
    if (!confirm(`âš ï¸ å±éšªæ“ä½œï¼\n\nç¢ºå®šè¦ã€Œæ°¸ä¹…åˆªé™¤ã€é€™å¼µè¨‚å–®å—ï¼Ÿ`)) return;
    setIsUpdating(true);
    try {
      await api.delete(`/orders/${order.id}`);
      alert('è¨‚å–®å·²åˆªé™¤');
      onStatusUpdate();
      onClose();
    } catch (error) {
      console.error(error);
      alert('åˆªé™¤å¤±æ•—');
    } finally {
      setIsUpdating(false);
    }
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col animate-in fade-in zoom-in-95 duration-200">
        
        <div className="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50">
          <div>
            <div className="flex items-center gap-3">
              <h2 className="text-xl font-bold text-gray-900">{order.orderNumber}</h2>
              <span className={`px-2.5 py-0.5 rounded-full text-xs font-bold ${order.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : order.status === 'processing' ? 'bg-blue-100 text-blue-800' : order.status === 'shipped' ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800'}`}>
                {typeof order.status === 'string' ? order.status.toUpperCase() : order.status}
              </span>
            </div>
            <p className="text-sm text-gray-500 mt-1">ç¶“éŠ·å•†ï¼š{order.user?.dealerProfile?.companyName || order.user?.name}</p>
          </div>
          <button onClick={onClose} className="p-2 hover:bg-gray-200 rounded-full transition-colors"><X className="w-5 h-5 text-gray-500" /></button>
        </div>

        <div className="flex-1 overflow-y-auto p-6 space-y-8">

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
             <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
               <h3 className="text-xs font-bold text-blue-600 uppercase mb-2 tracking-wider">é€è²¨è³‡è¨Š (Ship To)</h3>
               <div className="space-y-2 text-sm text-blue-900">
                 <p className="flex items-start gap-2"><MapPin className="w-4 h-4 shrink-0 mt-0.5 opacity-50" /><span className="font-bold">{order.shippingAddress || 'æœªå¡«å¯«åœ°å€'}</span></p>
                 <p className="flex items-center gap-2"><User className="w-4 h-4 shrink-0 opacity-50" /> ç¾å ´è¯çµ¡äººï¼š{order.siteContactPerson || 'åŒè¨‚è³¼äºº'}</p>
                 <p className="flex items-center gap-2"><Phone className="w-4 h-4 shrink-0 opacity-50" /> ç¾å ´é›»è©±ï¼š{order.siteContactPhone || order.user?.dealerProfile?.phone}</p>
                 <p className="text-xs text-blue-400 mt-1 pl-6">æ¡ˆå ´åç¨±ï¼š{order.projectName}</p>
               </div>
             </div>
             
             <div className="bg-gray-50 p-4 rounded-xl border border-gray-100 flex flex-col justify-center">
               <div className="flex justify-between items-center mb-2 border-b border-gray-200 pb-2">
                 <span className="text-sm text-gray-500">è¨‚å–®ç¸½é‡‘é¡</span>
                 <span className="text-xl font-bold text-blue-600">${Number(order.totalAmount).toLocaleString()}</span>
               </div>
               <div className="flex justify-between items-center">
                 <span className="text-sm text-gray-500">ä¸‹å–®æ™‚é–“</span>
                 <span className="text-sm font-medium text-gray-900">{new Date(order.createdAt).toLocaleString('zh-TW')}</span>
               </div>
             </div>
          </div>

          {order.customerNote && (
            <div className="bg-amber-50 p-4 rounded-xl border border-amber-100 flex items-start gap-3">
              <MessageSquare className="w-5 h-5 text-amber-600 mt-0.5 shrink-0" />
              <div><span className="text-sm font-bold text-amber-800 block mb-1">å®¢æˆ¶å‚™è¨»ï¼š</span><p className="text-sm text-amber-900 leading-relaxed whitespace-pre-wrap">{order.customerNote}</p></div>
            </div>
          )}

          {order.attachments && order.attachments.length > 0 && (
            <div className="border border-gray-200 rounded-xl p-4">
              <h3 className="text-sm font-bold text-gray-900 mb-3 flex items-center gap-2"><Paperclip className="w-4 h-4" /> è¨‚å–®é™„ä»¶ ({order.attachments.length})</h3>
              <div className="flex flex-wrap gap-3">
                {order.attachments.map((url, idx) => (
                  <Link key={idx} href={url} target="_blank" className="flex items-center gap-2 px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg hover:bg-blue-50 hover:border-blue-200 transition-colors group">
                    {url.match(/\.(jpeg|jpg|gif|png)$/i) ? <div className="w-8 h-8 bg-white rounded overflow-hidden border"><img src={url} className="w-full h-full object-cover" alt="preview" /></div> : <div className="w-8 h-8 bg-gray-200 rounded flex items-center justify-center"><ExternalLink className="w-4 h-4 text-gray-500" /></div>}
                    <span className="text-sm text-gray-600 group-hover:text-blue-600">é™„ä»¶ {idx + 1}</span>
                  </Link>
                ))}
              </div>
            </div>
          )}

          <div>
            <h3 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2"><Package className="w-5 h-5" /> è¨‚è³¼å“é … ({order.items?.length || 0})</h3>
            <div className="border border-gray-200 rounded-xl overflow-hidden">
              <table className="w-full text-sm text-left">
                <thead className="bg-gray-50 border-b border-gray-200 text-gray-500 font-medium">
                  <tr><th className="px-4 py-3">ç”¢å“è³‡è¨Š</th><th className="px-4 py-3">å°ºå¯¸ (å¯¬xé«˜)</th><th className="px-4 py-3">è¦æ ¼ç´°ç¯€</th><th className="px-4 py-3">ç‰¹æ®Šéœ€æ±‚</th><th className="px-4 py-3 text-right">å°è¨ˆ</th></tr>
                </thead>
                <tbody className="divide-y divide-gray-100">
                  {order.items?.map((item, index) => {
                    // âœ¨âœ¨âœ¨ æ–°å¢ï¼šç¸®åœ–é‚è¼¯ âœ¨âœ¨âœ¨
                    const thumb = item.product?.images?.[0] || item.product?.imageUrl;

                    return (
                      <tr key={index} className="hover:bg-gray-50 transition-colors">
                        <td className="px-4 py-4">
                          <div className="flex items-start gap-3">
                            {/* é¡¯ç¤ºç¸®åœ– */}
                            <div className="w-12 h-12 bg-gray-100 rounded-lg border border-gray-200 overflow-hidden shrink-0 flex items-center justify-center">
                              {thumb ? (
                                // eslint-disable-next-line @next/next/no-img-element
                                <img src={thumb} className="w-full h-full object-cover" alt={item.product?.name} />
                              ) : (
                                <ImageIcon className="w-5 h-5 text-gray-300" />
                              )}
                            </div>
                            
                            <div>
                              <div className="font-medium text-gray-900">{item.product?.name || 'æœªçŸ¥ç”¢å“'}</div>
                              <div className="flex items-center gap-2 mt-1">
                                {item.serviceType === 'material' ? <span className="text-[10px] px-1.5 py-0.5 bg-gray-100 text-gray-600 border border-gray-200 rounded flex items-center gap-1"><Package className="w-3 h-3" /> ç´”ææ–™</span> : <span className="text-[10px] px-1.5 py-0.5 bg-blue-50 text-blue-600 border border-blue-100 rounded flex items-center gap-1"><Hammer className="w-3 h-3" /> é€£å·¥å¸¶æ–™</span>}
                                <span className="text-xs text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded">x{item.quantity}</span>
                              </div>
                            </div>
                          </div>
                        </td>
                        <td className="px-4 py-4"><div className="flex items-center gap-1 font-mono text-blue-700 bg-blue-50 px-2 py-1 rounded w-fit"><Ruler className="w-3 h-3" /> {item.widthMatrix.mid} x {item.heightData.singleValue || item.heightData.mid}</div>{item.isCeilingMounted && <span className="text-xs text-green-600 mt-1 block font-medium">âœ” å°é ‚å®‰è£</span>}</td>
                        <td className="px-4 py-4 text-gray-600"><div>{item.colorName}</div><div>{item.materialName}</div><div className="text-xs text-gray-400 mt-0.5">{item.openingDirection}</div></td>
                        <td className="px-4 py-4 text-gray-500">{item.siteConditions?.floor ? <div className="flex items-center gap-1 text-orange-600 text-xs font-medium bg-orange-50 px-2 py-1 rounded w-fit"><AlertCircle className="w-3 h-3" /> åœ°é¢èª¤å·® {item.siteConditions.floor.diff}cm</div> : '-'}</td>
                        <td className="px-4 py-4 text-right font-bold text-gray-900">${Number(item.subtotal).toLocaleString()}</td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>

          {order.adminNote && <div className="bg-yellow-50 p-4 rounded-xl border border-yellow-200 text-yellow-800 text-sm"><strong>ç®¡ç†å“¡å‚™è¨»ï¼š</strong> {order.adminNote}</div>}
        </div>

        <div className="p-4 border-t border-gray-100 bg-gray-50 flex justify-between items-center gap-3">
           <div className="flex items-center gap-3">
             <Link href={`/orders/${order.id}/print`} target="_blank" className="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium flex items-center gap-2 shadow-sm"><Printer className="w-4 h-4" /> åˆ—å°å·¥å–®</Link>
             <button onClick={handleDelete} disabled={isUpdating} className="px-4 py-2 bg-red-50 text-red-600 border border-red-100 rounded-lg hover:bg-red-100 font-medium flex items-center gap-2 transition-colors"><Trash2 className="w-4 h-4" /> åˆªé™¤</button>
           </div>
           <div className="flex gap-2">
             {order.status === 'pending' && <><button onClick={() => handleStatusChange('cancelled')} disabled={isUpdating} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-bold transition-colors">æ‹’çµ•</button><button onClick={() => handleStatusChange('processing')} disabled={isUpdating} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-md flex items-center gap-2 transition-colors"><CheckCircle className="w-4 h-4" /> å¯©æ ¸é€šé</button></>}
             {order.status === 'processing' && <button onClick={() => handleStatusChange('shipped')} disabled={isUpdating} className="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-bold shadow-md flex items-center gap-2 transition-colors"><Truck className="w-4 h-4" /> å®‰æ’å‡ºè²¨</button>}
             {order.status === 'shipped' && <button onClick={() => handleStatusChange('completed')} disabled={isUpdating} className="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold shadow-md flex items-center gap-2 transition-colors"><CheckCircle className="w-4 h-4" /> æ¨™è¨˜ç‚ºå·²å®Œå·¥</button>}
           </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="backend/src/app.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { ConfigModule } from '@nestjs/config';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { UsersModule } from './users/users.module';
import { AuthModule } from './auth/auth.module';
import { ProductsModule } from './products/products.module';
import { OrdersModule } from './orders/orders.module';
import { ReportsModule } from './reports/reports.module';
import { SeriesModule } from './series/series.module';
import { AnnouncementsModule } from './announcements/announcements.module';
import { NotificationsModule } from './notifications/notifications.module';
// å¼•å…¥ç¶²ç«™è¨­å®šæ¨¡çµ„
import { SiteConfigModule } from './site-config/site-config.module';
// å¼•å…¥è³¼ç‰©è»Šæ¨¡çµ„
import { CartModule } from './cart/cart.module';
// âœ¨âœ¨âœ¨ å¼•å…¥ LogsModule âœ¨âœ¨âœ¨
import { LogsModule } from './logs/logs.module';

@Module({
  imports: [
    // 1. å…¨åŸŸç’°å¢ƒè®Šæ•¸è¨­å®š (.env)
    ConfigModule.forRoot({
      isGlobal: true, 
    }),
    
    // 2. è³‡æ–™åº«é€£ç·šè¨­å®š (PostgreSQL)
    TypeOrmModule.forRoot({
      type: 'postgres',
      url: process.env.DATABASE_URL, // å„ªå…ˆä½¿ç”¨ DATABASE_URL
      host: process.env.DB_HOST,
      port: parseInt(process.env.DB_PORT || '5432'),
      username: process.env.DB_USERNAME,
      password: process.env.DB_PASSWORD,
      database: process.env.DB_DATABASE,
      autoLoadEntities: true, // è‡ªå‹•è¼‰å…¥æ‰€æœ‰ Entity
      synchronize: true,      // é–‹ç™¼æ¨¡å¼ä¸‹è‡ªå‹•åŒæ­¥è³‡æ–™åº«çµæ§‹ (ç”Ÿç”¢ç’°å¢ƒå»ºè­°æ”¹ false)
      ssl: {
        rejectUnauthorized: false, // å…è¨±è‡ªæˆ‘ç°½ç½²æ†‘è­‰ (è§£æ±º Render/Neon SSL å•é¡Œ)
      },
    }),

    // 3. åŠŸèƒ½æ¨¡çµ„è¨»å†Š
    UsersModule,
    AuthModule,
    ProductsModule,
    OrdersModule,
    ReportsModule,
    SeriesModule,
    AnnouncementsModule,
    NotificationsModule,
    SiteConfigModule,
    CartModule,
    // âœ¨âœ¨âœ¨ è¨»å†Š LogsModule âœ¨âœ¨âœ¨
    LogsModule,
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
</file>

<file path="backend/src/orders/entities/order.entity.ts">
import { Entity, Column, PrimaryGeneratedColumn, ManyToOne, OneToMany, CreateDateColumn, UpdateDateColumn } from 'typeorm';
import { User } from '../../users/entities/user.entity';
import { OrderItem } from './order-item.entity';

export enum OrderStatus {
  PENDING = 'pending',       
  PROCESSING = 'processing', 
  SHIPPED = 'shipped',       
  COMPLETED = 'completed',   
  CANCELLED = 'cancelled',   
}

// âœ¨âœ¨âœ¨ ä¿®æ­£é‡é»ï¼šæ˜ç¢ºæŒ‡å®šè¡¨åç‚º 'orders' (è¤‡æ•¸)ï¼Œé¿é–‹ SQL ä¿ç•™å­— 'order' âœ¨âœ¨âœ¨
@Entity('orders')
export class Order {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ unique: true })
  orderNumber: string;

  @ManyToOne(() => User, { eager: true, onDelete: 'CASCADE' })
  user: User;

  @OneToMany(() => OrderItem, (item) => item.order, { cascade: true, eager: true })
  items: OrderItem[];

  @Column()
  projectName: string;

  @Column({ nullable: true })
  shippingAddress: string;

  @Column({ nullable: true })
  siteContactPerson: string; 

  @Column({ nullable: true })
  siteContactPhone: string; 

  @Column({ type: 'jsonb', nullable: true })
  attachments: string[];

  @Column({
    type: 'enum',
    enum: OrderStatus,
    default: OrderStatus.PENDING,
  })
  status: OrderStatus;

  @Column({ type: 'decimal', precision: 12, scale: 2 })
  totalAmount: number;

  @Column({ default: false })
  agreedToDisclaimer: boolean;

  @Column({ nullable: true })
  adminNote?: string;

  @Column({ nullable: true })
  customerNote?: string;

  @CreateDateColumn()
  createdAt: Date;

  @UpdateDateColumn()
  updatedAt: Date;
}
</file>

<file path="frontend/package.json">
{
  "name": "frontend",
  "version": "0.1.1",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@hookform/resolvers": "^5.2.2",
    "axios": "^1.13.2",
    "clsx": "^2.1.1",
    "lucide-react": "^0.554.0",
    "next": "15.1.9",
    "react": "19.0.0",
    "react-dom": "19.0.0",
    "react-hook-form": "^7.66.1",
    "tailwind-merge": "^3.4.0",
    "zod": "^4.1.12"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "15.1.9",
    "tailwindcss": "^4",
    "typescript": "^5"
  }
}
</file>

<file path="backend/src/users/entities/dealer-profile.entity.ts">
import { Entity, Column, PrimaryGeneratedColumn, OneToOne } from 'typeorm';
import { User } from './user.entity';

export enum DealerLevel {
  A = 'A',
  B = 'B',
  C = 'C',
}

export enum TradeType {
  DESIGN = 'design', 
  GLASS = 'glass',   
  WINDOW = 'window', 
  DECOR = 'decor',   
  OTHER = 'other',   
}

@Entity()
export class DealerProfile {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  companyName: string;

  @Column()
  taxId: string;

  @Column()
  contactPerson: string;

  @Column()
  phone: string;

  @Column()
  address: string;

  // âœ¨âœ¨âœ¨ ä¿®æ­£ï¼šåŠ å…¥ nullable: true è§£æ±ºè³‡æ–™åº«è¡çª âœ¨âœ¨âœ¨
  @Column({
    type: 'enum',
    enum: TradeType,
    default: TradeType.OTHER,
    nullable: true 
  })
  tradeType: TradeType;

  @Column({
    type: 'enum',
    enum: DealerLevel,
    default: DealerLevel.C,
  })
  level: DealerLevel;

  @Column({ default: false })
  isVerified: boolean;

  @Column({ type: 'decimal', precision: 12, scale: 2, default: 0 })
  walletBalance: number;

  @Column({ default: false })
  isUpgradeable: boolean;

  @OneToOne(() => User, (user) => user.dealerProfile)
  user: User;
}
</file>

<file path="backend/src/users/entities/user.entity.ts">
import { Entity, Column, PrimaryGeneratedColumn, OneToOne, JoinColumn, ManyToOne, OneToMany, CreateDateColumn, UpdateDateColumn } from 'typeorm';
import { DealerProfile } from './dealer-profile.entity';
import { TradeCategory } from './trade-category.entity';
import { CartItem } from '../../cart/entities/cart-item.entity';

export enum UserRole {
  // âœ¨âœ¨âœ¨ ä¿®æ­£ï¼šå°‡å€¼æ”¹ç‚ºå°å¯«ï¼Œä»¥ç¬¦åˆè³‡æ–™åº«ç¾æœ‰çš„ user_role_enum å®šç¾© âœ¨âœ¨âœ¨
  ADMIN = 'admin',
  DEALER = 'dealer',
}

@Entity()
export class User {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ unique: true })
  email: string;

  @Column({ nullable: true })
  password?: string;

  @Column({ nullable: true })
  name: string;

  @Column({
    type: 'enum',
    enum: UserRole,
    default: UserRole.DEALER,
  })
  role: UserRole;

  @Column({ default: true })
  isActive: boolean;

  @OneToOne(() => DealerProfile, (profile) => profile.user, { cascade: true, eager: true })
  @JoinColumn()
  dealerProfile: DealerProfile;

  @ManyToOne(() => TradeCategory, { nullable: true, eager: true })
  tradeCategory: TradeCategory;

  @OneToMany(() => CartItem, (cartItem) => cartItem.user)
  cartItems: CartItem[];

  @CreateDateColumn()
  createdAt: Date;

  @UpdateDateColumn()
  updatedAt: Date;
}
</file>

<file path="backend/src/users/users.service.ts">
import { Injectable, ConflictException, InternalServerErrorException, NotFoundException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import * as bcrypt from 'bcrypt';
import { User, UserRole } from './entities/user.entity';
import { CreateUserDto } from './dto/create-user.dto';
import { UpdateUserDto } from './dto/update-user.dto';
import { TradeCategory } from './entities/trade-category.entity';
import { DealerProfile, DealerLevel, TradeType } from './entities/dealer-profile.entity'; 
import { NotificationsService } from '../notifications/notifications.service';

// âœ¨âœ¨âœ¨ ç¡¬æ€§è¦å‰‡ (Hardcoded Rules) å®šç¾©å€ âœ¨âœ¨âœ¨
export const DEALER_LIMITS = {
  [DealerLevel.A]: 200000, // A ç´š 20è¬
  [DealerLevel.B]: 100000, // B ç´š 10è¬
  [DealerLevel.C]: 0,      // C ç´šä¸å¯å„²å€¼
};

@Injectable()
export class UsersService {
  constructor(
    @InjectRepository(User)
    private usersRepository: Repository<User>,
    @InjectRepository(TradeCategory)
    private tradeCategoriesRepository: Repository<TradeCategory>,
    @InjectRepository(DealerProfile)
    private dealerProfileRepository: Repository<DealerProfile>,
    private notificationsService: NotificationsService,
  ) {}

  // 1. è¨»å†Š (Create)
  async create(createUserDto: CreateUserDto) {
    const existingUser = await this.usersRepository.findOne({ 
      where: { email: createUserDto.email } 
    });
    
    if (existingUser) {
      throw new ConflictException('æ­¤ Email å·²ç¶“è¢«è¨»å†Š');
    }

    const user = new User();
    user.email = createUserDto.email;
    user.name = createUserDto.name;
    
    const salt = await bcrypt.genSalt();
    user.password = await bcrypt.hash(createUserDto.password, salt);

    if (createUserDto.tradeCategoryId && createUserDto.tradeCategoryId.trim() !== '') {
      const tradeCategory = await this.tradeCategoriesRepository.findOneBy({ 
        id: createUserDto.tradeCategoryId 
      });
      if (!tradeCategory) throw new NotFoundException('é¸æ“‡çš„ç‡Ÿæ¥­é¡åˆ¥ç„¡æ•ˆ');
      user.tradeCategory = tradeCategory;
    } else {
      // âœ¨ Fix: å¼·åˆ¶è½‰å‹ç‚º any ä»¥è§£æ±º TypeScript å° null çš„åš´æ ¼æª¢æŸ¥
      user.tradeCategory = null as any;
    }

    if (createUserDto.dealerProfile) {
      const profile = new DealerProfile();
      Object.assign(profile, createUserDto.dealerProfile);
      profile.level = DealerLevel.C; 
      profile.isVerified = false;
      profile.walletBalance = 0;
      profile.isUpgradeable = false; 
      
      user.dealerProfile = profile;
    }

    try {
      user.isActive = false;
      return await this.usersRepository.save(user);
    } catch (error: any) {
      console.error('Registration Error:', error);
      if (error.code === '23505') { 
        throw new ConflictException('è³‡æ–™é‡è¤‡ (Email æˆ–çµ±ç·¨å·²å­˜åœ¨)');
      }
      throw new InternalServerErrorException('è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  }

  // 2. æŸ¥è©¢æ‰€æœ‰ç”¨æˆ¶
  async findAll() {
    return this.usersRepository.find({
      relations: ['tradeCategory', 'dealerProfile'],
    });
  }

  // 3. æŸ¥è©¢å–®ä¸€ç”¨æˆ¶
  async findOne(id: string) {
    const user = await this.usersRepository.findOne({
      where: { id },
      relations: ['tradeCategory', 'dealerProfile'],
    });
    if (!user) throw new NotFoundException(`æ‰¾ä¸åˆ°ç”¨æˆ¶ #${id}`);
    return user;
  }

  // 4. é€é Email æŸ¥è©¢
  async findByEmail(email: string) {
    return this.usersRepository.findOne({
      where: { email },
      relations: ['tradeCategory', 'dealerProfile'],
    });
  }

  // 5. æ›´æ–°åŸºæœ¬è³‡æ–™ (ç®¡ç†å“¡ç”¨)
  async update(id: string, updateUserDto: UpdateUserDto) {
    await this.usersRepository.update(id, {
      isActive: updateUserDto.isActive,
      role: updateUserDto.role,
    });
    return this.findOne(id);
  }

  // 6. åˆªé™¤ç”¨æˆ¶
  async remove(id: string) {
    const user = await this.findOne(id);
    return this.usersRepository.remove(user);
  }

  // 7. åˆ‡æ›å•Ÿç”¨ç‹€æ…‹
  async toggleActive(id: string, isActive: boolean) {
    const user = await this.findOne(id);
    user.isActive = isActive;
    return this.usersRepository.save(user);
  }

  // 8. æ›´æ–°æœƒå“¡ç­‰ç´š
  async updateLevel(id: string, level: DealerLevel) {
    const user = await this.findOne(id);
    if (user.dealerProfile) {
      user.dealerProfile.level = level;
      await this.dealerProfileRepository.save(user.dealerProfile); 
    }
    return this.usersRepository.save(user); 
  }

  // 9. éŒ¢åŒ…å„²å€¼ (å¼•ç”¨ Hardcoded Rules)
  async deposit(id: string, amount: number) {
    const user = await this.findOne(id);
    if (!user.dealerProfile) {
      throw new NotFoundException('æ­¤ç”¨æˆ¶æ²’æœ‰ç¶“éŠ·å•†æª”æ¡ˆï¼Œç„¡æ³•å„²å€¼');
    }
    
    const currentBalance = Number(user.dealerProfile.walletBalance || 0);
    const addAmount = Number(amount);
    const newBalance = currentBalance + addAmount;
    
    // å–å¾—è©²ç­‰ç´šçš„ä¸Šé™
    const limit = DEALER_LIMITS[user.dealerProfile.level] || 0;

    // æª¢æŸ¥ C ç´š
    if (user.dealerProfile.level === DealerLevel.C) {
      throw new ConflictException('C ç´šæœƒå“¡ä¸å¯é€²è¡Œå„²å€¼');
    }

    // æª¢æŸ¥å–®ç­†ä¸Šé™
    if (addAmount > limit) {
        throw new ConflictException(`å–®ç­†å„²å€¼é‡‘é¡è¶…é ${user.dealerProfile.level} ç´šä¸Šé™ (${limit})`);
    }
    
    user.dealerProfile.walletBalance = newBalance;
    
    await this.dealerProfileRepository.save(user.dealerProfile);
    return user;
  }

  // 10. å‡ç´šç‚ºç®¡ç†å“¡
  async makeAdmin(email: string) {
    const user = await this.findByEmail(email);
    if (!user) {
      throw new NotFoundException(`æ‰¾ä¸åˆ°ç”¨æˆ¶: ${email}`);
    }
    
    user.role = UserRole.ADMIN; 
    return this.usersRepository.save(user);
  }

  // 11. æ›´æ–°å€‹äººè³‡æ–™é‚è¼¯
  async updateProfile(userId: string, data: any) {
    const user = await this.findOne(userId);
    
    // 1. æ›´æ–°åŸºæœ¬è³‡æ–™
    if (data.name) user.name = data.name;
    
    // 2. æ›´æ–°å¯†ç¢¼ (å¦‚æœæœ‰å¡«)
    if (data.password) {
      const salt = await bcrypt.genSalt();
      user.password = await bcrypt.hash(data.password, salt);
    }

    // 3. æ›´æ–°ç¶“éŠ·å•†è³‡æ–™ (DealerProfile)
    if (data.dealerProfile && user.dealerProfile) {
      if (data.dealerProfile.companyName) user.dealerProfile.companyName = data.dealerProfile.companyName;
      if (data.dealerProfile.taxId) user.dealerProfile.taxId = data.dealerProfile.taxId;
      if (data.dealerProfile.contactPerson) user.dealerProfile.contactPerson = data.dealerProfile.contactPerson;
      if (data.dealerProfile.phone) user.dealerProfile.phone = data.dealerProfile.phone;
      if (data.dealerProfile.address) user.dealerProfile.address = data.dealerProfile.address;
      
      // å„²å­˜é—œè¯è³‡æ–™
      await this.dealerProfileRepository.save(user.dealerProfile);
    }

    // å„²å­˜ User æœ¬é«”
    const savedUser = await this.usersRepository.save(user);

    // 4. ç™¼é€ Line é€šçŸ¥çµ¦ç®¡ç†å“¡
    try {
      const dealerName = savedUser.dealerProfile?.companyName || savedUser.email;
      const msg = `ğŸ”” æœƒå“¡è³‡æ–™è®Šæ›´é€šçŸ¥\nå®¢æˆ¶ï¼š${dealerName}\nç‹€æ…‹ï¼šå·²åœ¨å¾Œå°è‡ªè¡Œæ›´æ–°è³‡æ–™ï¼Œè«‹ç¢ºèªã€‚`;
      this.notificationsService.sendLineNotify(msg).catch(err => console.log('Line é€šçŸ¥ç•¥é (é–‹ç™¼æ¨¡å¼)'));
    } catch (e) {
      console.error('ç™¼é€é€šçŸ¥å¤±æ•—', e);
    }

    return savedUser;
  }
}
</file>

<file path="admin/src/lib/api.ts">
import axios from 'axios';

// âœ¨ è¨­å®šï¼šå¼·åˆ¶æŒ‡å‘æœ¬æ©Ÿå¾Œç«¯ (é–‹ç™¼æ™‚) æˆ–ç·šä¸Šç‰ˆ (éƒ¨ç½²æ™‚)
const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:4000';

// --- TypeScript ä»‹é¢å®šç¾©å€ ---

export interface OrderItem {
  id: string;
  product: { 
    name: string; 
    images?: string[]; 
    imageUrl?: string; 
  };
  serviceType: string;
  widthMatrix: { top: number; mid: number; bot: number };
  heightData: any;
  isCeilingMounted: boolean;
  siteConditions?: any;
  colorName: string;
  materialName: string;
  
  // âœ¨âœ¨âœ¨ è£œä¸Šé€™äº›ç¼ºå°‘çš„æ¬„ä½ âœ¨âœ¨âœ¨
  handleName?: string; // æŠŠæ‰‹
  openingDirection: string;
  hasThreshold: boolean;
  
  quantity: number;
  subtotal: number;
  priceSnapshot?: any;
}

export enum OrderStatus {
  PENDING = 'pending',       
  PROCESSING = 'processing', 
  SHIPPED = 'shipped',       
  COMPLETED = 'completed',   
  CANCELLED = 'cancelled',   
}

export interface Order {
  id: string;
  orderNumber: string;
  status: OrderStatus | string;
  totalAmount: number;
  createdAt: string;
  projectName: string;
  
  // âœ¨âœ¨âœ¨ è£œä¸Šæ”¶è²¨èˆ‡é™„ä»¶æ¬„ä½ âœ¨âœ¨âœ¨
  shippingAddress?: string;
  siteContactPerson?: string;
  siteContactPhone?: string;
  attachments?: string[];

  user: {
    id: string;
    email: string;
    name: string;
    dealerProfile?: {
      companyName: string;
      contactPerson: string;
      phone: string;
      address: string;
    };
  };
  items: OrderItem[]; 
  adminNote?: string;
  customerNote?: string;
}

// --- Axios å¯¦ä¾‹è¨­å®š ---

const axiosInstance = axios.create({
  baseURL: API_URL,
  headers: {
    'Content-Type': 'application/json',
  },
});

axiosInstance.interceptors.request.use((config) => {
  if (typeof window !== 'undefined') {
    const token = localStorage.getItem('somalink_admin_token');
    
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
  }
  return config;
});

// --- API æ–¹æ³•å°å‡º ---

export const api = {
  get: async (url: string) => {
    const response = await axiosInstance.get(url);
    return response.data;
  },
  post: async (url: string, data: any) => {
    const response = await axiosInstance.post(url, data);
    return response.data;
  },
  patch: async (url: string, data: any) => {
    const response = await axiosInstance.patch(url, data);
    return response.data;
  },
  delete: async (url: string) => {
    const response = await axiosInstance.delete(url);
    return response.data;
  },
  
  // åœ–ç‰‡ä¸Šå‚³
  uploadImage: async (file: File) => {
    const formData = new FormData();
    formData.append('file', file);
    // å»ºè­°å°‡æ­¤å­—ä¸²ç§»è‡³ .envï¼Œç›®å‰å…ˆä¿ç•™å¯«æ­»ä»¥åˆ©æ¸¬è©¦
    formData.append('upload_preset', 'yasou70731'); 
    
    const res = await axios.post(
      'https://api.cloudinary.com/v1_1/dnibj8za6/image/upload', 
      formData
    );
    return res.data.secure_url;
  }
};
</file>

<file path="backend/src/auth/auth.service.ts">
import { Injectable, UnauthorizedException, NotFoundException, BadRequestException } from '@nestjs/common';
import { JwtService } from '@nestjs/jwt';
import { UsersService } from '../users/users.service';
import { LogsService } from '../logs/logs.service';
import * as bcrypt from 'bcrypt';

@Injectable()
export class AuthService {
  constructor(
    private usersService: UsersService,
    private jwtService: JwtService,
    private logsService: LogsService,
  ) {}

  async validateUser(email: string, pass: string): Promise<any> {
    const user = await this.usersService.findByEmail(email);
    if (!user || !user.password) return null;
    const isMatch = await bcrypt.compare(pass, user.password);
    if (isMatch) {
      const { password, ...result } = user;
      return result;
    }
    return null;
  }

  async login(user: any, ip: string = 'unknown', userAgent: string = 'unknown') {
    const payload = { email: user.email, sub: user.id, role: user.role };
    this.logsService.logLogin(user, ip, userAgent).catch(err => console.error('Log failed', err));

    const safeUser = {
      id: user.id,
      email: user.email,
      name: user.name,
      role: user.role,
      isActive: user.isActive,
      dealerProfile: user.dealerProfile 
    };

    return {
      access_token: this.jwtService.sign(payload),
      user: safeUser,
    };
  }

  // âœ¨âœ¨âœ¨ 1. ç”³è«‹é‡è¨­å¯†ç¢¼ âœ¨âœ¨âœ¨
  async forgotPassword(email: string) {
    const user = await this.usersService.findByEmail(email);
    if (!user) {
      // ç‚ºäº†å®‰å…¨ï¼Œå³ä½¿ Email ä¸å­˜åœ¨ä¹Ÿä¸è¦å ±éŒ¯ï¼Œä»¥å…è¢«æš´åŠ›æšèˆ‰å¸³è™Ÿ
      // ä½†ç‚ºäº†é–‹ç™¼æ–¹ä¾¿ï¼Œæˆ‘å€‘é‚„æ˜¯ log ä¸€ä¸‹
      console.log(`[Auth] å˜—è©¦é‡è¨­ä¸å­˜åœ¨çš„ Email: ${email}`);
      return { message: 'è‹¥ Email å­˜åœ¨ï¼Œé‡è¨­ä¿¡ä»¶å·²ç™¼é€' };
    }

    // ç”¢ç”Ÿé‡è¨­å°ˆç”¨ Token (æ•ˆæœŸ 1 å°æ™‚)
    const resetToken = this.jwtService.sign(
      { sub: user.id, type: 'reset_password' }, 
      { expiresIn: '1h' }
    );

    // ç”¢ç”Ÿå‰ç«¯é‡è¨­é€£çµ (å‡è¨­å‰ç«¯åœ¨ localhost:3000)
    // ä¸Šç·šæ™‚è«‹æ”¹ç‚ºçœŸå¯¦ç¶²åŸŸ
    const resetLink = `http://localhost:3000/reset-password?token=${resetToken}`;

    // æ¨¡æ“¬ç™¼ä¿¡ (åœ¨çµ‚ç«¯æ©Ÿé¡¯ç¤º)
    console.log('=================================================');
    console.log('ğŸ”‘ [æ¨¡æ“¬éƒµä»¶ä¸»æ©Ÿ] é‡è¨­å¯†ç¢¼ä¿¡ä»¶å·²æ””æˆª');
    console.log(`æ”¶ä»¶äºº: ${email}`);
    console.log(`é‡è¨­é€£çµ: ${resetLink}`);
    console.log('=================================================');

    return { message: 'é‡è¨­ä¿¡ä»¶å·²ç™¼é€' };
  }

  // âœ¨âœ¨âœ¨ 2. åŸ·è¡Œé‡è¨­å¯†ç¢¼ âœ¨âœ¨âœ¨
  async resetPassword(token: string, newPassword: string) {
    try {
      // é©—è­‰ Token
      const payload = this.jwtService.verify(token);
      
      if (payload.type !== 'reset_password') {
        throw new BadRequestException('ç„¡æ•ˆçš„é‡è¨­æ†‘è­‰');
      }

      const userId = payload.sub;
      
      // æ›´æ–°å¯†ç¢¼ (åˆ©ç”¨ UsersService ç¾æœ‰çš„ updateProfile åŠŸèƒ½)
      await this.usersService.updateProfile(userId, { password: newPassword });

      return { message: 'å¯†ç¢¼é‡è¨­æˆåŠŸï¼Œè«‹é‡æ–°ç™»å…¥' };

    } catch (error) {
      console.error(error);
      throw new BadRequestException('é‡è¨­é€£çµå·²éæœŸæˆ–ç„¡æ•ˆ');
    }
  }
}
</file>

<file path="admin/src/app/page.tsx">
'use client';

import { useEffect, useState, useCallback, useMemo } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link'; 
import { 
  LayoutDashboard, Bell, Search, Filter, 
  CheckCircle, Clock, Info, ChevronRight, FileSpreadsheet, Calendar, User, Truck, Hammer, CheckSquare, Square
} from 'lucide-react';
import clsx from 'clsx';
import * as XLSX from 'xlsx';
import { api, Order } from '@/lib/api';
import OrderDetailModal from '@/components/OrderDetailModal';

export default function AdminDashboard() {
  const router = useRouter();
  
  const [orders, setOrders] = useState<Order[]>([]);
  const [loading, setLoading] = useState(true);
  const [selectedOrder, setSelectedOrder] = useState<Order | null>(null);
  
  // âœ¨âœ¨âœ¨ æ–°å¢ï¼šå¤šé¸ç‹€æ…‹ âœ¨âœ¨âœ¨
  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());

  // ç¯©é¸ç‹€æ…‹
  const [searchTerm, setSearchTerm] = useState('');
  const [dealerFilter, setDealerFilter] = useState('');
  const [dateFilter, setDateFilter] = useState('');
  const [statusFilter, setStatusFilter] = useState('all');

  useEffect(() => {
    const token = localStorage.getItem('somalink_admin_token');
    if (!token) { router.push('/login'); }
  }, [router]);

  const fetchOrders = useCallback(async () => {
    try {
      setLoading(true);
      const res = await api.get('/orders');
      if (Array.isArray(res)) {
        setOrders(res);
      } else {
        setOrders([]); 
      }
    } catch (err) {
      console.error('ç„¡æ³•å–å¾—è¨‚å–®åˆ—è¡¨:', err);
      setOrders([]); 
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    if (typeof window !== 'undefined' && localStorage.getItem('somalink_admin_token')) {
      fetchOrders();
    }
  }, [fetchOrders]);

  // éæ¿¾é‚è¼¯
  const filteredOrders = useMemo(() => {
    return (orders || []).filter(order => {
      if (!order) return false;
      const matchesSearch = (order.orderNumber || '').toLowerCase().includes(searchTerm.toLowerCase()) || (order.projectName && order.projectName.toLowerCase().includes(searchTerm.toLowerCase()));
      const dealerName = order.user?.dealerProfile?.companyName || order.user?.name || '';
      const matchesDealer = dealerName.toLowerCase().includes(dealerFilter.toLowerCase());
      const orderDate = order.createdAt ? new Date(order.createdAt).toISOString().split('T')[0] : '';
      const matchesDate = dateFilter ? orderDate === dateFilter : true;
      const matchesStatus = statusFilter === 'all' ? true : order.status === statusFilter;
      return matchesSearch && matchesDealer && matchesDate && matchesStatus;
    });
  }, [orders, searchTerm, dealerFilter, dateFilter, statusFilter]);

  // âœ¨âœ¨âœ¨ å¤šé¸æ“ä½œé‚è¼¯ âœ¨âœ¨âœ¨
  const toggleSelectAll = () => {
    if (selectedIds.size === filteredOrders.length) {
      setSelectedIds(new Set()); // å–æ¶ˆå…¨é¸
    } else {
      setSelectedIds(new Set(filteredOrders.map(o => o.id))); // å…¨é¸ç›®å‰é é¢
    }
  };

  const toggleSelectOne = (id: string) => {
    const newSet = new Set(selectedIds);
    if (newSet.has(id)) newSet.delete(id);
    else newSet.add(id);
    setSelectedIds(newSet);
  };

  // âœ¨âœ¨âœ¨ 1. åŒ¯å‡ºï¼šä¸€èˆ¬è¨‚å–®ç¸½è¡¨ (è²¡å‹™å°å¸³ç”¨) âœ¨âœ¨âœ¨
  const handleExportOrders = () => {
    // åªåŒ¯å‡ºå‹¾é¸çš„ï¼Œè‹¥ç„¡å‹¾é¸å‰‡åŒ¯å‡ºç•¶å‰ç¯©é¸çµæœ
    const targetOrders = selectedIds.size > 0 
      ? filteredOrders.filter(o => selectedIds.has(o.id)) 
      : filteredOrders;

    const data = targetOrders.map(o => ({
      'è¨‚å–®ç·¨è™Ÿ': o.orderNumber,
      'ç‹€æ…‹': o.status,
      'æ—¥æœŸ': new Date(o.createdAt).toLocaleDateString(),
      'ç¶“éŠ·å•†': o.user?.dealerProfile?.companyName || o.user?.email,
      'æ¡ˆå ´': o.projectName,
      'ç¸½é‡‘é¡': Number(o.totalAmount),
      'å•†å“æ•¸': o.items?.length || 0
    }));

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "è¨‚å–®ç¸½è¡¨");
    XLSX.writeFile(wb, `SomaLink_Orders_${new Date().toISOString().slice(0,10)}.xlsx`);
  };

  // âœ¨âœ¨âœ¨ 2. åŒ¯å‡ºï¼šè©³ç´°ç”Ÿç”¢å·¥å–® (å·¥å» å‚™æ–™ç”¨) âœ¨âœ¨âœ¨
  const handleExportProduction = () => {
    const targetOrders = selectedIds.size > 0 
      ? filteredOrders.filter(o => selectedIds.has(o.id)) 
      : filteredOrders;

    // å°‡è³‡æ–™ã€Œæ”¤å¹³ã€ï¼šä¸€å¼µè¨‚å–®æœ‰å¤šå€‹å•†å“ï¼Œè®Šæˆå¤šè¡Œ
    const flatData: any[] = [];
    
    targetOrders.forEach(order => {
      order.items?.forEach((item, idx) => {
        flatData.push({
          'è¨‚å–®ç·¨è™Ÿ': order.orderNumber,
          'é …æ¬¡': idx + 1,
          'æ¡ˆå ´åç¨±': order.projectName,
          'ç”¢å“åç¨±': item.product?.name,
          'é¡è‰²': item.colorName,
          'æè³ª': item.materialName,
          'æŠŠæ‰‹': item.handleName || 'ç„¡', // æŠŠæ‰‹æ¬„ä½
          'é–‹å‘': item.openingDirection,
          'å¯¬ (W)': item.widthMatrix?.mid,
          'é«˜ (H)': item.heightData?.singleValue || item.heightData?.mid,
          'å°é ‚': item.isCeilingMounted ? 'æ˜¯' : 'å¦',
          'æ•¸é‡': item.quantity,
          'å‚™è¨»': order.customerNote || ''
        });
      });
    });

    const ws = XLSX.utils.json_to_sheet(flatData);
    
    // è¨­å®šæ¬„å¯¬ (ç¾åŒ–)
    const wscols = [
      {wch: 15}, {wch: 5}, {wch: 15}, {wch: 20}, {wch: 10}, 
      {wch: 10}, {wch: 10}, {wch: 10}, {wch: 8}, {wch: 8}, 
      {wch: 6}, {wch: 6}, {wch: 20}
    ];
    ws['!cols'] = wscols;

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "ç”Ÿç”¢å‚™æ–™å–®");
    XLSX.writeFile(wb, `Production_List_${new Date().toISOString().slice(0,10)}.xlsx`);
  };

  // âœ¨âœ¨âœ¨ 3. æ‰¹é‡æ›´æ–°ç‹€æ…‹ âœ¨âœ¨âœ¨
  const handleBatchStatus = async (status: string) => {
    if (selectedIds.size === 0) return alert('è«‹å…ˆå‹¾é¸è¨‚å–®');
    if (!confirm(`ç¢ºå®šè¦å°‡é¸ä¸­çš„ ${selectedIds.size} ç­†è¨‚å–®ç‹€æ…‹æ”¹ç‚ºã€Œ${status}ã€å—ï¼Ÿ`)) return;

    try {
      const promises = Array.from(selectedIds).map(id => 
        api.patch(`/orders/${id}`, { status })
      );
      await Promise.all(promises);
      alert('æ‰¹é‡æ›´æ–°æˆåŠŸï¼');
      setSelectedIds(new Set()); // æ¸…ç©ºå‹¾é¸
      fetchOrders();
    } catch (err) {
      alert('éƒ¨åˆ†æ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯');
    }
  };

  const statusMap: Record<string, any> = {
    pending: { label: 'å¾…å¯©æ ¸', color: 'bg-yellow-100 text-yellow-800', icon: Clock },
    processing: { label: 'ç”Ÿç”¢ä¸­', color: 'bg-blue-100 text-blue-800', icon: Hammer },
    shipped: { label: 'å·²å‡ºè²¨', color: 'bg-purple-100 text-purple-800', icon: Truck }, 
    completed: { label: 'å·²å®Œæˆ', color: 'bg-green-100 text-green-800', icon: CheckCircle },
    cancelled: { label: 'å·²å–æ¶ˆ', color: 'bg-gray-100 text-gray-600', icon: Info },
  };

  const getActionButton = (status: string) => {
    switch (status) {
      case 'pending': return { text: 'å¯©æ ¸', style: 'text-blue-600 hover:text-blue-800' };
      case 'processing': return { text: 'ç®¡ç†', style: 'text-purple-600 hover:text-purple-800' }; 
      case 'shipped': return { text: 'è¿½è¹¤', style: 'text-green-600 hover:text-green-800' };    
      default: return { text: 'è©³æƒ…', style: 'text-gray-500 hover:text-gray-700' };
    }
  };

  return (
    <main className="flex-1 flex flex-col min-w-0 overflow-hidden">
      
      <header className="bg-white shadow-sm border-b border-gray-200 h-16 flex items-center justify-between px-8 sticky top-0 z-10">
        <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
          <LayoutDashboard className="w-5 h-5 text-gray-500" />
          è¨‚å–®æˆ°æƒ…å®¤
        </h2>
        <div className="flex items-center gap-4">
          <Link href="/logs" className="p-2 text-gray-400 hover:bg-gray-100 rounded-full relative transition-colors" title="ç³»çµ±æ—¥èªŒ">
            <Bell className="w-5 h-5" />
            <span className="absolute top-1.5 right-1.5 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
          </Link>
        </div>
      </header>

      <div className="flex-1 overflow-y-auto p-8">
        
        {/* KPI å¡ç‰‡ (ä¿æŒä¸è®Š) */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <p className="text-sm text-gray-500 font-medium uppercase tracking-wider">ç¯©é¸çµæœç­†æ•¸</p>
            <div className="flex items-end justify-between mt-2">
              <p className="text-4xl font-bold text-gray-900">{filteredOrders.length}</p>
              <span className="text-xs text-gray-400 px-2 py-1">ç­†è¨‚å–®</span>
            </div>
          </div>
          <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <p className="text-sm text-gray-500 font-medium uppercase tracking-wider">å¾…å¯©æ ¸ (ç¯©é¸å…§)</p>
            <div className="flex items-end justify-between mt-2">
              <p className="text-4xl font-bold text-yellow-600">{filteredOrders.filter(o => o.status === 'pending').length}</p>
              <span className="text-xs text-yellow-700 bg-yellow-50 px-2 py-1 rounded font-medium">éœ€è™•ç†</span>
            </div>
          </div>
          <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <p className="text-sm text-gray-500 font-medium uppercase tracking-wider">ç´¯ç©é‡‘é¡ (ç¯©é¸å…§)</p>
            <div className="flex items-end justify-between mt-2">
              <p className="text-4xl font-bold text-blue-600">${filteredOrders.reduce((sum, o) => sum + Number(o.totalAmount), 0).toLocaleString()}</p>
            </div>
          </div>
        </div>

        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
          
          {/* å·¥å…·åˆ— (ç¯©é¸ + æ‰¹é‡æ“ä½œ) */}
          <div className="p-5 border-b border-gray-100 bg-gray-50/50 flex flex-wrap items-center gap-4">
            
            {/* ... åŸæœ¬çš„ç¯©é¸æ¬„ä½ ... */}
            <div className="relative w-48">
              <Search className="absolute left-3 top-2.5 w-4 h-4 text-gray-400" />
              <input type="text" placeholder="æœå°‹å–®è™Ÿã€æ¡ˆå..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" />
            </div>
            {/* ... (çœç•¥éƒ¨åˆ†ç¯©é¸æ¬„ä½ä»¥ç¯€çœç¯‡å¹…ï¼Œè«‹ä¿ç•™æ‚¨åŸæœ¬çš„ç¯©é¸å™¨) ... */}
            <select value={statusFilter} onChange={(e) => setStatusFilter(e.target.value)} className="w-40 px-3 py-2 border border-gray-300 rounded-lg text-sm outline-none bg-white text-gray-600 cursor-pointer">
              <option value="all">å…¨éƒ¨ç‹€æ…‹</option>
              <option value="pending">å¾…å¯©æ ¸</option>
              <option value="processing">ç”Ÿç”¢ä¸­</option>
              <option value="shipped">å·²å‡ºè²¨</option>
            </select>

            <div className="ml-auto flex items-center gap-2">
              {/* âœ¨âœ¨âœ¨ æ‰¹é‡æ“ä½œæŒ‰éˆ• âœ¨âœ¨âœ¨ */}
              {selectedIds.size > 0 && (
                <div className="flex items-center gap-2 mr-4 animate-in fade-in">
                  <span className="text-sm text-gray-500 font-bold">å·²é¸ {selectedIds.size} ç­†ï¼š</span>
                  <button onClick={() => handleBatchStatus('processing')} className="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-xs font-bold hover:bg-blue-200 transition-colors">æ‰¹é‡å¯©æ ¸</button>
                  <button onClick={() => handleBatchStatus('shipped')} className="px-3 py-1.5 bg-purple-100 text-purple-700 rounded-lg text-xs font-bold hover:bg-purple-200 transition-colors">æ‰¹é‡å‡ºè²¨</button>
                </div>
              )}

              {/* åŒ¯å‡ºæŒ‰éˆ•çµ„ */}
              <div className="flex gap-2 border-l pl-4 border-gray-300">
                <button 
                  onClick={handleExportOrders}
                  className="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg text-sm font-bold hover:bg-gray-50 shadow-sm transition-all"
                >
                  <FileSpreadsheet className="w-4 h-4" /> åŒ¯å‡ºå°å¸³å–®
                </button>
                <button 
                  onClick={handleExportProduction}
                  className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-bold hover:bg-green-700 shadow-sm transition-all"
                >
                  <Hammer className="w-4 h-4" /> åŒ¯å‡ºç”Ÿç”¢å·¥å–®
                </button>
              </div>
            </div>
          </div>

          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  {/* âœ¨ å…¨é¸ Checkbox */}
                  <th className="px-6 py-3 w-10">
                    <button onClick={toggleSelectAll} className="text-gray-400 hover:text-blue-600">
                      {selectedIds.size > 0 && selectedIds.size === filteredOrders.length 
                        ? <CheckSquare className="w-5 h-5 text-blue-600" /> 
                        : <Square className="w-5 h-5" />}
                    </button>
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">å–®è™Ÿ / æ¡ˆå ´</th>
                  <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">ç¶“éŠ·å•†</th>
                  <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">ç”¢å“æ¦‚è¦</th>
                  <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">é‡‘é¡</th>
                  <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">æ—¥æœŸ</th>
                  <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">ç‹€æ…‹</th>
                  <th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">å‹•ä½œ</th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {loading ? (
                  <tr><td colSpan={8} className="text-center py-12 text-gray-500">è³‡æ–™è¼‰å…¥ä¸­...</td></tr>
                ) : filteredOrders.length === 0 ? (
                  <tr><td colSpan={8} className="text-center py-12 text-gray-500">æŸ¥ç„¡ç¬¦åˆæ¢ä»¶çš„è¨‚å–®</td></tr>
                ) : (
                  filteredOrders.map((order) => {
                    const status = statusMap[order.status as string] || { label: order.status, color: 'bg-gray-100', icon: Info };
                    const StatusIcon = status.icon;
                    const action = getActionButton(order.status as string); 
                    const firstItem = order.items?.[0];
                    const isSelected = selectedIds.has(order.id);

                    return (
                      <tr key={order.id} className={clsx("transition-colors group", isSelected ? "bg-blue-50" : "hover:bg-gray-50")}>
                        {/* âœ¨ å–®é¸ Checkbox */}
                        <td className="px-6 py-4">
                          <button onClick={() => toggleSelectOne(order.id)} className="text-gray-400 hover:text-blue-600">
                            {isSelected ? <CheckSquare className="w-5 h-5 text-blue-600" /> : <Square className="w-5 h-5" />}
                          </button>
                        </td>

                        <td className="px-6 py-4">
                          <div className="flex flex-col">
                            <span className="text-sm font-bold text-gray-900 group-hover:text-blue-600">{order.orderNumber}</span>
                            <span className="text-xs text-gray-500 mt-0.5">{order.projectName || 'æœªå‘½åæ¡ˆå ´'}</span>
                          </div>
                        </td>
                        <td className="px-6 py-4">
                          <div className="flex flex-col">
                            <span className="text-sm text-gray-900 font-medium">{order.user?.dealerProfile?.companyName || 'æœªçŸ¥'}</span>
                          </div>
                        </td>
                        <td className="px-6 py-4 text-sm text-gray-600">
                           {firstItem?.product?.name || 'ç„¡å•†å“'} 
                           {order.items.length > 1 && <span className="text-xs text-gray-400 ml-1">+{order.items.length - 1}</span>}
                        </td>
                        <td className="px-6 py-4 text-sm font-bold text-blue-600">${Number(order.totalAmount).toLocaleString()}</td>
                        <td className="px-6 py-4 text-xs text-gray-500">{new Date(order.createdAt).toLocaleDateString()}</td>
                        <td className="px-6 py-4">
                          <span className={clsx("px-2.5 py-1 rounded-full text-xs font-bold flex items-center w-fit gap-1.5 border", status.color, "border-transparent")}>
                            <StatusIcon className="w-3.5 h-3.5" />
                            {status.label}
                          </span>
                        </td>
                        <td className="px-6 py-4 text-right">
                          <button 
                            onClick={() => setSelectedOrder(order)} 
                            className={clsx("font-medium text-sm flex items-center justify-end gap-1 transition-colors", action.style)}
                          >
                            {action.text} <ChevronRight className="w-4 h-4" />
                          </button>
                        </td>
                      </tr>
                    );
                  })
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <OrderDetailModal 
        order={selectedOrder}
        isOpen={!!selectedOrder}
        onClose={() => setSelectedOrder(null)}
        onStatusUpdate={fetchOrders} 
      />
    </main>
  );
}
</file>

</files>
