This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
admin/.gitignore
admin/eslint.config.mjs
admin/next.config.ts
admin/package.json
admin/postcss.config.mjs
admin/public/file.svg
admin/public/globe.svg
admin/public/next.svg
admin/public/vercel.svg
admin/public/window.svg
admin/README.md
admin/src/app/favicon.ico
admin/src/app/globals.css
admin/src/app/layout.tsx
admin/src/app/login/page.tsx
admin/src/app/orders/[id]/print/page.tsx
admin/src/app/page.tsx
admin/src/app/products/[id]/page.tsx
admin/src/app/products/new/page.tsx
admin/src/app/products/page.tsx
admin/src/app/reports/page.tsx
admin/src/app/series/page.tsx
admin/src/app/settings/page.tsx
admin/src/app/users/page.tsx
admin/src/components/LayoutShell.tsx
admin/src/components/OrderDetailModal.tsx
admin/src/components/Sidebar.tsx
admin/src/lib/api.ts
admin/tsconfig.json
backend/.gitignore
backend/.prettierrc
backend/eslint.config.mjs
backend/nest-cli.json
backend/package.json
backend/README.md
backend/src/announcements/announcements.controller.ts
backend/src/announcements/announcements.module.ts
backend/src/announcements/announcements.service.ts
backend/src/announcements/dto/create-announcement.dto.ts
backend/src/announcements/dto/update-announcement.dto.ts
backend/src/announcements/entities/announcement.entity.ts
backend/src/app.controller.spec.ts
backend/src/app.controller.ts
backend/src/app.module.ts
backend/src/app.service.ts
backend/src/auth/auth.controller.ts
backend/src/auth/auth.module.ts
backend/src/auth/auth.service.ts
backend/src/auth/dto/create-auth.dto.ts
backend/src/auth/dto/update-auth.dto.ts
backend/src/auth/entities/auth.entity.ts
backend/src/auth/jwt-auth.guard.ts
backend/src/auth/jwt.strategy.ts
backend/src/cart/cart.controller.ts
backend/src/cart/cart.module.ts
backend/src/cart/cart.service.ts
backend/src/cart/entities/cart-item.entity.ts
backend/src/main.ts
backend/src/notifications/notifications.module.ts
backend/src/notifications/notifications.service.spec.ts
backend/src/notifications/notifications.service.ts
backend/src/orders/dto/create-order.dto.ts
backend/src/orders/dto/update-order.dto.ts
backend/src/orders/entities/order-item.entity.ts
backend/src/orders/entities/order.entity.ts
backend/src/orders/orders.controller.ts
backend/src/orders/orders.module.ts
backend/src/orders/orders.service.ts
backend/src/products/dto/create-product.dto.ts
backend/src/products/dto/update-product.dto.ts
backend/src/products/entities/product.entity.ts
backend/src/products/products.controller.ts
backend/src/products/products.module.ts
backend/src/products/products.service.ts
backend/src/reports/dto/create-report.dto.ts
backend/src/reports/dto/update-report.dto.ts
backend/src/reports/entities/report.entity.ts
backend/src/reports/reports.controller.ts
backend/src/reports/reports.module.ts
backend/src/reports/reports.service.ts
backend/src/series/dto/create-series.dto.ts
backend/src/series/dto/update-series.dto.ts
backend/src/series/entities/series.entity.ts
backend/src/series/series.controller.ts
backend/src/series/series.module.ts
backend/src/series/series.service.ts
backend/src/site-config/entities/site-config.entity.ts
backend/src/site-config/site-config.controller.ts
backend/src/site-config/site-config.module.ts
backend/src/site-config/site-config.service.ts
backend/src/users/dto/create-user.dto.ts
backend/src/users/dto/update-user.dto.ts
backend/src/users/entities/dealer-profile.entity.ts
backend/src/users/entities/trade-category.entity.ts
backend/src/users/entities/user.entity.ts
backend/src/users/trade-categories.controller.ts
backend/src/users/users.controller.ts
backend/src/users/users.module.ts
backend/src/users/users.service.ts
backend/test/app.e2e-spec.ts
backend/test/jest-e2e.json
backend/tsconfig.build.json
backend/tsconfig.json
frontend/.gitignore
frontend/eslint.config.mjs
frontend/forgot-password/page.tsx
frontend/next.config.ts
frontend/package.json
frontend/postcss.config.mjs
frontend/public/file.svg
frontend/public/globe.svg
frontend/public/next.svg
frontend/public/vercel.svg
frontend/public/window.svg
frontend/README.md
frontend/src/app/cart/page.tsx
frontend/src/app/favicon.ico
frontend/src/app/globals.css
frontend/src/app/layout.tsx
frontend/src/app/login/page.tsx
frontend/src/app/login/register/page.tsx
frontend/src/app/orders/[id]/print/page.tsx
frontend/src/app/orders/page.tsx
frontend/src/app/page.tsx
frontend/src/app/portal/page.tsx
frontend/src/app/product/[id]/page.tsx
frontend/src/app/profile/page.tsx
frontend/src/app/register/page.tsx
frontend/src/app/series/[name]/page.tsx
frontend/src/components/blocks/FeaturesBlock.tsx
frontend/src/components/blocks/HeroBlock.tsx
frontend/src/components/blocks/ProductListBlock.tsx
frontend/src/components/MeasurementModal.tsx
frontend/src/components/Modal.tsx
frontend/src/components/Navbar.tsx
frontend/src/context/CartContext.tsx
frontend/src/lib/api.ts
frontend/tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="backend/src/cart/cart.controller.ts">
import { Controller, Get, Post, Delete, Body, Param, UseGuards, Request } from '@nestjs/common';
import { CartService } from './cart.service';
import { JwtAuthGuard } from '../auth/jwt-auth.guard';

@Controller('cart')
@UseGuards(JwtAuthGuard) // ✨ 保護：只有登入才能用購物車 API
export class CartController {
  constructor(private readonly cartService: CartService) {}

  @Get()
  getCart(@Request() req) {
    return this.cartService.getCart(req.user);
  }

  @Post()
  addToCart(@Request() req, @Body() body: any) {
    return this.cartService.addToCart(req.user, body);
  }

  @Delete(':id')
  removeItem(@Request() req, @Param('id') id: string) {
    return this.cartService.removeItem(req.user, id);
  }

  @Delete()
  clearCart(@Request() req) {
    return this.cartService.clearCart(req.user);
  }
}
</file>

<file path="backend/src/cart/cart.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { CartService } from './cart.service';
import { CartController } from './cart.controller';
import { CartItem } from './entities/cart-item.entity';

@Module({
  imports: [TypeOrmModule.forFeature([CartItem])],
  controllers: [CartController],
  providers: [CartService],
  exports: [CartService] // We export CartService so other modules can use it if needed
})
export class CartModule {}
</file>

<file path="backend/src/cart/cart.service.ts">
import { Injectable, NotFoundException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { CartItem } from './entities/cart-item.entity';
import { User } from '../users/entities/user.entity';

@Injectable()
export class CartService {
  constructor(
    @InjectRepository(CartItem)
    private cartRepository: Repository<CartItem>,
  ) {}

  // 取得使用者的購物車
  async getCart(user: User) {
    return this.cartRepository.find({
      where: { user: { id: user.id } },
      relations: ['product'],
      order: { createdAt: 'DESC' }
    });
  }

  // 加入購物車
  async addToCart(user: User, itemDto: any) {
    // 這裡簡化處理：每次加入都算新的一筆 (因為客製化規格太複雜，很難比對是否完全相同)
    const cartItem = this.cartRepository.create({
      ...itemDto,
      user: user,
      product: { id: itemDto.productId } // 關聯產品
    });
    return this.cartRepository.save(cartItem);
  }

  // 移除單一項目
  async removeItem(user: User, id: string) {
    const item = await this.cartRepository.findOne({ where: { id, user: { id: user.id } } });
    if (!item) throw new NotFoundException('找不到該項目');
    return this.cartRepository.remove(item);
  }

  // 清空購物車 (結帳後使用)
  async clearCart(user: User) {
    const items = await this.cartRepository.find({ where: { user: { id: user.id } } });
    return this.cartRepository.remove(items);
  }
}
</file>

<file path="backend/src/cart/entities/cart-item.entity.ts">
import { Entity, Column, PrimaryGeneratedColumn, ManyToOne, CreateDateColumn, UpdateDateColumn } from 'typeorm';
import { User } from '../../users/entities/user.entity';
import { Product } from '../../products/entities/product.entity';

export enum ServiceType {
  MATERIAL = 'material',   
  ASSEMBLED = 'assembled', 
}

@Entity()
export class CartItem {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  // 關聯到使用者 (這是關鍵，讓購物車跟著人走)
  @ManyToOne(() => User, (user) => user.cartItems, { onDelete: 'CASCADE' })
  user: User;

  @ManyToOne(() => Product, { eager: true })
  product: Product;

  @Column({
    type: 'enum',
    enum: ServiceType,
    default: ServiceType.ASSEMBLED
  })
  serviceType: ServiceType;
  
  @Column({ type: 'jsonb' })
  widthMatrix: { top: number; mid: number; bot: number };

  @Column({ type: 'jsonb' })
  heightData: any; 

  @Column({ default: true })
  isCeilingMounted: boolean; 

  @Column({ type: 'jsonb', nullable: true })
  siteConditions: any;

  @Column()
  colorName: string;

  @Column()
  materialName: string;

  // 把手名稱 (與 OrderItem 一致)
  @Column({ nullable: true })
  handleName: string;

  @Column()
  openingDirection: string;

  @Column({ default: false })
  hasThreshold: boolean;

  @Column({ type: 'int', default: 1 })
  quantity: number;

  // 這裡儲存的是「加入購物車當下」的試算金額
  @Column({ type: 'decimal', precision: 12, scale: 2 })
  subtotal: number; 

  // 詳細價格快照 (與 OrderItem 結構保持一致，方便對帳)
  @Column({ type: 'jsonb' })
  priceSnapshot: {
    basePrice: number;
    sizeSurcharge: number;
    colorSurcharge: number;
    materialSurcharge: number;
    handleSurcharge: number;
    assemblyFee: number;
    thresholdFee: number;
  };

  @CreateDateColumn()
  createdAt: Date;

  @UpdateDateColumn()
  updatedAt: Date;
}
</file>

<file path="backend/src/site-config/entities/site-config.entity.ts">
import { Entity, Column, PrimaryColumn, UpdateDateColumn } from 'typeorm';

// 定義積木的結構 (給 TypeScript 看的)
export interface SiteBlock {
  id: string;       // 唯一 ID (用來排序和刪除)
  type: 'HERO' | 'FEATURES' | 'PRODUCT_LIST' | 'TEXT_BANNER'; // 積木類型
  data: any;        // 積木內容 (每種積木不一樣)
}

@Entity()
export class SiteConfig {
  // 我們固定用 'homepage' 或 'system_rules' 當作 ID
  @PrimaryColumn()
  key: string;

  // 用於首頁積木
  @Column({ type: 'jsonb', nullable: true })
  blocks: SiteBlock[];

  // ✨✨✨ 關鍵修正：補上 settings 欄位 ✨✨✨
  // 這樣 Service 才能存取 system_rules 的設定值
  @Column({ type: 'jsonb', nullable: true })
  settings: any;

  @UpdateDateColumn()
  updatedAt: Date;
}
</file>

<file path="backend/src/site-config/site-config.controller.ts">
import { Controller, Get, Patch, Body } from '@nestjs/common';
import { SiteConfigService } from './site-config.service';

@Controller('site-config')
export class SiteConfigController {
  constructor(private readonly service: SiteConfigService) {}

  // --- 首頁配置 ---
  @Get('homepage')
  getHomepage() {
    return this.service.getHomepageConfig();
  }

  @Patch('homepage')
  updateHomepage(@Body() body: any) {
    return this.service.updateHomepageConfig(body);
  }

  // --- ✨✨✨ 新增：系統規則接口 (解決 404 錯誤) ✨✨✨ ---
  @Get('rules')
  getSystemRules() {
    return this.service.getSystemRules();
  }

  @Patch('rules')
  updateSystemRules(@Body() body: any) {
    return this.service.updateSystemRules(body); // 注意：前端傳來的 body 應該是 settings 物件
  }
}
</file>

<file path="backend/src/site-config/site-config.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { SiteConfigService } from './site-config.service';
import { SiteConfigController } from './site-config.controller';
import { SiteConfig } from './entities/site-config.entity';

@Module({
  imports: [TypeOrmModule.forFeature([SiteConfig])],
  controllers: [SiteConfigController],
  providers: [SiteConfigService],
  exports: [SiteConfigService]
})
export class SiteConfigModule {}
</file>

<file path="backend/src/site-config/site-config.service.ts">
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { SiteConfig, SiteBlock } from './entities/site-config.entity';
import { randomUUID } from 'crypto'; 

@Injectable()
export class SiteConfigService {
  constructor(
    @InjectRepository(SiteConfig)
    private repo: Repository<SiteConfig>,
  ) {}

  // --- 首頁配置 (Homepage Config) ---
  
  // 取得設定 (如果沒有就建立預設值)
  async getHomepageConfig() {
    let config = await this.repo.findOneBy({ key: 'homepage' });
    
    // 如果沒有設定，初始化預設積木
    if (!config) {
      const defaultBlocks: SiteBlock[] = [
        // 1. Hero 主視覺區塊
        {
          id: randomUUID(),
          type: 'HERO',
          data: {
            title: '極致工藝，\n定義空間新維度。',
            subtitle: '專為室內設計師與專業經銷商打造的 B2B 數位工廠。',
            images: ["https://images.unsplash.com/photo-1600607686527-6fb886090705?auto=format&fit=crop&q=80&w=2000"]
          }
        },
        // 2. 特色介紹區塊
        {
          id: randomUUID(),
          type: 'FEATURES',
          data: {
            title: '為什麼選擇松成？',
            items: [
              { title: '六點矩陣丈量', desc: '獨家開發數位丈量系統，確保安裝完美貼合。' },
              { title: '連工帶料 / 純料', desc: '彈性的服務模式，滿足不同工班需求。' },
              { title: '全數位化履歷', desc: '全程透明化追蹤，讓您對業主更有交代。' }
            ]
          }
        },
        // 3. 產品列表區塊
        {
          id: randomUUID(),
          type: 'PRODUCT_LIST',
          data: {
            title: '熱門產品系列',
            count: 4
          }
        }
      ];

      config = this.repo.create({
        key: 'homepage',
        blocks: defaultBlocks
      });
      await this.repo.save(config);
    }
    return config;
  }

  // 更新首頁設定
  async updateHomepageConfig(data: Partial<SiteConfig>) {
    // 移除 key 避免被覆寫，確保 key 永遠是 'homepage'
    const { key, ...updateData } = data;
    
    // 確保資料庫有資料 (如果沒有會先建立預設值)
    await this.getHomepageConfig();
    
    await this.repo.update('homepage', updateData);
    return this.repo.findOneBy({ key: 'homepage' });
  }

  // --- 系統規則 (System Rules) ---
  
  async getSystemRules() {
    let config = await this.repo.findOneBy({ key: 'system_rules' });
    
    // 如果還沒有規則，建立預設值
    if (!config) {
      config = this.repo.create({
        key: 'system_rules',
        // 這裡依賴 Entity 中的 settings 欄位 (JSONB)
        settings: {
          // 1. 營運開關
          enable_registration: true, // 是否開放註冊
          maintenance_mode: false,   // 是否維護中
          allow_guest_view: true,    // 是否允許訪客瀏覽

          // 2. 會員價格策略
          discount_level_A: 0.85,    // A 級 85 折
          discount_level_B: 0.95,    // B 級 95 折

          // 3. 訂單流水號重置日 (每月幾號)
          order_reset_day: 1,

          // 4. 公司基本資料 (Footer 顯示用)
          company_name: '松成有限公司',
          tax_id: '12345678',
          phone: '(02) 2345-6789',
          address: '新北市三重區... (範例地址)',
          copyright_text: '© 2025 SomaLink. All rights reserved.'
        }
      });
      await this.repo.save(config);
    }
    return config;
  }

  // 更新系統規則
  async updateSystemRules(settings: any) {
    // 確保有資料
    await this.getSystemRules();
    
    // 更新 settings JSON 欄位
    await this.repo.update('system_rules', { settings });
    return this.repo.findOneBy({ key: 'system_rules' });
  }
}
</file>

<file path="frontend/forgot-password/page.tsx">
'use client';

import { useState } from 'react';
import { ArrowLeft, Mail, Send } from 'lucide-react';
import Link from 'next/link';

export default function ForgotPasswordPage() {
  const [email, setEmail] = useState('');
  const [isSubmitted, setIsSubmitted] = useState(false);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    // 這裡未來可以接後端 API 發送重設信
    // 目前先模擬成功
    setIsSubmitted(true);
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 px-4">
      <div className="max-w-md w-full bg-white p-8 rounded-2xl shadow-lg border border-gray-100">
        
        {/* Header */}
        <div className="text-center mb-8">
          <div className="mx-auto h-12 w-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 mb-4">
            <Mail className="h-6 w-6" />
          </div>
          <h2 className="text-2xl font-bold text-gray-900">忘記密碼</h2>
          <p className="mt-2 text-sm text-gray-500">
            請輸入您註冊的 Email，我們將協助您重設密碼。
          </p>
        </div>

        {isSubmitted ? (
          <div className="text-center space-y-6 animate-in fade-in">
            <div className="bg-green-50 text-green-700 p-4 rounded-xl text-sm">
              <p className="font-bold mb-1">申請已送出！</p>
              <p>請檢查您的信箱，或直接聯繫客服人員協助重設。</p>
            </div>
            <div className="text-sm text-gray-500">
              客服電話：(02) 2345-6789 <br/>
              Line ID: @somalink
            </div>
            <Link href="/login" className="block w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors">
              返回登入
            </Link>
          </div>
        ) : (
          <form onSubmit={handleSubmit} className="space-y-6">
            <div>
              <label className="block text-sm font-bold text-gray-700 mb-1">Email</label>
              <input 
                type="email" 
                required
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                placeholder="name@company.com"
              />
            </div>

            <button type="submit" className="w-full flex items-center justify-center gap-2 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors shadow-sm">
              <Send className="w-4 h-4" /> 發送重設連結
            </button>

            <div className="text-center">
              <Link href="/login" className="text-sm text-gray-500 hover:text-gray-700 flex items-center justify-center gap-1">
                <ArrowLeft className="w-4 h-4" /> 返回登入
              </Link>
            </div>
          </form>
        )}
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/app/portal/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import Link from "next/link";
import { ArrowRight, Megaphone, X, Loader2, ShoppingCart } from "lucide-react";
import { api } from '../../lib/api'; 

export default function HomePage() {
  // const router = useRouter(); // 首頁暫時不需要 router 了 (移到 Navbar)
  const [announcement, setAnnouncement] = useState<string | null>(null);
  const [showBanner, setShowBanner] = useState(true);
  
  // 系列資料狀態
  const [seriesList, setSeriesList] = useState<any[]>([]);
  const [loadingSeries, setLoadingSeries] = useState(true);

  useEffect(() => {
    const fetchData = async () => {
      try {
        // 抓公告
        const annRes = await api.get('/announcements/active');
        if (annRes && annRes.content) {
            setAnnouncement(annRes.content);
        }

        // 抓取系列
        const seriesRes = await api.get('/series');
        const data = Array.isArray(seriesRes) ? seriesRes : [];
        const activeSeries = data.filter((s: any) => s.isActive);
        setSeriesList(activeSeries);

      } catch (err) { 
        console.error('無法取得首頁資料', err); 
        setSeriesList([]); 
      } finally {
        setLoadingSeries(false);
      }
    };
    fetchData();
  }, []);

  return (
    <div className="min-h-screen bg-gray-50">
      
      {/* 1. 藍色公告橫幅 (保留) */}
      {announcement && showBanner && (
        <div className="bg-blue-600 text-white px-4 py-2.5 relative flex justify-center items-center text-xs sm:text-sm font-medium animate-in slide-in-from-top">
          <div className="flex items-center gap-2">
            <Megaphone className="w-4 h-4 animate-pulse" />
            <span>{announcement}</span>
          </div>
          <button 
            onClick={() => setShowBanner(false)}
            className="absolute right-2 top-1/2 -translate-y-1/2 p-1 hover:bg-blue-700 rounded-full transition-colors opacity-80 hover:opacity-100"
          >
            <X className="w-4 h-4" />
          </button>
        </div>
      )}

      {/* 2. Hero 歡迎區 (保留) */}
      <div className="bg-white border-b border-gray-200">
        <div className="max-w-7xl mx-auto px-4 py-10 sm:py-12">
          <h1 className="text-2xl sm:text-3xl font-bold text-gray-900 mb-2">歡迎來到 松成有限公司 數位工廠</h1>
          <p className="text-gray-500">請選擇下方產品系列，開始建立您的客製化報價單</p>
        </div>
      </div>

      {/* 3. Main: 動態系列櫥窗 (保留) */}
      <main className="max-w-7xl mx-auto px-4 py-8">
        {loadingSeries ? (
          <div className="flex justify-center py-20">
            <Loader2 className="animate-spin w-10 h-10 text-blue-600" />
          </div>
        ) : seriesList.length === 0 ? (
          <div className="text-center py-20 text-gray-500">
            尚無上架系列，請至後台新增。
          </div>
        ) : (
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            {seriesList.map((series) => (
              <Link 
                key={series.id} 
                href={`/series/${encodeURIComponent(series.name)}`} 
                className="group bg-white rounded-2xl overflow-hidden border border-gray-200 hover:shadow-xl hover:border-blue-300 transition-all duration-300 flex flex-col"
              >
                <div className="relative h-52 overflow-hidden bg-gray-100">
                  {/* eslint-disable-next-line @next/next/no-img-element */}
                  <img 
                    src={series.imageUrl || "https://images.unsplash.com/photo-1600607686527-6fb886090705?auto=format&fit=crop&q=80&w=800"} 
                    alt={series.name}
                    className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                  />
                  {/* ✨ Fix: 這裡改成 bg-linear-to-t 符合 Tailwind v4 規範 */}
                  <div className="absolute inset-0 bg-linear-to-t from-black/60 to-transparent opacity-60" />
                  <div className="absolute bottom-4 left-4 text-white">
                    <p className="text-xs font-medium opacity-90 tracking-wider uppercase">{series.description}</p>
                    <h3 className="text-lg font-bold">{series.displayName || series.name}</h3>
                  </div>
                </div>

                <div className="p-5 flex-1 flex flex-col justify-between">
                  <div>
                    <div className="flex items-center justify-between mb-2">
                      <span className="px-2.5 py-0.5 rounded-full bg-blue-50 text-blue-700 text-xs font-bold border border-blue-100">
                        B2B 專屬
                      </span>
                    </div>
                    <p className="text-gray-500 text-sm line-clamp-2">
                      支援高度客製化尺寸、顏色與玻璃配置。
                    </p>
                  </div>

                  <div className="mt-4 pt-4 border-t border-gray-50 flex items-center justify-between">
                    <div>
                      <p className="text-xs text-gray-400">基礎價格</p>
                      <p className="text-blue-600 font-bold text-lg">
                        ${series.priceStart?.toLocaleString()} 
                        <span className="text-xs text-gray-400 font-normal ml-1">起</span>
                      </p>
                    </div>
                    <div className="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center group-hover:bg-blue-600 group-hover:text-white transition-colors">
                      <ArrowRight className="w-5 h-5" />
                    </div>
                  </div>
                </div>
              </Link>
            ))}
          </div>
        )}
      </main>
    </div>
  );
}
</file>

<file path="frontend/src/app/profile/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useForm } from 'react-hook-form';
import { Save, User, Building2, Phone, MapPin, Loader2, ArrowLeft } from 'lucide-react';
import Link from 'next/link';
import { api } from '@/lib/api';

export default function ProfilePage() {
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(true);
  const [isSubmitting, setIsSubmitting] = useState(false);

  const { register, handleSubmit, setValue, reset } = useForm({
    defaultValues: {
      name: '',
      email: '',
      companyName: '',
      taxId: '',
      phone: '',
      address: '',
      password: '', // 選填：若填寫則修改密碼
      confirmPassword: ''
    }
  });

  useEffect(() => {
    // 載入當前使用者資料 (需要後端支援 /auth/me 或直接從 localStorage 讀取但最好重新 fetch)
    // 這裡示範重新 fetch 以確保資料最新
    const fetchProfile = async () => {
      try {
        const storedUser = localStorage.getItem('somalink_user');
        if (!storedUser) {
          router.push('/login');
          return;
        }
        
        // 假設我們用這個 endpoint 抓取最新個資，如果沒有這個 endpoint，也可以用 storedUser 暫代
        // 但為了安全與即時性，建議後端要有一個 GET /users/me
        // 這裡我們先用 storedUser 填充，並假設後端 PATCH 支援更新
        const user = JSON.parse(storedUser);
        
        // 如果後端有提供 GET /users/profile，可以在這裡呼叫
        // const res = await api.get('/users/profile');
        // const user = res;

        reset({
          name: user.dealerProfile?.contactPerson || user.name,
          email: user.email,
          companyName: user.dealerProfile?.companyName,
          taxId: user.dealerProfile?.taxId,
          phone: user.dealerProfile?.phone,
          address: user.dealerProfile?.address,
        });
      } catch (err) {
        console.error(err);
      } finally {
        setIsLoading(false);
      }
    };
    fetchProfile();
  }, [router, reset]);

  const onSubmit = async (data: any) => {
    if (data.password && data.password !== data.confirmPassword) {
      alert('兩次密碼輸入不一致');
      return;
    }

    setIsSubmitting(true);
    try {
      // 呼叫後端更新
      const payload = {
        name: data.name, // 聯絡人
        password: data.password || undefined, // 若為空則不傳
        dealerProfile: {
          companyName: data.companyName,
          taxId: data.taxId,
          contactPerson: data.name,
          phone: data.phone,
          address: data.address
        }
      };

      const updatedUser = await api.patch('/users/profile', payload);
      
      // 更新 localStorage
      localStorage.setItem('somalink_user', JSON.stringify(updatedUser));
      
      alert('資料更新成功！');
      router.refresh();
    } catch (error) {
      console.error(error);
      alert('更新失敗，請檢查網路或稍後再試');
    } finally {
      setIsSubmitting(false);
    }
  };

  if (isLoading) return <div className="min-h-screen flex justify-center items-center"><Loader2 className="animate-spin text-blue-600" /></div>;

  return (
    <div className="min-h-screen bg-gray-50 py-12 px-4 sm:px-6 lg:px-8 font-sans">
      <div className="max-w-3xl mx-auto">
        <div className="flex items-center gap-4 mb-8">
          <Link href="/" className="p-2 bg-white rounded-full shadow-sm hover:bg-gray-100 transition-colors">
            <ArrowLeft className="w-5 h-5 text-gray-600" />
          </Link>
          <h1 className="text-2xl font-bold text-gray-900">會員資料設定</h1>
        </div>

        <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
          
          {/* 基本資料卡片 */}
          <div className="bg-white p-8 rounded-2xl shadow-sm border border-gray-200">
            <h2 className="text-lg font-bold text-gray-900 mb-6 flex items-center gap-2">
              <Building2 className="w-5 h-5 text-blue-600" /> 公司與聯絡資訊
            </h2>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="md:col-span-2">
                <label className="block text-sm font-bold text-gray-700 mb-1">公司名稱</label>
                <input {...register('companyName')} className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" />
              </div>
              
              <div>
                <label className="block text-sm font-bold text-gray-700 mb-1">統一編號</label>
                <input {...register('taxId')} className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" />
              </div>

              <div>
                <label className="block text-sm font-bold text-gray-700 mb-1">聯絡人姓名</label>
                <input {...register('name')} className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" />
              </div>

              <div>
                <label className="block text-sm font-bold text-gray-700 mb-1">聯絡電話</label>
                <input {...register('phone')} className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" />
              </div>

              <div className="md:col-span-2">
                <label className="block text-sm font-bold text-gray-700 mb-1">通訊地址</label>
                <input {...register('address')} className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" />
              </div>
            </div>
          </div>

          {/* 帳號安全卡片 */}
          <div className="bg-white p-8 rounded-2xl shadow-sm border border-gray-200">
            <h2 className="text-lg font-bold text-gray-900 mb-6 flex items-center gap-2">
              <User className="w-5 h-5 text-green-600" /> 帳號安全
            </h2>
            
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-bold text-gray-700 mb-1">登入 Email (不可修改)</label>
                <input {...register('email')} disabled className="w-full p-3 border border-gray-200 bg-gray-100 rounded-xl text-gray-500 cursor-not-allowed" />
              </div>

              <div className="pt-4 border-t border-gray-100">
                <p className="text-sm text-gray-500 mb-4">若需修改密碼請填寫下方欄位，否則請留空。</p>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label className="block text-sm font-bold text-gray-700 mb-1">新密碼</label>
                    <input type="password" {...register('password')} className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="不修改請留空" />
                  </div>
                  <div>
                    <label className="block text-sm font-bold text-gray-700 mb-1">確認新密碼</label>
                    <input type="password" {...register('confirmPassword')} className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="再次輸入新密碼" />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div className="flex justify-end gap-4">
            <Link href="/" className="px-6 py-3 border border-gray-300 text-gray-700 font-bold rounded-xl hover:bg-gray-50 transition-colors">
              取消
            </Link>
            <button 
              type="submit" 
              disabled={isSubmitting}
              className="px-8 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 shadow-md flex items-center gap-2 disabled:opacity-70 transition-all"
            >
              {isSubmitting ? <Loader2 className="animate-spin w-5 h-5" /> : <><Save className="w-5 h-5" /> 儲存變更</>}
            </button>
          </div>

        </form>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/components/blocks/FeaturesBlock.tsx">
import { Ruler, Hammer, ShieldCheck } from "lucide-react";

export default function FeaturesBlock({ data }: { data: any }) {
  const items = data.items || [];
  const icons = [<Ruler key={0} className="w-7 h-7 text-blue-600" />, <Hammer key={1} className="w-7 h-7 text-blue-600" />, <ShieldCheck key={2} className="w-7 h-7 text-blue-600" />];

  return (
    <section className="py-24 bg-white">
      <div className="max-w-7xl mx-auto px-6">
        <div className="text-center mb-16">
          <h2 className="text-3xl font-bold text-gray-900 mb-4">{data.title}</h2>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-10">
          {items.map((item: any, idx: number) => (
            <div key={idx} className="bg-gray-50 p-8 rounded-3xl border border-gray-100 hover:shadow-lg transition-all">
              <div className="w-14 h-14 bg-blue-100 rounded-2xl flex items-center justify-center mb-6">
                {icons[idx % 3]}
              </div>
              <h3 className="text-xl font-bold text-gray-900 mb-3">{item.title}</h3>
              <p className="text-gray-500 leading-relaxed">{item.desc}</p>
            </div>
          ))}
        </div>
      </div>
    </section>
  );
}
</file>

<file path="frontend/src/components/blocks/HeroBlock.tsx">
'use client';
import { useState, useEffect } from 'react';
import Link from "next/link";
import { ArrowRight } from "lucide-react";

export default function HeroBlock({ data }: { data: any }) {
  const [currentImageIndex, setCurrentImageIndex] = useState(0);
  const images = data.images || [];

  useEffect(() => {
    if (images.length <= 1) return;
    const timer = setInterval(() => {
      setCurrentImageIndex((prev) => (prev + 1) % images.length);
    }, 5000);
    return () => clearInterval(timer);
  }, [images]);

  return (
    <div className="relative h-[85vh] w-full overflow-hidden bg-gray-900">
      {images.map((src: string, index: number) => (
        // eslint-disable-next-line @next/next/no-img-element
        <img 
          key={index} src={src} alt="Hero"
          className={`absolute inset-0 w-full h-full object-cover transition-opacity duration-1000 ${index === currentImageIndex ? 'opacity-100' : 'opacity-0'}`}
        />
      ))}
      <div className="absolute inset-0 bg-black/40" />
      <div className="relative z-10 h-full max-w-7xl mx-auto px-6 flex flex-col justify-center items-start text-white">
        <span className="bg-blue-600 text-white px-4 py-1 rounded-full text-sm font-bold mb-6">SOMA 松成有限公司</span>
        <h1 className="text-5xl md:text-7xl font-bold leading-tight mb-6 whitespace-pre-wrap">{data.title}</h1>
        <p className="text-lg md:text-xl text-gray-100 max-w-xl mb-10">{data.subtitle}</p>
        <div className="flex gap-4">
          <Link href="/portal" className="px-8 py-4 bg-white text-gray-900 rounded-full font-bold hover:bg-gray-100 flex items-center gap-2">進入經銷系統 <ArrowRight className="w-5 h-5" /></Link>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/components/blocks/ProductListBlock.tsx">
'use client';
import { useState, useEffect } from 'react';
import Link from 'next/link';
import { api } from '@/lib/api';
import { Loader2 } from 'lucide-react';

export default function ProductListBlock({ data }: { data: any }) {
  const [seriesList, setSeriesList] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    api.get('/series').then((res) => {
      const list = Array.isArray(res) ? res : [];
      setSeriesList(list.filter((s: any) => s.isActive).slice(0, data.count || 4));
    }).finally(() => setLoading(false));
  }, [data.count]);

  return (
    <section className="py-20 bg-gray-50 border-t border-gray-100">
      <div className="max-w-7xl mx-auto px-6">
        <div className="text-center mb-12"><h2 className="text-2xl font-bold text-gray-900">{data.title}</h2></div>
        {loading ? <div className="flex justify-center"><Loader2 className="animate-spin text-blue-600" /></div> : (
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            {seriesList.map((series) => (
              <Link 
                key={series.id} 
                href={`/series/${encodeURIComponent(series.name)}`} 
                // ✨ 修改重點：加入 border-2 border-transparent hover:border-blue-900 (海軍藍邊框)
                className="group block bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-2xl transition-all duration-300 border-2 border-transparent hover:border-blue-900 hover:-translate-y-1"
              >
                <div className="relative h-48 overflow-hidden bg-gray-100">
                  {/* eslint-disable-next-line @next/next/no-img-element */}
                  <img src={series.imageUrl} alt={series.name} className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" />
                  <div className="absolute inset-0 bg-linear-to-t from-black/70 to-transparent opacity-60" />
                  
                  {/* 文字也稍微放大一點增加對比 */}
                  <div className="absolute bottom-3 left-3 text-white">
                    <h3 className="text-lg font-bold group-hover:text-blue-100 transition-colors">{series.displayName || series.name}</h3>
                  </div>
                </div>
              </Link>
            ))}
          </div>
        )}
      </div>
    </section>
  );
}
</file>

<file path="frontend/src/components/Modal.tsx">
'use client';

import { X, CheckCircle, AlertCircle, HelpCircle, Info } from 'lucide-react';
import clsx from 'clsx';
import { ReactNode } from 'react';

interface ModalProps {
  isOpen: boolean;
  onClose: () => void;
  title: string;
  message?: ReactNode; // 支援文字或 JSX
  type?: 'success' | 'error' | 'warning' | 'info' | 'confirm';
  onConfirm?: () => void;
  confirmText?: string;
  cancelText?: string;
}

export default function Modal({ 
  isOpen, onClose, title, message, type = 'info', onConfirm, confirmText = '確定', cancelText = '取消' 
}: ModalProps) {
  if (!isOpen) return null;

  const iconMap = {
    success: <CheckCircle className="w-12 h-12 text-green-500" />,
    error: <AlertCircle className="w-12 h-12 text-red-500" />,
    warning: <AlertCircle className="w-12 h-12 text-orange-500" />,
    info: <Info className="w-12 h-12 text-blue-500" />,
    confirm: <HelpCircle className="w-12 h-12 text-blue-500" />,
  };

  return (
    // ✨ Fix: 將 z-[999] 改為 z-999 (Tailwind v4 標準寫法)
    <div className="fixed inset-0 z-999 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
      <div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl flex flex-col items-center text-center space-y-4 animate-in zoom-in-95 duration-200 relative">
        
        {/* 關閉按鈕 */}
        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
          <X className="w-5 h-5" />
        </button>
        
        {/* 圖示 */}
        <div className="mb-2 scale-110">
          {iconMap[type]}
        </div>
        
        {/* 標題與內容 */}
        <div>
          <h3 className="text-xl font-bold text-gray-900 mb-2">{title}</h3>
          {message && <div className="text-sm text-gray-600 leading-relaxed">{message}</div>}
        </div>
        
        {/* 按鈕區 */}
        <div className="flex w-full gap-3 mt-4">
          {type === 'confirm' ? (
            <>
              <button 
                onClick={onClose}
                className="flex-1 py-2.5 border border-gray-300 text-gray-700 rounded-xl font-bold hover:bg-gray-50 transition-colors"
              >
                {cancelText}
              </button>
              <button 
                onClick={() => { onConfirm?.(); onClose(); }}
                className="flex-1 py-2.5 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-colors shadow-md"
              >
                {confirmText}
              </button>
            </>
          ) : (
            <button 
              onClick={onClose}
              className={clsx(
                "w-full py-2.5 rounded-xl font-bold text-white transition-colors shadow-md",
                type === 'error' ? "bg-red-600 hover:bg-red-700" : "bg-blue-600 hover:bg-blue-700"
              )}
            >
              {confirmText}
            </button>
          )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="admin/.gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="admin/eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="admin/next.config.ts">
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
};

export default nextConfig;
</file>

<file path="admin/package.json">
{
  "name": "admin",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev -p 3001",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "axios": "^1.13.2",
    "clsx": "^2.1.1",
    "lucide-react": "^0.554.0",
    "next": "16.0.3",
    "react": "19.2.0",
    "react-dom": "19.2.0",
    "react-hook-form": "^7.66.1",
    "recharts": "^3.4.1",
    "tailwind-merge": "^3.4.0",
    "xlsx": "^0.18.5"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "16.0.3",
    "tailwindcss": "^4",
    "typescript": "^5"
  }
}
</file>

<file path="admin/postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="admin/public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="admin/public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="admin/public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="admin/public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="admin/public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="admin/README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="admin/src/app/globals.css">
@import "tailwindcss";
</file>

<file path="admin/src/app/layout.tsx">
import type { Metadata } from "next";
import "./globals.css";
import LayoutShell from "@/components/LayoutShell";

export const metadata: Metadata = {
  title: "SomaLink Admin",
  description: "B2B 工廠管理後台",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="zh-TW">
      <body className="bg-gray-100">
        <LayoutShell>
          {children}
        </LayoutShell>
      </body>
    </html>
  );
}
</file>

<file path="admin/src/app/orders/[id]/print/page.tsx">
'use client';

import { useEffect, useState, use } from 'react';
import { api } from '@/lib/api';
import { Loader2, Printer, MapPin, Phone, User, MessageSquare } from 'lucide-react';

export default function PrintDeliveryNotePage({ params }: { params: Promise<{ id: string }> }) {
  const { id } = use(params);
  const [order, setOrder] = useState<any>(null);
  const [showPrice, setShowPrice] = useState(true); 

  useEffect(() => {
    api.get(`/orders/${id}`).then(res => setOrder(res)).catch(console.error);
  }, [id]);

  if (!order) return <div className="flex justify-center p-12"><Loader2 className="animate-spin w-8 h-8 text-blue-600" /></div>;

  return (
    <div className="min-h-screen bg-gray-100 p-8 print:p-0 print:bg-white">
      
      {/* 控制列 (列印時隱藏) */}
      <div className="max-w-[210mm] mx-auto mb-6 flex justify-between items-center print:hidden bg-white p-4 rounded-lg shadow-sm border border-gray-200">
        <div className="flex items-center gap-3">
          <label className="flex items-center gap-2 cursor-pointer select-none">
            <input 
              type="checkbox" 
              checked={showPrice} 
              onChange={(e) => setShowPrice(e.target.checked)}
              className="w-4 h-4 text-blue-600 rounded cursor-pointer" 
            />
            <span className="text-sm text-gray-700 font-medium">顯示金額</span>
          </label>
          <span className="text-xs text-gray-400">| (給司機或現場看的單據可取消勾選)</span>
        </div>
        <button 
          onClick={() => window.print()}
          className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-sm transition-colors"
        >
          <Printer className="w-4 h-4" /> 列印 / 存為 PDF
        </button>
      </div>

      {/* A4 紙張區域 - 優化間距 (p-8 -> p-6) */}
      <div className="max-w-[210mm] mx-auto bg-white shadow-xl print:shadow-none p-8 print:p-6 min-h-[297mm] text-black font-sans relative flex flex-col box-border">
        
        {/* Header - 縮減下方間距 (pb-6 -> pb-4, mb-6 -> mb-4) */}
        <div className="flex justify-between items-start border-b-4 border-black pb-4 mb-4">
          <div className="flex items-center gap-4">
            <div className="w-14 h-14 bg-black text-white flex items-center justify-center text-2xl font-bold rounded-lg print:border print:border-black">S</div>
            <div>
              <h1 className="text-2xl font-extrabold tracking-wider text-black">出貨單</h1>
              <p className="text-sm font-bold mt-1 text-black">松成有限公司</p>
              <div className="flex gap-4 text-xs text-black font-medium mt-0.5">
                <span>統編：12345678</span>
                <span>電話：(02) 2345-6789</span>
              </div>
            </div>
          </div>
          <div className="text-right">
            <div className="inline-block border-2 border-black px-3 py-1 rounded mb-1">
              <p className="text-[10px] font-bold uppercase tracking-wide text-black">出貨單號 NO.</p>
              <p className="text-lg font-mono font-bold text-black leading-none">{order.orderNumber}</p>
            </div>
            <p className="text-xs mt-1 text-black font-medium">列印日期：{new Date().toLocaleDateString()}</p>
          </div>
        </div>

        {/* 客戶與送貨資訊 - 縮減間距 (gap-8 -> gap-4) */}
        <div className="grid grid-cols-2 gap-4 mb-4 break-inside-avoid">
          
          {/* 左邊：訂購經銷商 */}
          <div className="border-2 border-black rounded p-3">
            <h3 className="text-xs font-bold bg-gray-200 px-2 py-0.5 mb-2 inline-block rounded text-black print:border print:border-black">訂購經銷商 (Bill To)</h3>
            <div className="space-y-0.5 text-sm text-black">
              <p><span className="font-bold w-16 inline-block">公司名稱：</span><span className="font-bold">{order.user?.dealerProfile?.companyName}</span></p>
              <p><span className="font-bold w-16 inline-block">聯絡人：</span>{order.user?.dealerProfile?.contactPerson}</p>
              <p><span className="font-bold w-16 inline-block">電話：</span>{order.user?.dealerProfile?.phone}</p>
            </div>
          </div>

          {/* 右邊：施工/送貨地點 */}
          <div className="border-2 border-black rounded p-3">
            <h3 className="text-xs font-bold bg-gray-200 px-2 py-0.5 mb-2 inline-block rounded text-black print:border print:border-black">送貨資訊 (Ship To)</h3>
            <div className="space-y-0.5 text-sm text-black">
              <div className="mb-1">
                <p className="text-[10px] font-bold text-black">案場名稱</p>
                <p className="font-bold text-base leading-tight">{order.projectName}</p>
              </div>
              
              <div className="flex items-start gap-1 mb-1">
                <MapPin className="w-3.5 h-3.5 mt-0.5 text-black shrink-0" />
                <span className="font-bold border-b border-black pb-0 text-sm leading-tight">
                  {order.shippingAddress || '未指定地址 (同經銷商)'}
                </span>
              </div>

              <div className="grid grid-cols-2 gap-1 text-xs">
                <p className="flex items-center font-medium">
                  <User className="w-3 h-3 mr-1 text-black" /> 
                  {order.siteContactPerson || order.user?.dealerProfile?.contactPerson}
                </p>
                <p className="flex items-center font-medium">
                  <Phone className="w-3 h-3 mr-1 text-black" /> 
                  {order.siteContactPhone || order.user?.dealerProfile?.phone}
                </p>
              </div>
            </div>
          </div>
        </div>

        {/* 訂單備註 */}
        {order.customerNote && (
          <div className="mb-4 border-2 border-black bg-gray-50 p-2 rounded text-sm flex items-start gap-2 break-inside-avoid">
            <MessageSquare className="w-4 h-4 text-black mt-0.5 shrink-0" />
            <div className="text-black">
              <span className="font-bold mr-2">訂單備註：</span>
              <span className="font-medium">{order.customerNote}</span>
            </div>
          </div>
        )}

        {/* 產品明細 - 緊湊表格 */}
        <div className="flex-1">
          <table className="w-full mb-4 border-collapse">
            <thead>
              <tr className="bg-gray-200 border-y-2 border-black text-xs text-black">
                <th className="py-1 px-2 text-left w-8 font-bold">#</th>
                <th className="py-1 px-2 text-left font-bold">產品名稱 / 詳細規格</th>
                <th className="py-1 px-2 text-center w-16 font-bold">數量</th>
                {showPrice && <th className="py-1 px-2 text-right w-24 font-bold">單價</th>}
                {showPrice && <th className="py-1 px-2 text-right w-24 font-bold">金額</th>}
              </tr>
            </thead>
            <tbody className="text-sm text-black">
              {order.items?.map((item: any, index: number) => (
                <tr key={index} className="border-b border-black break-inside-avoid">
                  <td className="py-2 px-2 align-top font-bold text-center">{index + 1}</td>
                  <td className="py-2 px-2 align-top">
                    <p className="font-bold text-sm">{item.product?.name}</p>
                    <div className="text-black text-[10px] mt-1 grid grid-cols-2 gap-x-2 gap-y-0.5 font-mono font-medium">
                      <p>型號: {item.product?.sku}</p>
                      <p>顏色: {item.colorName}</p>
                      <p>材質: {item.materialName}</p>
                      <p>開向: {item.openingDirection}</p>
                      <p>模式: {item.serviceType === 'assembled' ? '連工帶料' : '純材料'}</p>
                    </div>
                    {/* 尺寸顯示 */}
                    <div className="mt-1 bg-white px-1.5 py-0.5 rounded inline-block text-[10px] font-mono border border-black font-bold">
                      W: {item.widthMatrix?.mid} x H: {item.heightData?.singleValue || item.heightData?.mid}
                      {item.isCeilingMounted && <span className="ml-1 text-black font-extrabold">(封頂)</span>}
                    </div>
                  </td>
                  <td className="py-2 px-2 text-center align-top font-bold">{item.quantity}</td>
                  {showPrice && <td className="py-2 px-2 text-right align-top font-mono font-medium">${Number(item.unitPrice || item.subtotal / item.quantity).toLocaleString()}</td>}
                  {showPrice && <td className="py-2 px-2 text-right align-top font-bold font-mono">${Number(item.subtotal).toLocaleString()}</td>}
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        {/* 總計與簽名 - 確保不被硬推到下一頁 */}
        <div className="break-inside-avoid">
          {showPrice && (
            <div className="flex justify-end mb-6 border-t-2 border-black pt-2">
              <div className="text-right">
                <p className="text-xs font-bold text-black">總計金額 (含稅)</p>
                <p className="text-2xl font-extrabold text-black">NT$ {Number(order.totalAmount).toLocaleString()}</p>
              </div>
            </div>
          )}

          {/* 底部簽名欄 - 縮減間距 */}
          <div className="mt-4 pt-4 border-t border-dashed border-gray-400">
            <div className="grid grid-cols-3 gap-8">
              <div className="text-center">
                <p className="text-xs font-bold mb-6 text-black">倉管備貨</p>
                <div className="border-b-2 border-black w-3/4 mx-auto"></div>
              </div>
              <div className="text-center">
                <p className="text-xs font-bold mb-6 text-black">司機配送</p>
                <div className="border-b-2 border-black w-3/4 mx-auto"></div>
              </div>
              <div className="text-center">
                <p className="text-xs font-bold mb-6 text-black">客戶簽收</p>
                <div className="border-b-2 border-black w-3/4 mx-auto"></div>
                <p className="text-[9px] text-black font-bold mt-1">本人確認上述規格與數量無誤</p>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  );
}
</file>

<file path="admin/src/app/products/[id]/page.tsx">
'use client';

import { useState, useEffect, use } from 'react';
import { useRouter } from 'next/navigation';
import { useForm, useFieldArray } from 'react-hook-form';
import { ArrowLeft, Save, Plus, Trash2, DollarSign, Ruler, Palette, Layers, MoveHorizontal, Image as ImageIcon, Loader2, UploadCloud, X, Percent } from 'lucide-react';
import Link from 'next/link';
import { api } from '@/lib/api';

const CLOUDINARY_CLOUD_NAME = 'dnibj8za6'; 
const CLOUDINARY_PRESET = 'yasou70731';  

interface ProductFormValues {
  name: string;
  sku: string;
  series: string;
  images: string[]; // 多圖陣列
  basePrice: number;
  requiresMeasurement: boolean;
  standardWidth: number;
  standardHeight: number;
  discountA?: number | null; // ✨ 新增
  discountB?: number | null; // ✨ 新增
  colors: { name: string; colorCode: string; priceSurcharge: number }[];
  materials: { name: string; priceSurcharge: number }[];
  openingOptions: { value: string }[];
}

export default function EditProductPage({ params }: { params: Promise<{ id: string }> }) {
  const { id } = use(params);
  const router = useRouter();
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isUploading, setIsUploading] = useState(false);
  const [isLoading, setIsLoading] = useState(true);

  const { register, control, handleSubmit, watch, setValue, getValues, reset } = useForm<ProductFormValues>({
    defaultValues: {
      name: '', sku: '', series: '', 
      images: [],
      basePrice: 0, requiresMeasurement: true,
      standardWidth: 90, standardHeight: 210,
      discountA: null,
      discountB: null,
      colors: [],
      materials: [],
      openingOptions: []
    }
  });

  const images = watch('images') || [];
  
  const { fields: colorFields, append: appendColor, remove: removeColor } = useFieldArray({ control, name: 'colors' });
  const { fields: materialFields, append: appendMaterial, remove: removeMaterial } = useFieldArray({ control, name: 'materials' });
  const { fields: openingFields, append: appendOpening, remove: removeOpening } = useFieldArray({ control, name: 'openingOptions' });

  // 1. 載入舊資料
  useEffect(() => {
    const fetchProduct = async () => {
      try {
        const data = await api.get(`/products/${id}`);
        if (!data) throw new Error("No data");

        // 資料轉換：處理圖片欄位相容性
        let imgList: string[] = [];
        if (Array.isArray(data.images)) {
          imgList = data.images;
        } else if (data.imageUrl) {
          imgList = [data.imageUrl]; // 舊資料只有一張，轉為陣列
        }

        const formattedData = {
          ...data,
          images: imgList,
          discountA: data.discountA || null,
          discountB: data.discountB || null,
          // 確保陣列存在，避免 null 錯誤
          colors: Array.isArray(data.colors) ? data.colors : [],
          materials: Array.isArray(data.materials) ? data.materials : [],
          openingOptions: Array.isArray(data.openingOptions) 
            ? data.openingOptions.map((v: string) => ({ value: v })) 
            : []
        };
        
        reset(formattedData);
      } catch (err) {
        console.error('載入失敗:', err);
        alert('找不到產品資料');
        router.push('/products');
      } finally {
        setIsLoading(false);
      }
    };
    fetchProduct();
  }, [id, reset, router]);

  // 多圖上傳處理
  const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (!files || files.length === 0) return;

    setIsUploading(true);
    const currentImages = getValues('images') || [];
    const newImages = [...currentImages];

    try {
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_PRESET);

        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, { method: 'POST', body: formData });
        const data = await res.json();
        if (data.secure_url) newImages.push(data.secure_url);
      }
      setValue('images', newImages);
    } catch (err) {
      alert('上傳失敗');
    } finally {
      setIsUploading(false);
    }
  };

  // 移除單張圖片
  const removeImage = (idx: number) => {
    const current = getValues('images');
    setValue('images', current.filter((_, i) => i !== idx));
  };

  // 送出更新
  const onSubmit = async (data: ProductFormValues) => {
    setIsSubmitting(true);
    try {
      // 過濾掉 id 等系統欄位，避免 500 錯誤
      const { id: _id, createdAt, updatedAt, ...restData } = data as any;
      
      const payload = {
        ...restData,
        discountA: data.discountA ? Number(data.discountA) : null,
        discountB: data.discountB ? Number(data.discountB) : null,
        openingOptions: data.openingOptions.map((opt) => opt.value).filter((v) => v)
      };
      
      await api.patch(`/products/${id}`, payload);
      alert('修改成功！');
      router.push('/products');
    } catch (error) {
      console.error(error);
      alert('修改失敗');
    } finally {
      setIsSubmitting(false);
    }
  };

  if (isLoading) return <div className="min-h-screen flex justify-center items-center"><Loader2 className="animate-spin text-blue-600" /></div>;

  return (
    <div className="min-h-screen bg-gray-50 p-8 font-sans pb-20">
      {/* Header */}
      <div className="max-w-4xl mx-auto flex items-center justify-between mb-8">
        <div className="flex items-center gap-4">
          <Link href="/products" className="p-2 hover:bg-white rounded-full transition-colors text-gray-500">
            <ArrowLeft className="w-6 h-6" />
          </Link>
          <div>
            <h1 className="text-2xl font-bold text-gray-900">編輯產品</h1>
            <p className="text-sm text-gray-500">修改產品 ID: {id}</p>
          </div>
        </div>
        <button onClick={handleSubmit(onSubmit)} disabled={isSubmitting} className="flex items-center gap-2 px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md font-bold disabled:opacity-50 transition-all">
          <Save className="w-4 h-4" />
          {isSubmitting ? '儲存中...' : '儲存修改'}
        </button>
      </div>

      <div className="max-w-4xl mx-auto space-y-6">
        
        {/* 1. 基本資訊與圖片 */}
        <section className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <h2 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2"><div className="w-1 h-6 bg-blue-500 rounded-full"></div> 基本資訊</h2>
          <div className="grid grid-cols-2 gap-6">
            <div className="col-span-2"><label className="block text-sm font-medium text-gray-700 mb-1">產品名稱</label><input {...register('name')} className="w-full p-2 border border-gray-300 rounded-lg outline-none" /></div>
            
            {/* 圖片列表 */}
            <div className="col-span-2">
              <label className="block text-sm font-medium text-gray-700 mb-2">產品圖片集</label>
              <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-4">
                {images.map((url, idx) => (
                  <div key={idx} className="relative group aspect-square bg-gray-100 rounded-lg overflow-hidden border border-gray-200">
                    {/* eslint-disable-next-line @next/next/no-img-element */}
                    <img src={url} alt={`Product ${idx}`} className="w-full h-full object-cover" />
                    <button type="button" onClick={() => removeImage(idx)} className="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity shadow-sm"><X className="w-3 h-3" /></button>
                    {idx === 0 && <span className="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-[10px] text-center py-1">封面圖</span>}
                  </div>
                ))}
                <label className="flex flex-col items-center justify-center aspect-square border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                  {isUploading ? <Loader2 className="w-6 h-6 text-gray-400 animate-spin" /> : <Plus className="w-6 h-6 text-gray-400" />}
                  <span className="text-xs text-gray-500 mt-1">{isUploading ? '上傳中' : '新增圖片'}</span>
                  <input type="file" className="hidden" accept="image/*" multiple onChange={handleImageUpload} disabled={isUploading} />
                </label>
              </div>
            </div>

            <div><label className="block text-sm font-medium text-gray-700 mb-1">型號 (SKU)</label><input {...register('sku')} className="w-full p-2 border border-gray-300 rounded-lg outline-none" /></div>
            <div><label className="block text-sm font-medium text-gray-700 mb-1">系列</label><input {...register('series')} className="w-full p-2 border border-gray-300 rounded-lg outline-none" /></div>
          </div>
        </section>

        {/* 2. 價格與尺寸 */}
        <section className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <h2 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2"><div className="w-1 h-6 bg-green-500 rounded-full"></div> 價格與尺寸</h2>
          <div className="grid grid-cols-3 gap-6">
            <div><label className="block text-sm font-medium text-gray-700 mb-1">基礎價格</label><input type="number" {...register('basePrice', { valueAsNumber: true })} className="w-full p-2 border border-gray-300 rounded-lg outline-none" /></div>
            <div><label className="block text-sm font-medium text-gray-700 mb-1">標準寬度</label><input type="number" {...register('standardWidth', { valueAsNumber: true })} className="w-full p-2 border border-gray-300 rounded-lg outline-none" /></div>
            <div><label className="block text-sm font-medium text-gray-700 mb-1">標準高度</label><input type="number" {...register('standardHeight', { valueAsNumber: true })} className="w-full p-2 border border-gray-300 rounded-lg outline-none" /></div>
            <div className="col-span-3 flex items-center gap-2 p-3 bg-gray-50 rounded-lg"><input type="checkbox" {...register('requiresMeasurement')} className="w-4 h-4 text-blue-600" /><label className="text-sm text-gray-700">需丈量 (勾選後前台會顯示「丈量並加入購物車」按鈕)</label></div>
          </div>
        </section>

        {/* ✨✨✨ 3. B2B 特殊折數 (新增區塊) ✨✨✨ */}
        <section className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <h2 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2"><Percent className="w-5 h-5 text-yellow-500" /> B2B 會員個別折數 (選填)</h2>
          <div className="grid grid-cols-2 gap-6 bg-yellow-50 p-4 rounded-lg border border-yellow-100">
            <div>
              <label className="block text-sm font-bold text-yellow-800 mb-1">A 級會員折數</label>
              <input 
                type="number" 
                step="0.01" 
                placeholder="預設 (空白)" 
                {...register('discountA')} 
                className="w-full p-2 border border-yellow-200 rounded-lg outline-none focus:ring-2 focus:ring-yellow-400 bg-white" 
              />
              <p className="text-xs text-yellow-600 mt-1">例如：0.8 代表 8 折。若留空則使用系統統一設定。</p>
            </div>
            <div>
              <label className="block text-sm font-bold text-yellow-800 mb-1">B 級會員折數</label>
              <input 
                type="number" 
                step="0.01" 
                placeholder="預設 (空白)" 
                {...register('discountB')} 
                className="w-full p-2 border border-yellow-200 rounded-lg outline-none focus:ring-2 focus:ring-yellow-400 bg-white" 
              />
              <p className="text-xs text-yellow-600 mt-1">例如：0.9 代表 9 折。</p>
            </div>
          </div>
        </section>

        {/* 4. 開門方向 */}
        <section className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <div className="flex justify-between mb-4"><h2 className="text-lg font-bold text-gray-900 flex items-center gap-2"><MoveHorizontal className="w-5 h-5" /> 開門方向</h2><button type="button" onClick={() => appendOpening({ value: '' })} className="text-blue-600 text-sm flex items-center"><Plus className="w-4 h-4" /> 新增</button></div>
          <div className="grid grid-cols-2 gap-3">{openingFields.map((f, i) => (<div key={f.id} className="flex gap-2 items-center bg-gray-50 p-2 rounded-lg border"><input {...register(`openingOptions.${i}.value`)} className="flex-1 bg-transparent outline-none text-sm" /><button type="button" onClick={() => removeOpening(i)} className="text-gray-400 hover:text-red-500"><Trash2 className="w-4 h-4" /></button></div>))}</div>
        </section>
        
        {/* 5. 顏色 */}
        <section className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <div className="flex justify-between mb-4"><h2 className="text-lg font-bold text-gray-900 flex items-center gap-2"><Palette className="w-5 h-5" /> 顏色</h2><button type="button" onClick={() => appendColor({ name: '', colorCode: '#000000', priceSurcharge: 0 })} className="text-blue-600 text-sm flex items-center"><Plus className="w-4 h-4" /> 新增</button></div>
          <div className="space-y-3">{colorFields.map((f, i) => (<div key={f.id} className="flex gap-3 items-end bg-gray-50 p-3 rounded-lg"><div className="flex-1"><input {...register(`colors.${i}.name`)} className="w-full p-2 border rounded text-sm" placeholder="名稱" /></div><div className="w-24"><input type="color" {...register(`colors.${i}.colorCode`)} className="h-9 w-9 border rounded cursor-pointer" /></div><div className="w-32"><input type="number" {...register(`colors.${i}.priceSurcharge`, { valueAsNumber: true })} className="w-full p-2 border rounded text-sm" placeholder="加價" /></div><button type="button" onClick={() => removeColor(i)} className="text-gray-400 hover:text-red-500"><Trash2 className="w-4 h-4" /></button></div>))}</div>
        </section>
        
        {/* 6. 材質 */}
        <section className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <div className="flex justify-between mb-4"><h2 className="text-lg font-bold text-gray-900 flex items-center gap-2"><Layers className="w-5 h-5" /> 材質</h2><button type="button" onClick={() => appendMaterial({ name: '', priceSurcharge: 0 })} className="text-blue-600 text-sm flex items-center"><Plus className="w-4 h-4" /> 新增</button></div>
          <div className="space-y-3">{materialFields.map((f, i) => (<div key={f.id} className="flex gap-3 items-end bg-gray-50 p-3 rounded-lg"><div className="flex-1"><input {...register(`materials.${i}.name`)} className="w-full p-2 border rounded text-sm" placeholder="名稱" /></div><div className="w-32"><input type="number" {...register(`materials.${i}.priceSurcharge`, { valueAsNumber: true })} className="w-full p-2 border rounded text-sm" placeholder="加價" /></div><button type="button" onClick={() => removeMaterial(i)} className="text-gray-400 hover:text-red-500"><Trash2 className="w-4 h-4" /></button></div>))}</div>
        </section>

      </div>
    </div>
  );
}
</file>

<file path="admin/src/app/products/new/page.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { useForm, useFieldArray } from 'react-hook-form';
import { ArrowLeft, Save, Plus, Trash2, DollarSign, Ruler, Palette, Layers, MoveHorizontal, Image as ImageIcon, Loader2, UploadCloud, X, Percent } from 'lucide-react';
import Link from 'next/link';
import { api } from '@/lib/api';

const CLOUDINARY_CLOUD_NAME = 'dnibj8za6'; 
const CLOUDINARY_PRESET = 'yasou70731';  

export default function NewProductPage() {
  const router = useRouter();
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isUploading, setIsUploading] = useState(false);

  const { register, control, handleSubmit, watch, setValue, getValues } = useForm({
    defaultValues: {
      name: '', sku: '', series: '', 
      images: [] as string[],
      basePrice: 0, requiresMeasurement: true,
      standardWidth: 90, standardHeight: 210,
      // ✨ 新增尺寸加價欄位預設值
      pricePerUnitWidth: 0,
      pricePerUnitHeight: 0,
      // ✨ 新增折數欄位預設值
      discountA: null,
      discountB: null,
      colors: [{ name: '標準黑', colorCode: '#000000', priceSurcharge: 0 }],
      materials: [{ name: '5mm 清玻', priceSurcharge: 0 }],
      openingOptions: [{ value: '左往右開' }, { value: '右往左開' }]
    }
  });

  const images = watch('images');
  const { fields: colorFields, append: appendColor, remove: removeColor } = useFieldArray({ control, name: 'colors' });
  const { fields: materialFields, append: appendMaterial, remove: removeMaterial } = useFieldArray({ control, name: 'materials' });
  const { fields: openingFields, append: appendOpening, remove: removeOpening } = useFieldArray({ control, name: 'openingOptions' });

  const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (!files || files.length === 0) return;

    setIsUploading(true);
    const currentImages = getValues('images') || [];
    const newImages = [...currentImages];

    try {
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_PRESET);

        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
          method: 'POST',
          body: formData,
        });
        
        const data = await res.json();
        if (data.secure_url) {
          newImages.push(data.secure_url);
        }
      }
      setValue('images', newImages);
    } catch (err) {
      console.error('上傳錯誤', err);
      alert('部分圖片上傳失敗！');
    } finally {
      setIsUploading(false);
    }
  };

  const removeImage = (indexToRemove: number) => {
    const currentImages = getValues('images');
    setValue('images', currentImages.filter((_, idx) => idx !== indexToRemove));
  };

  const onSubmit = async (data: any) => {
    setIsSubmitting(true);
    try {
      const payload = {
        ...data,
        // 如果輸入框是空的，轉為 null (代表使用系統預設)
        discountA: data.discountA ? Number(data.discountA) : null,
        discountB: data.discountB ? Number(data.discountB) : null,
        openingOptions: data.openingOptions.map((opt: any) => opt.value).filter((v: string) => v)
      };
      await api.post('/products', payload);
      alert('產品建立成功！');
      router.push('/products');
    } catch (error) {
      console.error(error);
      alert('建立失敗，請檢查後端連線');
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <div className="min-h-screen bg-gray-50 p-8 font-sans pb-20">
      <div className="max-w-4xl mx-auto flex items-center justify-between mb-8">
        <div className="flex items-center gap-4">
          <Link href="/products" className="p-2 hover:bg-white rounded-full transition-colors text-gray-500">
            <ArrowLeft className="w-6 h-6" />
          </Link>
          <div>
            <h1 className="text-2xl font-bold text-gray-900">新增產品</h1>
            <p className="text-sm text-gray-500">設定產品規格、價格與多張展示圖片</p>
          </div>
        </div>
        <button onClick={handleSubmit(onSubmit)} disabled={isSubmitting} className="flex items-center gap-2 px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md font-bold disabled:opacity-50 transition-all">
          <Save className="w-4 h-4" />
          {isSubmitting ? '儲存中...' : '儲存上架'}
        </button>
      </div>

      <div className="max-w-4xl mx-auto space-y-6">
        
        {/* 1. 基本資訊與圖片 */}
        <section className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <h2 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
            <div className="w-1 h-6 bg-blue-500 rounded-full"></div> 基本資訊
          </h2>
          <div className="grid grid-cols-2 gap-6">
            <div className="col-span-2">
              <label className="block text-sm font-medium text-gray-700 mb-1">產品名稱</label>
              <input {...register('name', { required: true })} className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
            </div>
            
            {/* 多圖上傳區 */}
            <div className="col-span-2">
              <label className="block text-sm font-medium text-gray-700 mb-2">產品圖片集 (可多選)</label>
              <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-4">
                {images.map((url, idx) => (
                  <div key={idx} className="relative group aspect-square bg-gray-100 rounded-lg overflow-hidden border border-gray-200">
                    {/* eslint-disable-next-line @next/next/no-img-element */}
                    <img src={url} alt={`Product ${idx}`} className="w-full h-full object-cover" />
                    <button 
                      type="button"
                      onClick={() => removeImage(idx)}
                      className="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity shadow-sm"
                    >
                      <X className="w-3 h-3" />
                    </button>
                    {idx === 0 && <span className="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-[10px] text-center py-1">封面圖</span>}
                  </div>
                ))}
                
                <label className="flex flex-col items-center justify-center aspect-square border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                  {isUploading ? <Loader2 className="w-6 h-6 text-gray-400 animate-spin" /> : <Plus className="w-6 h-6 text-gray-400" />}
                  <span className="text-xs text-gray-500 mt-1">{isUploading ? '上傳中' : '新增圖片'}</span>
                  <input type="file" className="hidden" accept="image/*" multiple onChange={handleImageUpload} disabled={isUploading} />
                </label>
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">產品型號 (SKU)</label>
              <input {...register('sku', { required: true })} className="w-full p-2 border border-gray-300 rounded-lg outline-none" />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">所屬系列</label>
              <input {...register('series', { required: true })} className="w-full p-2 border border-gray-300 rounded-lg outline-none" />
            </div>
          </div>
        </section>

        {/* 2. 價格與尺寸 */}
        <section className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <h2 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2"><div className="w-1 h-6 bg-green-500 rounded-full"></div> 價格與尺寸</h2>
          <div className="grid grid-cols-3 gap-6">
            <div><label className="block text-sm font-medium text-gray-700 mb-1">基礎價格</label><input type="number" {...register('basePrice', { valueAsNumber: true })} className="w-full p-2 border border-gray-300 rounded-lg outline-none" /></div>
            <div><label className="block text-sm font-medium text-gray-700 mb-1">標準寬度 (cm)</label><input type="number" {...register('standardWidth', { valueAsNumber: true })} className="w-full p-2 border border-gray-300 rounded-lg outline-none" /></div>
            <div><label className="block text-sm font-medium text-gray-700 mb-1">標準高度 (cm)</label><input type="number" {...register('standardHeight', { valueAsNumber: true })} className="w-full p-2 border border-gray-300 rounded-lg outline-none" /></div>
            
            {/* ✨ 新增：尺寸加價設定 */}
            <div className="bg-gray-50 p-3 rounded-lg border border-gray-200">
              <label className="block text-xs font-bold text-gray-500 mb-1">寬度每增 10cm 加價 ($)</label>
              <input type="number" {...register('pricePerUnitWidth', { valueAsNumber: true })} className="w-full p-1.5 border border-gray-300 rounded text-sm outline-none" placeholder="0" />
            </div>
            <div className="bg-gray-50 p-3 rounded-lg border border-gray-200">
              <label className="block text-xs font-bold text-gray-500 mb-1">高度每增 10cm 加價 ($)</label>
              <input type="number" {...register('pricePerUnitHeight', { valueAsNumber: true })} className="w-full p-1.5 border border-gray-300 rounded text-sm outline-none" placeholder="0" />
            </div>
            <div className="flex items-center justify-center p-3">
              <span className="text-xs text-gray-400">超過標準尺寸才計算</span>
            </div>

            <div className="col-span-3 flex items-center gap-2 p-3 bg-gray-50 rounded-lg"><input type="checkbox" {...register('requiresMeasurement')} className="w-4 h-4 text-blue-600" /><label className="text-sm text-gray-700">需丈量 (勾選後前台會顯示「丈量並加入購物車」按鈕)</label></div>
          </div>
        </section>

        {/* ✨✨✨ 3. B2B 特殊折數 (新增區塊) ✨✨✨ */}
        <section className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <h2 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2"><Percent className="w-5 h-5 text-yellow-500" /> B2B 會員個別折數 (選填)</h2>
          <div className="grid grid-cols-2 gap-6 bg-yellow-50 p-4 rounded-lg border border-yellow-100">
            <div>
              <label className="block text-sm font-bold text-yellow-800 mb-1">A 級會員折數</label>
              <input 
                type="number" 
                step="0.01" 
                placeholder="預設 (空白)" 
                {...register('discountA')} 
                className="w-full p-2 border border-yellow-200 rounded-lg outline-none focus:ring-2 focus:ring-yellow-400 bg-white" 
              />
              <p className="text-xs text-yellow-600 mt-1">例如：0.8 代表 8 折。若留空則使用系統統一設定。</p>
            </div>
            <div>
              <label className="block text-sm font-bold text-yellow-800 mb-1">B 級會員折數</label>
              <input 
                type="number" 
                step="0.01" 
                placeholder="預設 (空白)" 
                {...register('discountB')} 
                className="w-full p-2 border border-yellow-200 rounded-lg outline-none focus:ring-2 focus:ring-yellow-400 bg-white" 
              />
              <p className="text-xs text-yellow-600 mt-1">例如：0.9 代表 9 折。</p>
            </div>
          </div>
        </section>

        {/* 4. 開門方向 */}
        <section className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <div className="flex justify-between mb-4"><h2 className="text-lg font-bold text-gray-900 flex items-center gap-2"><MoveHorizontal className="w-5 h-5" /> 開門方向</h2><button type="button" onClick={() => appendOpening({ value: '' })} className="text-blue-600 text-sm flex items-center"><Plus className="w-4 h-4" /> 新增</button></div>
          <div className="grid grid-cols-2 gap-3">{openingFields.map((f, i) => (<div key={f.id} className="flex gap-2 items-center bg-gray-50 p-2 rounded-lg border"><input {...register(`openingOptions.${i}.value`)} className="flex-1 bg-transparent outline-none text-sm" /><button type="button" onClick={() => removeOpening(i)} className="text-gray-400 hover:text-red-500"><Trash2 className="w-4 h-4" /></button></div>))}</div>
        </section>
        
        {/* 5. 顏色 */}
        <section className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <div className="flex justify-between mb-4"><h2 className="text-lg font-bold text-gray-900 flex items-center gap-2"><Palette className="w-5 h-5" /> 顏色</h2><button type="button" onClick={() => appendColor({ name: '', colorCode: '#000000', priceSurcharge: 0 })} className="text-blue-600 text-sm flex items-center"><Plus className="w-4 h-4" /> 新增</button></div>
          <div className="space-y-3">{colorFields.map((f, i) => (<div key={f.id} className="flex gap-3 items-end bg-gray-50 p-3 rounded-lg"><div className="flex-1"><input {...register(`colors.${i}.name`)} className="w-full p-2 border rounded text-sm" placeholder="名稱" /></div><div className="w-24"><input type="color" {...register(`colors.${i}.colorCode`)} className="h-9 w-9 border rounded cursor-pointer" /></div><div className="w-32"><input type="number" {...register(`colors.${i}.priceSurcharge`, { valueAsNumber: true })} className="w-full p-2 border rounded text-sm" placeholder="加價" /></div><button type="button" onClick={() => removeColor(i)} className="text-gray-400 hover:text-red-500"><Trash2 className="w-4 h-4" /></button></div>))}</div>
        </section>
        
        {/* 6. 材質 */}
        <section className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <div className="flex justify-between mb-4"><h2 className="text-lg font-bold text-gray-900 flex items-center gap-2"><Layers className="w-5 h-5" /> 材質</h2><button type="button" onClick={() => appendMaterial({ name: '', priceSurcharge: 0 })} className="text-blue-600 text-sm flex items-center"><Plus className="w-4 h-4" /> 新增</button></div>
          <div className="space-y-3">{materialFields.map((f, i) => (<div key={f.id} className="flex gap-3 items-end bg-gray-50 p-3 rounded-lg"><div className="flex-1"><input {...register(`materials.${i}.name`)} className="w-full p-2 border rounded text-sm" placeholder="名稱" /></div><div className="w-32"><input type="number" {...register(`materials.${i}.priceSurcharge`, { valueAsNumber: true })} className="w-full p-2 border rounded text-sm" placeholder="加價" /></div><button type="button" onClick={() => removeMaterial(i)} className="text-gray-400 hover:text-red-500"><Trash2 className="w-4 h-4" /></button></div>))}</div>
        </section>

      </div>
    </div>
  );
}
</file>

<file path="admin/src/components/LayoutShell.tsx">
'use client';

import { usePathname } from 'next/navigation';
import Sidebar from "@/components/Sidebar";

export default function LayoutShell({ children }: { children: React.ReactNode }) {
  const pathname = usePathname();

  // 定義「不需要側邊欄」的頁面
  // 包含登入頁、以及所有列印頁面
  const isFullScreenPage = 
    pathname === '/login' || 
    pathname.includes('/print');

  if (isFullScreenPage) {
    // 全螢幕模式 (只有內容，沒有 Sidebar)
    return <div className="w-full h-full">{children}</div>;
  }

  // 一般後台模式 (有 Sidebar)
  return (
    <div className="flex min-h-screen font-sans">
      <Sidebar />
      <div className="flex-1 md:ml-64 transition-all duration-300">
        {children}
      </div>
    </div>
  );
}
</file>

<file path="admin/tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}
</file>

<file path="backend/.gitignore">
# compiled output
/dist
/node_modules
/build

# Logs
logs
*.log
npm-debug.log*
pnpm-debug.log*
yarn-debug.log*
yarn-error.log*
lerna-debug.log*

# OS
.DS_Store

# Tests
/coverage
/.nyc_output

# IDEs and editors
/.idea
.project
.classpath
.c9/
*.launch
.settings/
*.sublime-workspace

# IDE - VSCode
.vscode/*
!.vscode/settings.json
!.vscode/tasks.json
!.vscode/launch.json
!.vscode/extensions.json

# dotenv environment variable files
.env
.env.development.local
.env.test.local
.env.production.local
.env.local

# temp directory
.temp
.tmp

# Runtime data
pids
*.pid
*.seed
*.pid.lock

# Diagnostic reports (https://nodejs.org/api/report.html)
report.[0-9]*.[0-9]*.[0-9]*.[0-9]*.json
</file>

<file path="backend/.prettierrc">
{
  "singleQuote": true,
  "trailingComma": "all"
}
</file>

<file path="backend/eslint.config.mjs">
// @ts-check
import eslint from '@eslint/js';
import eslintPluginPrettierRecommended from 'eslint-plugin-prettier/recommended';
import globals from 'globals';
import tseslint from 'typescript-eslint';

export default tseslint.config(
  {
    ignores: ['eslint.config.mjs'],
  },
  eslint.configs.recommended,
  ...tseslint.configs.recommendedTypeChecked,
  eslintPluginPrettierRecommended,
  {
    languageOptions: {
      globals: {
        ...globals.node,
        ...globals.jest,
      },
      sourceType: 'commonjs',
      parserOptions: {
        projectService: true,
        tsconfigRootDir: import.meta.dirname,
      },
    },
  },
  {
    rules: {
      '@typescript-eslint/no-explicit-any': 'off',
      '@typescript-eslint/no-floating-promises': 'warn',
      '@typescript-eslint/no-unsafe-argument': 'warn',
      "prettier/prettier": ["error", { endOfLine: "auto" }],
    },
  },
);
</file>

<file path="backend/nest-cli.json">
{
  "$schema": "https://json.schemastore.org/nest-cli",
  "collection": "@nestjs/schematics",
  "sourceRoot": "src",
  "compilerOptions": {
    "deleteOutDir": true
  }
}
</file>

<file path="backend/README.md">
<p align="center">
  <a href="http://nestjs.com/" target="blank"><img src="https://nestjs.com/img/logo-small.svg" width="120" alt="Nest Logo" /></a>
</p>

[circleci-image]: https://img.shields.io/circleci/build/github/nestjs/nest/master?token=abc123def456
[circleci-url]: https://circleci.com/gh/nestjs/nest

  <p align="center">A progressive <a href="http://nodejs.org" target="_blank">Node.js</a> framework for building efficient and scalable server-side applications.</p>
    <p align="center">
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/v/@nestjs/core.svg" alt="NPM Version" /></a>
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/l/@nestjs/core.svg" alt="Package License" /></a>
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/dm/@nestjs/common.svg" alt="NPM Downloads" /></a>
<a href="https://circleci.com/gh/nestjs/nest" target="_blank"><img src="https://img.shields.io/circleci/build/github/nestjs/nest/master" alt="CircleCI" /></a>
<a href="https://discord.gg/G7Qnnhy" target="_blank"><img src="https://img.shields.io/badge/discord-online-brightgreen.svg" alt="Discord"/></a>
<a href="https://opencollective.com/nest#backer" target="_blank"><img src="https://opencollective.com/nest/backers/badge.svg" alt="Backers on Open Collective" /></a>
<a href="https://opencollective.com/nest#sponsor" target="_blank"><img src="https://opencollective.com/nest/sponsors/badge.svg" alt="Sponsors on Open Collective" /></a>
  <a href="https://paypal.me/kamilmysliwiec" target="_blank"><img src="https://img.shields.io/badge/Donate-PayPal-ff3f59.svg" alt="Donate us"/></a>
    <a href="https://opencollective.com/nest#sponsor"  target="_blank"><img src="https://img.shields.io/badge/Support%20us-Open%20Collective-41B883.svg" alt="Support us"></a>
  <a href="https://twitter.com/nestframework" target="_blank"><img src="https://img.shields.io/twitter/follow/nestframework.svg?style=social&label=Follow" alt="Follow us on Twitter"></a>
</p>
  <!--[![Backers on Open Collective](https://opencollective.com/nest/backers/badge.svg)](https://opencollective.com/nest#backer)
  [![Sponsors on Open Collective](https://opencollective.com/nest/sponsors/badge.svg)](https://opencollective.com/nest#sponsor)-->

## Description

[Nest](https://github.com/nestjs/nest) framework TypeScript starter repository.

## Project setup

```bash
$ npm install
```

## Compile and run the project

```bash
# development
$ npm run start

# watch mode
$ npm run start:dev

# production mode
$ npm run start:prod
```

## Run tests

```bash
# unit tests
$ npm run test

# e2e tests
$ npm run test:e2e

# test coverage
$ npm run test:cov
```

## Deployment

When you're ready to deploy your NestJS application to production, there are some key steps you can take to ensure it runs as efficiently as possible. Check out the [deployment documentation](https://docs.nestjs.com/deployment) for more information.

If you are looking for a cloud-based platform to deploy your NestJS application, check out [Mau](https://mau.nestjs.com), our official platform for deploying NestJS applications on AWS. Mau makes deployment straightforward and fast, requiring just a few simple steps:

```bash
$ npm install -g @nestjs/mau
$ mau deploy
```

With Mau, you can deploy your application in just a few clicks, allowing you to focus on building features rather than managing infrastructure.

## Resources

Check out a few resources that may come in handy when working with NestJS:

- Visit the [NestJS Documentation](https://docs.nestjs.com) to learn more about the framework.
- For questions and support, please visit our [Discord channel](https://discord.gg/G7Qnnhy).
- To dive deeper and get more hands-on experience, check out our official video [courses](https://courses.nestjs.com/).
- Deploy your application to AWS with the help of [NestJS Mau](https://mau.nestjs.com) in just a few clicks.
- Visualize your application graph and interact with the NestJS application in real-time using [NestJS Devtools](https://devtools.nestjs.com).
- Need help with your project (part-time to full-time)? Check out our official [enterprise support](https://enterprise.nestjs.com).
- To stay in the loop and get updates, follow us on [X](https://x.com/nestframework) and [LinkedIn](https://linkedin.com/company/nestjs).
- Looking for a job, or have a job to offer? Check out our official [Jobs board](https://jobs.nestjs.com).

## Support

Nest is an MIT-licensed open source project. It can grow thanks to the sponsors and support by the amazing backers. If you'd like to join them, please [read more here](https://docs.nestjs.com/support).

## Stay in touch

- Author - [Kamil Myśliwiec](https://twitter.com/kammysliwiec)
- Website - [https://nestjs.com](https://nestjs.com/)
- Twitter - [@nestframework](https://twitter.com/nestframework)

## License

Nest is [MIT licensed](https://github.com/nestjs/nest/blob/master/LICENSE).
</file>

<file path="backend/src/announcements/announcements.controller.ts">
import { Controller, Get, Post, Patch, Delete, Body, Param } from '@nestjs/common';
import { AnnouncementsService } from './announcements.service';

@Controller('announcements')
export class AnnouncementsController { // ✨ 確認這裡有 export
  constructor(private readonly service: AnnouncementsService) {}

  // 1. 前台抓取最新公告
  @Get('active')
  findActive() {
    return this.service.findActive();
  }

  // 2. 後台列表
  @Get()
  findAll() {
    return this.service.findAll();
  }

  // 3. 新增
  @Post()
  create(@Body() body: { content: string }) {
    return this.service.create(body.content);
  }

  // 4. 切換狀態
  @Patch(':id')
  update(@Param('id') id: string, @Body() body: { isActive: boolean }) {
    return this.service.toggle(id, body.isActive);
  }

  // 5. 刪除
  @Delete(':id')
  remove(@Param('id') id: string) {
    return this.service.remove(id);
  }
}
</file>

<file path="backend/src/announcements/announcements.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { AnnouncementsService } from './announcements.service';
import { AnnouncementsController } from './announcements.controller';
import { Announcement } from './entities/announcement.entity';

@Module({
  imports: [TypeOrmModule.forFeature([Announcement])],
  controllers: [AnnouncementsController],
  providers: [AnnouncementsService],
})
export class AnnouncementsModule {}
</file>

<file path="backend/src/announcements/announcements.service.ts">
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Announcement } from './entities/announcement.entity';

@Injectable()
export class AnnouncementsService {
  constructor(
    @InjectRepository(Announcement)
    private repo: Repository<Announcement>,
  ) {}

  // 1. 建立公告
  create(content: string) {
    const announcement = this.repo.create({ content, isActive: true }); // 預設啟用
    return this.repo.save(announcement);
  }

  // 2. 查詢所有 (後台用)
  findAll() {
    return this.repo.find({ order: { createdAt: 'DESC' } });
  }

  // 3. 查詢「目前啟用」的公告 (前台用) - 只抓最新的一筆
  async findActive() {
    return this.repo.findOne({
      where: { isActive: true },
      order: { createdAt: 'DESC' },
    });
  }

  // 4. 切換狀態 (開/關)
  async toggle(id: string, isActive: boolean) {
    await this.repo.update(id, { isActive });
    return this.repo.findOneBy({ id });
  }

  // 5. 刪除
  remove(id: string) {
    return this.repo.delete(id);
  }
}
</file>

<file path="backend/src/announcements/dto/create-announcement.dto.ts">
export class CreateAnnouncementDto {}
</file>

<file path="backend/src/announcements/dto/update-announcement.dto.ts">
import { PartialType } from '@nestjs/mapped-types';
import { CreateAnnouncementDto } from './create-announcement.dto';

export class UpdateAnnouncementDto extends PartialType(CreateAnnouncementDto) {}
</file>

<file path="backend/src/announcements/entities/announcement.entity.ts">
import { Entity, Column, PrimaryGeneratedColumn, CreateDateColumn } from 'typeorm';

@Entity()
export class Announcement {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  content: string; // 公告內容

  @Column({ default: false })
  isActive: boolean; // 是否啟用 (顯示在前台)

  @CreateDateColumn()
  createdAt: Date;
}
</file>

<file path="backend/src/app.controller.spec.ts">
import { Test, TestingModule } from '@nestjs/testing';
import { AppController } from './app.controller';
import { AppService } from './app.service';

describe('AppController', () => {
  let appController: AppController;

  beforeEach(async () => {
    const app: TestingModule = await Test.createTestingModule({
      controllers: [AppController],
      providers: [AppService],
    }).compile();

    appController = app.get<AppController>(AppController);
  });

  describe('root', () => {
    it('should return "Hello World!"', () => {
      expect(appController.getHello()).toBe('Hello World!');
    });
  });
});
</file>

<file path="backend/src/app.controller.ts">
import { Controller, Get } from '@nestjs/common';
import { AppService } from './app.service';

@Controller()
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get()
  getHello(): string {
    return this.appService.getHello();
  }
}
</file>

<file path="backend/src/app.service.ts">
import { Injectable } from '@nestjs/common';

@Injectable()
export class AppService {
  getHello(): string {
    return 'Hello World!';
  }
}
</file>

<file path="backend/src/auth/auth.controller.ts">
import { Controller, Post, Body, UnauthorizedException } from '@nestjs/common';
import { AuthService } from './auth.service';

@Controller('auth')
export class AuthController {
  constructor(private readonly authService: AuthService) {}

  @Post('login')
  async login(@Body() body: any) {
    // 1. 驗證帳號密碼
    const user = await this.authService.validateUser(body.email, body.password);
    
    if (!user) {
      throw new UnauthorizedException('帳號或密碼錯誤');
    }

    // 2. 發放 Token
    return this.authService.login(user);
  }
}
</file>

<file path="backend/src/auth/auth.module.ts">
import { Module } from '@nestjs/common';
import { AuthService } from './auth.service';
import { AuthController } from './auth.controller';
import { UsersModule } from '../users/users.module';
import { JwtModule } from '@nestjs/jwt';
import { ConfigModule, ConfigService } from '@nestjs/config'; // 確保引入 ConfigModule
import { JwtStrategy } from './jwt.strategy';

@Module({
  imports: [
    ConfigModule, // ✨ 關鍵修正：這裡必須明確匯入 ConfigModule，JwtStrategy 才讀得到
    UsersModule,
    JwtModule.registerAsync({
      imports: [ConfigModule],
      useFactory: async (configService: ConfigService) => ({
        secret: configService.get<string>('JWT_SECRET'),
        signOptions: { expiresIn: '1d' },
      }),
      inject: [ConfigService],
    }),
  ],
  controllers: [AuthController],
  providers: [AuthService, JwtStrategy],
})
export class AuthModule {}
</file>

<file path="backend/src/auth/entities/auth.entity.ts">
export class Auth {}
</file>

<file path="backend/src/auth/jwt-auth.guard.ts">
import { Injectable } from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport';

@Injectable()
export class JwtAuthGuard extends AuthGuard('jwt') {}
</file>

<file path="backend/src/main.ts">
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  
  // 🔍 診斷監視器：印出目前讀到的資料庫網址 (只印前 20 個字，保護密碼)
  const dbUrl = process.env.DATABASE_URL;
  console.log('------------------------------------------------');
  console.log('🔍 診斷檢查中...');
  console.log('資料庫網址讀取狀態:', dbUrl ? '✅ 讀到了' : '❌ 是空的 (undefined)');
  if (dbUrl) {
    console.log('網址開頭:', dbUrl.substring(0, 25) + '...');
  }
  console.log('------------------------------------------------');

  app.enableCors();
  await app.listen(4000);
}
bootstrap();
</file>

<file path="backend/src/notifications/notifications.module.ts">
import { Module } from '@nestjs/common';
import { NotificationsService } from './notifications.service';

@Module({
  providers: [NotificationsService],
  // ✨ 關鍵修正：必須把 Service 匯出，別的模組才看得到！
  exports: [NotificationsService], 
})
export class NotificationsModule {}
</file>

<file path="backend/src/notifications/notifications.service.spec.ts">
import { Test, TestingModule } from '@nestjs/testing';
import { NotificationsService } from './notifications.service';

describe('NotificationsService', () => {
  let service: NotificationsService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [NotificationsService],
    }).compile();

    service = module.get<NotificationsService>(NotificationsService);
  });

  it('should be defined', () => {
    expect(service).toBeDefined();
  });
});
</file>

<file path="backend/src/notifications/notifications.service.ts">
import { Injectable } from '@nestjs/common';
import * as nodemailer from 'nodemailer';
import axios from 'axios';

@Injectable()
export class NotificationsService {
  // 1. 寄送 Email (給經銷商)
  async sendEmail(to: string, subject: string, text: string) {
    // TODO: 階段二會在這裡填入真的 Gmail/Resend 設定
    // 目前先用 console.log 模擬
    console.log('=================================================');
    console.log('📧 [模擬寄信] 準備發送 Email...');
    console.log(`收件人: ${to}`);
    console.log(`主旨: ${subject}`);
    console.log(`內容: ${text}`);
    console.log('=================================================');
    
    // 假裝發送成功
    return true;
  }

  // 2. 發送 Line Notify (給工廠管理員)
  async sendLineNotify(message: string) {
    // TODO: 階段二會在這裡填入 Line Token
    // 目前先用 console.log 模擬
    console.log('=================================================');
    console.log('🔔 [模擬 Line] 準備發送通知給管理員...');
    console.log(`訊息: ${message}`);
    console.log('=================================================');

    /* 真實程式碼預留區 (等拿到 Token 解開註解即可)
    const token = process.env.LINE_NOTIFY_TOKEN;
    if (token) {
      await axios.post(
        'https://notify-api.line.me/api/notify',
        `message=${encodeURIComponent(message)}`,
        { headers: { Authorization: `Bearer ${token}` } }
      );
    }
    */
    return true;
  }
}
</file>

<file path="backend/src/products/dto/create-product.dto.ts">
export class CreateProductDto {}
</file>

<file path="backend/src/products/dto/update-product.dto.ts">
import { PartialType } from '@nestjs/mapped-types';
import { CreateProductDto } from './create-product.dto';

export class UpdateProductDto extends PartialType(CreateProductDto) {}
</file>

<file path="backend/src/products/entities/product.entity.ts">
import { Entity, Column, PrimaryGeneratedColumn, CreateDateColumn, UpdateDateColumn } from 'typeorm';

export class ProductOption {
  name: string;
  priceSurcharge: number; 
}

@Entity()
export class Product {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  name: string;  

  @Column()
  sku: string;   

  @Column()
  series: string; 

  @Column({ type: 'jsonb', nullable: true }) 
  images: string[]; 

  @Column({ type: 'decimal', precision: 10, scale: 2 })
  basePrice: number; 

  @Column({ type: 'decimal', precision: 10, scale: 2, default: 0 })
  assemblyFee: number; 

  @Column({ type: 'decimal', precision: 5, scale: 2, nullable: true })
  discountA: number; 

  @Column({ type: 'decimal', precision: 5, scale: 2, nullable: true })
  discountB: number; 

  @Column({ type: 'int', default: 90 })
  standardWidth: number;  

  @Column({ type: 'int', default: 210 })
  standardHeight: number; 

  @Column({ type: 'int', default: 0 })
  pricePerUnitWidth: number; 

  @Column({ type: 'int', default: 0 })
  pricePerUnitHeight: number; 

  @Column({ default: true })
  requiresMeasurement: boolean; 
  
  @Column({ type: 'jsonb', nullable: true })
  colors: ProductOption[];

  @Column({ type: 'jsonb', nullable: true })
  materials: ProductOption[];

  // ✨✨✨ 新增：把手選項 ✨✨✨
  @Column({ type: 'jsonb', nullable: true })
  handles: ProductOption[];

  @Column({ type: 'jsonb', nullable: true })
  openingOptions: string[];

  @Column({ default: true })
  isActive: boolean; 

  @CreateDateColumn()
  createdAt: Date;

  @UpdateDateColumn()
  updatedAt: Date;
}
</file>

<file path="backend/src/products/products.controller.ts">
import { Controller, Get, Post, Body, Param, Patch, Delete } from '@nestjs/common'; // ✨ 記得引入 Patch, Delete
import { ProductsService } from './products.service';

@Controller('products')
export class ProductsController {
  constructor(private readonly productsService: ProductsService) {}

  @Post()
  create(@Body() createProductDto: any) {
    return this.productsService.create(createProductDto);
  }

  @Get()
  findAll() {
    return this.productsService.findAll();
  }

  @Get(':id')
  findOne(@Param('id') id: string) {
    return this.productsService.findOne(id);
  }

  // ✨ 新增：更新 API (PATCH)
  @Patch(':id')
  update(@Param('id') id: string, @Body() updateProductDto: any) {
    return this.productsService.update(id, updateProductDto);
  }

  // ✨ 新增：刪除 API (DELETE)
  @Delete(':id')
  remove(@Param('id') id: string) {
    return this.productsService.remove(id);
  }
}
</file>

<file path="backend/src/products/products.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { ProductsService } from './products.service';
import { ProductsController } from './products.controller';
import { Product } from './entities/product.entity';

@Module({
  imports: [
    // ✨ 關鍵修正：註冊 Product 實體，讓 TypeORM 認識它
    TypeOrmModule.forFeature([Product]),
  ],
  controllers: [ProductsController],
  providers: [ProductsService],
  exports: [ProductsService], // 匯出 Service，以防之後 Order 需要查產品
})
export class ProductsModule {}
</file>

<file path="backend/src/products/products.service.ts">
import { Injectable, NotFoundException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Product } from './entities/product.entity';

@Injectable()
export class ProductsService {
  constructor(
    @InjectRepository(Product)
    private productsRepository: Repository<Product>,
  ) {}

  // 1. 建立產品
  create(createProductDto: any) {
    const product = this.productsRepository.create(createProductDto);
    return this.productsRepository.save(product);
  }

  // 2. 查詢所有產品
  findAll() {
    return this.productsRepository.find({ order: { createdAt: 'DESC' } });
  }

  // 3. 查詢單一產品
  findOne(id: string) {
    return this.productsRepository.findOneBy({ id });
  }

  // ✨ 4. 更新產品 (修復 500 錯誤版)
  async update(id: string, updateProductDto: any) {
    // 🔍 除錯用：印出收到什麼資料
    console.log('👉 [Backend] 收到更新請求 ID:', id);
    console.log('📦 [Backend] 原始資料:', JSON.stringify(updateProductDto));

    // 🛑 強制移除不可更新的系統欄位 (由後端把關最安全)
    delete updateProductDto.id;
    delete updateProductDto.createdAt;
    delete updateProductDto.updatedAt;

    // 確保數值欄位真的是數字 (防止前端傳來字串導致資料庫報錯)
    if (updateProductDto.basePrice) updateProductDto.basePrice = Number(updateProductDto.basePrice);
    if (updateProductDto.standardWidth) updateProductDto.standardWidth = Number(updateProductDto.standardWidth);
    if (updateProductDto.standardHeight) updateProductDto.standardHeight = Number(updateProductDto.standardHeight);

    try {
      // 執行更新
      await this.productsRepository.update(id, updateProductDto);
      
      console.log('✅ [Backend] 更新成功');
      return this.productsRepository.findOneBy({ id });
    } catch (error) {
      console.error('❌ [Backend] 更新失敗 (SQL Error):', error);
      // 這裡不 throw，讓 Controller 捕捉或是回傳更具體的錯誤
      throw error;
    }
  }

  // 5. 刪除產品
  async remove(id: string) {
    await this.productsRepository.delete(id);
    return { deleted: true };
  }
}
</file>

<file path="backend/src/reports/dto/create-report.dto.ts">
export class CreateReportDto {}
</file>

<file path="backend/src/reports/dto/update-report.dto.ts">
import { PartialType } from '@nestjs/mapped-types';
import { CreateReportDto } from './create-report.dto';

export class UpdateReportDto extends PartialType(CreateReportDto) {}
</file>

<file path="backend/src/reports/entities/report.entity.ts">
export class Report {}
</file>

<file path="backend/src/reports/reports.controller.ts">
import { Controller, Get } from '@nestjs/common';
import { ReportsService } from './reports.service';

@Controller('reports')
export class ReportsController {
  constructor(private readonly reportsService: ReportsService) {}

  @Get('dashboard')
  getStats() {
    return this.reportsService.getDashboardStats();
  }
}
</file>

<file path="backend/src/reports/reports.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { ReportsService } from './reports.service';
import { ReportsController } from './reports.controller';
import { Order } from '../orders/entities/order.entity'; // 引入 Order

@Module({
  imports: [TypeOrmModule.forFeature([Order])], // 記得註冊 Order 實體
  controllers: [ReportsController],
  providers: [ReportsService],
})
export class ReportsModule {}
</file>

<file path="backend/src/series/dto/create-series.dto.ts">
export class CreateSeriesDto {}
</file>

<file path="backend/src/series/dto/update-series.dto.ts">
import { PartialType } from '@nestjs/mapped-types';
import { CreateSeriesDto } from './create-series.dto';

export class UpdateSeriesDto extends PartialType(CreateSeriesDto) {}
</file>

<file path="backend/src/series/entities/series.entity.ts">
import { Entity, Column, PrimaryGeneratedColumn } from 'typeorm';

@Entity()
export class Series {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ unique: true })
  name: string; // 識別名稱 (例如：極簡系列)，這會跟產品的 series 欄位對應

  @Column()
  displayName: string; // 前台顯示的標題 (例如：極簡細框系列)

  @Column()
  description: string; // 描述 (例如：Modern Slim)

  @Column()
  imageUrl: string; // 封面圖網址

  @Column({ type: 'int', default: 0 })
  priceStart: number; // 起始價格

  @Column({ default: true })
  isActive: boolean; // 是否顯示
}
</file>

<file path="backend/src/series/series.controller.ts">
import { Controller, Get, Post, Body, Patch, Param, Delete } from '@nestjs/common';
import { SeriesService } from './series.service';

@Controller('series')
export class SeriesController {
  constructor(private readonly seriesService: SeriesService) {}

  @Post()
  create(@Body() body: any) { return this.seriesService.create(body); }

  @Get()
  findAll() { return this.seriesService.findAll(); }

  @Get(':id')
  findOne(@Param('id') id: string) { return this.seriesService.findOne(id); }

  @Patch(':id')
  update(@Param('id') id: string, @Body() body: any) { return this.seriesService.update(id, body); }

  @Delete(':id')
  remove(@Param('id') id: string) { return this.seriesService.remove(id); }
}
</file>

<file path="backend/src/series/series.module.ts">
import { Module, OnModuleInit } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { SeriesService } from './series.service';
import { SeriesController } from './series.controller';
import { Series } from './entities/series.entity';

@Module({
  imports: [TypeOrmModule.forFeature([Series])],
  controllers: [SeriesController],
  providers: [SeriesService],
})
export class SeriesModule implements OnModuleInit {
  constructor(private readonly service: SeriesService) {}
  
  // ✨ 啟動時自動建立預設系列資料 (避免前台空空的)
  async onModuleInit() {
    await this.service.initDefaults();
  }
}
</file>

<file path="backend/src/series/series.service.ts">
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Series } from './entities/series.entity';

@Injectable()
export class SeriesService {
  constructor(
    @InjectRepository(Series)
    private repo: Repository<Series>,
  ) {}

  create(data: any) {
    const series = this.repo.create(data);
    return this.repo.save(series);
  }

  findAll() {
    return this.repo.find({ order: { name: 'ASC' } });
  }

  findOne(id: string) {
    return this.repo.findOneBy({ id });
  }

  async update(id: string, data: any) {
    await this.repo.update(id, data);
    return this.repo.findOneBy({ id });
  }

  remove(id: string) {
    return this.repo.delete(id);
  }

  // 初始化預設系列 (懶人包)
  async initDefaults() {
    const count = await this.repo.count();
    if (count === 0) {
      const defaults = [
        { name: '極簡系列', displayName: '極簡細框系列', description: 'Modern Slim', priceStart: 5000, imageUrl: 'https://images.unsplash.com/photo-1600607686527-6fb886090705?auto=format&fit=crop&q=80&w=800' },
        { name: '經典系列', displayName: '經典寬框系列', description: 'Classic Bold', priceStart: 4500, imageUrl: 'https://images.unsplash.com/photo-1584622050111-993a426fbf0a?auto=format&fit=crop&q=80&w=800' },
        { name: '淋浴系列', displayName: '淋浴拉門系列', description: 'Shower Doors', priceStart: 8000, imageUrl: 'https://images.unsplash.com/photo-1631679706909-1844bbd07221?auto=format&fit=crop&q=80&w=800' },
        { name: '懸浮系列', displayName: '懸浮無軌系列', description: 'Magnetic Levitation', priceStart: 12000, imageUrl: 'https://images.unsplash.com/photo-1486946255434-2466348c2166?auto=format&fit=crop&q=80&w=800' },
      ];
      for (const s of defaults) await this.repo.save(this.repo.create(s));
    }
  }
}
</file>

<file path="backend/src/users/entities/trade-category.entity.ts">
import { Entity, Column, PrimaryGeneratedColumn } from 'typeorm';

@Entity()
export class TradeCategory {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  name: string; // 顯示名稱 (e.g. 專業玻璃行)

  @Column({ unique: true })
  code: string; // 代碼 (e.g. glass)

  @Column({ default: false })
  isUpgradeable: boolean; // 能否升級 B 級

  // ✨ 新增：該行業別的預設折數 (1.0 = 原價, 0.7 = 7折)
  @Column({ type: 'decimal', precision: 5, scale: 2, default: 1.0 })
  discountRate: number;
}
</file>

<file path="backend/src/users/trade-categories.controller.ts">
import { Controller, Get, Post, Patch, Delete, Body, Param } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { TradeCategory } from './entities/trade-category.entity';

@Controller('trade-categories')
export class TradeCategoriesController {
  constructor(
    @InjectRepository(TradeCategory)
    private repo: Repository<TradeCategory>,
  ) {}

  @Get()
  findAll() {
    return this.repo.find({ order: { id: 'ASC' } });
  }

  // 新增時接收 discountRate
  @Post()
  create(@Body() body: { name: string; code: string; isUpgradeable: boolean; discountRate: number }) {
    const category = this.repo.create({
      ...body,
      discountRate: body.discountRate || 1.0 // 預設原價
    });
    return this.repo.save(category);
  }

  // 修改時接收 discountRate
  @Patch(':id')
  async update(@Param('id') id: string, @Body() body: { isUpgradeable?: boolean; discountRate?: number }) {
    await this.repo.update(id, body);
    return this.repo.findOneBy({ id });
  }

  @Delete(':id')
  delete(@Param('id') id: string) {
    return this.repo.delete(id);
  }
}
</file>

<file path="backend/src/users/users.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { UsersService } from './users.service';
import { UsersController } from './users.controller';
import { TradeCategoriesController } from './trade-categories.controller'; 
import { User } from './entities/user.entity';
import { DealerProfile } from './entities/dealer-profile.entity';
import { TradeCategory } from './entities/trade-category.entity';
import { NotificationsModule } from '../notifications/notifications.module';
// ✨ 修正：路徑改為 ../cart (原本是 ../../cart)
import { CartItem } from '../cart/entities/cart-item.entity';

@Module({
  imports: [
    // 將 CartItem 加入 forFeature
    TypeOrmModule.forFeature([User, DealerProfile, TradeCategory, CartItem]),
    NotificationsModule,
  ],
  controllers: [
    UsersController, 
    TradeCategoriesController 
  ],
  providers: [UsersService],
  exports: [UsersService], 
})
export class UsersModule {}
</file>

<file path="backend/test/app.e2e-spec.ts">
import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication } from '@nestjs/common';
import request from 'supertest';
import { App } from 'supertest/types';
import { AppModule } from './../src/app.module';

describe('AppController (e2e)', () => {
  let app: INestApplication<App>;

  beforeEach(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    await app.init();
  });

  it('/ (GET)', () => {
    return request(app.getHttpServer())
      .get('/')
      .expect(200)
      .expect('Hello World!');
  });
});
</file>

<file path="backend/test/jest-e2e.json">
{
  "moduleFileExtensions": ["js", "json", "ts"],
  "rootDir": ".",
  "testEnvironment": "node",
  "testRegex": ".e2e-spec.ts$",
  "transform": {
    "^.+\\.(t|j)s$": "ts-jest"
  }
}
</file>

<file path="backend/tsconfig.build.json">
{
  "extends": "./tsconfig.json",
  "exclude": ["node_modules", "test", "dist", "**/*spec.ts"]
}
</file>

<file path="backend/tsconfig.json">
{
  "compilerOptions": {
    "module": "nodenext",
    "moduleResolution": "nodenext",
    "resolvePackageJsonExports": true,
    "esModuleInterop": true,
    "isolatedModules": true,
    "declaration": true,
    "removeComments": true,
    "emitDecoratorMetadata": true,
    "experimentalDecorators": true,
    "allowSyntheticDefaultImports": true,
    "target": "ES2023",
    "sourceMap": true,
    "outDir": "./dist",
    "baseUrl": "./",
    "incremental": true,
    "skipLibCheck": true,
    "strictNullChecks": true,
    "forceConsistentCasingInFileNames": true,
    "noImplicitAny": false,
    "strictBindCallApply": false,
    "noFallthroughCasesInSwitch": false
  }
}
</file>

<file path="frontend/.gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="frontend/eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="frontend/next.config.ts">
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
};

export default nextConfig;
</file>

<file path="frontend/package.json">
{
  "name": "frontend",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@hookform/resolvers": "^5.2.2",
    "axios": "^1.13.2",
    "clsx": "^2.1.1",
    "lucide-react": "^0.554.0",
    "next": "16.0.3",
    "react": "19.2.0",
    "react-dom": "19.2.0",
    "react-hook-form": "^7.66.1",
    "tailwind-merge": "^3.4.0",
    "zod": "^4.1.12"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "16.0.3",
    "tailwindcss": "^4",
    "typescript": "^5"
  }
}
</file>

<file path="frontend/postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="frontend/public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="frontend/public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="frontend/public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="frontend/public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="frontend/public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="frontend/README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="frontend/src/app/globals.css">
@import "tailwindcss";
</file>

<file path="frontend/src/app/login/page.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { api } from '@/lib/api';
import { Loader2, Lock, Mail, AlertCircle } from 'lucide-react';
import Link from 'next/link';

export default function LoginPage() {
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(false);
  const [errorMsg, setErrorMsg] = useState<string | null>(null);
  
  // ✨ 新增：記住我狀態
  const [rememberMe, setRememberMe] = useState(false);
  
  const [formData, setFormData] = useState({ email: '', password: '' });

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);
    setErrorMsg(null);

    try {
      const data = await api.post('/auth/login', formData);
      const { access_token, user } = data;

      // ✨ 根據「記住我」選擇儲存位置
      if (rememberMe) {
        // 存入 LocalStorage (永久)
        localStorage.setItem('somalink_token', access_token);
        localStorage.setItem('somalink_user', JSON.stringify(user));
        // 清除 Session 以防萬一
        sessionStorage.removeItem('somalink_token');
        sessionStorage.removeItem('somalink_user');
      } else {
        // 存入 SessionStorage (關閉分頁即失效)
        sessionStorage.setItem('somalink_token', access_token);
        sessionStorage.setItem('somalink_user', JSON.stringify(user));
        // 清除 Local
        localStorage.removeItem('somalink_token');
        localStorage.removeItem('somalink_user');
      }

      router.push('/');
    } catch (err: any) {
      console.error('登入失敗:', err);
      if (err.response?.status === 401) {
        setErrorMsg('帳號或密碼錯誤');
      } else {
        setErrorMsg('系統連線錯誤，請確認後端是否已啟動');
      }
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 px-4 sm:px-6 lg:px-8">
      <div className="max-w-md w-full space-y-8 bg-white p-8 rounded-2xl shadow-lg border border-gray-100">
        
        <div className="text-center">
          <div className="mx-auto h-12 w-12 bg-blue-600 rounded-xl flex items-center justify-center text-white font-bold text-2xl mb-4 shadow-blue-200 shadow-md">
            S
          </div>
          <h2 className="text-3xl font-bold tracking-tight text-gray-900">
            經銷商登入
          </h2>
          <p className="mt-2 text-sm text-gray-600">
            歡迎回到 松成有限公司 數位工廠
          </p>
        </div>

        {errorMsg && (
          <div className="bg-red-50 border border-red-200 rounded-lg p-4 flex items-start gap-3 animate-pulse">
            <AlertCircle className="w-5 h-5 text-red-600 mt-0.5 shrink-0" />
            <p className="text-sm text-red-700 font-medium">{errorMsg}</p>
          </div>
        )}

        <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-bold text-gray-700 mb-1">Email 帳號</label>
              <div className="relative">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><Mail className="h-5 w-5 text-gray-400" /></div>
                <input type="email" required className="block w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" placeholder="your@company.com" value={formData.email} onChange={(e) => setFormData({...formData, email: e.target.value})} />
              </div>
            </div>
            <div>
              <label className="block text-sm font-bold text-gray-700 mb-1">密碼</label>
              <div className="relative">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><Lock className="h-5 w-5 text-gray-400" /></div>
                <input type="password" required className="block w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" placeholder="••••••••" value={formData.password} onChange={(e) => setFormData({...formData, password: e.target.value})} />
              </div>
            </div>
          </div>

          {/* ✨ 新增：記住我 & 忘記密碼 */}
          <div className="flex items-center justify-between">
            <div className="flex items-center">
              <input
                id="remember-me"
                name="remember-me"
                type="checkbox"
                checked={rememberMe}
                onChange={(e) => setRememberMe(e.target.checked)}
                className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded cursor-pointer"
              />
              <label htmlFor="remember-me" className="ml-2 block text-sm text-gray-900 cursor-pointer select-none">
                記住我
              </label>
            </div>

            <div className="text-sm">
              <Link href="/forgot-password" className="font-medium text-blue-600 hover:text-blue-500">
                忘記密碼？
              </Link>
            </div>
          </div>

          <button type="submit" disabled={isLoading} className="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-70 disabled:cursor-not-allowed transition-all shadow-md hover:shadow-lg">
            {isLoading ? <Loader2 className="animate-spin -ml-1 mr-2 h-5 w-5" /> : '登入系統'}
          </button>

          <div className="text-center space-y-3 mt-6 border-t border-gray-100 pt-6">
            <Link href="/register" className="block text-sm font-bold text-blue-600 hover:text-blue-800 hover:underline transition-colors">還沒有帳號？點此申請成為經銷商</Link>
            <Link href="/" className="block text-sm text-gray-400 hover:text-gray-600 transition-colors">← 先回首頁逛逛</Link>
          </div>
        </form>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/app/login/register/page.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { api } from '@/lib/api';
import { Loader2, UserPlus, Building2, FileText, User, Phone, Mail, Lock, ArrowLeft } from 'lucide-react';
import Link from 'next/link';

export default function RegisterPage() {
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(false);
  
  const [formData, setFormData] = useState({
    email: '',
    password: '',
    companyName: '',
    taxId: '', // 統編
    contactPerson: '',
    phone: '',
    address: ''
  });

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);

    try {
      // 呼叫後端註冊 API
      // 後端會自動建立 User + DealerProfile (預設 C 級)
      await api.post('/users', formData);
      
      alert('🎉 註冊成功！請使用剛建立的帳號登入。');
      router.push('/login'); // 導向登入頁

    } catch (err: any) {
      console.error(err);
      alert('註冊失敗：' + (err.response?.data?.message || '請檢查資料是否正確'));
    } finally {
      setIsLoading(false);
    }
  };

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
  };

  return (
    <div className="min-h-screen bg-gray-50 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-md w-full space-y-8 bg-white p-8 rounded-2xl shadow-lg border border-gray-100">
        
        <div className="text-center">
          <h2 className="text-3xl font-bold tracking-tight text-gray-900">
            申請成為經銷商
          </h2>
          <p className="mt-2 text-sm text-gray-600">
            加入 SomaLink，享受 B2B 專屬價格與服務
          </p>
        </div>

        <form className="mt-8 space-y-4" onSubmit={handleSubmit}>
          
          {/* 帳號密碼區 */}
          <div className="space-y-2">
            <div className="relative">
              <Mail className="absolute left-3 top-3 w-5 h-5 text-gray-400" />
              <input name="email" type="email" required placeholder="Email (登入帳號)" onChange={handleChange} 
                className="w-full pl-10 p-2.5 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
            <div className="relative">
              <Lock className="absolute left-3 top-3 w-5 h-5 text-gray-400" />
              <input name="password" type="password" required placeholder="設定密碼" onChange={handleChange} 
                className="w-full pl-10 p-2.5 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
          </div>

          <div className="border-t border-gray-100 my-4"></div>

          {/* 公司資料區 */}
          <div className="space-y-2">
            <div className="relative">
              <Building2 className="absolute left-3 top-3 w-5 h-5 text-gray-400" />
              <input name="companyName" required placeholder="公司名稱" onChange={handleChange} 
                className="w-full pl-10 p-2.5 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
            <div className="relative">
              <FileText className="absolute left-3 top-3 w-5 h-5 text-gray-400" />
              <input name="taxId" required placeholder="統一編號" onChange={handleChange} 
                className="w-full pl-10 p-2.5 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
            <div className="relative">
              <User className="absolute left-3 top-3 w-5 h-5 text-gray-400" />
              <input name="contactPerson" required placeholder="聯絡人姓名" onChange={handleChange} 
                className="w-full pl-10 p-2.5 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
            <div className="relative">
              <Phone className="absolute left-3 top-3 w-5 h-5 text-gray-400" />
              <input name="phone" required placeholder="聯絡電話" onChange={handleChange} 
                className="w-full pl-10 p-2.5 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
          </div>

          <button type="submit" disabled={isLoading}
            className="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 shadow-md transition-all disabled:opacity-70">
            {isLoading ? <Loader2 className="animate-spin" /> : <><UserPlus className="w-5 h-5 mr-2" /> 提交申請</>}
          </button>

          <div className="text-center mt-4">
            <Link href="/login" className="text-sm text-blue-600 hover:underline flex items-center justify-center gap-1">
              <ArrowLeft className="w-4 h-4" /> 已有帳號？返回登入
            </Link>
          </div>

        </form>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/app/orders/[id]/print/page.tsx">
'use client';

import { useEffect, useState, use } from 'react';
import { api } from '@/lib/api';
import { Loader2, Printer, MapPin, Phone, User, MessageSquare } from 'lucide-react';

export default function PrintDeliveryNotePage({ params }: { params: Promise<{ id: string }> }) {
  const { id } = use(params);
  const [order, setOrder] = useState<any>(null);
  const [showPrice, setShowPrice] = useState(true); 

  useEffect(() => {
    api.get(`/orders/${id}`).then(res => setOrder(res)).catch(console.error);
  }, [id]);

  if (!order) return <div className="flex justify-center p-12"><Loader2 className="animate-spin w-8 h-8 text-blue-600" /></div>;

  return (
    <div className="min-h-screen bg-gray-100 p-8 print:p-0 print:bg-white">
      
      {/* 控制列 (列印時隱藏) */}
      <div className="max-w-[210mm] mx-auto mb-6 flex justify-between items-center print:hidden bg-white p-4 rounded-lg shadow-sm border border-gray-200">
        <div className="flex items-center gap-3">
          <label className="flex items-center gap-2 cursor-pointer select-none">
            <input 
              type="checkbox" 
              checked={showPrice} 
              onChange={(e) => setShowPrice(e.target.checked)}
              className="w-4 h-4 text-blue-600 rounded cursor-pointer" 
            />
            <span className="text-sm text-gray-700 font-medium">顯示金額</span>
          </label>
          <span className="text-xs text-gray-400">| (給司機或現場看的單據可取消勾選)</span>
        </div>
        <button 
          onClick={() => window.print()}
          className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-sm transition-colors"
        >
          <Printer className="w-4 h-4" /> 列印 / 存為 PDF
        </button>
      </div>

      {/* A4 紙張區域 - 優化間距 (p-8 -> p-6) */}
      <div className="max-w-[210mm] mx-auto bg-white shadow-xl print:shadow-none p-8 print:p-6 min-h-[297mm] text-black font-sans relative flex flex-col box-border">
        
        {/* Header - 縮減下方間距 (pb-6 -> pb-4, mb-6 -> mb-4) */}
        <div className="flex justify-between items-start border-b-4 border-black pb-4 mb-4">
          <div className="flex items-center gap-4">
            <div className="w-14 h-14 bg-black text-white flex items-center justify-center text-2xl font-bold rounded-lg print:border print:border-black">S</div>
            <div>
              <h1 className="text-2xl font-extrabold tracking-wider text-black">出貨單</h1>
              <p className="text-sm font-bold mt-1 text-black">松成有限公司</p>
              <div className="flex gap-4 text-xs text-black font-medium mt-0.5">
                <span>統編：12345678</span>
                <span>電話：(02) 2345-6789</span>
              </div>
            </div>
          </div>
          <div className="text-right">
            <div className="inline-block border-2 border-black px-3 py-1 rounded mb-1">
              <p className="text-[10px] font-bold uppercase tracking-wide text-black">出貨單號 NO.</p>
              <p className="text-lg font-mono font-bold text-black leading-none">{order.orderNumber}</p>
            </div>
            <p className="text-xs mt-1 text-black font-medium">列印日期：{new Date().toLocaleDateString()}</p>
          </div>
        </div>

        {/* 客戶與送貨資訊 - 縮減間距 (gap-8 -> gap-4) */}
        <div className="grid grid-cols-2 gap-4 mb-4 break-inside-avoid">
          
          {/* 左邊：訂購經銷商 */}
          <div className="border-2 border-black rounded p-3">
            <h3 className="text-xs font-bold bg-gray-200 px-2 py-0.5 mb-2 inline-block rounded text-black print:border print:border-black">訂購經銷商 (Bill To)</h3>
            <div className="space-y-0.5 text-sm text-black">
              <p><span className="font-bold w-16 inline-block">公司名稱：</span><span className="font-bold">{order.user?.dealerProfile?.companyName}</span></p>
              <p><span className="font-bold w-16 inline-block">聯絡人：</span>{order.user?.dealerProfile?.contactPerson}</p>
              <p><span className="font-bold w-16 inline-block">電話：</span>{order.user?.dealerProfile?.phone}</p>
            </div>
          </div>

          {/* 右邊：施工/送貨地點 */}
          <div className="border-2 border-black rounded p-3">
            <h3 className="text-xs font-bold bg-gray-200 px-2 py-0.5 mb-2 inline-block rounded text-black print:border print:border-black">送貨資訊 (Ship To)</h3>
            <div className="space-y-0.5 text-sm text-black">
              <div className="mb-1">
                <p className="text-[10px] font-bold text-black">案場名稱</p>
                <p className="font-bold text-base leading-tight">{order.projectName}</p>
              </div>
              
              <div className="flex items-start gap-1 mb-1">
                <MapPin className="w-3.5 h-3.5 mt-0.5 text-black shrink-0" />
                <span className="font-bold border-b border-black pb-0 text-sm leading-tight">
                  {order.shippingAddress || '未指定地址 (同經銷商)'}
                </span>
              </div>

              <div className="grid grid-cols-2 gap-1 text-xs">
                <p className="flex items-center font-medium">
                  <User className="w-3 h-3 mr-1 text-black" /> 
                  {order.siteContactPerson || order.user?.dealerProfile?.contactPerson}
                </p>
                <p className="flex items-center font-medium">
                  <Phone className="w-3 h-3 mr-1 text-black" /> 
                  {order.siteContactPhone || order.user?.dealerProfile?.phone}
                </p>
              </div>
            </div>
          </div>
        </div>

        {/* 訂單備註 */}
        {order.customerNote && (
          <div className="mb-4 border-2 border-black bg-gray-50 p-2 rounded text-sm flex items-start gap-2 break-inside-avoid">
            <MessageSquare className="w-4 h-4 text-black mt-0.5 shrink-0" />
            <div className="text-black">
              <span className="font-bold mr-2">訂單備註：</span>
              <span className="font-medium">{order.customerNote}</span>
            </div>
          </div>
        )}

        {/* 產品明細 - 緊湊表格 */}
        <div className="flex-1">
          <table className="w-full mb-4 border-collapse">
            <thead>
              <tr className="bg-gray-200 border-y-2 border-black text-xs text-black">
                <th className="py-1 px-2 text-left w-8 font-bold">#</th>
                <th className="py-1 px-2 text-left font-bold">產品名稱 / 詳細規格</th>
                <th className="py-1 px-2 text-center w-16 font-bold">數量</th>
                {showPrice && <th className="py-1 px-2 text-right w-24 font-bold">單價</th>}
                {showPrice && <th className="py-1 px-2 text-right w-24 font-bold">金額</th>}
              </tr>
            </thead>
            <tbody className="text-sm text-black">
              {order.items?.map((item: any, index: number) => (
                <tr key={index} className="border-b border-black break-inside-avoid">
                  <td className="py-2 px-2 align-top font-bold text-center">{index + 1}</td>
                  <td className="py-2 px-2 align-top">
                    <p className="font-bold text-sm">{item.product?.name}</p>
                    <div className="text-black text-[10px] mt-1 grid grid-cols-2 gap-x-2 gap-y-0.5 font-mono font-medium">
                      <p>型號: {item.product?.sku}</p>
                      <p>顏色: {item.colorName}</p>
                      <p>材質: {item.materialName}</p>
                      <p>開向: {item.openingDirection}</p>
                      <p>模式: {item.serviceType === 'assembled' ? '連工帶料' : '純材料'}</p>
                    </div>
                    {/* 尺寸顯示 */}
                    <div className="mt-1 bg-white px-1.5 py-0.5 rounded inline-block text-[10px] font-mono border border-black font-bold">
                      W: {item.widthMatrix?.mid} x H: {item.heightData?.singleValue || item.heightData?.mid}
                      {item.isCeilingMounted && <span className="ml-1 text-black font-extrabold">(封頂)</span>}
                    </div>
                  </td>
                  <td className="py-2 px-2 text-center align-top font-bold">{item.quantity}</td>
                  {showPrice && <td className="py-2 px-2 text-right align-top font-mono font-medium">${Number(item.unitPrice || item.subtotal / item.quantity).toLocaleString()}</td>}
                  {showPrice && <td className="py-2 px-2 text-right align-top font-bold font-mono">${Number(item.subtotal).toLocaleString()}</td>}
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        {/* 總計與簽名 - 確保不被硬推到下一頁 */}
        <div className="break-inside-avoid">
          {showPrice && (
            <div className="flex justify-end mb-6 border-t-2 border-black pt-2">
              <div className="text-right">
                <p className="text-xs font-bold text-black">總計金額 (含稅)</p>
                <p className="text-2xl font-extrabold text-black">NT$ {Number(order.totalAmount).toLocaleString()}</p>
              </div>
            </div>
          )}

          {/* 底部簽名欄 - 縮減間距 */}
          <div className="mt-4 pt-4 border-t border-dashed border-gray-400">
            <div className="grid grid-cols-3 gap-8">
              <div className="text-center">
                <p className="text-xs font-bold mb-6 text-black">倉管備貨</p>
                <div className="border-b-2 border-black w-3/4 mx-auto"></div>
              </div>
              <div className="text-center">
                <p className="text-xs font-bold mb-6 text-black">司機配送</p>
                <div className="border-b-2 border-black w-3/4 mx-auto"></div>
              </div>
              <div className="text-center">
                <p className="text-xs font-bold mb-6 text-black">客戶簽收</p>
                <div className="border-b-2 border-black w-3/4 mx-auto"></div>
                <p className="text-[9px] text-black font-bold mt-1">本人確認上述規格與數量無誤</p>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  );
}
</file>

<file path="frontend/src/app/series/[name]/page.tsx">
'use client';

import { useState, useEffect, use } from 'react';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { ArrowLeft, Search, ShoppingCart, Lock } from 'lucide-react'; // ✨ 新增 Lock 圖示
import { api } from '@/lib/api';
import Modal from '@/components/Modal'; // ✨ 引入彈窗

export default function SeriesListPage({ params }: { params: Promise<{ name: string }> }) {
  const { name } = use(params);
  const seriesName = decodeURIComponent(name);
  const router = useRouter();

  const [products, setProducts] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  
  // ✨ 登入提示彈窗狀態
  const [showLoginModal, setShowLoginModal] = useState(false);

  useEffect(() => {
    const fetchProducts = async () => {
      try {
        const res = await api.get('/products');
        const data = Array.isArray(res) ? res : [];
        const filtered = data.filter((p: any) => p.series === seriesName);
        setProducts(filtered);
      } catch (err) {
        console.error(err);
        setProducts([]);
      } finally {
        setLoading(false);
      }
    };
    fetchProducts();
  }, [seriesName]);

  // ✨✨✨ 點擊商品時的檢查邏輯 ✨✨✨
  const handleProductClick = (productId: string) => {
    // 檢查 LocalStorage 或 SessionStorage 是否有 Token
    const token = localStorage.getItem('somalink_token') || sessionStorage.getItem('somalink_token');
    
    if (!token) {
      // 沒登入 -> 跳出彈窗
      setShowLoginModal(true);
    } else {
      // 有登入 -> 正常跳轉
      router.push(`/product/${productId}`);
    }
  };

  return (
    <div className="min-h-screen bg-gray-50">
      
      {/* ✨ 提示彈窗 */}
      <Modal 
        isOpen={showLoginModal} 
        title="會員專屬權限"
        message="本站採會員制，請先登入會員帳號，即可查看完整產品規格與專屬優惠價格。"
        type="confirm"
        confirmText="前往登入"
        cancelText="稍後再說"
        onClose={() => setShowLoginModal(false)}
        onConfirm={() => router.push('/login')}
      />

      {/* Header */}
      <header className="bg-white shadow-sm border-b border-gray-100 h-16 flex items-center px-4 sticky top-0 z-10">
        <div className="max-w-7xl mx-auto w-full flex items-center gap-4">
          <Link href="/" className="p-2 hover:bg-gray-100 rounded-full transition-colors">
            <ArrowLeft className="w-5 h-5 text-gray-600" />
          </Link>
          <h1 className="text-lg font-bold text-gray-900">{seriesName}</h1>
        </div>
      </header>

      {/* Content */}
      <main className="max-w-7xl mx-auto px-4 py-8">
        {loading ? (
          <div className="text-center py-12 text-gray-500">載入產品中...</div>
        ) : products.length === 0 ? (
          <div className="text-center py-12">
            <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <Search className="w-8 h-8 text-gray-400" />
            </div>
            <h3 className="text-lg font-bold text-gray-900">此系列尚無產品</h3>
            <p className="text-gray-500 mt-1">請至後台新增產品，並確認系列名稱為「{seriesName}」</p>
          </div>
        ) : (
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            {products.map((product) => {
              const thumb = (product.images && product.images.length > 0) 
                ? product.images[0] 
                : (product.imageUrl || "https://images.unsplash.com/photo-1584622050111-993a426fbf0a?auto=format&fit=crop&q=80&w=800");

              return (
                <div 
                  key={product.id} 
                  // ✨ 改用 onClick 觸發檢查，而不是直接 Link
                  onClick={() => handleProductClick(product.id)}
                  className="group bg-white rounded-xl overflow-hidden border border-gray-200 hover:shadow-lg hover:border-blue-300 transition-all duration-300 flex flex-col cursor-pointer relative"
                >
                  <div className="relative h-48 bg-gray-100 overflow-hidden">
                    {/* eslint-disable-next-line @next/next/no-img-element */}
                    <img 
                      src={thumb} 
                      alt={product.name} 
                      className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" 
                    />
                  </div>
                  
                  <div className="p-4">
                    <h3 className="font-bold text-gray-900 mb-1 group-hover:text-blue-600 transition-colors">{product.name}</h3>
                    <p className="text-xs text-gray-500 font-mono mb-3">{product.sku}</p>
                    <div className="flex items-center justify-between mt-auto">
                      <span className="text-blue-600 font-bold flex items-center gap-1">
                        ${Number(product.basePrice).toLocaleString()} 起
                      </span>
                      <button className="p-2 bg-gray-50 rounded-full group-hover:bg-blue-600 group-hover:text-white transition-colors">
                        <ShoppingCart className="w-4 h-4" />
                      </button>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </main>
    </div>
  );
}
</file>

<file path="frontend/src/components/Navbar.tsx">
'use client';

import { useEffect, useState } from 'react';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { Package, Clock, Truck, CheckCircle, Trash2, Hammer, XCircle, RefreshCw, Loader2 } from 'lucide-react';
import { api } from '@/lib/api';
import Modal from '@/components/Modal';
import { useCart, CartItem } from '@/context/CartContext';

// 定義介面 (與 API 回傳一致)
interface OrderItem {
  product: { 
    id: string; 
    name: string; 
    basePrice?: number; 
    assemblyFee?: number;
  };
  quantity: number;
  serviceType: 'material' | 'assembled';
  widthMatrix: any;
  heightData: any;
  isCeilingMounted: boolean;
  siteConditions: any;
  colorName: string;
  materialName: string;
  handleName: string;
  openingDirection: string;
  hasThreshold: boolean;
  subtotal: number;
  priceSnapshot: any;
}

interface Order {
  id: string;
  orderNumber: string;
  status: 'pending' | 'processing' | 'shipped' | 'completed' | 'cancelled';
  totalAmount: number;
  createdAt: string;
  projectName: string;
  items: OrderItem[];
}

export default function OrdersPage() {
  const router = useRouter();
  const { addToCart } = useCart(); 
  const [orders, setOrders] = useState<Order[]>([]);
  const [loading, setLoading] = useState(true);
  
  // ✨ 權限檢查狀態
  const [authChecking, setAuthChecking] = useState(true);

  // ✨ 彈窗狀態
  const [deleteModal, setDeleteModal] = useState({ isOpen: false, orderId: '' });
  const [reorderModal, setReorderModal] = useState({ isOpen: false, order: null as Order | null });
  const [isDeleting, setIsDeleting] = useState(false);

  useEffect(() => {
    // ✨✨✨ 檢查是否登入 ✨✨✨
    const token = localStorage.getItem('somalink_token') || sessionStorage.getItem('somalink_token');
    if (!token) {
      router.replace('/login');
      return;
    }
    setAuthChecking(false);

    const fetchOrders = async () => {
      try {
        const data = await api.get('/orders');
        setOrders(data);
      } catch (error) {
        console.error('Failed to fetch orders', error);
      } finally {
        setLoading(false);
      }
    };
    fetchOrders();
  }, [router]);

  // --- 刪除邏輯 ---
  const confirmDelete = (orderId: string) => {
    setDeleteModal({ isOpen: true, orderId });
  };

  const handleDelete = async () => {
    if (!deleteModal.orderId) return;
    setIsDeleting(true);
    try {
      await api.delete(`/orders/${deleteModal.orderId}`);
      setOrders((prev) => prev.filter((o) => o.id !== deleteModal.orderId));
    } catch (error) {
      console.error(error);
      alert('刪除失敗：可能訂單已進入生產流程，請聯繫客服。');
    } finally {
      setIsDeleting(false);
      setDeleteModal({ isOpen: false, orderId: '' });
    }
  };

  // --- 再次購買邏輯 ---
  const confirmReorder = (order: Order) => {
    setReorderModal({ isOpen: true, order });
  };

  const handleReorder = () => {
    const order = reorderModal.order;
    if (!order) return;

    order.items.forEach(item => {
      const cartItem: CartItem = {
        internalId: crypto.randomUUID(), 
        productId: item.product?.id,     
        productName: item.product?.name || '未知商品',
        // 使用當時的快照價格重新計算單價 (或根據您的需求抓取最新價格)
        unitPrice: Number(item.priceSnapshot?.basePrice || 0) + 
                   Number(item.priceSnapshot?.sizeSurcharge || 0) +
                   Number(item.priceSnapshot?.colorSurcharge || 0) +
                   Number(item.priceSnapshot?.materialSurcharge || 0) +
                   Number(item.priceSnapshot?.handleSurcharge || 0) +
                   (item.serviceType === 'assembled' ? Number(item.priceSnapshot?.assemblyFee || 0) : 0),
        quantity: item.quantity,
        subtotal: Number(item.subtotal),
        serviceType: item.serviceType,
        widthMatrix: item.widthMatrix,
        heightData: item.heightData,
        isCeilingMounted: item.isCeilingMounted,
        siteConditions: item.siteConditions,
        colorName: item.colorName,
        materialName: item.materialName,
        handleName: item.handleName || '',
        openingDirection: item.openingDirection,
        hasThreshold: item.hasThreshold,
        priceSnapshot: item.priceSnapshot
      };
      addToCart(cartItem);
    });
    
    setReorderModal({ isOpen: false, order: null });
    router.push('/cart');
  };

  const getStatusDisplay = (status: string) => {
    switch (status) {
      case 'pending': return { label: '待審核', color: 'bg-yellow-100 text-yellow-800', icon: <Clock className="w-4 h-4" /> };
      case 'processing': return { label: '生產中', color: 'bg-blue-100 text-blue-800', icon: <Hammer className="w-4 h-4" /> };
      case 'shipped': return { label: '已出貨', color: 'bg-purple-100 text-purple-800', icon: <Truck className="w-4 h-4" /> };
      case 'completed': return { label: '已完成', color: 'bg-green-100 text-green-800', icon: <CheckCircle className="w-4 h-4" /> };
      case 'cancelled': return { label: '已取消', color: 'bg-gray-100 text-gray-600', icon: <XCircle className="w-4 h-4" /> };
      default: return { label: status, color: 'bg-gray-100 text-gray-600', icon: null };
    }
  };

  // 如果還在檢查權限或載入中，顯示 Loading
  if (authChecking || loading) return <div className="min-h-screen bg-gray-50 flex items-center justify-center"><Loader2 className="animate-spin text-blue-600 w-10 h-10" /></div>;

  return (
    <div className="min-h-screen bg-gray-50 py-12">
      
      {/* 刪除確認彈窗 */}
      <Modal 
        isOpen={deleteModal.isOpen}
        onClose={() => setDeleteModal({ isOpen: false, orderId: '' })}
        type="confirm" 
        title="取消訂單"
        message="確定要取消並刪除這筆訂單嗎？此動作無法復原，且僅能在「待審核」狀態下執行。"
        confirmText={isDeleting ? "刪除中..." : "確認取消"}
        cancelText="保留訂單"
        onConfirm={handleDelete}
      />

      {/* 再次購買確認彈窗 */}
      <Modal 
        isOpen={reorderModal.isOpen}
        onClose={() => setReorderModal({ isOpen: false, order: null })}
        type="confirm" 
        title="再次購買"
        message={`確定要將訂單 ${reorderModal.order?.orderNumber} 的所有商品規格複製到購物車嗎？`}
        confirmText="加入購物車"
        cancelText="取消"
        onConfirm={handleReorder}
      />

      <div className="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
        <div className="flex justify-between items-end mb-8">
          <div><h1 className="text-3xl font-bold text-gray-900">我的訂單</h1><p className="text-gray-500 mt-2">追蹤您的訂製門扇生產進度</p></div>
          <Link href="/" className="bg-blue-600 text-white px-6 py-2.5 rounded-xl font-bold hover:bg-blue-700 transition-colors shadow-sm flex items-center gap-2"><Package className="w-5 h-5" /> 新增訂單</Link>
        </div>

        <div className="space-y-6">
          {orders.length === 0 ? (
            <div className="text-center py-20 bg-white rounded-3xl border border-gray-200"><Package className="w-16 h-16 text-gray-300 mx-auto mb-4" /><h3 className="text-xl font-bold text-gray-900">目前沒有訂單</h3><p className="text-gray-500 mt-2">開始您的第一個數位工廠專案吧！</p></div>
          ) : (
            orders.map((order) => {
              const statusInfo = getStatusDisplay(order.status);
              return (
                <div key={order.id} className="bg-white rounded-2xl border border-gray-200 p-6 shadow-sm hover:shadow-md transition-shadow relative group">
                  <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <div className="flex items-center gap-3">
                      <div className="bg-gray-100 p-2 rounded-lg"><Package className="w-6 h-6 text-gray-600" /></div>
                      <div>
                        <div className="font-mono font-bold text-gray-900 text-lg">{order.orderNumber}</div>
                        <div className="text-sm text-gray-500 flex items-center gap-2"><span>{new Date(order.createdAt).toLocaleDateString()}</span><span className="w-1 h-1 bg-gray-300 rounded-full"></span><span>{order.projectName}</span></div>
                      </div>
                    </div>
                    <div className={`px-4 py-1.5 rounded-full text-sm font-bold flex items-center gap-2 ${statusInfo.color}`}>{statusInfo.icon}{statusInfo.label}</div>
                  </div>

                  <div className="bg-gray-50 rounded-xl p-4 mb-6">
                    <div className="flex justify-between items-center text-sm text-gray-600 mb-2"><span>訂購項目：</span><span className="font-bold text-gray-900">{order.items?.length || 0} 件商品</span></div>
                    <div className="space-y-1">
                      {order.items?.slice(0, 2).map((item, idx) => (
                        <div key={idx} className="text-sm text-gray-500 flex justify-between items-center">
                           <div className="flex items-center gap-2"><span>- {item.product?.name}</span>{item.serviceType === 'material' ? <span className="text-[10px] px-1.5 py-0.5 bg-gray-200 text-gray-600 rounded flex items-center gap-1"><Package className="w-3 h-3" /> 純料</span> : <span className="text-[10px] px-1.5 py-0.5 bg-blue-100 text-blue-600 rounded flex items-center gap-1"><Hammer className="w-3 h-3" /> 代工</span>}</div><span>x{item.quantity}</span>
                        </div>
                      ))}
                      {(order.items?.length || 0) > 2 && <div className="text-xs text-gray-400 pl-2">...還有 {(order.items?.length || 0) - 2} 項</div>}
                    </div>
                    <div className="border-t border-gray-200 mt-3 pt-3 flex justify-between items-center"><span className="font-bold text-gray-900">總金額</span><span className="text-xl font-bold text-blue-600">${Number(order.totalAmount).toLocaleString()}</span></div>
                  </div>

                  <div className="flex justify-end items-center gap-3">
                    {/* ✨✨✨ 再次購買按鈕 ✨✨✨ */}
                    <button 
                      onClick={() => confirmReorder(order)}
                      className="text-blue-600 hover:text-blue-800 hover:bg-blue-50 px-4 py-2 rounded-lg text-sm font-bold transition-colors flex items-center gap-2 border border-blue-200"
                    >
                      <RefreshCw className="w-4 h-4" /> 再次購買
                    </button>

                    {order.status === 'pending' && (
                      <button 
                        onClick={() => confirmDelete(order.id)}
                        disabled={isDeleting && deleteModal.orderId === order.id}
                        className="text-red-500 hover:text-red-700 hover:bg-red-50 px-4 py-2 rounded-lg text-sm font-bold transition-colors flex items-center gap-2"
                      >
                        {isDeleting && deleteModal.orderId === order.id ? '刪除中...' : <><Trash2 className="w-4 h-4" /> 取消</>}
                      </button>
                    )}
                    
                    <Link href={`/orders/${order.id}/print`} target="_blank" className="bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 px-4 py-2 rounded-lg font-bold text-sm transition-colors">列印工單</Link>
                  </div>
                </div>
              );
            })
          )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/context/CartContext.tsx">
'use client';

import { createContext, useContext, useState, useEffect, ReactNode } from 'react';

export interface CartItem {
  internalId: string; 
  productId: string;
  productName: string; 
  unitPrice: number;   
  
  serviceType: string;
  widthMatrix: { top: number; mid: number; bot: number };
  heightData: any;
  isCeilingMounted: boolean;
  siteConditions?: any;
  colorName: string;
  materialName: string;
  // ✨✨✨ 新增把手 ✨✨✨
  handleName: string;
  openingDirection: string;
  hasThreshold: boolean;
  
  quantity: number;
  subtotal: number;
  priceSnapshot: any; 
}

interface CartContextType {
  items: CartItem[];
  addToCart: (item: CartItem) => void;
  removeFromCart: (internalId: string) => void;
  clearCart: () => void;
  cartCount: number;
  cartTotal: number;
}

const CartContext = createContext<CartContextType | undefined>(undefined);

export function CartProvider({ children }: { children: ReactNode }) {
  const [items, setItems] = useState<CartItem[]>([]);

  useEffect(() => {
    const saved = localStorage.getItem('soma_cart');
    if (saved) {
      try {
        setItems(JSON.parse(saved));
      } catch (e) {
        console.error('Failed to parse cart', e);
      }
    }
  }, []);

  useEffect(() => {
    localStorage.setItem('soma_cart', JSON.stringify(items));
  }, [items]);

  const addToCart = (newItem: CartItem) => {
    setItems((prev) => [...prev, newItem]);
  };

  const removeFromCart = (internalId: string) => {
    setItems((prev) => prev.filter((item) => item.internalId !== internalId));
  };

  const clearCart = () => {
    setItems([]);
  };

  const cartTotal = items.reduce((sum, item) => sum + item.subtotal, 0);

  return (
    <CartContext.Provider 
      value={{ 
        items, 
        addToCart, 
        removeFromCart, 
        clearCart,
        cartCount: items.length,
        cartTotal
      }}
    >
      {children}
    </CartContext.Provider>
  );
}

export function useCart() {
  const context = useContext(CartContext);
  if (context === undefined) {
    throw new Error('useCart must be used within a CartProvider');
  }
  return context;
}
</file>

<file path="frontend/tsconfig.json">
{
  "compilerOptions": {
    "lib": [
      "dom",
      "dom.iterable",
      "esnext"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": [
        "./src/*"
      ]
    },
    "target": "ES2017"
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts"
  ],
  "exclude": [
    "node_modules"
  ]
}
</file>

<file path="admin/src/app/products/page.tsx">
'use client';

import { useEffect, useState } from 'react';
import { Plus, Package, Edit, Trash2, Search, Image as ImageIcon } from 'lucide-react';
import Link from 'next/link';
import { api } from '@/lib/api';

export default function ProductsPage() {
  const [products, setProducts] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');

  const fetchProducts = async () => {
    try {
      // ✨ 修正：直接使用 res，不要再寫 .data (因為 api.ts 已處理)
      const res = await api.get('/products');
      
      if (Array.isArray(res)) {
        setProducts(res);
      } else {
        console.warn('API 回傳格式異常:', res);
        setProducts([]);
      }
    } catch (err) { 
      console.error('無法取得產品列表:', err);
      setProducts([]); 
    } finally { 
      setLoading(false); 
    }
  };

  useEffect(() => { fetchProducts(); }, []);

  const handleDelete = async (id: string) => {
    if (!confirm('確定要刪除此產品嗎？(此操作無法復原)')) return;
    try {
      await api.delete(`/products/${id}`);
      alert('刪除成功');
      fetchProducts(); // 重整列表
    } catch (err) {
      alert('刪除失敗');
    }
  };

  // 簡單的前端搜尋過濾
  const filteredProducts = products.filter(p => 
    p.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
    p.sku.toLowerCase().includes(searchTerm.toLowerCase())
  );

  return (
    <div className="min-h-screen bg-gray-50 p-8 font-sans">
      <div className="flex justify-between items-center mb-8">
        <div>
          <h1 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
            <Package className="w-6 h-6 text-blue-600" /> 產品管理
          </h1>
          <p className="text-gray-500 text-sm mt-1">管理所有上架的門款、價格與客製化選項</p>
        </div>
        <Link href="/products/new" className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-sm font-bold">
          <Plus className="w-5 h-5" /> 新增產品
        </Link>
      </div>

      <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div className="p-4 border-b border-gray-100 bg-gray-50/50">
          <div className="relative max-w-sm">
            <Search className="absolute left-3 top-2.5 w-4 h-4 text-gray-400" />
            <input 
              type="text" 
              placeholder="搜尋產品名稱或型號..." 
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" 
            />
          </div>
        </div>

        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">圖片</th>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">產品資訊</th>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">系列</th>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">基礎價格</th>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">尺寸規格</th>
              <th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">操作</th>
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-gray-200">
            {loading ? (
              <tr><td colSpan={6} className="text-center py-12 text-gray-500">載入中...</td></tr>
            ) : filteredProducts.length === 0 ? (
              <tr><td colSpan={6} className="text-center py-12 text-gray-500">尚無產品</td></tr>
            ) : (
              filteredProducts.map((product) => {
                // ✨ 圖片顯示邏輯：優先用新陣列的第一張，沒有就用舊欄位，再沒有就顯示圖示
                const thumb = product.images?.[0] || product.imageUrl;

                return (
                  <tr key={product.id} className="hover:bg-blue-50/30 transition-colors group">
                    <td className="px-6 py-4">
                      <div className="w-12 h-12 bg-gray-100 rounded-lg border border-gray-200 overflow-hidden flex items-center justify-center">
                        {thumb ? (
                          // eslint-disable-next-line @next/next/no-img-element
                          <img src={thumb} alt={product.name} className="w-full h-full object-cover" />
                        ) : (
                          <ImageIcon className="w-5 h-5 text-gray-400" />
                        )}
                      </div>
                    </td>
                    <td className="px-6 py-4">
                      <div>
                        <div className="font-bold text-gray-900">{product.name}</div>
                        <div className="text-xs text-gray-500 font-mono">{product.sku}</div>
                      </div>
                    </td>
                    <td className="px-6 py-4">
                      <span className="px-2 py-1 rounded bg-gray-100 text-xs text-gray-600 border border-gray-200">
                        {product.series}
                      </span>
                    </td>
                    <td className="px-6 py-4 font-bold text-blue-600 font-mono">
                      ${Number(product.basePrice).toLocaleString()}
                    </td>
                    <td className="px-6 py-4 text-sm text-gray-600 font-mono">
                      {product.standardWidth} x {product.standardHeight}
                      {product.requiresMeasurement && <span className="ml-2 text-xs text-orange-500 bg-orange-50 px-1 rounded">客製</span>}
                    </td>
                    <td className="px-6 py-4 text-right">
                      <div className="flex justify-end gap-3">
                        <Link href={`/products/${product.id}`} className="text-gray-400 hover:text-blue-600 transition-colors" title="編輯">
                          <Edit className="w-4 h-4" />
                        </Link>
                        <button onClick={() => handleDelete(product.id)} className="text-gray-400 hover:text-red-600 transition-colors" title="刪除">
                          <Trash2 className="w-4 h-4" />
                        </button>
                      </div>
                    </td>
                  </tr>
                );
              })
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}
</file>

<file path="admin/src/app/reports/page.tsx">
'use client';

import { useEffect, useState } from 'react';
import { BarChart3, PieChart as PieIcon, TrendingUp, DollarSign, Package, Trophy, Palette } from 'lucide-react';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, PieChart, Pie, Cell, Legend } from 'recharts';
import { api } from '@/lib/api';

const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8'];

const STATUS_LABEL: Record<string, string> = {
  pending: '待審核',
  processing: '生產中',
  shipped: '已出貨',
  completed: '已完成',
  cancelled: '已取消'
};

export default function ReportsPage() {
  const [data, setData] = useState<any>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchData = async () => {
      try {
        const res = await api.get('/reports/dashboard');
        setData(res);
      } catch (err) {
        console.error(err);
      } finally {
        setLoading(false);
      }
    };
    fetchData();
  }, []);

  if (loading) return <div className="p-12 text-center text-gray-500">載入數據中...</div>;
  if (!data) return <div className="p-12 text-center text-gray-500">暫無數據</div>;

  // 整理 Pie Chart 數據 (防呆)
  const pieData = data.statusDist?.map((item: any) => ({
    name: STATUS_LABEL[item.status] || item.status,
    value: Number(item.count)
  })) || [];

  return (
    <div className="min-h-screen bg-gray-50 p-8 font-sans">
      
      <div className="mb-8">
        <h1 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
          <div className="p-2 bg-indigo-100 rounded-lg"><BarChart3 className="w-6 h-6 text-indigo-600" /></div>
          營運報表中心
        </h1>
        <p className="text-gray-500 text-sm mt-1">即時分析工廠營收與訂單分佈</p>
      </div>

      {/* 1. 核心指標 (KPI) */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <div className="flex items-center gap-3 mb-2">
            <div className="p-2 bg-green-100 rounded-full"><DollarSign className="w-5 h-5 text-green-600" /></div>
            <h3 className="text-gray-500 font-bold text-sm">總營業額 (Revenue)</h3>
          </div>
          <p className="text-4xl font-bold text-gray-900">${Number(data.totalRevenue || 0).toLocaleString()}</p>
        </div>

        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <div className="flex items-center gap-3 mb-2">
            <div className="p-2 bg-blue-100 rounded-full"><Package className="w-5 h-5 text-blue-600" /></div>
            <h3 className="text-gray-500 font-bold text-sm">總訂單數 (Orders)</h3>
          </div>
          <p className="text-4xl font-bold text-gray-900">{data.totalOrders || 0}</p>
        </div>

        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <div className="flex items-center gap-3 mb-2">
            <div className="p-2 bg-purple-100 rounded-full"><TrendingUp className="w-5 h-5 text-purple-600" /></div>
            <h3 className="text-gray-500 font-bold text-sm">平均客單價</h3>
          </div>
          <p className="text-4xl font-bold text-gray-900">
            ${(data.totalOrders > 0 ? Math.round(data.totalRevenue / data.totalOrders) : 0).toLocaleString()}
          </p>
        </div>
      </div>

      {/* 2. 圖表區 */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        
        {/* 營收趨勢圖 (Bar Chart) */}
        {/* ✨ Fix: 加上 min-w-0 防止 Grid 擠壓導致圖表寬度計算錯誤 */}
        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 min-w-0">
          <h3 className="text-lg font-bold text-gray-900 mb-6">近 6 個月營收趨勢</h3>
          {/* ✨ Fix: 明確指定 w-full，確保 ResponsiveContainer 抓得到寬度 */}
          <div className="h-80 w-full">
            <ResponsiveContainer width="100%" height="100%">
              <BarChart data={data.trendData || []}>
                <CartesianGrid strokeDasharray="3 3" vertical={false} />
                <XAxis dataKey="name" axisLine={false} tickLine={false} />
                <YAxis axisLine={false} tickLine={false} />
                <Tooltip 
                  formatter={(value: number) => [`$${value.toLocaleString()}`, '營收']}
                  contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 12px rgba(0,0,0,0.1)' }}
                />
                <Bar dataKey="total" fill="#4F46E5" radius={[4, 4, 0, 0]} barSize={40} />
              </BarChart>
            </ResponsiveContainer>
          </div>
        </div>

        {/* 訂單狀態分佈 (Pie Chart) */}
        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 min-w-0">
          <h3 className="text-lg font-bold text-gray-900 mb-6">訂單狀態分佈</h3>
          <div className="h-80 w-full flex justify-center items-center">
            <ResponsiveContainer width="100%" height="100%">
              <PieChart>
                <Pie
                  data={pieData}
                  cx="50%"
                  cy="50%"
                  innerRadius={60}
                  outerRadius={100}
                  fill="#8884d8"
                  paddingAngle={5}
                  dataKey="value"
                  label={({name, percent}) => `${name} ${((percent || 0) * 100).toFixed(0)}%`}
                >
                  {pieData.map((entry: any, index: number) => (
                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                  ))}
                </Pie>
                <Tooltip />
                <Legend verticalAlign="bottom" height={36} />
              </PieChart>
            </ResponsiveContainer>
          </div>
        </div>
      </div>

      {/* 3. 熱銷排行榜 (Top 5) */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        {/* 熱銷產品 */}
        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden min-w-0">
          <div className="p-6 border-b border-gray-100 flex items-center gap-2">
            <Trophy className="w-5 h-5 text-yellow-500" />
            <h3 className="text-lg font-bold text-gray-900">熱銷產品排行 (Top 5)</h3>
          </div>
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">排名</th>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">產品名稱</th>
                <th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">銷售數量</th>
                <th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">總營收</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-200">
              {data.productStats?.map((item: any, index: number) => (
                <tr key={index} className="hover:bg-gray-50">
                  <td className="px-6 py-4 text-sm text-gray-500 font-bold">#{index + 1}</td>
                  <td className="px-6 py-4 text-sm text-gray-900 font-medium">{item.name || '未知產品'}</td>
                  <td className="px-6 py-4 text-sm text-gray-900 text-right">{item.count}</td>
                  <td className="px-6 py-4 text-sm text-blue-600 font-bold text-right">${Number(item.revenue).toLocaleString()}</td>
                </tr>
              ))}
              {(!data.productStats || data.productStats.length === 0) && <tr><td colSpan={4} className="p-4 text-center text-gray-400 text-sm">暫無數據</td></tr>}
            </tbody>
          </table>
        </div>

        {/* 熱銷顏色 */}
        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden min-w-0">
          <div className="p-6 border-b border-gray-100 flex items-center gap-2">
            <Palette className="w-5 h-5 text-pink-500" />
            <h3 className="text-lg font-bold text-gray-900">熱銷顏色排行 (Top 5)</h3>
          </div>
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">排名</th>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">顏色名稱</th>
                <th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">選擇次數</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-200">
              {data.colorStats?.map((item: any, index: number) => (
                <tr key={index} className="hover:bg-gray-50">
                  <td className="px-6 py-4 text-sm text-gray-500 font-bold">#{index + 1}</td>
                  <td className="px-6 py-4 text-sm text-gray-900 font-medium">{item.name || '未選色'}</td>
                  <td className="px-6 py-4 text-sm text-gray-900 text-right">{item.count}</td>
                </tr>
              ))}
              {(!data.colorStats || data.colorStats.length === 0) && <tr><td colSpan={3} className="p-4 text-center text-gray-400 text-sm">暫無數據</td></tr>}
            </tbody>
          </table>
        </div>

      </div>
    </div>
  );
}
</file>

<file path="admin/src/app/series/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { Plus, Edit, Trash2, Save, X, Image as ImageIcon, Loader2, UploadCloud, Layers } from 'lucide-react';
import { api } from '@/lib/api';

// ⚠️ 請填入您的 Cloudinary 資訊
const CLOUDINARY_CLOUD_NAME = 'dnibj8za6'; 
const CLOUDINARY_PRESET = 'yasou70731'; 

export default function SeriesPage() {
  const [seriesList, setSeriesList] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);

  // 表單控制
  const { register, handleSubmit, reset, setValue, watch } = useForm({
    defaultValues: {
      name: '',        // 系統代碼
      displayName: '', // 顯示名稱
      description: '', // 描述
      priceStart: 0,   // 起始價
      imageUrl: '',    // 封面圖
      isActive: true
    }
  });

  const imageUrl = watch('imageUrl');
  const [isUploading, setIsUploading] = useState(false);

  // 1. 載入列表
  const fetchSeries = async () => {
    try {
      const res = await api.get('/series');
      // ✨ Fix: 直接使用 res，並確保它是陣列
      if (Array.isArray(res)) {
        setSeriesList(res);
      } else {
        console.warn('API 回傳格式異常 (非陣列):', res);
        setSeriesList([]);
      }
    } catch (err) {
      console.error(err);
      setSeriesList([]);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => { fetchSeries(); }, []);

  // 2. 圖片上傳
  const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;
    setIsUploading(true);
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', CLOUDINARY_PRESET);

    try {
      const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, { method: 'POST', body: formData });
      const data = await res.json();
      if (data.secure_url) setValue('imageUrl', data.secure_url);
    } catch (err) {
      alert('圖片上傳失敗');
    } finally {
      setIsUploading(false);
    }
  };

  // 3. 送出表單 (新增或修改)
  const onSubmit = async (data: any) => {
    try {
      if (editingId) {
        await api.patch(`/series/${editingId}`, data);
        alert('修改成功');
      } else {
        await api.post('/series', data);
        alert('新增成功');
      }
      closeModal();
      fetchSeries();
    } catch (err) {
      alert('操作失敗 (名稱可能重複)');
    }
  };

  // 4. 刪除
  const handleDelete = async (id: string) => {
    if (!confirm('確定刪除此系列嗎？(底下的產品可能會找不到系列)')) return;
    try {
      await api.delete(`/series/${id}`);
      fetchSeries();
    } catch (err) { alert('刪除失敗'); }
  };

  // 開啟編輯
  const openEdit = (series: any) => {
    setEditingId(series.id);
    reset(series);
    setIsModalOpen(true);
  };

  const closeModal = () => {
    setIsModalOpen(false);
    setEditingId(null);
    reset({ name: '', displayName: '', description: '', priceStart: 0, imageUrl: '', isActive: true });
  };

  return (
    <div className="min-h-screen bg-gray-50 p-8 font-sans">
      <div className="flex justify-between items-center mb-8">
        <div>
          <h1 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
            <Layers className="w-6 h-6 text-blue-600" /> 系列管理
          </h1>
          <p className="text-gray-500 text-sm mt-1">管理前台首頁顯示的產品系列與封面圖</p>
        </div>
        <button onClick={() => setIsModalOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-sm">
          <Plus className="w-5 h-5" /> 新增系列
        </button>
      </div>

      {/* 列表 */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {loading ? <p>載入中...</p> : seriesList.map((item) => (
          <div key={item.id} className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden group">
            <div className="relative h-48 bg-gray-100">
              {/* eslint-disable-next-line @next/next/no-img-element */}
              <img src={item.imageUrl} alt={item.name} className="w-full h-full object-cover" />
              <div className="absolute top-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                <button onClick={() => openEdit(item)} className="p-2 bg-white rounded-full shadow hover:text-blue-600"><Edit className="w-4 h-4" /></button>
                <button onClick={() => handleDelete(item.id)} className="p-2 bg-white rounded-full shadow hover:text-red-600"><Trash2 className="w-4 h-4" /></button>
              </div>
            </div>
            <div className="p-4">
              <h3 className="font-bold text-gray-900 text-lg">{item.displayName}</h3>
              <p className="text-xs text-gray-500 mb-2">系統代碼: {item.name}</p>
              <p className="text-sm text-gray-600 line-clamp-2 mb-3">{item.description}</p>
              <div className="flex justify-between items-center pt-3 border-t border-gray-50">
                <span className="text-blue-600 font-bold">${item.priceStart?.toLocaleString()} 起</span>
                <span className={`text-xs px-2 py-1 rounded ${item.isActive ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}`}>
                  {item.isActive ? '顯示中' : '已隱藏'}
                </span>
              </div>
            </div>
          </div>
        ))}
      </div>

      {/* 彈窗 Modal */}
      {isModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-6">
              <h3 className="text-xl font-bold text-gray-900">{editingId ? '編輯系列' : '新增系列'}</h3>
              <button onClick={closeModal} className="text-gray-400 hover:text-gray-600"><X className="w-5 h-5" /></button>
            </div>
            
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-bold text-gray-700 mb-1">系統代碼 (Name)</label>
                <input {...register('name', { required: true })} placeholder="例如：極簡系列 (需與產品設定一致)" className="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" />
                <p className="text-xs text-gray-400 mt-1">※ 此名稱用於關聯產品，請勿隨意修改</p>
              </div>
              <div>
                <label className="block text-sm font-bold text-gray-700 mb-1">顯示名稱 (Display Name)</label>
                <input {...register('displayName', { required: true })} placeholder="例如：極簡細框系列" className="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" />
              </div>
              <div>
                <label className="block text-sm font-bold text-gray-700 mb-1">描述</label>
                <textarea {...register('description')} rows={2} className="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" />
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-bold text-gray-700 mb-1">起始價格</label>
                  <input type="number" {...register('priceStart', { valueAsNumber: true })} className="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                <div className="flex items-center mt-6">
                  <label className="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" {...register('isActive')} className="w-4 h-4 text-blue-600" />
                    <span className="text-sm text-gray-700">啟用顯示</span>
                  </label>
                </div>
              </div>

              {/* 圖片上傳 */}
              <div>
                <label className="block text-sm font-bold text-gray-700 mb-2">封面圖片</label>
                <div className="flex gap-4 items-start">
                  <label className="flex-1 h-24 border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-gray-50">
                    {isUploading ? <Loader2 className="animate-spin text-gray-400" /> : <UploadCloud className="text-gray-400" />}
                    <span className="text-xs text-gray-500 mt-1">點擊上傳圖片</span>
                    <input type="file" hidden accept="image/*" onChange={handleImageUpload} />
                  </label>
                  <div className="w-24 h-24 bg-gray-100 rounded-lg border overflow-hidden shrink-0">
                    {imageUrl ? (
                      // eslint-disable-next-line @next/next/no-img-element
                      <img src={imageUrl} className="w-full h-full object-cover" alt="Preview" />
                    ) : <div className="w-full h-full flex items-center justify-center text-xs text-gray-400">預覽</div>}
                  </div>
                </div>
                <input type="hidden" {...register('imageUrl')} />
              </div>

              <button onClick={handleSubmit(onSubmit)} className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 mt-4 flex justify-center items-center gap-2">
                <Save className="w-4 h-4" /> 儲存設定
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="admin/src/app/settings/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { Save, Plus, Trash2, Briefcase, Ruler, Megaphone, LayoutTemplate, Loader2, UploadCloud, X, ArrowUp, ArrowDown, Edit, List, Image as ImageIcon, Settings as SettingsIcon, ShieldAlert, Lock, Globe, Percent, CalendarClock, Building } from 'lucide-react';
import clsx from 'clsx';
import { api } from '@/lib/api';

const CLOUDINARY_CLOUD_NAME = 'dnibj8za6'; 
const CLOUDINARY_PRESET = 'yasou70731'; 

interface Category { id: string; name: string; code: string; isUpgradeable: boolean; discountRate: number; }
interface Announcement { id: string; content: string; isActive: boolean; createdAt: string; }

export default function SettingsPage() {
  const [activeTab, setActiveTab] = useState('category');
  
  // 資料狀態
  const [categories, setCategories] = useState<Category[]>([]);
  const [announcements, setAnnouncements] = useState<Announcement[]>([]);
  const [siteConfig, setSiteConfig] = useState<any>({ blocks: [] });
  
  // 系統規則狀態
  const [systemRules, setSystemRules] = useState<any>({
    enable_registration: true,
    maintenance_mode: false,
    allow_guest_view: true,
    discount_level_A: 0.85,
    discount_level_B: 0.95,
    order_reset_day: 1,
    company_name: '',
    tax_id: '',
    phone: '',
    address: '',
    copyright_text: ''
  });

  const [isConfigLoading, setIsConfigLoading] = useState(false);
  const [editingBlock, setEditingBlock] = useState<any>(null); // 正在編輯的積木
  const [isUploading, setIsUploading] = useState(false);

  // 載入資料
  const fetchCategories = async () => { try { const res = await api.get('/trade-categories'); setCategories(res.data || res); } catch (e) {} };
  const fetchAnnouncements = async () => { try { const res = await api.get('/announcements'); setAnnouncements(res.data || res); } catch (e) {} };
  const fetchSiteConfig = async () => {
    setIsConfigLoading(true);
    try { const res = await api.get('/site-config/homepage'); if (!res.blocks) res.blocks = []; setSiteConfig(res); } catch (e) {}
    finally { setIsConfigLoading(false); }
  };
  const fetchSystemRules = async () => {
    try { const res = await api.get('/site-config/rules'); if (res.settings) setSystemRules(res.settings); } catch (e) {}
  };

  useEffect(() => {
    if (activeTab === 'category') fetchCategories();
    if (activeTab === 'announcement') fetchAnnouncements();
    if (activeTab === 'homepage') fetchSiteConfig();
    if (activeTab === 'rules') fetchSystemRules();
  }, [activeTab]);

  // --- 1. 營業類別操作 ---
  const handleAddCategory = async () => {
    const name = prompt('請輸入分類名稱'); if (!name) return;
    const code = prompt('請輸入代碼'); if (!code) return;
    const rateStr = prompt('預設折數', '1.0');
    try { await api.post('/trade-categories', { name, code, discountRate: parseFloat(rateStr || '1.0'), isUpgradeable: false }); fetchCategories(); } 
    catch (e) { alert('新增失敗'); }
  };
  const handleDeleteCategory = async (id: string) => { if(confirm('確定刪除？')) { await api.delete(`/trade-categories/${id}`); fetchCategories(); } };
  const handleToggleCategory = async (id: string, val: boolean) => { await api.patch(`/trade-categories/${id}`, { isUpgradeable: !val }); fetchCategories(); };
  const handleRateChange = async (id: string, val: number) => { await api.patch(`/trade-categories/${id}`, { discountRate: val }); };
  
  // --- 2. 公告操作 ---
  const handleAddAnnouncement = async () => { const content = prompt('內容：'); if(content) { await api.post('/announcements', { content }); fetchAnnouncements(); } };
  const handleToggleAnnouncement = async (id: string, val: boolean) => { await api.patch(`/announcements/${id}`, { isActive: !val }); fetchAnnouncements(); };
  const handleDeleteAnnouncement = async (id: string) => { if(confirm('刪除?')) { await api.delete(`/announcements/${id}`); fetchAnnouncements(); }};

  // --- 3. 首頁積木操作 ---
  const addBlock = (type: string) => {
    const newBlock = {
      id: crypto.randomUUID(),
      type,
      data: type === 'HERO' ? { title: '新標題', subtitle: '副標題', images: [] } :
            type === 'FEATURES' ? { title: '特色介紹', items: [{title:'特色1', desc:'描述'},{title:'特色2', desc:'描述'},{title:'特色3', desc:'描述'}] } :
            { title: '產品列表', count: 4 }
    };
    setSiteConfig({ ...siteConfig, blocks: [...(siteConfig.blocks || []), newBlock] });
  };
  const removeBlock = (id: string) => { if(!confirm('確定移除此區塊？')) return; setSiteConfig({ ...siteConfig, blocks: siteConfig.blocks.filter((b: any) => b.id !== id) }); };
  const moveBlock = (index: number, direction: -1 | 1) => {
    const newBlocks = [...siteConfig.blocks];
    if (index + direction < 0 || index + direction >= newBlocks.length) return;
    const temp = newBlocks[index];
    newBlocks[index] = newBlocks[index + direction];
    newBlocks[index + direction] = temp;
    setSiteConfig({ ...siteConfig, blocks: newBlocks });
  };
  const saveConfig = async () => { try { await api.patch('/site-config/homepage', siteConfig); alert('儲存成功！前台首頁已更新。'); } catch (e) { alert('儲存失敗'); } };
  
  const handleEditImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (!files?.length) return;
    setIsUploading(true);
    const newImages = [...(editingBlock.data.images || [])];
    try {
      for (let i = 0; i < files.length; i++) {
        const formData = new FormData();
        formData.append('file', files[i]);
        formData.append('upload_preset', CLOUDINARY_PRESET);
        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, { method: 'POST', body: formData });
        const data = await res.json();
        if (data.secure_url) newImages.push(data.secure_url);
      }
      setEditingBlock({ ...editingBlock, data: { ...editingBlock.data, images: newImages } });
    } finally { setIsUploading(false); }
  };

  // --- 4. 系統規則操作 ---
  const saveRules = async () => {
    try {
      await api.patch('/site-config/rules', systemRules);
      alert('系統規則已更新！');
    } catch (e) { alert('儲存失敗'); }
  };

  return (
    <div className="min-h-screen bg-gray-50 p-8 font-sans">
      <div className="mb-8">
        <h1 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
          <div className="p-2 bg-gray-200 rounded-lg"><Briefcase className="w-6 h-6 text-gray-700" /></div>
          系統設定
        </h1>
        <p className="text-gray-500 text-sm mt-1">全域參數配置中心</p>
      </div>

      <div className="flex flex-col lg:flex-row gap-8">
        {/* 左側選單 */}
        <div className="w-full lg:w-64 shrink-0 space-y-2">
          <button onClick={() => setActiveTab('category')} className={clsx("w-full text-left px-4 py-3 rounded-lg font-medium flex items-center gap-3 transition-all", activeTab === 'category' ? "bg-white shadow-sm text-blue-600 border border-blue-100" : "text-gray-600 hover:bg-white hover:shadow-sm")}><Briefcase className="w-5 h-5" /> 營業類別管理</button>
          <button onClick={() => setActiveTab('params')} className={clsx("w-full text-left px-4 py-3 rounded-lg font-medium flex items-center gap-3 transition-all", activeTab === 'params' ? "bg-white shadow-sm text-blue-600 border border-blue-100" : "text-gray-600 hover:bg-white hover:shadow-sm")}><Ruler className="w-5 h-5" /> 施工參數設定</button>
          <button onClick={() => setActiveTab('announcement')} className={clsx("w-full text-left px-4 py-3 rounded-lg font-medium flex items-center gap-3 transition-all", activeTab === 'announcement' ? "bg-white shadow-sm text-blue-600 border border-blue-100" : "text-gray-600 hover:bg-white hover:shadow-sm")}><Megaphone className="w-5 h-5" /> 網站公告</button>
          <button onClick={() => setActiveTab('homepage')} className={clsx("w-full text-left px-4 py-3 rounded-lg font-medium flex items-center gap-3 transition-all", activeTab === 'homepage' ? "bg-white shadow-sm text-blue-600 border border-blue-100" : "text-gray-600 hover:bg-white hover:shadow-sm")}><LayoutTemplate className="w-5 h-5" /> 首頁積木配置</button>
          <button onClick={() => setActiveTab('rules')} className={clsx("w-full text-left px-4 py-3 rounded-lg font-medium flex items-center gap-3 transition-all", activeTab === 'rules' ? "bg-white shadow-sm text-blue-600 border border-blue-100" : "text-gray-600 hover:bg-white hover:shadow-sm")}><SettingsIcon className="w-5 h-5" /> 系統規則設定</button>
        </div>

        {/* 右側內容 */}
        <div className="flex-1">
          
          {/* Tab 1: 營業類別 (完整邏輯) */}
          {activeTab === 'category' && (
            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
              <div className="p-6 border-b border-gray-100 flex justify-between items-center">
                <h3 className="text-lg font-bold text-gray-900">營業類別管理</h3>
                <button onClick={handleAddCategory} className="flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 font-bold text-sm"><Plus className="w-4 h-4" /> 新增</button>
              </div>
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                  <tr><th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">名稱</th><th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">預設折數</th><th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">升級資格</th><th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">操作</th></tr>
                </thead>
                <tbody className="divide-y divide-gray-200">
                  {categories.map((cat) => (
                    <tr key={cat.id} className="hover:bg-gray-50">
                      <td className="px-6 py-4 text-sm font-bold text-gray-900">{cat.name} <span className="text-gray-400 text-xs">({cat.code})</span></td>
                      <td className="px-6 py-4"><input type="number" step="0.01" defaultValue={cat.discountRate} onBlur={(e) => handleRateChange(cat.id, parseFloat(e.target.value))} className="w-16 p-1 border rounded text-center font-mono text-sm" /></td>
                      <td className="px-6 py-4"><button onClick={() => handleToggleCategory(cat.id, cat.isUpgradeable)} className={clsx("relative inline-flex h-6 w-11 items-center rounded-full transition-colors", cat.isUpgradeable ? "bg-green-500" : "bg-gray-200")}><span className={clsx("inline-block h-4 w-4 transform rounded-full bg-white transition-transform", cat.isUpgradeable ? "translate-x-6" : "translate-x-1")}/></button></td>
                      <td className="px-6 py-4 text-right"><button onClick={() => handleDeleteCategory(cat.id)} className="text-gray-400 hover:text-red-500"><Trash2 className="w-4 h-4" /></button></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}

          {/* Tab 2: 施工參數 (保留佔位) */}
          {activeTab === 'params' && (
            <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-8 text-center text-gray-500">施工參數設定功能開發中...</div>
          )}

          {/* Tab 3: 網站公告 (完整邏輯) */}
          {activeTab === 'announcement' && (
            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
              <div className="p-6 border-b border-gray-100 flex justify-between items-center">
                <h3 className="text-lg font-bold text-gray-900">網站公告發布</h3>
                <button onClick={handleAddAnnouncement} className="flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 font-bold text-sm"><Plus className="w-4 h-4" /> 發布公告</button>
              </div>
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50"><tr><th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">公告內容</th><th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">狀態</th><th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">操作</th></tr></thead>
                <tbody className="divide-y divide-gray-200">
                  {announcements.map((item) => (
                    <tr key={item.id} className="hover:bg-gray-50">
                      <td className="px-6 py-4 text-sm text-gray-900">{item.content}</td>
                      <td className="px-6 py-4"><button onClick={() => handleToggleAnnouncement(item.id, item.isActive)} className={clsx("px-2 py-1 rounded text-xs font-bold", item.isActive ? "bg-green-100 text-green-700" : "bg-gray-100 text-gray-500")}>{item.isActive ? '顯示中' : '已隱藏'}</button></td>
                      <td className="px-6 py-4 text-right"><button onClick={() => handleDeleteAnnouncement(item.id)} className="text-gray-400 hover:text-red-500"><Trash2 className="w-4 h-4" /></button></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}

          {/* Tab 4: 首頁積木配置 (完整邏輯) */}
          {activeTab === 'homepage' && (
            <div className="flex gap-8 items-start">
              <div className="w-1/3 bg-white p-4 rounded-xl shadow-sm border border-gray-200 space-y-4">
                <h3 className="font-bold text-gray-700 border-b pb-2 mb-2">區塊排序與管理</h3>
                {isConfigLoading ? <div className="text-center py-4"><Loader2 className="animate-spin w-6 h-6 text-blue-600 mx-auto" /></div> : (
                  <div className="space-y-3">
                    {siteConfig.blocks?.map((block: any, idx: number) => (
                      <div key={block.id} className="flex items-center justify-between p-3 bg-gray-50 border border-gray-200 rounded-lg group hover:border-blue-300 transition-colors">
                        <div className="flex items-center gap-3">
                          <span className="w-6 h-6 bg-blue-100 text-blue-600 rounded flex items-center justify-center text-xs font-bold">{idx + 1}</span>
                          <span className="font-medium text-gray-700 text-sm">
                            {block.type === 'HERO' ? '主視覺輪播' : block.type === 'FEATURES' ? '特色介紹' : '產品列表'}
                          </span>
                        </div>
                        <div className="flex items-center gap-1 opacity-60 group-hover:opacity-100 transition-opacity">
                          <button onClick={() => moveBlock(idx, -1)} disabled={idx === 0} className="p-1 hover:bg-gray-200 rounded disabled:opacity-30"><ArrowUp className="w-4 h-4" /></button>
                          <button onClick={() => moveBlock(idx, 1)} disabled={idx === siteConfig.blocks.length - 1} className="p-1 hover:bg-gray-200 rounded disabled:opacity-30"><ArrowDown className="w-4 h-4" /></button>
                          <button onClick={() => setEditingBlock(block)} className="p-1 hover:bg-blue-100 text-blue-600 rounded"><Edit className="w-4 h-4" /></button>
                          <button onClick={() => removeBlock(block.id)} className="p-1 hover:bg-red-100 text-red-600 rounded"><Trash2 className="w-4 h-4" /></button>
                        </div>
                      </div>
                    ))}
                    {siteConfig.blocks?.length === 0 && <div className="text-center text-gray-400 py-4 text-sm">目前無區塊</div>}
                  </div>
                )}

                <div className="grid grid-cols-3 gap-2 pt-2 border-t mt-4">
                  <button onClick={() => addBlock('HERO')} className="p-2 bg-gray-50 border border-dashed border-gray-300 rounded hover:border-blue-500 hover:text-blue-600 flex flex-col items-center gap-1 text-[10px] font-medium transition-colors"><ImageIcon className="w-4 h-4" />+ 主視覺</button>
                  <button onClick={() => addBlock('FEATURES')} className="p-2 bg-gray-50 border border-dashed border-gray-300 rounded hover:border-blue-500 hover:text-blue-600 flex flex-col items-center gap-1 text-[10px] font-medium transition-colors"><List className="w-4 h-4" />+ 特色欄</button>
                  <button onClick={() => addBlock('PRODUCT_LIST')} className="p-2 bg-gray-50 border border-dashed border-gray-300 rounded hover:border-blue-500 hover:text-blue-600 flex flex-col items-center gap-1 text-[10px] font-medium transition-colors"><LayoutTemplate className="w-4 h-4" />+ 產品列</button>
                </div>

                <button onClick={saveConfig} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold shadow hover:bg-blue-700 transition-colors flex items-center justify-center gap-2"><Save className="w-4 h-4" /> 儲存發布</button>
              </div>

              <div className="flex-1 bg-white rounded-xl border border-gray-200 p-8 flex flex-col items-center justify-center text-gray-400 min-h-[400px]">
                <LayoutTemplate className="w-16 h-16 mb-4 text-gray-200" />
                <p className="text-lg font-medium text-gray-500">點擊左側「筆」圖示開始編輯</p>
                <p className="text-sm mt-2">您可以新增多個區塊，並自由拖曳排序。</p>
              </div>
            </div>
          )}

          {/* ✨ Tab 5: 系統規則設定 (完整邏輯) */}
          {activeTab === 'rules' && (
            <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6 space-y-8">
              <div className="border-b border-gray-100 pb-4">
                <h3 className="text-lg font-bold text-gray-900">系統營運規則</h3>
                <p className="text-sm text-gray-500">控制網站的全域開關與權限</p>
              </div>

              <div className="space-y-4">
                <h4 className="text-sm font-bold text-gray-900 flex items-center gap-2"><Building className="w-4 h-4" /> 公司資訊與頁尾設定</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg border border-gray-200">
                  <div className="col-span-1 md:col-span-2"><label className="block text-sm font-medium text-gray-700 mb-1">公司名稱</label><input type="text" value={systemRules.company_name || ''} onChange={(e) => setSystemRules({...systemRules, company_name: e.target.value})} className="w-full p-2 border border-gray-300 rounded-lg outline-none" /></div>
                  <div><label className="block text-sm font-medium text-gray-700 mb-1">統一編號</label><input type="text" value={systemRules.tax_id || ''} onChange={(e) => setSystemRules({...systemRules, tax_id: e.target.value})} className="w-full p-2 border border-gray-300 rounded-lg outline-none" /></div>
                  <div><label className="block text-sm font-medium text-gray-700 mb-1">聯絡電話</label><input type="text" value={systemRules.phone || ''} onChange={(e) => setSystemRules({...systemRules, phone: e.target.value})} className="w-full p-2 border border-gray-300 rounded-lg outline-none" /></div>
                  <div className="col-span-1 md:col-span-2"><label className="block text-sm font-medium text-gray-700 mb-1">公司地址</label><input type="text" value={systemRules.address || ''} onChange={(e) => setSystemRules({...systemRules, address: e.target.value})} className="w-full p-2 border border-gray-300 rounded-lg outline-none" /></div>
                  <div className="col-span-1 md:col-span-2"><label className="block text-sm font-medium text-gray-700 mb-1">版權宣告 (Copyright)</label><input type="text" value={systemRules.copyright_text || ''} onChange={(e) => setSystemRules({...systemRules, copyright_text: e.target.value})} className="w-full p-2 border border-gray-300 rounded-lg outline-none" /></div>
                </div>
              </div>
              
              <div className="border-t border-gray-100 my-4"></div>

              <div className="bg-blue-50 border border-blue-100 rounded-xl p-4 flex items-start gap-3">
                <ShieldAlert className="w-6 h-6 text-blue-600 mt-0.5" />
                <div>
                  <h4 className="font-bold text-blue-900 mb-1">🔒 核心金流規則 (已硬編碼寫死)</h4>
                  <ul className="text-sm text-blue-800 space-y-1 list-disc list-inside">
                    <li>A 級會員儲值上限：<span className="font-mono font-bold">NT$ 200,000</span></li>
                    <li>B 級會員儲值上限：<span className="font-mono font-bold">NT$ 100,000</span></li>
                  </ul>
                </div>
              </div>

              <div className="space-y-4">
                <h4 className="text-sm font-bold text-gray-900 flex items-center gap-2"><Percent className="w-4 h-4" /> 會員價格策略</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg border border-gray-200">
                  <div><label className="block text-sm font-medium text-gray-700 mb-1">A 級會員預設折數</label><input type="number" step="0.01" value={systemRules.discount_level_A} onChange={(e) => setSystemRules({...systemRules, discount_level_A: parseFloat(e.target.value)})} className="w-full p-2 border border-gray-300 rounded-lg outline-none font-mono" /></div>
                  <div><label className="block text-sm font-medium text-gray-700 mb-1">B 級會員預設折數</label><input type="number" step="0.01" value={systemRules.discount_level_B} onChange={(e) => setSystemRules({...systemRules, discount_level_B: parseFloat(e.target.value)})} className="w-full p-2 border border-gray-300 rounded-lg outline-none font-mono" /></div>
                </div>
              </div>

              <div className="space-y-4 pt-4 border-t border-gray-100">
                <h4 className="text-sm font-bold text-gray-900 flex items-center gap-2"><CalendarClock className="w-4 h-4" /> 訂單流水號設定</h4>
                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                  <label className="block text-sm font-medium text-gray-700 mb-1">流水號重置日 (每月幾號)</label>
                  <input type="number" min="1" max="31" value={systemRules.order_reset_day || 1} onChange={(e) => setSystemRules({...systemRules, order_reset_day: parseInt(e.target.value)})} className="w-full p-2 border border-gray-300 rounded-lg outline-none font-mono" />
                </div>
              </div>

              <div className="space-y-6 pt-4 border-t border-gray-100">
                <h4 className="text-sm font-bold text-gray-900 flex items-center gap-2"><SettingsIcon className="w-4 h-4" /> 功能開關</h4>
                <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200">
                  <div className="flex items-center gap-3"><div className="p-2 bg-white rounded-full border"><Lock className="w-5 h-5 text-gray-600" /></div><div><div className="font-bold text-gray-900">開放經銷商註冊</div><div className="text-xs text-gray-500">關閉後，前台註冊功能將隱藏。</div></div></div>
                  <label className="relative inline-flex items-center cursor-pointer"><input type="checkbox" checked={systemRules.enable_registration} onChange={(e) => setSystemRules({...systemRules, enable_registration: e.target.checked})} className="sr-only peer" /><div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
                </div>
                <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200">
                  <div className="flex items-center gap-3"><div className="p-2 bg-white rounded-full border"><ShieldAlert className="w-5 h-5 text-orange-600" /></div><div><div className="font-bold text-gray-900">系統維護模式</div><div className="text-xs text-gray-500">開啟後，前台將顯示「系統維護中」。</div></div></div>
                  <label className="relative inline-flex items-center cursor-pointer"><input type="checkbox" checked={systemRules.maintenance_mode} onChange={(e) => setSystemRules({...systemRules, maintenance_mode: e.target.checked})} className="sr-only peer" /><div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-orange-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div></label>
                </div>
              </div>

              <button onClick={saveRules} className="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-sm transition-all mt-4">儲存系統設定</button>
            </div>
          )}

        </div>
      </div>

      {/* 積木編輯 Modal */}
      {editingBlock && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-xl p-6 max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-6 pb-4 border-b">
              <h3 className="text-xl font-bold text-gray-900">編輯區塊</h3>
              <button onClick={() => setEditingBlock(null)} className="text-gray-400 hover:text-gray-600"><X className="w-5 h-5" /></button>
            </div>
            <div className="space-y-5">
              {editingBlock.type === 'HERO' && (
                <>
                  <div><label className="block text-sm font-bold mb-1 text-gray-700">主標題</label><textarea rows={2} value={editingBlock.data.title} onChange={(e) => setEditingBlock({...editingBlock, data: {...editingBlock.data, title: e.target.value}})} className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" /></div>
                  <div><label className="block text-sm font-bold mb-1 text-gray-700">副標題</label><input type="text" value={editingBlock.data.subtitle} onChange={(e) => setEditingBlock({...editingBlock, data: {...editingBlock.data, subtitle: e.target.value}})} className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" /></div>
                  <div>
                    <label className="block text-sm font-bold mb-2 text-gray-700">輪播圖片</label>
                    <div className="grid grid-cols-3 gap-3 mb-2">
                      {editingBlock.data.images?.map((url: string, i: number) => (
                        <div key={i} className="relative aspect-video bg-gray-100 rounded-lg overflow-hidden group border">
                          <img src={url} className="w-full h-full object-cover" alt="slide" />
                          <button onClick={() => {
                            const newImgs = editingBlock.data.images.filter((_:any, idx:number) => idx !== i);
                            setEditingBlock({...editingBlock, data: {...editingBlock.data, images: newImgs}});
                          }} className="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"><X className="w-3 h-3"/></button>
                        </div>
                      ))}
                      <label className="flex flex-col items-center justify-center border-2 border-dashed rounded-lg cursor-pointer h-full hover:bg-gray-50 transition-colors">
                        {isUploading ? <Loader2 className="animate-spin w-5 h-5 text-gray-400"/> : <Plus className="w-6 h-6 text-gray-400"/>}
                        <span className="text-xs text-gray-500 mt-1">上傳</span>
                        <input type="file" hidden multiple accept="image/*" onChange={handleEditImageUpload} disabled={isUploading} />
                      </label>
                    </div>
                  </div>
                </>
              )}
              {editingBlock.type === 'FEATURES' && (
                <>
                  <div><label className="block text-sm font-bold mb-1 text-gray-700">區塊標題</label><input type="text" value={editingBlock.data.title} onChange={(e) => setEditingBlock({...editingBlock, data: {...editingBlock.data, title: e.target.value}})} className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" /></div>
                  <div className="space-y-3">
                    {editingBlock.data.items.map((item: any, i: number) => (
                      <div key={i} className="p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <div className="text-xs font-bold text-gray-500 mb-2 uppercase tracking-wider">特色重點 {i + 1}</div>
                        <input type="text" value={item.title} onChange={(e) => { const newItems = [...editingBlock.data.items]; newItems[i].title = e.target.value; setEditingBlock({...editingBlock, data: {...editingBlock.data, items: newItems}}); }} className="w-full p-2 border rounded mb-2 text-sm bg-white" placeholder="標題" />
                        <textarea rows={2} value={item.desc} onChange={(e) => { const newItems = [...editingBlock.data.items]; newItems[i].desc = e.target.value; setEditingBlock({...editingBlock, data: {...editingBlock.data, items: newItems}}); }} className="w-full p-2 border rounded text-sm bg-white" placeholder="描述內容" />
                      </div>
                    ))}
                  </div>
                </>
              )}
              {editingBlock.type === 'PRODUCT_LIST' && (
                <>
                  <div><label className="block text-sm font-bold mb-1 text-gray-700">列表標題</label><input type="text" value={editingBlock.data.title} onChange={(e) => setEditingBlock({...editingBlock, data: {...editingBlock.data, title: e.target.value}})} className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" /></div>
                  <div><label className="block text-sm font-bold mb-1 text-gray-700">顯示數量</label><input type="number" value={editingBlock.data.count} onChange={(e) => setEditingBlock({...editingBlock, data: {...editingBlock.data, count: Number(e.target.value)}})} className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" /></div>
                </>
              )}
              <div className="pt-4 border-t mt-4 flex gap-3">
                <button onClick={() => setEditingBlock(null)} className="flex-1 py-2.5 border border-gray-300 text-gray-700 rounded-lg font-bold hover:bg-gray-50 transition-colors">取消</button>
                <button onClick={() => { const newBlocks = siteConfig.blocks.map((b: any) => b.id === editingBlock.id ? editingBlock : b); setSiteConfig({ ...siteConfig, blocks: newBlocks }); setEditingBlock(null); }} className="flex-1 py-2.5 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors shadow-sm">確認修改</button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="admin/src/components/Sidebar.tsx">
'use client';

import Link from "next/link";
import { useRouter } from "next/navigation";
import { LayoutDashboard, Package, Users, Settings, LogOut, Layers, BarChart3 } from "lucide-react"; // ✨ 引入 BarChart3 圖示

export default function Sidebar() {
  const router = useRouter();

  // 登出邏輯
  const handleLogout = () => {
    if (confirm('確定要登出管理後台嗎？')) {
      localStorage.removeItem('somalink_admin_token');
      localStorage.removeItem('somalink_admin_user');
      window.location.href = '/login';
    }
  };

  return (
    <aside className="w-64 bg-slate-900 text-white shrink-0 hidden md:flex flex-col fixed inset-y-0 left-0 z-50">
      
      {/* Logo 區 */}
      <div className="h-16 flex items-center px-6 border-b border-slate-800 shadow-md bg-slate-900">
        <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center font-bold text-lg mr-3 shadow-blue-900/20">
          S
        </div>
        <span className="font-bold text-lg tracking-wide">松成有限公司</span>
      </div>

      {/* 選單連結區 */}
      <nav className="flex-1 py-6 space-y-2 px-3 overflow-y-auto">
        <Link 
          href="/" 
          className="flex items-center px-3 py-3 text-slate-300 hover:text-white hover:bg-slate-800 rounded-lg transition-colors group"
        >
          <LayoutDashboard className="w-5 h-5 mr-3 group-hover:text-blue-400 transition-colors" />
          訂單戰情室
        </Link>

        {/* ✨ 新增：營運報表按鈕 */}
        <Link 
          href="/reports" 
          className="flex items-center px-3 py-3 text-slate-300 hover:text-white hover:bg-slate-800 rounded-lg transition-colors group"
        >
          <BarChart3 className="w-5 h-5 mr-3 group-hover:text-blue-400 transition-colors" />
          營運報表
        </Link>

        <Link 
          href="/products" 
          className="flex items-center px-3 py-3 text-slate-300 hover:text-white hover:bg-slate-800 rounded-lg transition-colors group"
        >
          <Package className="w-5 h-5 mr-3 group-hover:text-blue-400 transition-colors" />
          產品管理
        </Link>

        <Link 
          href="/series" 
          className="flex items-center px-3 py-3 text-slate-300 hover:text-white hover:bg-slate-800 rounded-lg transition-colors group"
        >
          <Layers className="w-5 h-5 mr-3 group-hover:text-blue-400 transition-colors" />
          系列管理
        </Link>

        <Link 
          href="/users" 
          className="flex items-center px-3 py-3 text-slate-300 hover:text-white hover:bg-slate-800 rounded-lg transition-colors group"
        >
          <Users className="w-5 h-5 mr-3 group-hover:text-blue-400 transition-colors" />
          會員管理
        </Link>

        <div className="pt-4 mt-4 border-t border-slate-800">
          <Link 
            href="/settings" 
            className="flex items-center px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors"
          >
            <Settings className="w-5 h-5 mr-3" />
            系統設定
          </Link>
        </div>
      </nav>

      {/* 底部使用者資訊 & 登出按鈕 */}
      <div className="p-4 border-t border-slate-800 bg-slate-900">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-full bg-linear-to-tr from-blue-500 to-purple-500 flex items-center justify-center shadow-lg font-bold text-sm">
            A
          </div>
          <div className="flex-1 min-w-0">
            <p className="text-sm font-medium truncate">Admin</p>
            <p className="text-xs text-slate-500 truncate">超級管理員</p>
          </div>
          <button 
            onClick={handleLogout}
            className="text-slate-400 hover:text-red-400 hover:bg-slate-800 p-2 rounded-md transition-all"
            title="登出系統"
          >
            <LogOut className="w-5 h-5" />
          </button>
        </div>
      </div>
    </aside>
  );
}
</file>

<file path="backend/package.json">
{
  "name": "backend",
  "version": "0.0.1",
  "description": "",
  "author": "",
  "private": true,
  "license": "UNLICENSED",
  "scripts": {
    "build": "nest build",
    "format": "prettier --write \"src/**/*.ts\" \"test/**/*.ts\"",
    "start": "nest start",
    "start:dev": "nest start --watch",
    "start:debug": "nest start --debug --watch",
    "start:prod": "node dist/main",
    "lint": "eslint \"{src,apps,libs,test}/**/*.ts\" --fix",
    "test": "jest",
    "test:watch": "jest --watch",
    "test:cov": "jest --coverage",
    "test:debug": "node --inspect-brk -r tsconfig-paths/register -r ts-node/register node_modules/.bin/jest --runInBand",
    "test:e2e": "jest --config ./test/jest-e2e.json"
  },
  "dependencies": {
    "@nestjs/axios": "^4.0.1",
    "@nestjs/common": "^11.0.1",
    "@nestjs/config": "^4.0.2",
    "@nestjs/core": "^11.0.1",
    "@nestjs/jwt": "^11.0.1",
    "@nestjs/mapped-types": "*",
    "@nestjs/passport": "^11.0.5",
    "@nestjs/platform-express": "^11.0.1",
    "@nestjs/typeorm": "^11.0.0",
    "@types/nodemailer": "^7.0.4",
    "axios": "^1.13.2",
    "bcrypt": "^6.0.0",
    "class-transformer": "^0.5.1",
    "class-validator": "^0.14.2",
    "nodemailer": "^7.0.10",
    "passport": "^0.7.0",
    "passport-jwt": "^4.0.1",
    "passport-local": "^1.0.0",
    "pg": "^8.16.3",
    "reflect-metadata": "^0.2.2",
    "rxjs": "^7.8.1",
    "typeorm": "^0.3.27"
  },
  "devDependencies": {
    "@eslint/eslintrc": "^3.2.0",
    "@eslint/js": "^9.18.0",
    "@nestjs/cli": "^11.0.0",
    "@nestjs/schematics": "^11.0.0",
    "@nestjs/testing": "^11.0.1",
    "@types/bcrypt": "^6.0.0",
    "@types/express": "^5.0.0",
    "@types/jest": "^30.0.0",
    "@types/node": "^22.10.7",
    "@types/passport-jwt": "^4.0.1",
    "@types/passport-local": "^1.0.38",
    "@types/supertest": "^6.0.2",
    "eslint": "^9.18.0",
    "eslint-config-prettier": "^10.0.1",
    "eslint-plugin-prettier": "^5.2.2",
    "globals": "^16.0.0",
    "jest": "^30.0.0",
    "prettier": "^3.4.2",
    "source-map-support": "^0.5.21",
    "supertest": "^7.0.0",
    "ts-jest": "^29.2.5",
    "ts-loader": "^9.5.2",
    "ts-node": "^10.9.2",
    "tsconfig-paths": "^4.2.0",
    "typescript": "^5.7.3",
    "typescript-eslint": "^8.20.0"
  },
  "jest": {
    "moduleFileExtensions": [
      "js",
      "json",
      "ts"
    ],
    "rootDir": "src",
    "testRegex": ".*\\.spec\\.ts$",
    "transform": {
      "^.+\\.(t|j)s$": "ts-jest"
    },
    "collectCoverageFrom": [
      "**/*.(t|j)s"
    ],
    "coverageDirectory": "../coverage",
    "testEnvironment": "node"
  }
}
</file>

<file path="backend/src/auth/dto/create-auth.dto.ts">
import { IsEmail, IsNotEmpty, IsString, MinLength } from 'class-validator';

export class CreateAuthDto {
  // Define properties for CreateAuthDto here if needed, 
  // or remove if unused. For now, keeping it empty to avoid breaking other imports.
}

// ✨ Added 'export' here so it can be imported by auth.service.ts
export class AuthPayloadDto {
  @IsEmail()
  email: string;

  @IsString()
  @IsNotEmpty()
  @MinLength(6)
  password: string;
}
</file>

<file path="backend/src/auth/dto/update-auth.dto.ts">
import { IsEmail, IsNotEmpty, IsString, MinLength } from 'class-validator';

export class CreateAuthDto {
  // Define properties for CreateAuthDto here if needed, 
  // or remove if unused. For now, keeping it empty to avoid breaking other imports.
}

export class AuthPayloadDto {
  @IsEmail()
  email: string;

  @IsString()
  @IsNotEmpty()
  @MinLength(6)
  password: string;
}
</file>

<file path="backend/src/orders/dto/update-order.dto.ts">
import { PartialType } from '@nestjs/mapped-types';
import { CreateOrderDto } from './create-order.dto';
import { IsEnum, IsOptional, IsString } from 'class-validator';
import { OrderStatus } from '../entities/order.entity';

export class UpdateOrderDto extends PartialType(CreateOrderDto) {
  @IsOptional()
  @IsEnum(OrderStatus)
  status?: OrderStatus;

  @IsOptional()
  @IsString()
  adminNote?: string;
}
</file>

<file path="backend/src/orders/entities/order-item.entity.ts">
import { Entity, Column, PrimaryGeneratedColumn, ManyToOne } from 'typeorm';
import { Order } from './order.entity';
import { Product } from '../../products/entities/product.entity';

export enum ServiceType {
  MATERIAL = 'material',   
  ASSEMBLED = 'assembled', 
}

@Entity()
export class OrderItem {
  @PrimaryGeneratedColumn('uuid')
  id: string;
  
  // 關聯回訂單主檔
  @ManyToOne(() => Order, (order) => order.items, { onDelete: 'CASCADE' }) 
  order: Order;

  @ManyToOne(() => Product, { eager: true })
  product: Product;

  @Column({
    type: 'enum',
    enum: ServiceType,
    default: ServiceType.ASSEMBLED
  })
  serviceType: ServiceType;
  
  @Column({ type: 'jsonb' })
  widthMatrix: { top: number; mid: number; bot: number };

  @Column({ type: 'jsonb' })
  heightData: any; 

  @Column({ default: true })
  isCeilingMounted: boolean; 

  @Column({ type: 'jsonb', nullable: true })
  siteConditions: any;

  @Column()
  colorName: string;

  @Column()
  materialName: string;

  // 把手名稱
  @Column({ nullable: true })
  handleName: string;

  @Column()
  openingDirection: string;

  @Column({ default: false })
  hasThreshold: boolean;

  @Column({ type: 'int', default: 1 })
  quantity: number;

  @Column({ type: 'decimal', precision: 12, scale: 2 })
  subtotal: number; 

  @Column({ type: 'jsonb' })
  priceSnapshot: {
    basePrice: number;
    sizeSurcharge: number;
    colorSurcharge: number;
    materialSurcharge: number;
    handleSurcharge: number;
    assemblyFee: number;
    thresholdFee: number;
  };
}
</file>

<file path="backend/src/orders/orders.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { OrdersService } from './orders.service';
import { OrdersController } from './orders.controller';
import { Order } from './entities/order.entity';
import { OrderItem } from './entities/order-item.entity';
import { User } from '../users/entities/user.entity';
import { NotificationsModule } from '../notifications/notifications.module';
// ✨✨✨ 引入 SiteConfigModule ✨✨✨
import { SiteConfigModule } from '../site-config/site-config.module';

@Module({
  imports: [
    TypeOrmModule.forFeature([Order, OrderItem, User]), 
    NotificationsModule,
    // ✨✨✨ 註冊 ✨✨✨
    SiteConfigModule
  ],
  controllers: [OrdersController],
  providers: [OrdersService],
  exports: [OrdersService], 
})
export class OrdersModule {}
</file>

<file path="backend/src/users/dto/create-user.dto.ts">
import { IsString, IsEmail, IsOptional, ValidateNested, IsNotEmpty } from 'class-validator';
import { Type } from 'class-transformer';

// 定義經銷商資料結構 (內嵌於 User DTO)
class CreateDealerProfileDto {
  @IsString()
  @IsNotEmpty()
  companyName: string;

  @IsString()
  @IsOptional()
  taxId?: string;

  @IsString()
  @IsNotEmpty()
  contactPerson: string;

  @IsString()
  @IsNotEmpty()
  phone: string;

  @IsString()
  @IsNotEmpty()
  address: string;
}

export class CreateUserDto {
  @IsEmail()
  email: string;

  @IsString()
  @IsNotEmpty()
  password: string;

  @IsString()
  @IsNotEmpty()
  name: string; // 聯絡人姓名

  // 允許 tradeCategoryId 為字串或 undefined (處理前端傳來的空值)
  @IsOptional()
  @IsString()
  tradeCategoryId?: string;

  @IsOptional()
  @ValidateNested()
  @Type(() => CreateDealerProfileDto)
  dealerProfile?: CreateDealerProfileDto;
}
</file>

<file path="frontend/src/app/cart/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { Trash2, ArrowRight, Loader2, ShoppingBag, AlertCircle, Hammer, Package, MessageSquare, MapPin, Building2, User, Phone, Copy, UploadCloud, FileText, X } from 'lucide-react';
import { useCart } from '@/context/CartContext';
import { api } from '@/lib/api';
import Modal from '@/components/Modal'; // ✨ 引入通用彈窗

const CLOUDINARY_CLOUD_NAME = 'dnibj8za6'; 
const CLOUDINARY_PRESET = 'yasou70731';  

export default function CartPage() {
  const router = useRouter();
  const { items, removeFromCart, clearCart, cartTotal } = useCart();
  
  const [mounted, setMounted] = useState(false);
  const [currentUser, setCurrentUser] = useState<any>(null);

  // ✨ Modal 狀態管理
  const [modalConfig, setModalConfig] = useState({
    isOpen: false,
    title: '',
    message: '',
    type: 'info' as 'success' | 'error' | 'info' | 'warning',
    redirect: '' // 點擊確定後是否要跳轉
  });

  useEffect(() => {
    setMounted(true);
    const stored = localStorage.getItem('somalink_user') || sessionStorage.getItem('somalink_user');
    if (stored) {
      try { setCurrentUser(JSON.parse(stored)); } catch(e) {}
    }
  }, []);

  const [projectName, setProjectName] = useState('');
  const [shippingAddress, setShippingAddress] = useState(''); 
  const [siteContactPerson, setSiteContactPerson] = useState(''); 
  const [siteContactPhone, setSiteContactPhone] = useState(''); 
  const [customerNote, setCustomerNote] = useState(''); 
  
  const [attachments, setAttachments] = useState<string[]>([]);
  const [isUploading, setIsUploading] = useState(false);

  const [agreed, setAgreed] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);

  // ✨ 顯示彈窗 Helper
  const showAlert = (title: string, message: string, type: 'error' | 'success' | 'info' | 'warning' = 'error', redirect = '') => {
    setModalConfig({ isOpen: true, title, message, type, redirect });
  };

  const fillMemberInfo = () => {
    if (currentUser && currentUser.dealerProfile) {
      const { address, contactPerson, phone } = currentUser.dealerProfile;
      if (address) setShippingAddress(address);
      if (contactPerson) setSiteContactPerson(contactPerson);
      if (phone) setSiteContactPhone(phone);
    } else {
      showAlert('提示', '無法讀取會員資料，請確認您已登入。', 'info');
    }
  };

  const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (!files || files.length === 0) return;

    setIsUploading(true);
    const newAttachments = [...attachments];

    try {
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_PRESET);

        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
          method: 'POST',
          body: formData,
        });
        
        const data = await res.json();
        if (data.secure_url) {
          newAttachments.push(data.secure_url);
        }
      }
      setAttachments(newAttachments);
    } catch (err) {
      console.error('上傳失敗', err);
      showAlert('上傳失敗', '部分檔案上傳失敗，請檢查網路或檔案大小。', 'error');
    } finally {
      setIsUploading(false);
    }
  };

  const removeAttachment = (index: number) => {
    setAttachments(prev => prev.filter((_, i) => i !== index));
  };

  const handleSubmit = async () => {
    // ✨ 改用 showAlert 取代 alert
    if (!projectName.trim()) { showAlert('欄位未填', '請輸入案場名稱', 'warning'); return; }
    if (!shippingAddress.trim()) { showAlert('欄位未填', '請輸入施工/送貨地址', 'warning'); return; }
    if (!siteContactPerson.trim()) { showAlert('欄位未填', '請輸入現場聯絡人', 'warning'); return; }
    if (!siteContactPhone.trim()) { showAlert('欄位未填', '請輸入現場電話', 'warning'); return; }
    if (!agreed) { showAlert('請同意條款', '請勾選「我已確認上述規格無誤，並同意服務條款」', 'warning'); return; }

    setIsSubmitting(true);

    try {
      const payload = {
        projectName,
        shippingAddress,
        siteContactPerson,
        siteContactPhone,
        customerNote,
        attachments,
        agreedToDisclaimer: agreed,
        items: items.map(item => ({
          productId: item.productId,
          serviceType: item.serviceType,
          widthMatrix: item.widthMatrix,
          heightData: item.heightData,
          isCeilingMounted: item.isCeilingMounted,
          siteConditions: item.siteConditions,
          colorName: item.colorName,
          materialName: item.materialName,
          // ✨ 傳送把手資訊
          handleName: item.handleName,
          openingDirection: item.openingDirection,
          hasThreshold: item.hasThreshold,
          quantity: item.quantity,
          subtotal: item.subtotal,
          priceSnapshot: item.priceSnapshot
        }))
      };

      await api.post('/orders', payload);
      clearCart();
      
      // ✨ 成功後顯示彈窗並跳轉
      showAlert('訂單已送出！', '您的訂單已成功建立，請至「歷史訂單」查看進度。', 'success', '/orders');

    } catch (error: any) {
      console.error(error);
      if (error.response?.status === 401) {
        showAlert('權限錯誤', '請先登入會員後再試。', 'error', '/login');
      } else {
        showAlert('結帳失敗', '系統發生錯誤，請聯繫管理員。', 'error');
      }
    } finally {
      setIsSubmitting(false);
    }
  };

  if (!mounted) return null;

  if (items.length === 0) {
    return (
      <div className="min-h-[60vh] flex flex-col items-center justify-center p-8 text-center">
        <div className="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-6">
          <ShoppingBag className="w-10 h-10 text-gray-400" />
        </div>
        <h2 className="text-2xl font-bold text-gray-900 mb-2">購物車是空的</h2>
        <p className="text-gray-500 mb-8 max-w-sm">看起來您還沒有加入任何門扇。去逛逛我們的產品系列，開始您的數位工廠之旅吧！</p>
        <Link href="/" className="px-8 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition-colors">
          前往選購
        </Link>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 py-12">
      {/* ✨ 全域彈窗元件 */}
      <Modal 
        isOpen={modalConfig.isOpen}
        title={modalConfig.title}
        message={modalConfig.message}
        type={modalConfig.type}
        onClose={() => {
          setModalConfig(prev => ({ ...prev, isOpen: false }));
          if (modalConfig.redirect) router.push(modalConfig.redirect);
        }}
        confirmText="確定"
      />

      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 className="text-3xl font-bold text-gray-900 mb-8">確認訂單內容</h1>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-10">
          
          {/* 左側：商品列表 */}
          <div className="lg:col-span-2 space-y-6">
            {items.map((item) => (
              <div key={item.internalId} className="bg-white rounded-2xl border border-gray-200 p-6 shadow-sm flex flex-col sm:flex-row gap-6 relative group">
                <button 
                  onClick={() => removeFromCart(item.internalId)}
                  className="absolute top-4 right-4 p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors"
                >
                  <Trash2 className="w-5 h-5" />
                </button>
                <div className="w-24 h-24 bg-gray-100 rounded-xl shrink-0 overflow-hidden">
                   {/* eslint-disable-next-line @next/next/no-img-element */}
                   <img src="https://images.unsplash.com/photo-1600607686527-6fb886090705?auto=format&fit=crop&q=80&w=200" alt={item.productName} className="w-full h-full object-cover" />
                </div>
                <div className="flex-1">
                  <div className="flex flex-wrap items-center gap-2 mb-1">
                    <h3 className="text-lg font-bold text-gray-900">{item.productName}</h3>
                    {item.serviceType === 'material' ? (
                      <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-bold bg-gray-100 text-gray-700 border border-gray-200"><Package className="w-3 h-3" /> 純材料</span>
                    ) : (
                      <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-bold bg-blue-50 text-blue-700 border border-blue-100"><Hammer className="w-3 h-3" /> 連工帶料</span>
                    )}
                  </div>
                  <div className="mt-2 space-y-1 text-sm text-gray-600">
                    {/* ✨ 顯示把手名稱 */}
                    <p><span className="font-medium">規格：</span>{item.colorName} / {item.materialName} / {item.handleName || '無把手'} / {item.openingDirection}</p>
                    <p><span className="font-medium">尺寸：</span>W {item.widthMatrix.mid}cm x H {item.heightData.singleValue || item.heightData.mid || 'N/A'}cm {item.isCeilingMounted && <span className="ml-2 px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded-full">封頂</span>}</p>
                    {item.siteConditions?.floor && <p className="text-orange-600 text-xs flex items-center gap-1"><AlertCircle className="w-3 h-3" /> 地面水平誤差: {item.siteConditions.floor.diff}cm</p>}
                  </div>
                  <div className="mt-4 flex items-center justify-between">
                    <div className="flex items-baseline gap-2">
                      <span className="text-2xl font-bold text-blue-600">${item.subtotal.toLocaleString()}</span>
                      <span className="text-xs text-gray-400">({item.serviceType === 'material' ? '材料買斷價' : '含工資打包價'})</span>
                    </div>
                    <span className="text-sm text-gray-400">數量: {item.quantity}</span>
                  </div>
                </div>
              </div>
            ))}
          </div>

          {/* 右側：結帳面板 */}
          <div className="lg:col-span-1">
            <div className="bg-white rounded-2xl border border-gray-200 p-6 shadow-sm sticky top-24">
              <h2 className="text-xl font-bold text-gray-900 mb-6">訂單摘要</h2>
              <div className="space-y-4 mb-6">
                <div className="flex justify-between text-gray-600"><span>商品總數</span><span>{items.length} 件</span></div>
                <div className="flex justify-between text-lg font-bold text-gray-900 pt-4 border-t border-gray-100"><span>總金額</span><span>${cartTotal.toLocaleString()}</span></div>
              </div>

              <div className="mb-6 flex justify-between items-center">
                <span className="text-xs font-bold text-gray-500 uppercase tracking-wider">收貨與聯絡資訊</span>
                <button onClick={fillMemberInfo} className="text-xs text-blue-600 hover:bg-blue-50 px-2 py-1 rounded flex items-center gap-1 transition-colors"><Copy className="w-3 h-3" /> 同會員資料</button>
              </div>

              <div className="space-y-4 mb-6">
                <div>
                  <label className="flex items-center gap-1 text-sm font-medium text-gray-700 mb-1"><Building2 className="w-3.5 h-3.5" /> 案場名稱 *</label>
                  <input type="text" value={projectName} onChange={(e) => setProjectName(e.target.value)} placeholder="例：台北帝寶 A 棟" className="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none text-sm" />
                </div>
                <div>
                  <label className="flex items-center gap-1 text-sm font-medium text-gray-700 mb-1"><MapPin className="w-3.5 h-3.5" /> 施工/送貨地址 *</label>
                  <input type="text" value={shippingAddress} onChange={(e) => setShippingAddress(e.target.value)} placeholder="完整地址" className="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none text-sm" />
                </div>
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="flex items-center gap-1 text-sm font-medium text-gray-700 mb-1"><User className="w-3.5 h-3.5" /> 現場聯絡人 *</label>
                    <input type="text" value={siteContactPerson} onChange={(e) => setSiteContactPerson(e.target.value)} placeholder="王先生" className="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none text-sm" />
                  </div>
                  <div>
                    <label className="flex items-center gap-1 text-sm font-medium text-gray-700 mb-1"><Phone className="w-3.5 h-3.5" /> 現場電話 *</label>
                    <input type="tel" value={siteContactPhone} onChange={(e) => setSiteContactPhone(e.target.value)} placeholder="0912..." className="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none text-sm" />
                  </div>
                </div>
              </div>

              <div className="mb-6">
                <label className="flex items-center gap-1 text-sm font-medium text-gray-700 mb-2"><UploadCloud className="w-3.5 h-3.5" /> 附件上傳 (現場照/CAD圖) 選填</label>
                
                <div className="flex flex-wrap gap-2 mb-2">
                  {attachments.map((url, index) => (
                    <div key={index} className="relative group">
                      <div className="w-12 h-12 bg-gray-100 rounded-lg border border-gray-200 flex items-center justify-center overflow-hidden">
                        {url.match(/\.(jpeg|jpg|gif|png)$/i) ? (
                          // eslint-disable-next-line @next/next/no-img-element
                          <img src={url} alt="attachment" className="w-full h-full object-cover" />
                        ) : (
                          <FileText className="w-6 h-6 text-gray-400" />
                        )}
                      </div>
                      <button onClick={() => removeAttachment(index)} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity shadow-sm"><X className="w-3 h-3" /></button>
                    </div>
                  ))}
                  
                  <label className="w-12 h-12 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center cursor-pointer hover:bg-gray-50 hover:border-blue-400 transition-colors">
                    {isUploading ? <Loader2 className="w-5 h-5 text-blue-500 animate-spin" /> : <UploadCloud className="w-5 h-5 text-gray-400" />}
                    <input type="file" multiple onChange={handleFileUpload} className="hidden" disabled={isUploading} />
                  </label>
                </div>
                <p className="text-xs text-gray-400">支援圖片與 PDF，單檔請勿超過 10MB。</p>
              </div>

              <div className="mb-6">
                <label className="flex items-center gap-1 text-sm font-medium text-gray-700 mb-2"><MessageSquare className="w-3.5 h-3.5" /> 訂單備註 (選填)</label>
                <textarea value={customerNote} onChange={(e) => setCustomerNote(e.target.value)} placeholder="其他需求..." className="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none h-20 resize-none text-sm" />
              </div>

              <label className="flex items-start gap-3 mb-6 cursor-pointer p-3 rounded-lg hover:bg-gray-50 transition-colors">
                <input type="checkbox" checked={agreed} onChange={(e) => setAgreed(e.target.checked)} className="mt-1 w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500" />
                <span className="text-sm text-gray-600 leading-relaxed">我已確認上述規格無誤，並同意服務條款。</span>
              </label>

              <button onClick={handleSubmit} disabled={isSubmitting} className="w-full py-4 bg-gray-900 hover:bg-black text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2 disabled:opacity-70">
                {isSubmitting ? <Loader2 className="animate-spin w-5 h-5" /> : <>確認下單 <ArrowRight className="w-5 h-5" /></>}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/app/layout.tsx">
import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";
import { CartProvider } from "@/context/CartContext"; // 👈 引入 Context
import Navbar from "@/components/Navbar"; // 👈 我們等下立刻建這個元件

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "SomaLink B2B",
  description: "數位工廠下單系統",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="zh-TW">
      <body className={`${geistSans.variable} ${geistMono.variable} antialiased bg-gray-50 text-gray-900`}>
        {/* ✨ 包上 CartProvider */}
        <CartProvider>
          {/* ✨ 加個導覽列方便回首頁和看購物車 */}
          <Navbar />
          <main className="min-h-screen">
            {children}
          </main>
        </CartProvider>
      </body>
    </html>
  );
}
</file>

<file path="frontend/src/app/orders/page.tsx">
'use client';

import { useEffect, useState } from 'react';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { Package, Clock, Truck, CheckCircle, Trash2, Hammer, XCircle, RefreshCw, Loader2 } from 'lucide-react';
import { api } from '@/lib/api';
import Modal from '@/components/Modal';
import { useCart, CartItem } from '@/context/CartContext';

// 定義介面 (與 API 回傳一致)
interface OrderItem {
  product: { 
    id: string; 
    name: string; 
    basePrice?: number; 
    assemblyFee?: number;
  };
  quantity: number;
  serviceType: 'material' | 'assembled';
  widthMatrix: any;
  heightData: any;
  isCeilingMounted: boolean;
  siteConditions: any;
  colorName: string;
  materialName: string;
  handleName: string;
  openingDirection: string;
  hasThreshold: boolean;
  subtotal: number;
  priceSnapshot: any;
}

interface Order {
  id: string;
  orderNumber: string;
  status: 'pending' | 'processing' | 'shipped' | 'completed' | 'cancelled';
  totalAmount: number;
  createdAt: string;
  projectName: string;
  items: OrderItem[];
}

export default function OrdersPage() {
  const router = useRouter();
  const { addToCart } = useCart(); 
  const [orders, setOrders] = useState<Order[]>([]);
  const [loading, setLoading] = useState(true);
  
  // ✨ 權限檢查狀態
  const [authChecking, setAuthChecking] = useState(true);

  // ✨ 彈窗狀態
  const [deleteModal, setDeleteModal] = useState({ isOpen: false, orderId: '' });
  const [reorderModal, setReorderModal] = useState({ isOpen: false, order: null as Order | null });
  const [isDeleting, setIsDeleting] = useState(false);

  useEffect(() => {
    // ✨✨✨ 檢查是否登入 ✨✨✨
    const token = localStorage.getItem('somalink_token') || sessionStorage.getItem('somalink_token');
    if (!token) {
      router.replace('/login');
      return;
    }
    setAuthChecking(false);

    const fetchOrders = async () => {
      try {
        const data = await api.get('/orders');
        setOrders(data);
      } catch (error) {
        console.error('Failed to fetch orders', error);
      } finally {
        setLoading(false);
      }
    };
    fetchOrders();
  }, [router]);

  // --- 刪除邏輯 ---
  const confirmDelete = (orderId: string) => {
    setDeleteModal({ isOpen: true, orderId });
  };

  const handleDelete = async () => {
    if (!deleteModal.orderId) return;
    setIsDeleting(true);
    try {
      await api.delete(`/orders/${deleteModal.orderId}`);
      setOrders((prev) => prev.filter((o) => o.id !== deleteModal.orderId));
    } catch (error) {
      console.error(error);
      alert('刪除失敗：可能訂單已進入生產流程，請聯繫客服。');
    } finally {
      setIsDeleting(false);
      setDeleteModal({ isOpen: false, orderId: '' });
    }
  };

  // --- 再次購買邏輯 ---
  const confirmReorder = (order: Order) => {
    setReorderModal({ isOpen: true, order });
  };

  const handleReorder = () => {
    const order = reorderModal.order;
    if (!order) return;

    order.items.forEach(item => {
      const cartItem: CartItem = {
        internalId: crypto.randomUUID(), 
        productId: item.product?.id,     
        productName: item.product?.name || '未知商品',
        // 使用當時的快照價格重新計算單價 (或根據您的需求抓取最新價格)
        unitPrice: Number(item.priceSnapshot?.basePrice || 0) + 
                   Number(item.priceSnapshot?.sizeSurcharge || 0) +
                   Number(item.priceSnapshot?.colorSurcharge || 0) +
                   Number(item.priceSnapshot?.materialSurcharge || 0) +
                   Number(item.priceSnapshot?.handleSurcharge || 0) +
                   (item.serviceType === 'assembled' ? Number(item.priceSnapshot?.assemblyFee || 0) : 0),
        quantity: item.quantity,
        subtotal: Number(item.subtotal),
        serviceType: item.serviceType,
        widthMatrix: item.widthMatrix,
        heightData: item.heightData,
        isCeilingMounted: item.isCeilingMounted,
        siteConditions: item.siteConditions,
        colorName: item.colorName,
        materialName: item.materialName,
        handleName: item.handleName || '',
        openingDirection: item.openingDirection,
        hasThreshold: item.hasThreshold,
        priceSnapshot: item.priceSnapshot
      };
      addToCart(cartItem);
    });
    
    setReorderModal({ isOpen: false, order: null });
    router.push('/cart');
  };

  const getStatusDisplay = (status: string) => {
    switch (status) {
      case 'pending': return { label: '待審核', color: 'bg-yellow-100 text-yellow-800', icon: <Clock className="w-4 h-4" /> };
      case 'processing': return { label: '生產中', color: 'bg-blue-100 text-blue-800', icon: <Hammer className="w-4 h-4" /> };
      case 'shipped': return { label: '已出貨', color: 'bg-purple-100 text-purple-800', icon: <Truck className="w-4 h-4" /> };
      case 'completed': return { label: '已完成', color: 'bg-green-100 text-green-800', icon: <CheckCircle className="w-4 h-4" /> };
      case 'cancelled': return { label: '已取消', color: 'bg-gray-100 text-gray-600', icon: <XCircle className="w-4 h-4" /> };
      default: return { label: status, color: 'bg-gray-100 text-gray-600', icon: null };
    }
  };

  // 如果還在檢查權限或載入中，顯示 Loading
  if (authChecking || loading) return <div className="min-h-screen bg-gray-50 flex items-center justify-center"><Loader2 className="animate-spin text-blue-600 w-10 h-10" /></div>;

  return (
    <div className="min-h-screen bg-gray-50 py-12">
      
      {/* 刪除確認彈窗 */}
      <Modal 
        isOpen={deleteModal.isOpen}
        onClose={() => setDeleteModal({ isOpen: false, orderId: '' })}
        type="confirm" 
        title="取消訂單"
        message="確定要取消並刪除這筆訂單嗎？此動作無法復原，且僅能在「待審核」狀態下執行。"
        confirmText={isDeleting ? "刪除中..." : "確認取消"}
        cancelText="保留訂單"
        onConfirm={handleDelete}
      />

      {/* 再次購買確認彈窗 */}
      <Modal 
        isOpen={reorderModal.isOpen}
        onClose={() => setReorderModal({ isOpen: false, order: null })}
        type="confirm" 
        title="再次購買"
        message={`確定要將訂單 ${reorderModal.order?.orderNumber} 的所有商品規格複製到購物車嗎？`}
        confirmText="加入購物車"
        cancelText="取消"
        onConfirm={handleReorder}
      />

      <div className="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
        <div className="flex justify-between items-end mb-8">
          <div><h1 className="text-3xl font-bold text-gray-900">我的訂單</h1><p className="text-gray-500 mt-2">追蹤您的訂製門扇生產進度</p></div>
          <Link href="/" className="bg-blue-600 text-white px-6 py-2.5 rounded-xl font-bold hover:bg-blue-700 transition-colors shadow-sm flex items-center gap-2"><Package className="w-5 h-5" /> 新增訂單</Link>
        </div>

        <div className="space-y-6">
          {orders.length === 0 ? (
            <div className="text-center py-20 bg-white rounded-3xl border border-gray-200"><Package className="w-16 h-16 text-gray-300 mx-auto mb-4" /><h3 className="text-xl font-bold text-gray-900">目前沒有訂單</h3><p className="text-gray-500 mt-2">開始您的第一個數位工廠專案吧！</p></div>
          ) : (
            orders.map((order) => {
              const statusInfo = getStatusDisplay(order.status);
              return (
                <div key={order.id} className="bg-white rounded-2xl border border-gray-200 p-6 shadow-sm hover:shadow-md transition-shadow relative group">
                  <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <div className="flex items-center gap-3">
                      <div className="bg-gray-100 p-2 rounded-lg"><Package className="w-6 h-6 text-gray-600" /></div>
                      <div>
                        <div className="font-mono font-bold text-gray-900 text-lg">{order.orderNumber}</div>
                        <div className="text-sm text-gray-500 flex items-center gap-2"><span>{new Date(order.createdAt).toLocaleDateString()}</span><span className="w-1 h-1 bg-gray-300 rounded-full"></span><span>{order.projectName}</span></div>
                      </div>
                    </div>
                    <div className={`px-4 py-1.5 rounded-full text-sm font-bold flex items-center gap-2 ${statusInfo.color}`}>{statusInfo.icon}{statusInfo.label}</div>
                  </div>

                  <div className="bg-gray-50 rounded-xl p-4 mb-6">
                    <div className="flex justify-between items-center text-sm text-gray-600 mb-2"><span>訂購項目：</span><span className="font-bold text-gray-900">{order.items?.length || 0} 件商品</span></div>
                    <div className="space-y-1">
                      {order.items?.slice(0, 2).map((item, idx) => (
                        <div key={idx} className="text-sm text-gray-500 flex justify-between items-center">
                           <div className="flex items-center gap-2"><span>- {item.product?.name}</span>{item.serviceType === 'material' ? <span className="text-[10px] px-1.5 py-0.5 bg-gray-200 text-gray-600 rounded flex items-center gap-1"><Package className="w-3 h-3" /> 純料</span> : <span className="text-[10px] px-1.5 py-0.5 bg-blue-100 text-blue-600 rounded flex items-center gap-1"><Hammer className="w-3 h-3" /> 代工</span>}</div><span>x{item.quantity}</span>
                        </div>
                      ))}
                      {(order.items?.length || 0) > 2 && <div className="text-xs text-gray-400 pl-2">...還有 {(order.items?.length || 0) - 2} 項</div>}
                    </div>
                    <div className="border-t border-gray-200 mt-3 pt-3 flex justify-between items-center"><span className="font-bold text-gray-900">總金額</span><span className="text-xl font-bold text-blue-600">${Number(order.totalAmount).toLocaleString()}</span></div>
                  </div>

                  <div className="flex justify-end items-center gap-3">
                    {/* ✨✨✨ 再次購買按鈕 ✨✨✨ */}
                    <button 
                      onClick={() => confirmReorder(order)}
                      className="text-blue-600 hover:text-blue-800 hover:bg-blue-50 px-4 py-2 rounded-lg text-sm font-bold transition-colors flex items-center gap-2 border border-blue-200"
                    >
                      <RefreshCw className="w-4 h-4" /> 再次購買
                    </button>

                    {order.status === 'pending' && (
                      <button 
                        onClick={() => confirmDelete(order.id)}
                        disabled={isDeleting && deleteModal.orderId === order.id}
                        className="text-red-500 hover:text-red-700 hover:bg-red-50 px-4 py-2 rounded-lg text-sm font-bold transition-colors flex items-center gap-2"
                      >
                        {isDeleting && deleteModal.orderId === order.id ? '刪除中...' : <><Trash2 className="w-4 h-4" /> 取消</>}
                      </button>
                    )}
                    
                    <Link href={`/orders/${order.id}/print`} target="_blank" className="bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 px-4 py-2 rounded-lg font-bold text-sm transition-colors">列印工單</Link>
                  </div>
                </div>
              );
            })
          )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/app/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { Trash2, ArrowRight, Loader2, ShoppingBag, AlertCircle, Hammer, Package, MessageSquare, MapPin, Building2, User, Phone, Copy, UploadCloud, FileText, X } from 'lucide-react';
import { useCart } from '@/context/CartContext';
import { api } from '@/lib/api';
import Modal from '@/components/Modal'; // ✨ 引入通用彈窗

const CLOUDINARY_CLOUD_NAME = 'dnibj8za6'; 
const CLOUDINARY_PRESET = 'yasou70731';  

export default function CartPage() {
  const router = useRouter();
  const { items, removeFromCart, clearCart, cartTotal } = useCart();
  
  const [mounted, setMounted] = useState(false);
  const [currentUser, setCurrentUser] = useState<any>(null);

  // ✨ Modal 狀態管理
  const [modalConfig, setModalConfig] = useState({
    isOpen: false,
    title: '',
    message: '',
    type: 'info' as 'success' | 'error' | 'info' | 'warning',
    redirect: '' // 點擊確定後是否要跳轉
  });

  useEffect(() => {
    setMounted(true);
    const stored = localStorage.getItem('somalink_user') || sessionStorage.getItem('somalink_user');
    if (stored) {
      try { setCurrentUser(JSON.parse(stored)); } catch(e) {}
    }
  }, []);

  const [projectName, setProjectName] = useState('');
  const [shippingAddress, setShippingAddress] = useState(''); 
  const [siteContactPerson, setSiteContactPerson] = useState(''); 
  const [siteContactPhone, setSiteContactPhone] = useState(''); 
  const [customerNote, setCustomerNote] = useState(''); 
  
  const [attachments, setAttachments] = useState<string[]>([]);
  const [isUploading, setIsUploading] = useState(false);

  const [agreed, setAgreed] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);

  // ✨ 顯示彈窗 Helper
  const showAlert = (title: string, message: string, type: 'error' | 'success' | 'info' | 'warning' = 'error', redirect = '') => {
    setModalConfig({ isOpen: true, title, message, type, redirect });
  };

  const fillMemberInfo = () => {
    if (currentUser && currentUser.dealerProfile) {
      const { address, contactPerson, phone } = currentUser.dealerProfile;
      if (address) setShippingAddress(address);
      if (contactPerson) setSiteContactPerson(contactPerson);
      if (phone) setSiteContactPhone(phone);
    } else {
      showAlert('提示', '無法讀取會員資料，請確認您已登入。', 'info');
    }
  };

  const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (!files || files.length === 0) return;

    setIsUploading(true);
    const newAttachments = [...attachments];

    try {
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_PRESET);

        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
          method: 'POST',
          body: formData,
        });
        
        const data = await res.json();
        if (data.secure_url) {
          newAttachments.push(data.secure_url);
        }
      }
      setAttachments(newAttachments);
    } catch (err) {
      console.error('上傳失敗', err);
      showAlert('上傳失敗', '部分檔案上傳失敗，請檢查網路或檔案大小。', 'error');
    } finally {
      setIsUploading(false);
    }
  };

  const removeAttachment = (index: number) => {
    setAttachments(prev => prev.filter((_, i) => i !== index));
  };

  const handleSubmit = async () => {
    // ✨ 改用 showAlert 取代 alert
    if (!projectName.trim()) { showAlert('欄位未填', '請輸入案場名稱', 'warning'); return; }
    if (!shippingAddress.trim()) { showAlert('欄位未填', '請輸入施工/送貨地址', 'warning'); return; }
    if (!siteContactPerson.trim()) { showAlert('欄位未填', '請輸入現場聯絡人', 'warning'); return; }
    if (!siteContactPhone.trim()) { showAlert('欄位未填', '請輸入現場電話', 'warning'); return; }
    if (!agreed) { showAlert('請同意條款', '請勾選「我已確認上述規格無誤，並同意服務條款」', 'warning'); return; }

    setIsSubmitting(true);

    try {
      const payload = {
        projectName,
        shippingAddress,
        siteContactPerson,
        siteContactPhone,
        customerNote,
        attachments,
        agreedToDisclaimer: agreed,
        items: items.map(item => ({
          productId: item.productId,
          serviceType: item.serviceType,
          widthMatrix: item.widthMatrix,
          heightData: item.heightData,
          isCeilingMounted: item.isCeilingMounted,
          siteConditions: item.siteConditions,
          colorName: item.colorName,
          materialName: item.materialName,
          // ✨ 傳送把手資訊
          handleName: item.handleName,
          openingDirection: item.openingDirection,
          hasThreshold: item.hasThreshold,
          quantity: item.quantity,
          subtotal: item.subtotal,
          priceSnapshot: item.priceSnapshot
        }))
      };

      await api.post('/orders', payload);
      clearCart();
      
      // ✨ 成功後顯示彈窗並跳轉
      showAlert('訂單已送出！', '您的訂單已成功建立，請至「歷史訂單」查看進度。', 'success', '/orders');

    } catch (error: any) {
      console.error(error);
      if (error.response?.status === 401) {
        showAlert('權限錯誤', '請先登入會員後再試。', 'error', '/login');
      } else {
        showAlert('結帳失敗', '系統發生錯誤，請聯繫管理員。', 'error');
      }
    } finally {
      setIsSubmitting(false);
    }
  };

  if (!mounted) return null;

  if (items.length === 0) {
    return (
      <div className="min-h-[60vh] flex flex-col items-center justify-center p-8 text-center">
        <div className="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-6">
          <ShoppingBag className="w-10 h-10 text-gray-400" />
        </div>
        <h2 className="text-2xl font-bold text-gray-900 mb-2">購物車是空的</h2>
        <p className="text-gray-500 mb-8 max-w-sm">看起來您還沒有加入任何門扇。去逛逛我們的產品系列，開始您的數位工廠之旅吧！</p>
        <Link href="/" className="px-8 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition-colors">
          前往選購
        </Link>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 py-12">
      {/* ✨ 全域彈窗元件 */}
      <Modal 
        isOpen={modalConfig.isOpen}
        title={modalConfig.title}
        message={modalConfig.message}
        type={modalConfig.type}
        onClose={() => {
          setModalConfig(prev => ({ ...prev, isOpen: false }));
          if (modalConfig.redirect) router.push(modalConfig.redirect);
        }}
        confirmText="確定"
      />

      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 className="text-3xl font-bold text-gray-900 mb-8">確認訂單內容</h1>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-10">
          
          {/* 左側：商品列表 */}
          <div className="lg:col-span-2 space-y-6">
            {items.map((item) => (
              <div key={item.internalId} className="bg-white rounded-2xl border border-gray-200 p-6 shadow-sm flex flex-col sm:flex-row gap-6 relative group">
                <button 
                  onClick={() => removeFromCart(item.internalId)}
                  className="absolute top-4 right-4 p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors"
                >
                  <Trash2 className="w-5 h-5" />
                </button>
                <div className="w-24 h-24 bg-gray-100 rounded-xl shrink-0 overflow-hidden">
                   {/* eslint-disable-next-line @next/next/no-img-element */}
                   <img src="https://images.unsplash.com/photo-1600607686527-6fb886090705?auto=format&fit=crop&q=80&w=200" alt={item.productName} className="w-full h-full object-cover" />
                </div>
                <div className="flex-1">
                  <div className="flex flex-wrap items-center gap-2 mb-1">
                    <h3 className="text-lg font-bold text-gray-900">{item.productName}</h3>
                    {item.serviceType === 'material' ? (
                      <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-bold bg-gray-100 text-gray-700 border border-gray-200"><Package className="w-3 h-3" /> 純材料</span>
                    ) : (
                      <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-bold bg-blue-50 text-blue-700 border border-blue-100"><Hammer className="w-3 h-3" /> 連工帶料</span>
                    )}
                  </div>
                  <div className="mt-2 space-y-1 text-sm text-gray-600">
                    {/* ✨ 顯示把手名稱 */}
                    <p><span className="font-medium">規格：</span>{item.colorName} / {item.materialName} / {item.handleName || '無把手'} / {item.openingDirection}</p>
                    <p><span className="font-medium">尺寸：</span>W {item.widthMatrix.mid}cm x H {item.heightData.singleValue || item.heightData.mid || 'N/A'}cm {item.isCeilingMounted && <span className="ml-2 px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded-full">封頂</span>}</p>
                    {item.siteConditions?.floor && <p className="text-orange-600 text-xs flex items-center gap-1"><AlertCircle className="w-3 h-3" /> 地面水平誤差: {item.siteConditions.floor.diff}cm</p>}
                  </div>
                  <div className="mt-4 flex items-center justify-between">
                    <div className="flex items-baseline gap-2">
                      <span className="text-2xl font-bold text-blue-600">${item.subtotal.toLocaleString()}</span>
                      <span className="text-xs text-gray-400">({item.serviceType === 'material' ? '材料買斷價' : '含工資打包價'})</span>
                    </div>
                    <span className="text-sm text-gray-400">數量: {item.quantity}</span>
                  </div>
                </div>
              </div>
            ))}
          </div>

          {/* 右側：結帳面板 */}
          <div className="lg:col-span-1">
            <div className="bg-white rounded-2xl border border-gray-200 p-6 shadow-sm sticky top-24">
              <h2 className="text-xl font-bold text-gray-900 mb-6">訂單摘要</h2>
              <div className="space-y-4 mb-6">
                <div className="flex justify-between text-gray-600"><span>商品總數</span><span>{items.length} 件</span></div>
                <div className="flex justify-between text-lg font-bold text-gray-900 pt-4 border-t border-gray-100"><span>總金額</span><span>${cartTotal.toLocaleString()}</span></div>
              </div>

              <div className="mb-6 flex justify-between items-center">
                <span className="text-xs font-bold text-gray-500 uppercase tracking-wider">收貨與聯絡資訊</span>
                <button onClick={fillMemberInfo} className="text-xs text-blue-600 hover:bg-blue-50 px-2 py-1 rounded flex items-center gap-1 transition-colors"><Copy className="w-3 h-3" /> 同會員資料</button>
              </div>

              <div className="space-y-4 mb-6">
                <div>
                  <label className="flex items-center gap-1 text-sm font-medium text-gray-700 mb-1"><Building2 className="w-3.5 h-3.5" /> 案場名稱 *</label>
                  <input type="text" value={projectName} onChange={(e) => setProjectName(e.target.value)} placeholder="例：台北帝寶 A 棟" className="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none text-sm" />
                </div>
                <div>
                  <label className="flex items-center gap-1 text-sm font-medium text-gray-700 mb-1"><MapPin className="w-3.5 h-3.5" /> 施工/送貨地址 *</label>
                  <input type="text" value={shippingAddress} onChange={(e) => setShippingAddress(e.target.value)} placeholder="完整地址" className="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none text-sm" />
                </div>
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="flex items-center gap-1 text-sm font-medium text-gray-700 mb-1"><User className="w-3.5 h-3.5" /> 現場聯絡人 *</label>
                    <input type="text" value={siteContactPerson} onChange={(e) => setSiteContactPerson(e.target.value)} placeholder="王先生" className="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none text-sm" />
                  </div>
                  <div>
                    <label className="flex items-center gap-1 text-sm font-medium text-gray-700 mb-1"><Phone className="w-3.5 h-3.5" /> 現場電話 *</label>
                    <input type="tel" value={siteContactPhone} onChange={(e) => setSiteContactPhone(e.target.value)} placeholder="0912..." className="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none text-sm" />
                  </div>
                </div>
              </div>

              <div className="mb-6">
                <label className="flex items-center gap-1 text-sm font-medium text-gray-700 mb-2"><UploadCloud className="w-3.5 h-3.5" /> 附件上傳 (現場照/CAD圖) 選填</label>
                <div className="flex flex-wrap gap-2 mb-2">
                  {attachments.map((url, index) => (
                    <div key={index} className="relative group">
                      <div className="w-12 h-12 bg-gray-100 rounded-lg border border-gray-200 flex items-center justify-center overflow-hidden">
                        {url.match(/\.(jpeg|jpg|gif|png)$/i) ? (
                          // eslint-disable-next-line @next/next/no-img-element
                          <img src={url} alt="attachment" className="w-full h-full object-cover" />
                        ) : (
                          <FileText className="w-6 h-6 text-gray-400" />
                        )}
                      </div>
                      <button onClick={() => removeAttachment(index)} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity shadow-sm"><X className="w-3 h-3" /></button>
                    </div>
                  ))}
                  <label className="w-12 h-12 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center cursor-pointer hover:bg-gray-50 hover:border-blue-400 transition-colors">
                    {isUploading ? <Loader2 className="w-5 h-5 text-blue-500 animate-spin" /> : <UploadCloud className="w-5 h-5 text-gray-400" />}
                    <input type="file" multiple onChange={handleFileUpload} className="hidden" disabled={isUploading} />
                  </label>
                </div>
                <p className="text-xs text-gray-400">支援圖片與 PDF，單檔請勿超過 10MB。</p>
              </div>

              <div className="mb-6">
                <label className="flex items-center gap-1 text-sm font-medium text-gray-700 mb-2"><MessageSquare className="w-3.5 h-3.5" /> 訂單備註 (選填)</label>
                <textarea value={customerNote} onChange={(e) => setCustomerNote(e.target.value)} placeholder="其他需求..." className="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none h-20 resize-none text-sm" />
              </div>

              <label className="flex items-start gap-3 mb-6 cursor-pointer p-3 rounded-lg hover:bg-gray-50 transition-colors">
                <input type="checkbox" checked={agreed} onChange={(e) => setAgreed(e.target.checked)} className="mt-1 w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500" />
                <span className="text-sm text-gray-600 leading-relaxed">我已確認上述規格無誤，並同意服務條款。</span>
              </label>

              <button onClick={handleSubmit} disabled={isSubmitting} className="w-full py-4 bg-gray-900 hover:bg-black text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2 disabled:opacity-70">
                {isSubmitting ? <Loader2 className="animate-spin w-5 h-5" /> : <>確認下單 <ArrowRight className="w-5 h-5" /></>}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/app/product/[id]/page.tsx">
'use client';

import { useState, useEffect, use } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { Ruler, Loader2, Hammer, Package, ArrowLeft, GripHorizontal, CheckCircle, BadgePercent } from 'lucide-react';
import clsx from 'clsx';
import MeasurementModal, { MeasurementData } from '@/components/MeasurementModal';
import { useCart, CartItem } from '@/context/CartContext';
import { api } from '@/lib/api';

export default function ProductDetailPage({ params }: { params: Promise<{ id: string }> }) {
  const { id } = use(params);
  const router = useRouter();
  const { addToCart } = useCart();

  const [product, setProduct] = useState<any>(null);
  const [systemRules, setSystemRules] = useState<any>(null); 
  const [userLevel, setUserLevel] = useState<string>('C');   
  
  const [loading, setLoading] = useState(true);
  // ✨ 權限檢查狀態
  const [authChecking, setAuthChecking] = useState(true);

  const [activeImageIndex, setActiveImageIndex] = useState(0);

  // 選項狀態
  const [selectedColor, setSelectedColor] = useState<string>('');
  const [selectedMaterial, setSelectedMaterial] = useState<string>('');
  const [selectedHandle, setSelectedHandle] = useState<string>('');
  const [openingDirection, setOpeningDirection] = useState<string>('');
  const [serviceType, setServiceType] = useState<'material' | 'assembled'>('assembled'); 
  
  const [isMeasureOpen, setIsMeasureOpen] = useState(false);
  const [showSuccessModal, setShowSuccessModal] = useState(false);
  const [successMsg, setSuccessMsg] = useState('');

  const [quantity] = useState(1);
  const [isSubmitting, setIsSubmitting] = useState(false);

  // 1. 載入資料 (含權限檢查)
  useEffect(() => {
    // ✨✨✨ 檢查是否登入 (防止直接輸入網址進入) ✨✨✨
    const token = localStorage.getItem('somalink_token') || sessionStorage.getItem('somalink_token');
    if (!token) {
      // 未登入直接導回登入頁
      router.replace('/login');
      return;
    }
    setAuthChecking(false);

    const fetchData = async () => {
      try {
        // A. 抓產品
        const prodRes = await api.get(`/products/${id}`);
        const prodData = prodRes.data || prodRes; 
        
        if (!prodData.images || prodData.images.length === 0) {
            if (prodData.imageUrl) prodData.images = [prodData.imageUrl];
            else prodData.images = ["https://images.unsplash.com/photo-1600607686527-6fb886090705?auto=format&fit=crop&q=80&w=800"];
        }
        setProduct(prodData);
        
        // 設定預設選項
        if (prodData.colors?.length > 0) setSelectedColor(prodData.colors[0].name);
        if (prodData.materials?.length > 0) setSelectedMaterial(prodData.materials[0].name);
        if (prodData.handles?.length > 0) setSelectedHandle(prodData.handles[0].name);
        if (prodData.openingOptions?.length > 0) setOpeningDirection(prodData.openingOptions[0]);

        // B. 抓系統規則 (為了全域折數)
        try {
          const ruleRes = await api.get('/site-config/rules');
          if (ruleRes?.settings) setSystemRules(ruleRes.settings);
        } catch (e) { console.error('無法讀取系統規則', e); }

        // C. 抓會員等級
        const storedUser = localStorage.getItem('somalink_user') || sessionStorage.getItem('somalink_user');
        if (storedUser) {
          const u = JSON.parse(storedUser);
          if (u.dealerProfile?.level) setUserLevel(u.dealerProfile.level);
        }

      } catch (err) {
        console.error('資料載入失敗', err);
      } finally {
        setLoading(false);
      }
    };
    fetchData();
  }, [id, router]);

  // 如果正在檢查權限或載入中，顯示 Loading
  if (authChecking || loading) return <div className="min-h-screen flex justify-center items-center"><Loader2 className="animate-spin text-blue-600" /></div>;
  if (!product) return <div className="min-h-screen flex justify-center items-center">找不到產品</div>;

  // ✨✨✨ 2. 計算折數與價格 (優先權邏輯) ✨✨✨
  
  let discountMultiplier = 1.0; // 預設原價
  // 確保數值型別
  const productDiscountA = product.discountA !== null ? Number(product.discountA) : null;
  const productDiscountB = product.discountB !== null ? Number(product.discountB) : null;
  const systemDiscountA = systemRules?.discount_level_A ? Number(systemRules.discount_level_A) : 1.0;
  const systemDiscountB = systemRules?.discount_level_B ? Number(systemRules.discount_level_B) : 1.0;

  if (userLevel === 'A') {
    // 優先權：產品個別設定 > 系統全域設定 > 原價
    discountMultiplier = productDiscountA ?? systemDiscountA;
  } else if (userLevel === 'B') {
    discountMultiplier = productDiscountB ?? systemDiscountB;
  }

  // 基礎配置加總
  const currentColorObj = product.colors?.find((c: any) => c.name === selectedColor);
  const currentMaterialObj = product.materials?.find((m: any) => m.name === selectedMaterial);
  const currentHandleObj = product.handles?.find((h: any) => h.name === selectedHandle);

  // 原始單價 (未打折前)
  let rawUnitPrice = Number(product.basePrice) + 
                     (Number(currentColorObj?.priceSurcharge) || 0) + 
                     (Number(currentMaterialObj?.priceSurcharge) || 0) +
                     (Number(currentHandleObj?.priceSurcharge) || 0);
  
  const assemblyFee = Number(product.assemblyFee) || 3000; 
  if (serviceType === 'assembled') rawUnitPrice += assemblyFee;

  // ✨ 最終單價 (打折後)
  const finalUnitPrice = Math.round(rawUnitPrice * discountMultiplier);

  // 3. 加入購物車邏輯
  const handleAddToCart = (measureData?: MeasurementData) => {
    setIsSubmitting(true);

    let sizeSurcharge = 0;
    if (measureData && product.requiresMeasurement) {
      const wValues = [measureData.width.top, measureData.width.mid, measureData.width.bot];
      const maxW = Math.max(...wValues); 
      const hValues = [measureData.height.left, measureData.height.mid, measureData.height.right];
      const maxH = measureData.height.singleValue || Math.max(...hValues); 

      const stdW = product.standardWidth || 90;
      const stdH = product.standardHeight || 210;
      const pricePerW = product.pricePerUnitWidth || 0; 
      const pricePerH = product.pricePerUnitHeight || 0; 

      if (maxW > stdW) sizeSurcharge += Math.ceil((maxW - stdW) / 10) * pricePerW;
      if (maxH > stdH) sizeSurcharge += Math.ceil((maxH - stdH) / 10) * pricePerH;
    }

    // 尺寸加價也依折數計算
    const finalSizeSurcharge = Math.round(sizeSurcharge * discountMultiplier);
    
    const totalUnitPrice = finalUnitPrice + finalSizeSurcharge;
    const totalSubtotal = totalUnitPrice * quantity;

    const newItem: CartItem = {
      internalId: crypto.randomUUID(),
      productId: product.id,
      productName: product.name,
      unitPrice: totalUnitPrice, // 使用打折後的最終單價
      quantity: quantity,
      subtotal: totalSubtotal,
      serviceType: serviceType, 
      colorName: selectedColor || '標準',
      materialName: selectedMaterial || '標準',
      // ✨ 寫入把手
      handleName: selectedHandle || '無',
      openingDirection: openingDirection || '無',
      hasThreshold: false,
      widthMatrix: measureData?.width || { top: 0, mid: 0, bot: 0 },
      heightData: measureData?.height || { left: 0, mid: 0, right: 0 },
      isCeilingMounted: measureData?.isCeilingMounted ?? false,
      siteConditions: measureData?.floorError ? { floor: measureData.floorError } : undefined,
      priceSnapshot: {
        basePrice: Number(product.basePrice),
        sizeSurcharge: finalSizeSurcharge, 
        colorSurcharge: Number(currentColorObj?.priceSurcharge) || 0,
        materialSurcharge: Number(currentMaterialObj?.priceSurcharge) || 0,
        handleSurcharge: Number(currentHandleObj?.priceSurcharge) || 0,
        assemblyFee: serviceType === 'assembled' ? assemblyFee : 0,
        thresholdFee: 0
      }
    };

    addToCart(newItem);

    setTimeout(() => {
      setIsSubmitting(false);
      setIsMeasureOpen(false);
      let msg = '';
      if (finalSizeSurcharge > 0) msg = `(含尺寸加價 $${finalSizeSurcharge.toLocaleString()})`;
      setSuccessMsg(msg);
      setShowSuccessModal(true);
    }, 500);
  };

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-6xl mx-auto px-4">
        <div className="mb-6">
          <Link href={product.series ? `/series/${encodeURIComponent(product.series)}` : "/"} className="inline-flex items-center gap-2 text-gray-500 hover:text-blue-600 transition-colors font-medium">
            <ArrowLeft className="w-5 h-5" /> 返回 {product.series || '首頁'}
          </Link>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-10">
          
          {/* 左側圖片畫廊 */}
          <div className="space-y-4">
            <div className="aspect-square bg-white rounded-2xl border border-gray-200 overflow-hidden shadow-sm relative group">
               {/* eslint-disable-next-line @next/next/no-img-element */}
              <img src={product.images[activeImageIndex]} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" alt={product.name} />
            </div>
            {product.images.length > 1 && (
              <div className="flex gap-3 overflow-x-auto pb-2 snap-x">
                {product.images.map((img: string, idx: number) => (
                  <button key={idx} onClick={() => setActiveImageIndex(idx)} className={clsx("relative w-20 h-20 rounded-lg overflow-hidden border-2 shrink-0 transition-all snap-start", activeImageIndex === idx ? "border-blue-600 ring-2 ring-blue-100" : "border-transparent hover:border-gray-300")}>
                    {/* eslint-disable-next-line @next/next/no-img-element */}
                    <img src={img} alt={`Thumbnail ${idx}`} className="w-full h-full object-cover" />
                  </button>
                ))}
              </div>
            )}
          </div>

          <div className="space-y-8">
            
            <div className="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm relative overflow-hidden">
              
              {/* ✨ 會員等級標籤 */}
              {discountMultiplier < 1 && (
                <div className="absolute top-4 right-4 flex items-center gap-1 bg-red-100 text-red-700 px-3 py-1 rounded-full text-xs font-bold shadow-sm border border-red-200">
                  <BadgePercent className="w-4 h-4" />
                  {userLevel} 級會員專屬優惠 ({(discountMultiplier * 10).toFixed(1)}折)
                </div>
              )}

              <h1 className="text-2xl font-bold text-gray-900">{product.name}</h1>
              <p className="text-gray-500 text-sm mt-1">{product.series} / {product.sku}</p>
              
              <div className="mt-4 flex items-end gap-3">
                <div className="flex items-baseline gap-2">
                  <span className="text-4xl font-bold text-blue-600">${finalUnitPrice.toLocaleString()}</span>
                  <span className="text-sm text-gray-500">/ {serviceType === 'assembled' ? '連工帶料' : '純材料'}</span>
                </div>
                {discountMultiplier < 1 && (
                  <span className="text-sm text-gray-400 line-through mb-1">原價 ${rawUnitPrice.toLocaleString()}</span>
                )}
              </div>
              
              {product.requiresMeasurement && <p className="text-xs text-orange-600 mt-2 bg-orange-50 px-2 py-1 rounded inline-block">* 實際價格將於輸入丈量尺寸後計算 (標準 {product.standardWidth}x{product.standardHeight}cm 內不加價)</p>}
            </div>

            {/* 服務模式 */}
            <div>
              <h3 className="text-sm font-bold text-gray-900 mb-3">服務模式</h3>
              <div className="grid grid-cols-2 gap-3">
                <button onClick={() => setServiceType('material')} className={clsx("flex items-center justify-center gap-2 py-3 px-4 rounded-xl text-sm font-bold border-2 transition-all", serviceType === 'material' ? "border-gray-600 bg-gray-100 text-gray-900 ring-1 ring-gray-600" : "border-gray-200 bg-white hover:border-gray-300 text-gray-500")}><Package className="w-4 h-4" /> 純材料 (DIY)</button>
                <button onClick={() => setServiceType('assembled')} className={clsx("flex items-center justify-center gap-2 py-3 px-4 rounded-xl text-sm font-bold border-2 transition-all", serviceType === 'assembled' ? "border-blue-600 bg-blue-50 text-blue-900 ring-1 ring-blue-600" : "border-gray-200 bg-white hover:border-gray-300 text-gray-500")}><Hammer className="w-4 h-4" /> 連工帶料 (含安裝)</button>
              </div>
              {serviceType === 'assembled' && <p className="text-xs text-blue-600 mt-2 ml-1">* 已包含標準安裝費 ${assemblyFee.toLocaleString()}</p>}
            </div>

            {/* 顏色選擇 */}
            {product.colors && product.colors.length > 0 && (
              <div>
                <h3 className="text-sm font-bold text-gray-900 mb-3 flex items-center justify-between"><span>鋁框顏色</span><span className="text-xs text-gray-500 font-normal">已選：{selectedColor}</span></h3>
                <div className="grid grid-cols-3 gap-3">
                  {product.colors.map((color: any, idx: number) => (
                    <button key={idx} onClick={() => setSelectedColor(color.name)} className={clsx("relative flex items-center gap-3 p-3 rounded-xl border-2 transition-all", selectedColor === color.name ? "border-blue-600 bg-blue-50 ring-1 ring-blue-600" : "border-gray-200 bg-white hover:border-gray-300 hover:bg-gray-50")}><span className="w-6 h-6 rounded-full border border-gray-300 shadow-sm" style={{ backgroundColor: color.colorCode || '#000' }} /><span className={clsx("text-sm font-medium", selectedColor === color.name ? "text-blue-900" : "text-gray-700")}>{color.name}</span>{Number(color.priceSurcharge) > 0 && <span className="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full shadow-sm font-bold">+${color.priceSurcharge}</span>}</button>
                  ))}
                </div>
              </div>
            )}

            {/* 材質選擇 */}
            {product.materials && product.materials.length > 0 && (
              <div>
                <h3 className="text-sm font-bold text-gray-900 mb-3 flex items-center justify-between"><span>玻璃/板材</span><span className="text-xs text-gray-500 font-normal">已選：{selectedMaterial}</span></h3>
                <div className="grid grid-cols-2 gap-3">
                  {product.materials.map((mat: any, idx: number) => (
                    <button key={idx} onClick={() => setSelectedMaterial(mat.name)} className={clsx("relative p-3 rounded-xl border-2 transition-all text-left", selectedMaterial === mat.name ? "border-blue-600 bg-blue-50 ring-1 ring-blue-600" : "border-gray-200 bg-white hover:border-gray-300 hover:bg-gray-50")}><span className={clsx("text-sm font-medium block", selectedMaterial === mat.name ? "text-blue-900" : "text-gray-700")}>{mat.name}</span>{Number(mat.priceSurcharge) > 0 && <span className="text-xs text-red-500 font-medium block mt-1">+${mat.priceSurcharge}</span>}</button>
                  ))}
                </div>
              </div>
            )}

            {/* ✨ 把手選擇 ✨ */}
            {product.handles && product.handles.length > 0 && (
              <div>
                <h3 className="text-sm font-bold text-gray-900 mb-3 flex items-center justify-between"><span>把手配件</span><span className="text-xs text-gray-500 font-normal">已選：{selectedHandle}</span></h3>
                <div className="grid grid-cols-2 gap-3">
                  {product.handles.map((h: any, idx: number) => (
                    <button key={idx} onClick={() => setSelectedHandle(h.name)} className={clsx("relative p-3 rounded-xl border-2 transition-all flex items-center gap-3", selectedHandle === h.name ? "border-blue-600 bg-blue-50 ring-1 ring-blue-600" : "border-gray-200 bg-white hover:border-gray-300 hover:bg-gray-50")}>
                      <GripHorizontal className={clsx("w-5 h-5", selectedHandle === h.name ? "text-blue-600" : "text-gray-400")} />
                      <span className={clsx("text-sm font-medium flex-1 text-left", selectedHandle === h.name ? "text-blue-900" : "text-gray-700")}>{h.name}</span>
                      {Number(h.priceSurcharge) > 0 && <span className="text-xs text-red-500 font-medium">+${h.priceSurcharge}</span>}
                    </button>
                  ))}
                </div>
              </div>
            )}

            {/* 開門方向 */}
            {product.openingOptions && product.openingOptions.length > 0 && (
              <div>
                <h3 className="text-sm font-bold text-gray-900 mb-3">開門方向</h3>
                <div className="grid grid-cols-2 gap-3">
                  {product.openingOptions.map((opt: string, idx: number) => (
                    <button key={idx} onClick={() => setOpeningDirection(opt)} className={clsx("py-3 px-4 rounded-xl text-sm font-bold border-2 transition-all flex items-center justify-center", openingDirection === opt ? "border-blue-600 bg-blue-50 text-blue-900 ring-1 ring-blue-600" : "border-gray-200 bg-white hover:border-gray-300 text-gray-500")}>{opt}</button>
                  ))}
                </div>
              </div>
            )}

            <hr className="border-gray-100" />

            {product.requiresMeasurement ? (
              <div className="bg-yellow-50 border border-yellow-200 rounded-xl p-5">
                <div className="flex items-start gap-3 mb-4"><div className="p-2 bg-yellow-100 rounded-lg text-yellow-700"><Ruler className="w-6 h-6" /></div><div><h4 className="text-yellow-900 font-bold">此產品需輸入丈量數據</h4><p className="text-sm text-yellow-700 mt-1">請準備好現場寬度與高度數據。</p></div></div>
                <button onClick={() => setIsMeasureOpen(true)} disabled={isSubmitting} className="w-full py-3.5 bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold rounded-xl transition-colors shadow-sm flex items-center justify-center gap-2 disabled:opacity-70">{isSubmitting ? <Loader2 className="animate-spin" /> : <><Ruler className="w-5 h-5" /> 丈量並加入購物車</>}</button>
              </div>
            ) : (
              <button onClick={() => handleAddToCart()} disabled={isSubmitting} className="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl transition-all shadow-md">{isSubmitting ? '處理中...' : '加入購物車'}</button>
            )}

            <MeasurementModal isOpen={isMeasureOpen} onClose={() => setIsMeasureOpen(false)} onConfirm={(data) => handleAddToCart(data)} />

            {/* 成功彈窗 (使用 Inline Custom UI 以保持 Green Check 設計) */}
            {showSuccessModal && (
              <div className="fixed inset-0 z-60 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
                <div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl flex flex-col items-center text-center space-y-4 animate-in zoom-in-95 duration-200">
                  <div className="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-2"><CheckCircle className="w-8 h-8" /></div>
                  <h3 className="text-xl font-bold text-gray-900">成功加入購物車！</h3>
                  <p className="text-sm text-gray-600">{product.name} {successMsg && <span className="block mt-1 font-medium text-orange-600">{successMsg}</span>}</p>
                  <div className="flex flex-col w-full gap-3 mt-2">
                    <button onClick={() => router.push('/cart')} className="w-full py-3.5 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-colors shadow-md flex items-center justify-center gap-2">前往結帳</button>
                    <button onClick={() => setShowSuccessModal(false)} className="w-full py-3.5 bg-gray-100 text-gray-700 rounded-xl font-bold hover:bg-gray-200 transition-colors">繼續購物</button>
                  </div>
                </div>
              </div>
            )}

          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/components/MeasurementModal.tsx">
'use client';

import { useState, useEffect } from 'react';
import { X, Info, Check, AlertTriangle } from 'lucide-react';
import clsx from 'clsx';

export interface MeasurementData {
  width: { top: number; mid: number; bot: number };
  height: { left: number; mid: number; right: number; singleValue?: number };
  isCeilingMounted: boolean;
  floorError?: { diff: number; description?: string };
}

interface MeasurementModalProps {
  isOpen: boolean;
  onClose: () => void;
  onConfirm: (data: MeasurementData) => void;
}

export default function MeasurementModal({ isOpen, onClose, onConfirm }: MeasurementModalProps) {
  const [step, setStep] = useState(1); // 1: 尺寸輸入, 2: 環境評估
  
  // 尺寸數據
  const [width, setWidth] = useState({ top: '', mid: '', bot: '' });
  const [height, setHeight] = useState({ left: '', mid: '', right: '' });
  const [isCeilingMounted, setIsCeilingMounted] = useState(true);

  // 環境數據
  // ✨ 修正：預設為 false (代表無誤差)，只有勾選有誤差時才需要輸入
  const [hasFloorError, setHasFloorError] = useState(false); 
  const [floorDiff, setFloorDiff] = useState('');

  // 初始化 / 重置
  useEffect(() => {
    if (isOpen) {
      setStep(1);
      setWidth({ top: '', mid: '', bot: '' });
      setHeight({ left: '', mid: '', right: '' });
      setIsCeilingMounted(true);
      setHasFloorError(false); // 預設為完美狀況
      setFloorDiff('');
    }
  }, [isOpen]);

  if (!isOpen) return null;

  const handleNext = () => {
    // 簡單驗證尺寸是否填寫
    if (!width.top || !width.mid || !width.bot || !height.left || !height.mid || !height.right) {
      alert('請填寫完整的寬度與高度數據 (共 6 個欄位)');
      return;
    }
    setStep(2);
  };

  const handleConfirm = () => {
    // ✨ 驗證邏輯修正：只有在「有誤差」且「未填寫數值」時才擋下
    if (hasFloorError && !floorDiff) {
      alert('您勾選了有地面高低差，請輸入誤差數值');
      return;
    }

    const data: MeasurementData = {
      width: {
        top: Number(width.top),
        mid: Number(width.mid),
        bot: Number(width.bot),
      },
      height: {
        left: Number(height.left),
        mid: Number(height.mid),
        right: Number(height.right),
      },
      isCeilingMounted,
      // 如果無誤差，floorError 就給 undefined
      floorError: hasFloorError ? { diff: Number(floorDiff) } : undefined
    };

    onConfirm(data);
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
      <div className="bg-white rounded-2xl w-full max-w-lg overflow-hidden shadow-2xl flex flex-col max-h-[90vh]">
        
        {/* 標題列 */}
        <div className="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50">
          <h3 className="font-bold text-lg text-gray-900">
            {step === 1 ? '步驟 1/2：輸入丈量尺寸' : '步驟 2/2：環境評估'}
          </h3>
          <button onClick={onClose} className="p-2 text-gray-400 hover:bg-gray-200 rounded-full transition-colors">
            <X className="w-5 h-5" />
          </button>
        </div>

        {/* 內容區 */}
        <div className="p-6 overflow-y-auto space-y-6">
          
          {step === 1 && (
            <>
              {/* 寬度輸入區 */}
              <div className="space-y-3">
                <label className="block text-sm font-bold text-gray-700">寬度測量 (Width) <span className="text-red-500">*</span></label>
                <div className="grid grid-cols-3 gap-3">
                  {['top', 'mid', 'bot'].map((pos) => (
                    <div key={pos}>
                      <input 
                        type="number" 
                        placeholder={pos === 'top' ? '上' : pos === 'mid' ? '中' : '下'}
                        value={width[pos as keyof typeof width]}
                        onChange={(e) => setWidth({ ...width, [pos]: e.target.value })}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-center focus:ring-2 focus:ring-blue-500 outline-none transition-all placeholder:text-gray-300"
                      />
                    </div>
                  ))}
                </div>
                <p className="text-xs text-gray-500">請分別測量 上/中/下 三點寬度 (單位: cm)</p>
              </div>

              {/* 高度輸入區 */}
              <div className="space-y-3">
                <div className="flex justify-between items-center">
                  <label className="block text-sm font-bold text-gray-700">高度測量 (Height) <span className="text-red-500">*</span></label>
                  <label className="flex items-center gap-2 cursor-pointer select-none">
                    <input 
                      type="checkbox" 
                      checked={isCeilingMounted}
                      onChange={(e) => setIsCeilingMounted(e.target.checked)}
                      className="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                    />
                    <span className="text-xs font-bold text-blue-700 bg-blue-50 px-2 py-0.5 rounded border border-blue-100">封頂安裝</span>
                  </label>
                </div>
                <div className="grid grid-cols-3 gap-3">
                  {['left', 'mid', 'right'].map((pos) => (
                    <div key={pos}>
                      <input 
                        type="number" 
                        placeholder={pos === 'left' ? '左' : pos === 'mid' ? '中' : '右'}
                        value={height[pos as keyof typeof height]}
                        onChange={(e) => setHeight({ ...height, [pos]: e.target.value })}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-center focus:ring-2 focus:ring-blue-500 outline-none transition-all placeholder:text-gray-300"
                      />
                    </div>
                  ))}
                </div>
                <p className="text-xs text-gray-500">請分別測量 左/中/右 三點高度 (單位: cm)</p>
              </div>
            </>
          )}

          {step === 2 && (
            <div className="space-y-6">
              <div className="bg-blue-50 p-4 rounded-xl flex items-start gap-3 text-blue-800 text-sm border border-blue-100">
                <Info className="w-5 h-5 shrink-0 mt-0.5" />
                <p>請確認現場地面是否有高低差。若牆面/地面垂直水平良好，請選擇第一項。</p>
              </div>

              <div className="space-y-3">
                
                {/* 選項 1: 完美無誤差 (預設) */}
                <label className={clsx(
                  "flex items-center gap-4 p-4 border rounded-xl cursor-pointer transition-all",
                  !hasFloorError ? "border-green-500 bg-green-50 ring-1 ring-green-500" : "border-gray-200 hover:bg-gray-50"
                )}>
                  <input 
                    type="radio" 
                    name="floor_condition"
                    checked={!hasFloorError}
                    onChange={() => {
                      setHasFloorError(false);
                      setFloorDiff('');
                    }}
                    className="w-5 h-5 text-green-600 border-gray-300 focus:ring-green-500"
                  />
                  <div className="flex-1">
                    <span className="font-bold text-gray-900 block">✅ 垂直水平良好 (無誤差)</span>
                    <span className="text-xs text-gray-500">現場條件標準，不需要特殊調整</span>
                  </div>
                </label>

                {/* 選項 2: 有誤差 */}
                <label className={clsx(
                  "flex items-start gap-4 p-4 border rounded-xl cursor-pointer transition-all",
                  hasFloorError ? "border-orange-500 bg-orange-50 ring-1 ring-orange-500" : "border-gray-200 hover:bg-gray-50"
                )}>
                  <input 
                    type="radio" 
                    name="floor_condition"
                    checked={hasFloorError}
                    onChange={() => setHasFloorError(true)}
                    className="w-5 h-5 text-orange-600 border-gray-300 focus:ring-orange-500 mt-1"
                  />
                  <div className="flex-1">
                    <span className="font-bold text-gray-900 block">⚠️ 有地面高低差 (水平誤差)</span>
                    <span className="text-xs text-gray-500 mb-2 block">左右高度不一致，需填寫誤差值</span>
                    
                    {/* 輸入框只在勾選時出現 */}
                    {hasFloorError && (
                      <div className="mt-3 flex items-center gap-2 animate-in fade-in slide-in-from-top-2">
                        <label className="text-sm font-bold text-gray-700 whitespace-nowrap">高低落差：</label>
                        <input 
                          type="number" 
                          value={floorDiff}
                          onChange={(e) => setFloorDiff(e.target.value)}
                          placeholder="0.5"
                          className="w-24 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none bg-white"
                          autoFocus
                        />
                        <span className="text-sm text-gray-500">cm</span>
                      </div>
                    )}
                  </div>
                </label>

              </div>
            </div>
          )}

        </div>

        {/* 底部按鈕 */}
        <div className="p-5 border-t border-gray-100 flex justify-end gap-3 bg-gray-50">
          {step === 2 && (
            <button 
              onClick={() => setStep(1)}
              className="px-5 py-2.5 rounded-xl font-bold text-gray-600 hover:bg-gray-200 transition-colors"
            >
              上一步
            </button>
          )}
          <button 
            onClick={step === 1 ? handleNext : handleConfirm}
            className="px-8 py-2.5 bg-gray-900 hover:bg-black text-white rounded-xl font-bold transition-colors shadow-lg flex items-center gap-2"
          >
            {step === 1 ? '下一步' : <><Check className="w-4 h-4" /> 完成並加入</>}
          </button>
        </div>

      </div>
    </div>
  );
}
</file>

<file path="frontend/src/lib/api.ts">
import axios from 'axios';

const API_URL = process.env.NEXT_PUBLIC_API_URL || 'https://somalink-backend.onrender.com';

export interface OrderItem {
  id: string;
  product: { 
    name: string;
    images?: string[];
    imageUrl?: string; 
  };
  serviceType: 'material' | 'assembled';
  widthMatrix: { top: number; mid: number; bot: number };
  heightData: any;
  isCeilingMounted: boolean;
  siteConditions?: any;
  colorName: string;
  materialName: string;
  handleName?: string;
  openingDirection: string;
  hasThreshold: boolean;
  quantity: number;
  subtotal: number;
  priceSnapshot: any;
}

export enum OrderStatus {
  PENDING = 'pending',       
  PROCESSING = 'processing', 
  SHIPPED = 'shipped',       
  COMPLETED = 'completed',   
  CANCELLED = 'cancelled',   
}

export interface Order {
  id: string;
  orderNumber: string;
  status: OrderStatus;
  totalAmount: number;
  createdAt: string;
  projectName: string;
  shippingAddress?: string;
  siteContactPerson?: string;
  siteContactPhone?: string;
  attachments?: string[];
  customerNote?: string;
  adminNote?: string;
  items: OrderItem[]; 
}

const axiosInstance = axios.create({
  baseURL: API_URL,
  headers: {
    'Content-Type': 'application/json',
  },
});

// 請求攔截器：自動帶入 Token
axiosInstance.interceptors.request.use((config) => {
  if (typeof window !== 'undefined') {
    // ✨ 修改：優先讀取 LocalStorage，沒有的話讀取 SessionStorage
    const token = localStorage.getItem('somalink_token') || sessionStorage.getItem('somalink_token');
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
  }
  return config;
});

export const api = {
  get: async (url: string) => {
    const response = await axiosInstance.get(url);
    return response.data;
  },
  post: async (url: string, data: any) => {
    const response = await axiosInstance.post(url, data);
    return response.data;
  },
  patch: async (url: string, data: any) => {
    const response = await axiosInstance.patch(url, data);
    return response.data;
  },
  delete: async (url: string) => {
    const response = await axiosInstance.delete(url);
    return response.data;
  },
};
</file>

<file path="admin/src/app/login/page.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { api } from '@/lib/api';
import { Loader2, Lock, ShieldCheck, AlertCircle } from 'lucide-react';

export default function AdminLoginPage() {
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(false);
  const [errorMsg, setErrorMsg] = useState<string | null>(null);
  
  const [formData, setFormData] = useState({
    email: '',
    password: ''
  });

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);
    setErrorMsg(null);

    try {
      // 1. 呼叫後端登入
      // ✨ Fix: api.post 已經回傳 data，所以直接解構即可，不需要再寫 .data
      const data = await api.post('/auth/login', formData);
      const { access_token, user } = data;

      // 2. 檢查是否為管理員
      // ✨ Fix: 同時允許大寫 ADMIN (後端預設) 與小寫 admin
      if (user.role !== 'ADMIN' && user.role !== 'admin') {
        setErrorMsg('權限不足：您不是系統管理員');
        setIsLoading(false);
        return;
      }

      // 3. 儲存 Token
      localStorage.setItem('somalink_admin_token', access_token);
      localStorage.setItem('somalink_admin_user', JSON.stringify(user));
      
      // 4. 進入戰情室
      router.push('/');

    } catch (err: any) {
      console.error('登入失敗:', err);
      if (err.response?.status === 401) {
        setErrorMsg('帳號或密碼錯誤');
      } else {
        // 顯示具體的錯誤訊息，方便除錯
        setErrorMsg(err.message || '系統連線錯誤');
      }
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-slate-900 px-4 font-sans">
      <div className="max-w-md w-full space-y-8 bg-white p-10 rounded-2xl shadow-2xl">
        
        <div className="text-center">
          <div className="mx-auto h-16 w-16 bg-slate-800 rounded-xl flex items-center justify-center text-white mb-6 shadow-lg">
            <ShieldCheck className="w-8 h-8" />
          </div>
          <h2 className="text-3xl font-extrabold text-slate-900">
            松成有限公司
          </h2>
          <p className="mt-2 text-sm text-slate-500 font-medium tracking-wide uppercase">
            工廠管理後台
          </p>
        </div>

        {errorMsg && (
          <div className="bg-red-50 border border-red-200 rounded-lg p-4 flex items-start gap-3">
            <AlertCircle className="w-5 h-5 text-red-600 mt-0.5 shrink-0" />
            <p className="text-sm text-red-700 font-medium">{errorMsg}</p>
          </div>
        )}

        <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
          <div className="space-y-5">
            <div>
              <label className="block text-sm font-bold text-slate-700 mb-1">管理員帳號</label>
              <input
                type="email"
                required
                className="block w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none transition-all"
                placeholder="admin@somalink.com"
                value={formData.email}
                onChange={(e) => setFormData({...formData, email: e.target.value})}
              />
            </div>

            <div>
              <label className="block text-sm font-bold text-slate-700 mb-1">密碼</label>
              <div className="relative">
                <input
                  type="password"
                  required
                  className="block w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none transition-all"
                  placeholder="••••••••"
                  value={formData.password}
                  onChange={(e) => setFormData({...formData, password: e.target.value})}
                />
                <Lock className="absolute right-3 top-3.5 w-5 h-5 text-gray-400" />
              </div>
            </div>
          </div>

          <button
            type="submit"
            disabled={isLoading}
            className="w-full flex justify-center py-3.5 px-4 border border-transparent rounded-xl text-sm font-bold text-white bg-slate-900 hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 disabled:opacity-70 transition-all shadow-lg"
          >
            {isLoading ? <Loader2 className="animate-spin" /> : '進入後台系統'}
          </button>
        </form>
        
        <div className="text-center text-xs text-gray-400 mt-4">
          此區域僅限授權人員進入，IP 位置將被記錄。
        </div>
      </div>
    </div>
  );
}
</file>

<file path="admin/src/app/users/page.tsx">
'use client';

import { useEffect, useState, useMemo } from 'react';
import { Users, Search, Wallet, AlertCircle, ChevronDown, ArrowUpCircle, Filter, CheckCircle, XCircle, Power, Trash2 } from 'lucide-react';
import { api } from '@/lib/api';
import clsx from 'clsx';

export default function UsersPage() {
  const [users, setUsers] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');
  
  const [selectedUser, setSelectedUser] = useState<any>(null);
  const [modalMode, setModalMode] = useState<'deposit' | 'level'>('deposit'); 
  const [depositAmount, setDepositAmount] = useState('');
  const [newLevel, setNewLevel] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);

  const fetchUsers = async () => {
    try {
      const res = await api.get('/users');
      // ✨ Fix: 直接使用 res，並確保它是陣列
      if (Array.isArray(res)) {
        setUsers(res);
      } else {
        console.warn('API 回傳格式異常 (非陣列):', res);
        setUsers([]);
      }
    } catch (err) {
      console.error(err);
      setUsers([]);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchUsers();
  }, []);

  // 開通/停權
  const handleToggleActive = async (user: any) => {
    const action = user.isActive ? '停權' : '開通';
    if (!confirm(`確定要${action} ${user.dealerProfile.companyName} 嗎？`)) return;

    try {
      await api.patch(`/users/${user.id}/status`, { isActive: !user.isActive });
      alert(`${action}成功！`);
      fetchUsers();
    } catch (err) {
      alert('操作失敗，請檢查後端連線');
    }
  };

  // 刪除會員
  const handleDeleteUser = async (user: any) => {
    if (!confirm(`⚠️ 警告：確定要刪除會員【${user.dealerProfile.companyName}】嗎？\n\n此操作將永久刪除該帳號及其所有資料，且無法復原！`)) return;
    
    try {
      await api.delete(`/users/${user.id}`);
      alert('刪除成功！');
      fetchUsers();
    } catch (err) {
      console.error(err);
      alert('刪除失敗');
    }
  };

  const filteredUsers = useMemo(() => {
    return (users || []).filter(user => {
      if (!user) return false;
      const term = searchTerm.toLowerCase();
      const profile = user.dealerProfile;
      return (
        (profile?.companyName || '').toLowerCase().includes(term) ||
        (profile?.taxId || '').includes(term) ||
        (profile?.contactPerson || '').toLowerCase().includes(term) ||
        (user.email || '').toLowerCase().includes(term)
      );
    });
  }, [users, searchTerm]);

  const handleDeposit = async () => {
    if (!depositAmount || Number(depositAmount) <= 0) return alert('請輸入有效金額');
    setIsSubmitting(true);
    try {
      await api.post(`/users/${selectedUser.id}/deposit`, { amount: Number(depositAmount) });
      alert('🎉 儲值成功！');
      closeModal();
      fetchUsers();
    } catch (err: any) {
      alert(err.response?.data?.message || '儲值失敗');
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleLevelChange = async () => {
    if (!newLevel) return;
    setIsSubmitting(true);
    try {
       await api.patch(`/users/${selectedUser.id}/level`, { level: newLevel });
       alert('等級修改成功！');
       closeModal();
       fetchUsers();
    } catch (err: any) {
      alert('修改失敗');
    } finally {
      setIsSubmitting(false);
    }
  };

  const openModal = (user: any, mode: 'deposit' | 'level') => {
    setSelectedUser(user);
    setModalMode(mode);
    setDepositAmount('');
    setNewLevel(user.dealerProfile?.level || 'C');
  };

  const closeModal = () => {
    setSelectedUser(null);
  };

  return (
    <div className="min-h-screen bg-gray-50 p-8 font-sans">
      
      {/* Header */}
      <div className="flex justify-between items-center mb-8">
        <div>
          <h1 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
            <Users className="w-6 h-6 text-blue-600" />
            會員管理
          </h1>
          <p className="text-gray-500 text-sm mt-1">管理經銷商等級、審核開通與錢包儲值</p>
        </div>
      </div>

      {/* 列表卡片 */}
      <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        
        <div className="p-5 border-b border-gray-100 bg-gray-50/50 flex items-center gap-4">
          <div className="relative w-72">
            <Search className="absolute left-3 top-2.5 w-4 h-4 text-gray-400" />
            <input type="text" placeholder="搜尋公司名、統編、聯絡人..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all" />
          </div>
          <div className="text-sm text-gray-500">共 {filteredUsers.length} 位會員</div>
        </div>

        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">狀態</th>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">公司名稱 / 統編</th>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">聯絡人</th>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">等級</th>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">錢包餘額</th>
              <th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">操作</th>
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-gray-200">
            {loading ? <tr><td colSpan={6} className="text-center py-12 text-gray-500">載入中...</td></tr> : 
              filteredUsers.map((user) => {
                const profile = user.dealerProfile;
                return (
                  <tr key={user.id} className={clsx("transition-colors", user.isActive ? "hover:bg-gray-50" : "bg-red-50 hover:bg-red-100")}>
                    
                    <td className="px-6 py-4">
                      <button 
                        onClick={() => handleToggleActive(user)}
                        className={clsx(
                          "flex items-center gap-1 px-2 py-1 rounded-full text-xs font-bold border transition-all",
                          user.isActive 
                            ? "bg-green-100 text-green-700 border-green-200 hover:bg-green-200" 
                            : "bg-red-100 text-red-700 border-red-200 hover:bg-red-200"
                        )}
                        title="點擊切換狀態"
                      >
                        {user.isActive ? <CheckCircle className="w-3 h-3" /> : <Power className="w-3 h-3" />}
                        {user.isActive ? '已開通' : '待審核'}
                      </button>
                    </td>

                    <td className="px-6 py-4">
                      <div className="font-bold text-gray-900">{profile?.companyName}</div>
                      <div className="text-xs text-gray-500 font-mono">{profile?.taxId}</div>
                      <div className="text-[10px] text-gray-400 mt-1">{profile?.tradeType}</div>
                    </td>
                    <td className="px-6 py-4">
                      <div className="text-sm text-gray-900">{profile?.contactPerson}</div>
                      <div className="text-xs text-gray-400">{user.email}</div>
                    </td>
                    <td className="px-6 py-4">
                      <div className="flex items-center gap-2">
                        <span className={clsx("px-2 py-1 rounded text-xs font-bold border", profile?.level === 'A' ? "bg-yellow-100 text-yellow-800 border-yellow-200" : profile?.level === 'B' ? "bg-blue-100 text-blue-800 border-blue-200" : "bg-gray-100 text-gray-600 border-gray-200")}>
                          {profile?.level} 級夥伴
                        </span>
                        <button onClick={() => openModal(user, 'level')} className="text-gray-400 hover:text-blue-600 transition-colors" title="修改等級"><ArrowUpCircle className="w-4 h-4" /></button>
                      </div>
                    </td>
                    <td className="px-6 py-4">
                      <div className="flex items-center gap-2">
                        <Wallet className="w-4 h-4 text-gray-400" />
                        <span className="font-mono font-bold text-gray-900">${Number(profile?.walletBalance).toLocaleString()}</span>
                      </div>
                    </td>
                    <td className="px-6 py-4 text-right">
                      <div className="flex items-center justify-end gap-2">
                        {profile?.level !== 'C' ? (
                          <button onClick={() => openModal(user, 'deposit')} className="text-blue-600 hover:bg-blue-50 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors border border-blue-100">儲值</button>
                        ) : <span className="text-xs text-gray-400 bg-gray-50 px-2 py-1 rounded">不可儲值</span>}
                        
                        <button 
                          onClick={() => handleDeleteUser(user)} 
                          className="text-gray-400 hover:text-red-600 hover:bg-red-50 p-1.5 rounded-lg transition-colors"
                          title="刪除會員"
                        >
                          <Trash2 className="w-4 h-4" />
                        </button>
                      </div>
                    </td>
                  </tr>
                );
              })
            }
          </tbody>
        </table>
      </div>

      {selectedUser && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            
            {modalMode === 'deposit' && (
              <>
                <h3 className="text-xl font-bold text-gray-900 mb-1">錢包儲值</h3>
                <p className="text-sm text-gray-500 mb-6">正在為 <span className="font-bold text-blue-600">{selectedUser.dealerProfile.companyName}</span> 儲值</p>
                <div className="space-y-4">
                  <div><label className="block text-sm font-medium text-gray-700 mb-1">儲值金額 (NT$)</label><input type="number" autoFocus className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-lg font-mono" placeholder="例如：100000" value={depositAmount} onChange={(e) => setDepositAmount(e.target.value)} /><p className="text-xs text-gray-500 mt-1 flex items-center gap-1"><AlertCircle className="w-3 h-3" /> 單筆上限：{selectedUser.dealerProfile.level === 'A' ? '20萬' : '10萬'}</p></div>
                  <div className="flex gap-3 mt-6"><button onClick={closeModal} className="flex-1 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">取消</button><button onClick={handleDeposit} disabled={isSubmitting} className="flex-1 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold disabled:opacity-70">{isSubmitting ? '處理中...' : '確認儲值'}</button></div>
                </div>
              </>
            )}

            {modalMode === 'level' && (
              <>
                <h3 className="text-xl font-bold text-gray-900 mb-1">修改會員等級</h3>
                <p className="text-sm text-gray-500 mb-6">調整 <span className="font-bold text-blue-600">{selectedUser.dealerProfile.companyName}</span> 的權限</p>
                <div className="space-y-4">
                  <div><label className="block text-sm font-medium text-gray-700 mb-2">選擇新等級</label><div className="grid grid-cols-3 gap-3">{['A', 'B', 'C'].map(lvl => (<button key={lvl} onClick={() => setNewLevel(lvl)} className={clsx("py-3 border-2 rounded-xl font-bold text-lg transition-all", newLevel === lvl ? "border-blue-600 bg-blue-50 text-blue-700" : "border-gray-200 hover:border-gray-300 text-gray-600")}>{lvl} 級</button>))}</div></div>
                  <div className="flex gap-3 mt-6"><button onClick={closeModal} className="flex-1 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">取消</button><button onClick={handleLevelChange} disabled={isSubmitting} className="flex-1 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold disabled:opacity-70">{isSubmitting ? '儲存中...' : '確認修改'}</button></div>
                </div>
              </>
            )}
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="backend/src/app.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { ConfigModule } from '@nestjs/config';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { UsersModule } from './users/users.module';
import { AuthModule } from './auth/auth.module';
import { ProductsModule } from './products/products.module';
import { OrdersModule } from './orders/orders.module';
import { ReportsModule } from './reports/reports.module';
import { SeriesModule } from './series/series.module';
import { AnnouncementsModule } from './announcements/announcements.module';
import { NotificationsModule } from './notifications/notifications.module';
// 引入網站設定模組 (首頁積木、系統規則)
import { SiteConfigModule } from './site-config/site-config.module';
// 引入購物車模組 (伺服器端購物車)
import { CartModule } from './cart/cart.module';

@Module({
  imports: [
    // 1. 全域環境變數設定 (.env)
    ConfigModule.forRoot({
      isGlobal: true, 
    }),
    
    // 2. 資料庫連線設定 (PostgreSQL)
    TypeOrmModule.forRoot({
      type: 'postgres',
      url: process.env.DATABASE_URL, // 優先使用 DATABASE_URL
      host: process.env.DB_HOST,
      port: parseInt(process.env.DB_PORT || '5432'),
      username: process.env.DB_USERNAME,
      password: process.env.DB_PASSWORD,
      database: process.env.DB_DATABASE,
      autoLoadEntities: true, // 自動載入所有 Entity
      synchronize: true,      // 開發模式下自動同步資料庫結構 (生產環境建議改 false)
      ssl: {
        rejectUnauthorized: false, // 允許自我簽署憑證 (解決 Render/Neon SSL 問題)
      },
    }),

    // 3. 功能模組註冊
    UsersModule,
    AuthModule,
    ProductsModule,
    OrdersModule,
    ReportsModule,
    SeriesModule,
    AnnouncementsModule,
    NotificationsModule,
    SiteConfigModule,
    CartModule,
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
</file>

<file path="backend/src/auth/jwt.strategy.ts">
// 檔案位置: backend/src/auth/jwt.strategy.ts

import { ExtractJwt, Strategy } from 'passport-jwt';
import { PassportStrategy } from '@nestjs/passport';
import { Injectable, UnauthorizedException } from '@nestjs/common';
import { ConfigService } from '@nestjs/config'; // 1. 新增引入
import { UsersService } from '../users/users.service';

@Injectable()
export class JwtStrategy extends PassportStrategy(Strategy) {
  constructor(
    private usersService: UsersService,
    private configService: ConfigService, // 2. 注入 ConfigService
  ) {
    super({
      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
      ignoreExpiration: false,
      // 3. 修正：從環境變數讀取密鑰，如果讀不到則使用預設值 (建議正式環境一定要設定環境變數)
      secretOrKey: configService.get<string>('JWT_SECRET') || 'secretKey',
    });
  }

  async validate(payload: any) {
    const user = await this.usersService.findByEmail(payload.email);
    if (!user) {
      throw new UnauthorizedException();
    }
    return user;
  }
}
</file>

<file path="backend/src/orders/dto/create-order.dto.ts">
import { IsString, IsBoolean, IsArray, IsNumber, ValidateNested, IsOptional, IsObject } from 'class-validator';
import { Type } from 'class-transformer';

export class CreateOrderItemDto {
  @IsString()
  productId: string;

  @IsString()
  serviceType: string;

  @IsObject()
  widthMatrix: { top: number; mid: number; bot: number };

  @IsObject()
  heightData: any;

  @IsBoolean()
  isCeilingMounted: boolean;

  @IsObject()
  @IsOptional()
  siteConditions?: any;

  @IsString()
  colorName: string;

  @IsString()
  materialName: string;

  // ✨✨✨ 新增：把手名稱 (選填) ✨✨✨
  @IsString()
  @IsOptional()
  handleName?: string;

  @IsString()
  openingDirection: string;

  @IsBoolean()
  hasThreshold: boolean;

  @IsNumber()
  quantity: number;

  @IsNumber()
  subtotal: number;

  @IsObject()
  priceSnapshot: any;
}

export class CreateOrderDto {
  @IsString()
  projectName: string;

  @IsString()
  @IsOptional()
  shippingAddress?: string;

  @IsString()
  @IsOptional()
  siteContactPerson?: string;

  @IsString()
  @IsOptional()
  siteContactPhone?: string;

  @IsArray()
  @IsOptional()
  @IsString({ each: true })
  attachments?: string[];

  @IsBoolean()
  agreedToDisclaimer: boolean;

  @IsOptional()
  @IsString()
  customerNote?: string;

  @IsArray()
  @ValidateNested({ each: true })
  @Type(() => CreateOrderItemDto)
  items: CreateOrderItemDto[];
}
</file>

<file path="backend/src/orders/entities/order.entity.ts">
import { Entity, Column, PrimaryGeneratedColumn, ManyToOne, OneToMany, CreateDateColumn, UpdateDateColumn } from 'typeorm';
import { User } from '../../users/entities/user.entity';
import { OrderItem } from './order-item.entity';

export enum OrderStatus {
  PENDING = 'pending',       
  PROCESSING = 'processing', 
  SHIPPED = 'shipped',       
  COMPLETED = 'completed',   
  CANCELLED = 'cancelled',   
}

@Entity()
export class Order {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ unique: true })
  orderNumber: string;

  @ManyToOne(() => User, { eager: true })
  user: User;

  @OneToMany(() => OrderItem, (item) => item.order, { cascade: true, eager: true })
  items: OrderItem[];

  @Column()
  projectName: string;

  @Column({ nullable: true })
  shippingAddress: string;

  @Column({ nullable: true })
  siteContactPerson: string; 

  @Column({ nullable: true })
  siteContactPhone: string; 

  // ✨✨✨ 新增：附件欄位 (儲存 URL 字串陣列) ✨✨✨
  @Column({ type: 'jsonb', nullable: true })
  attachments: string[];

  @Column({
    type: 'enum',
    enum: OrderStatus,
    default: OrderStatus.PENDING,
  })
  status: OrderStatus;

  @Column({ type: 'decimal', precision: 12, scale: 2 })
  totalAmount: number;

  @Column({ default: false })
  agreedToDisclaimer: boolean;

  @Column({ nullable: true })
  adminNote?: string;

  @Column({ nullable: true })
  customerNote?: string;

  @CreateDateColumn()
  createdAt: Date;

  @UpdateDateColumn()
  updatedAt: Date;
}
</file>

<file path="backend/src/orders/orders.controller.ts">
import { Controller, Get, Post, Body, Patch, Param, Delete, UseGuards, Request } from '@nestjs/common';
import { OrdersService } from './orders.service';
import { CreateOrderDto } from './dto/create-order.dto';
import { UpdateOrderDto } from './dto/update-order.dto';
import { JwtAuthGuard } from '../auth/jwt-auth.guard';
import { UserRole } from '../users/entities/user.entity'; // ✨ 記得引入 UserRole

@Controller('orders')
export class OrdersController {
  constructor(private readonly ordersService: OrdersService) {}

  // 1. 建立訂單
  @Post()
  @UseGuards(JwtAuthGuard)
  create(@Body() createOrderDto: CreateOrderDto, @Request() req) {
    return this.ordersService.create(createOrderDto, req.user);
  }

  // ✨ 2. 查詢訂單列表 (修正權限邏輯)
  @Get()
  @UseGuards(JwtAuthGuard)
  findAll(@Request() req) {
    // 判斷角色：如果是管理員，就呼叫 findAll (查全部)
    // 兼容大小寫 (ADMIN 或 admin)
    if (req.user.role === UserRole.ADMIN || req.user.role === 'admin' || req.user.role === 'ADMIN') {
      return this.ordersService.findAll();
    }
    // 如果是經銷商，只查自己的
    return this.ordersService.findAllByUser(req.user);
  }

  // 避免 /orders/all 被當成 id
  @Get('all')
  @UseGuards(JwtAuthGuard)
  findAllAlias(@Request() req) {
    if (req.user.role === UserRole.ADMIN || req.user.role === 'admin') {
      return this.ordersService.findAll();
    }
    return this.ordersService.findAllByUser(req.user);
  }

  // 3. 查詢單一訂單
  @Get(':id')
  @UseGuards(JwtAuthGuard)
  findOne(@Param('id') id: string) {
    return this.ordersService.findOne(id);
  }

  // 4. 更新訂單狀態
  @Patch(':id')
  @UseGuards(JwtAuthGuard)
  update(@Param('id') id: string, @Body() updateOrderDto: UpdateOrderDto) {
    return this.ordersService.updateStatus(id, updateOrderDto.status, updateOrderDto.adminNote);
  }

  // 5. 刪除訂單
  @Delete(':id')
  @UseGuards(JwtAuthGuard)
  remove(@Param('id') id: string, @Request() req) {
    return this.ordersService.remove(id, req.user);
  }
}
</file>

<file path="backend/src/orders/orders.service.ts">
import { Injectable, NotFoundException, ForbiddenException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository, Like } from 'typeorm';
import { Order, OrderStatus } from './entities/order.entity';
import { OrderItem } from './entities/order-item.entity';
import { User } from '../users/entities/user.entity';
import { NotificationsService } from '../notifications/notifications.service';
import { CreateOrderDto } from './dto/create-order.dto';
import { SiteConfigService } from '../site-config/site-config.service'; // ✨ 1. 引入設定服務

@Injectable()
export class OrdersService {
  constructor(
    @InjectRepository(Order)
    private ordersRepository: Repository<Order>,
    @InjectRepository(User)
    private usersRepository: Repository<User>,
    private notificationsService: NotificationsService,
    private siteConfigService: SiteConfigService, // ✨ 2. 注入設定服務
  ) {}

  // 1. 查詢所有訂單 (管理員用)
  async findAll() {
    return this.ordersRepository.find({
      relations: ['user', 'user.dealerProfile', 'items', 'items.product'],
      order: { createdAt: 'DESC' },
    });
  }

  // 2. 查詢特定使用者的訂單 (經銷商用)
  async findAllByUser(user: User) {
    return this.ordersRepository.find({
      where: { user: { id: user.id } },
      relations: ['items', 'items.product'],
      order: { createdAt: 'DESC' },
    });
  }

  // 3. 查詢單一訂單
  async findOne(id: string) {
    const order = await this.ordersRepository.findOne({
      where: { id },
      relations: ['user', 'user.dealerProfile', 'items', 'items.product'],
    });
    if (!order) {
      throw new NotFoundException(`找不到訂單 #${id}`);
    }
    return order;
  }

  // 4. 建立訂單 (月刷制流水號邏輯)
  async create(createOrderDto: CreateOrderDto, user: User) {
    const order = new Order();
    order.user = user;
    order.projectName = createOrderDto.projectName;
    
    // 收貨資訊
    order.shippingAddress = createOrderDto.shippingAddress || '';
    order.siteContactPerson = createOrderDto.siteContactPerson || '';
    order.siteContactPhone = createOrderDto.siteContactPhone || '';
    
    // 附件
    order.attachments = createOrderDto.attachments || [];

    order.agreedToDisclaimer = createOrderDto.agreedToDisclaimer;
    order.customerNote = createOrderDto.customerNote;
    
    // ✨✨✨ 流水號生成邏輯 (月刷制) ✨✨✨
    
    // 1. 讀取後台設定的「重置日」
    const rules = await this.siteConfigService.getSystemRules();
    const resetDay = rules.settings?.order_reset_day || 1; // 預設每月 1 號重置

    // 2. 計算當前所屬的週期 (Cycle)
    const today = new Date();
    let cycleYear = today.getFullYear();
    let cycleMonth = today.getMonth(); // 0-11 (注意：0是1月)

    // 如果今天還沒到重置日 (例如設定 25 號，今天是 20 號)，則歸屬到「上個月」的帳務週期
    if (today.getDate() < resetDay) {
      cycleMonth -= 1;
    }

    // 處理跨年 (例如 1月往前推變成去年的 12月)
    if (cycleMonth < 0) {
      cycleMonth = 11;
      cycleYear -= 1;
    }

    // 3. 生成前綴字串：ORD-YYYYMM- (例如 ORD-202511-)
    const dateStr = `${cycleYear}${String(cycleMonth + 1).padStart(2, '0')}`; 
    const prefix = `ORD-${dateStr}`;

    // 4. 找出該週期的最後一筆訂單，以決定序號
    const lastOrder = await this.ordersRepository.findOne({
      where: { orderNumber: Like(`${prefix}%`) }, 
      order: { orderNumber: 'DESC' },
    });

    let sequence = 1;
    if (lastOrder) {
      const parts = lastOrder.orderNumber.split('-');
      // 確保格式正確 (ORD-YYYYMM-XXX)
      if (parts.length === 3) {
        const lastSeq = parseInt(parts[2], 10);
        if (!isNaN(lastSeq)) {
          sequence = lastSeq + 1;
        }
      }
    }

    // 補零 (001, 002...)
    const sequenceStr = sequence.toString().padStart(3, '0'); 
    order.orderNumber = `${prefix}-${sequenceStr}`;
    order.status = OrderStatus.PENDING;

    // 建立訂單項目
    order.items = createOrderDto.items.map(itemDto => {
      const item = new OrderItem();
      item.product = { id: itemDto.productId } as any; 
      item.serviceType = itemDto.serviceType as any; 
      item.widthMatrix = itemDto.widthMatrix;
      item.heightData = itemDto.heightData;
      item.isCeilingMounted = itemDto.isCeilingMounted;
      item.siteConditions = itemDto.siteConditions;
      item.colorName = itemDto.colorName;
      item.materialName = itemDto.materialName;
      item.handleName = itemDto.handleName || '';
      item.openingDirection = itemDto.openingDirection;
      item.hasThreshold = itemDto.hasThreshold;
      item.quantity = itemDto.quantity;
      item.subtotal = itemDto.subtotal;
      item.priceSnapshot = itemDto.priceSnapshot;
      return item;
    });

    // 計算總金額
    order.totalAmount = order.items.reduce((sum, item) => sum + Number(item.subtotal), 0);

    const savedOrder = await this.ordersRepository.save(order);

    // 發送通知
    const dealerName = user.dealerProfile?.companyName || user.email;
    const firstItemName = savedOrder.items[0]?.product?.name || '客製化門扇'; 
    const itemCount = savedOrder.items.length;
    const attachmentHint = order.attachments.length > 0 ? ` (含 ${order.attachments.length} 個附件)` : '';
    
    try {
        const msg = `🔥 新訂單通知${attachmentHint}！\n單號：${savedOrder.orderNumber}\n客戶：${dealerName}\n地點：${order.shippingAddress}\n內容：${firstItemName} 等 ${itemCount} 件`;
        this.notificationsService.sendLineNotify(msg).catch(err => console.log('Line 通知略過'));
    } catch (e) {
        // 忽略通知錯誤
    }

    return savedOrder;
  }

  // 5. 更新狀態
  async updateStatus(id: string, status?: OrderStatus, adminNote?: string) {
    const updateData: any = {};
    if (status !== undefined) updateData.status = status;
    if (adminNote !== undefined) updateData.adminNote = adminNote;

    if (Object.keys(updateData).length > 0) {
      await this.ordersRepository.update(id, updateData);
    }
    
    const updatedOrder = await this.ordersRepository.findOne({
      where: { id },
      relations: ['user', 'items', 'items.product']
    });

    if (updatedOrder && status) {
        let subject = '';
        let body = '';

        if (status === OrderStatus.PROCESSING) {
            subject = `【SomaLink】訂單 ${updatedOrder.orderNumber} 已審核通過`;
            body = `您的訂單已通過審核，工廠將開始排程生產。`;
        } else if (status === OrderStatus.SHIPPED) {
            subject = `【SomaLink】訂單 ${updatedOrder.orderNumber} 已出貨`;
            body = `您的訂單已完成生產並安排出貨，請留意物流通知。`;
        } else if (status === OrderStatus.COMPLETED) {
             subject = `【SomaLink】訂單 ${updatedOrder.orderNumber} 已結案`;
             body = `感謝您的訂購，期待再次為您服務。`;
        }

        if (subject) {
            this.notificationsService.sendEmail(updatedOrder.user.email, subject, body)
                .catch(err => console.log('Email 通知略過'));
        }
    }

    return updatedOrder;
  }

  // 6. 刪除訂單
  async remove(id: string, user: User) {
    const order = await this.findOne(id);

    if (order.user.id !== user.id) {
      throw new ForbiddenException('您無權刪除此訂單');
    }

    if (order.status !== OrderStatus.PENDING) {
      throw new ForbiddenException('訂單已進入生產流程，無法刪除。請聯繫客服。');
    }

    return this.ordersRepository.remove(order);
  }
}
</file>

<file path="backend/src/users/dto/update-user.dto.ts">
import { PartialType } from '@nestjs/mapped-types';
import { CreateUserDto } from './create-user.dto';
import { IsBoolean, IsOptional, IsEnum } from 'class-validator';
import { UserRole } from '../entities/user.entity'; // ✨ 修正引用路徑

export class UpdateUserDto extends PartialType(CreateUserDto) {
  @IsOptional()
  @IsBoolean()
  isActive?: boolean;

  @IsOptional()
  @IsEnum(UserRole)
  role?: UserRole;
}
</file>

<file path="backend/src/users/users.controller.ts">
import { Controller, Get, Post, Patch, Delete, Body, Param, HttpException, HttpStatus, Query, UseGuards, Request } from '@nestjs/common';
import { UsersService } from './users.service';
import { JwtAuthGuard } from '../auth/jwt-auth.guard'; // 記得引入 Guard

@Controller('users')
export class UsersController {
  constructor(private readonly usersService: UsersService) {}

  // ... (Create, FindAll 保持原樣) ...
  @Post()
  create(@Body() createUserDto: any) { return this.usersService.create(createUserDto); }

  @Get()
  findAll() { return this.usersService.findAll(); }

  // ✨✨✨ 新增：取得當前使用者資料 ✨✨✨
  @Get('profile')
  @UseGuards(JwtAuthGuard)
  async getProfile(@Request() req) {
    return this.usersService.findOne(req.user.id);
  }

  // ✨✨✨ 新增：更新當前使用者資料 ✨✨✨
  @Patch('profile')
  @UseGuards(JwtAuthGuard)
  async updateProfile(@Request() req, @Body() body: any) {
    try {
      // 強制使用 Token 裡的 ID，防止修改他人資料
      return await this.usersService.updateProfile(req.user.id, body);
    } catch (error: any) {
      throw new HttpException(error.message, HttpStatus.BAD_REQUEST);
    }
  }

  // ... (其他管理員用的 API 保持原樣：status, level, deposit, make-admin, remove) ...
  @Patch(':id/status')
  async updateStatus(@Param('id') id: string, @Body() body: { isActive: boolean }) { return this.usersService.toggleActive(id, body.isActive); }

  @Patch(':id/level')
  async updateLevel(@Param('id') id: string, @Body() body: { level: any }) { return this.usersService.updateLevel(id, body.level); }

  @Post(':id/deposit')
  async deposit(@Param('id') id: string, @Body() body: { amount: number }) { return this.usersService.deposit(id, body.amount); }

  @Get('make-admin')
  async makeAdmin(@Query('email') email: string) { return this.usersService.makeAdmin(email); }

  @Delete(':id')
  async remove(@Param('id') id: string) { return this.usersService.remove(id); }
}
</file>

<file path="frontend/src/app/register/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { Building2, Mail, Lock, User, Phone, MapPin, FileText, Loader2, AlertCircle } from 'lucide-react';
import { api } from '@/lib/api';

// 定義營業類別型別
interface TradeCategory {
  id: string;
  name: string;
}

export default function RegisterPage() {
  const router = useRouter();
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [categories, setCategories] = useState<TradeCategory[]>([]);
  const [errorMsg, setErrorMsg] = useState('');

  // 表單狀態
  const [formData, setFormData] = useState({
    email: '',
    password: '',
    confirmPassword: '',
    name: '', // 聯絡人姓名
    companyName: '',
    taxId: '',
    phone: '',
    address: '',
    tradeCategoryId: '',
  });

  // ✨ 修正：載入真實的營業類別
  useEffect(() => {
    const fetchCategories = async () => {
      try {
        // 從後端 API 取得資料 (這樣才會拿到正確的 UUID)
        const res = await api.get('/trade-categories');
        // 兼容 API 回傳可能是陣列或 { data: [] } 的格式
        const data = Array.isArray(res) ? res : (res.data || []);
        setCategories(data);
      } catch (err) {
        console.error('Failed to fetch categories', err);
        // 如果抓不到資料 (例如後端沒開放權限)，至少給一個空陣列，不要用假資料害自己
        setCategories([]); 
      }
    };
    fetchCategories();
  }, []);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setErrorMsg('');

    if (formData.password !== formData.confirmPassword) {
      setErrorMsg('兩次密碼輸入不一致');
      return;
    }

    setIsSubmitting(true);

    try {
      // 構建傳送給後端的資料
      const payload = {
        email: formData.email,
        password: formData.password,
        name: formData.name,
        // ✨ 關鍵修正：如果是空字串，轉為 undefined，避免後端查詢出錯
        tradeCategoryId: formData.tradeCategoryId || undefined,
        dealerProfile: {
          companyName: formData.companyName,
          taxId: formData.taxId,
          contactPerson: formData.name,
          phone: formData.phone,
          address: formData.address,
        },
      };

      await api.post('/users', payload);
      
      alert('🎉 註冊成功！\n請等待管理員審核開通帳號。');
      router.push('/login');

    } catch (error: any) {
      console.error(error);
      const message = error.response?.data?.message || '註冊失敗，請稍後再試';
      setErrorMsg(Array.isArray(message) ? message[0] : message);
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <div className="min-h-screen bg-gray-50 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-md w-full space-y-8 bg-white p-8 rounded-2xl shadow-lg border border-gray-100">
        
        {/* Header */}
        <div className="text-center">
          <div className="mx-auto h-12 w-12 bg-blue-100 rounded-xl flex items-center justify-center mb-4">
            <User className="h-6 w-6 text-blue-600" />
          </div>
          <h2 className="text-3xl font-extrabold text-gray-900">註冊經銷商帳號</h2>
          <p className="mt-2 text-sm text-gray-600">
            加入 SomaLink，享受 B2B 數位工廠服務
          </p>
        </div>

        {/* Error Message */}
        {errorMsg && (
          <div className="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-xl flex items-center gap-2 text-sm animate-pulse">
            <AlertCircle className="w-4 h-4" />
            {errorMsg}
          </div>
        )}

        <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
          <div className="space-y-4">
            
            {/* 帳號資訊 */}
            <div className="grid grid-cols-2 gap-4">
              <div className="col-span-2">
                <label className="block text-sm font-medium text-gray-700 mb-1">Email (登入帳號)</label>
                <div className="relative">
                  <Mail className="absolute left-3 top-2.5 h-5 w-5 text-gray-400" />
                  <input
                    name="email"
                    type="email"
                    required
                    className="pl-10 w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500"
                    placeholder="your@email.com"
                    onChange={handleChange}
                  />
                </div>
              </div>
              
              <div className="col-span-1">
                <label className="block text-sm font-medium text-gray-700 mb-1">密碼</label>
                <div className="relative">
                  <Lock className="absolute left-3 top-2.5 h-5 w-5 text-gray-400" />
                  <input
                    name="password"
                    type="password"
                    required
                    className="pl-10 w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500"
                    placeholder="******"
                    onChange={handleChange}
                  />
                </div>
              </div>

              <div className="col-span-1">
                <label className="block text-sm font-medium text-gray-700 mb-1">確認密碼</label>
                <input
                  name="confirmPassword"
                  type="password"
                  required
                  className="w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500"
                  placeholder="******"
                  onChange={handleChange}
                />
              </div>
            </div>

            <div className="relative flex py-2 items-center">
              <div className="grow border-t border-gray-200"></div>
              <span className="shrink-0 mx-4 text-gray-400 text-xs">公司資料</span>
              <div className="grow border-t border-gray-200"></div>
            </div>

            {/* 公司資訊 */}
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">公司名稱</label>
                <div className="relative">
                  <Building2 className="absolute left-3 top-2.5 h-5 w-5 text-gray-400" />
                  <input
                    name="companyName"
                    type="text"
                    required
                    className="pl-10 w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500"
                    placeholder="例如：松成有限公司"
                    onChange={handleChange}
                  />
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">聯絡人姓名</label>
                  <input
                    name="name"
                    type="text"
                    required
                    className="w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500"
                    placeholder="王小明"
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">聯絡電話</label>
                  <div className="relative">
                    <Phone className="absolute left-3 top-2.5 h-5 w-5 text-gray-400" />
                    <input
                      name="phone"
                      type="tel"
                      required
                      className="pl-10 w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500"
                      placeholder="0912-345-678"
                      onChange={handleChange}
                    />
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">統一編號 (選填)</label>
                  <div className="relative">
                    <FileText className="absolute left-3 top-2.5 h-5 w-5 text-gray-400" />
                    <input
                      name="taxId"
                      type="text"
                      className="pl-10 w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500"
                      placeholder="8碼統編"
                      onChange={handleChange}
                    />
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">營業類別</label>
                  <select
                    name="tradeCategoryId"
                    className="w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 bg-white"
                    onChange={handleChange}
                    value={formData.tradeCategoryId}
                  >
                    <option value="">請選擇...</option>
                    {categories.map(c => (
                      <option key={c.id} value={c.id}>{c.name}</option>
                    ))}
                  </select>
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">公司地址</label>
                <div className="relative">
                  <MapPin className="absolute left-3 top-2.5 h-5 w-5 text-gray-400" />
                  <input
                    name="address"
                    type="text"
                    required
                    className="pl-10 w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500"
                    placeholder="請輸入完整地址"
                    onChange={handleChange}
                  />
                </div>
              </div>

            </div>

          </div>

          <button
            type="submit"
            disabled={isSubmitting}
            className="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-xl text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-70 transition-colors shadow-lg hover:shadow-xl"
          >
            {isSubmitting ? (
              <Loader2 className="animate-spin h-5 w-5" />
            ) : (
              '註冊帳號'
            )}
          </button>

          <div className="text-center">
            <Link href="/login" className="font-medium text-blue-600 hover:text-blue-500 text-sm">
              已經有帳號？返回登入
            </Link>
          </div>
        </form>
      </div>
    </div>
  );
}
</file>

<file path="admin/src/components/OrderDetailModal.tsx">
'use client';

import { X, Printer, Package, Ruler, AlertCircle, Trash2, Hammer, MessageSquare, Truck, CheckCircle, User, Phone, MapPin, Paperclip, ExternalLink, Image as ImageIcon } from 'lucide-react';
import { Order, api } from '@/lib/api';
import { useState } from 'react';
import Link from 'next/link';

interface OrderDetailModalProps {
  order: Order | null;
  isOpen: boolean;
  onClose: () => void;
  onStatusUpdate: () => void;
}

export default function OrderDetailModal({ order, isOpen, onClose, onStatusUpdate }: OrderDetailModalProps) {
  const [isUpdating, setIsUpdating] = useState(false);

  if (!isOpen || !order) return null;

  const handleStatusChange = async (newStatus: string) => {
    let confirmMsg = `確定要將狀態變更為 ${newStatus} 嗎？`;
    if (newStatus === 'processing') confirmMsg = `✅ 審核通過確認\n\n確定接受此訂單並開始生產？`;
    else if (newStatus === 'shipped') confirmMsg = `🚚 出貨確認\n\n確定將訂單標記為「已出貨」？`;
    else if (newStatus === 'completed') confirmMsg = `🎉 完工結案\n\n確定將訂單標記為「已完成」？`;

    if (!confirm(confirmMsg)) return;
    setIsUpdating(true);
    try {
      await api.patch(`/orders/${order.id}`, { status: newStatus });
      onStatusUpdate();
      onClose();
    } catch (error) {
      console.error(error);
      alert('更新失敗');
    } finally {
      setIsUpdating(false);
    }
  };

  const handleDelete = async () => {
    if (!confirm(`⚠️ 危險操作！\n\n確定要「永久刪除」這張訂單嗎？`)) return;
    setIsUpdating(true);
    try {
      await api.delete(`/orders/${order.id}`);
      alert('訂單已刪除');
      onStatusUpdate();
      onClose();
    } catch (error) {
      console.error(error);
      alert('刪除失敗');
    } finally {
      setIsUpdating(false);
    }
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col animate-in fade-in zoom-in-95 duration-200">
        
        <div className="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50">
          <div>
            <div className="flex items-center gap-3">
              <h2 className="text-xl font-bold text-gray-900">{order.orderNumber}</h2>
              <span className={`px-2.5 py-0.5 rounded-full text-xs font-bold ${order.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : order.status === 'processing' ? 'bg-blue-100 text-blue-800' : order.status === 'shipped' ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800'}`}>
                {typeof order.status === 'string' ? order.status.toUpperCase() : order.status}
              </span>
            </div>
            <p className="text-sm text-gray-500 mt-1">經銷商：{order.user?.dealerProfile?.companyName || order.user?.name}</p>
          </div>
          <button onClick={onClose} className="p-2 hover:bg-gray-200 rounded-full transition-colors"><X className="w-5 h-5 text-gray-500" /></button>
        </div>

        <div className="flex-1 overflow-y-auto p-6 space-y-8">

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
             <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
               <h3 className="text-xs font-bold text-blue-600 uppercase mb-2 tracking-wider">送貨資訊 (Ship To)</h3>
               <div className="space-y-2 text-sm text-blue-900">
                 <p className="flex items-start gap-2"><MapPin className="w-4 h-4 shrink-0 mt-0.5 opacity-50" /><span className="font-bold">{order.shippingAddress || '未填寫地址'}</span></p>
                 <p className="flex items-center gap-2"><User className="w-4 h-4 shrink-0 opacity-50" /> 現場聯絡人：{order.siteContactPerson || '同訂購人'}</p>
                 <p className="flex items-center gap-2"><Phone className="w-4 h-4 shrink-0 opacity-50" /> 現場電話：{order.siteContactPhone || order.user?.dealerProfile?.phone}</p>
                 <p className="text-xs text-blue-400 mt-1 pl-6">案場名稱：{order.projectName}</p>
               </div>
             </div>
             
             <div className="bg-gray-50 p-4 rounded-xl border border-gray-100 flex flex-col justify-center">
               <div className="flex justify-between items-center mb-2 border-b border-gray-200 pb-2">
                 <span className="text-sm text-gray-500">訂單總金額</span>
                 <span className="text-xl font-bold text-blue-600">${Number(order.totalAmount).toLocaleString()}</span>
               </div>
               <div className="flex justify-between items-center">
                 <span className="text-sm text-gray-500">下單時間</span>
                 <span className="text-sm font-medium text-gray-900">{new Date(order.createdAt).toLocaleString('zh-TW')}</span>
               </div>
             </div>
          </div>

          {order.customerNote && (
            <div className="bg-amber-50 p-4 rounded-xl border border-amber-100 flex items-start gap-3">
              <MessageSquare className="w-5 h-5 text-amber-600 mt-0.5 shrink-0" />
              <div><span className="text-sm font-bold text-amber-800 block mb-1">客戶備註：</span><p className="text-sm text-amber-900 leading-relaxed whitespace-pre-wrap">{order.customerNote}</p></div>
            </div>
          )}

          {order.attachments && order.attachments.length > 0 && (
            <div className="border border-gray-200 rounded-xl p-4">
              <h3 className="text-sm font-bold text-gray-900 mb-3 flex items-center gap-2"><Paperclip className="w-4 h-4" /> 訂單附件 ({order.attachments.length})</h3>
              <div className="flex flex-wrap gap-3">
                {order.attachments.map((url, idx) => (
                  <Link key={idx} href={url} target="_blank" className="flex items-center gap-2 px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg hover:bg-blue-50 hover:border-blue-200 transition-colors group">
                    {url.match(/\.(jpeg|jpg|gif|png)$/i) ? <div className="w-8 h-8 bg-white rounded overflow-hidden border"><img src={url} className="w-full h-full object-cover" alt="preview" /></div> : <div className="w-8 h-8 bg-gray-200 rounded flex items-center justify-center"><ExternalLink className="w-4 h-4 text-gray-500" /></div>}
                    <span className="text-sm text-gray-600 group-hover:text-blue-600">附件 {idx + 1}</span>
                  </Link>
                ))}
              </div>
            </div>
          )}

          <div>
            <h3 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2"><Package className="w-5 h-5" /> 訂購品項 ({order.items?.length || 0})</h3>
            <div className="border border-gray-200 rounded-xl overflow-hidden">
              <table className="w-full text-sm text-left">
                <thead className="bg-gray-50 border-b border-gray-200 text-gray-500 font-medium">
                  <tr><th className="px-4 py-3">產品資訊</th><th className="px-4 py-3">尺寸 (寬x高)</th><th className="px-4 py-3">規格細節</th><th className="px-4 py-3">特殊需求</th><th className="px-4 py-3 text-right">小計</th></tr>
                </thead>
                <tbody className="divide-y divide-gray-100">
                  {order.items?.map((item, index) => {
                    // ✨✨✨ 新增：縮圖邏輯 ✨✨✨
                    const thumb = item.product?.images?.[0] || item.product?.imageUrl;

                    return (
                      <tr key={index} className="hover:bg-gray-50 transition-colors">
                        <td className="px-4 py-4">
                          <div className="flex items-start gap-3">
                            {/* 顯示縮圖 */}
                            <div className="w-12 h-12 bg-gray-100 rounded-lg border border-gray-200 overflow-hidden shrink-0 flex items-center justify-center">
                              {thumb ? (
                                // eslint-disable-next-line @next/next/no-img-element
                                <img src={thumb} className="w-full h-full object-cover" alt={item.product?.name} />
                              ) : (
                                <ImageIcon className="w-5 h-5 text-gray-300" />
                              )}
                            </div>
                            
                            <div>
                              <div className="font-medium text-gray-900">{item.product?.name || '未知產品'}</div>
                              <div className="flex items-center gap-2 mt-1">
                                {item.serviceType === 'material' ? <span className="text-[10px] px-1.5 py-0.5 bg-gray-100 text-gray-600 border border-gray-200 rounded flex items-center gap-1"><Package className="w-3 h-3" /> 純材料</span> : <span className="text-[10px] px-1.5 py-0.5 bg-blue-50 text-blue-600 border border-blue-100 rounded flex items-center gap-1"><Hammer className="w-3 h-3" /> 連工帶料</span>}
                                <span className="text-xs text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded">x{item.quantity}</span>
                              </div>
                            </div>
                          </div>
                        </td>
                        <td className="px-4 py-4"><div className="flex items-center gap-1 font-mono text-blue-700 bg-blue-50 px-2 py-1 rounded w-fit"><Ruler className="w-3 h-3" /> {item.widthMatrix.mid} x {item.heightData.singleValue || item.heightData.mid}</div>{item.isCeilingMounted && <span className="text-xs text-green-600 mt-1 block font-medium">✔ 封頂安裝</span>}</td>
                        <td className="px-4 py-4 text-gray-600"><div>{item.colorName}</div><div>{item.materialName}</div><div className="text-xs text-gray-400 mt-0.5">{item.openingDirection}</div></td>
                        <td className="px-4 py-4 text-gray-500">{item.siteConditions?.floor ? <div className="flex items-center gap-1 text-orange-600 text-xs font-medium bg-orange-50 px-2 py-1 rounded w-fit"><AlertCircle className="w-3 h-3" /> 地面誤差 {item.siteConditions.floor.diff}cm</div> : '-'}</td>
                        <td className="px-4 py-4 text-right font-bold text-gray-900">${Number(item.subtotal).toLocaleString()}</td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>

          {order.adminNote && <div className="bg-yellow-50 p-4 rounded-xl border border-yellow-200 text-yellow-800 text-sm"><strong>管理員備註：</strong> {order.adminNote}</div>}
        </div>

        <div className="p-4 border-t border-gray-100 bg-gray-50 flex justify-between items-center gap-3">
           <div className="flex items-center gap-3">
             <Link href={`/orders/${order.id}/print`} target="_blank" className="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium flex items-center gap-2 shadow-sm"><Printer className="w-4 h-4" /> 列印工單</Link>
             <button onClick={handleDelete} disabled={isUpdating} className="px-4 py-2 bg-red-50 text-red-600 border border-red-100 rounded-lg hover:bg-red-100 font-medium flex items-center gap-2 transition-colors"><Trash2 className="w-4 h-4" /> 刪除</button>
           </div>
           <div className="flex gap-2">
             {order.status === 'pending' && <><button onClick={() => handleStatusChange('cancelled')} disabled={isUpdating} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-bold transition-colors">拒絕</button><button onClick={() => handleStatusChange('processing')} disabled={isUpdating} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-md flex items-center gap-2 transition-colors"><CheckCircle className="w-4 h-4" /> 審核通過</button></>}
             {order.status === 'processing' && <button onClick={() => handleStatusChange('shipped')} disabled={isUpdating} className="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-bold shadow-md flex items-center gap-2 transition-colors"><Truck className="w-4 h-4" /> 安排出貨</button>}
             {order.status === 'shipped' && <button onClick={() => handleStatusChange('completed')} disabled={isUpdating} className="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold shadow-md flex items-center gap-2 transition-colors"><CheckCircle className="w-4 h-4" /> 標記為已完工</button>}
           </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="backend/src/reports/reports.service.ts">
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Order } from '../orders/entities/order.entity';

@Injectable()
export class ReportsService {
  constructor(
    @InjectRepository(Order)
    private ordersRepo: Repository<Order>,
  ) {}

  async getDashboardStats() {
    // 1. 總營收 (排除已取消)
    const revenueResult = await this.ordersRepo.createQueryBuilder('order')
      .select('SUM(order.totalAmount)', 'sum')
      .where('order.status != :status', { status: 'cancelled' })
      .getRawOne();
    const totalRevenue = Number(revenueResult.sum || 0);

    // 2. 訂單總數
    const totalOrders = await this.ordersRepo.count();

    // 3. 依狀態分佈 (Pie Chart)
    const statusDist = await this.ordersRepo.createQueryBuilder('order')
      .select('order.status', 'status')
      .addSelect('COUNT(order.id)', 'count')
      .groupBy('order.status')
      .getRawMany();

    // 4. 最近 6 個月營收趨勢 (Bar Chart)
    const allOrders = await this.ordersRepo.find({ 
      where: {  }, 
      select: ['totalAmount', 'createdAt', 'status'],
      order: { createdAt: 'ASC' }
    });

    const monthlyStats: any = {};
    allOrders.forEach(o => {
      if (o.status === 'cancelled') return;
      const month = new Date(o.createdAt).toISOString().slice(0, 7); // YYYY-MM
      if (!monthlyStats[month]) monthlyStats[month] = 0;
      monthlyStats[month] += Number(o.totalAmount);
    });

    const trendData = Object.keys(monthlyStats).map(month => ({
      name: month,
      total: monthlyStats[month]
    })).slice(-6); 

    // ✨ Fix 5: 熱銷產品排行 (修正關聯路徑: Order -> OrderItem -> Product)
    const productStats = await this.ordersRepo.createQueryBuilder('order')
      .leftJoin('order.items', 'item')      // 先連到 items
      .leftJoin('item.product', 'product')  // 再從 item 連到 product
      .select('product.name', 'name')
      .addSelect('COUNT(order.id)', 'count')
      .addSelect('SUM(order.totalAmount)', 'revenue')
      .where('order.status != :status', { status: 'cancelled' })
      .groupBy('product.name')
      .orderBy('count', 'DESC')
      .limit(5)
      .getRawMany();

    // ✨ Fix 6: 熱銷顏色排行 (修正為從 OrderItem 統計顏色)
    const colorStats = await this.ordersRepo.createQueryBuilder('order')
      .leftJoin('order.items', 'item')      // 顏色資訊在 item 上
      .select('item.colorName', 'name')
      .addSelect('COUNT(order.id)', 'count')
      .where('order.status != :status', { status: 'cancelled' })
      .groupBy('item.colorName')
      .orderBy('count', 'DESC')
      .limit(5)
      .getRawMany();

    return {
      totalRevenue,
      totalOrders,
      statusDist,
      trendData,
      productStats,
      colorStats,
    };
  }
}
</file>

<file path="backend/src/users/entities/user.entity.ts">
import { Entity, Column, PrimaryGeneratedColumn, OneToOne, JoinColumn, ManyToOne, OneToMany, CreateDateColumn, UpdateDateColumn } from 'typeorm';
import { DealerProfile } from './dealer-profile.entity';
import { TradeCategory } from './trade-category.entity';
import { CartItem } from '../../cart/entities/cart-item.entity';

export enum UserRole {
  // ✨✨✨ 修正：改回小寫，以符合資料庫現有的 Enum 定義 ✨✨✨
  ADMIN = 'admin',
  DEALER = 'dealer',
}

@Entity()
export class User {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ unique: true })
  email: string;

  @Column({ nullable: true })
  password?: string;

  @Column({ nullable: true })
  name: string;

  @Column({
    type: 'enum',
    enum: UserRole,
    default: UserRole.DEALER,
  })
  role: UserRole;

  @Column({ default: true })
  isActive: boolean;

  @OneToOne(() => DealerProfile, (profile) => profile.user, { cascade: true, eager: true })
  @JoinColumn()
  dealerProfile: DealerProfile;

  @ManyToOne(() => TradeCategory, { nullable: true, eager: true })
  tradeCategory: TradeCategory;

  @OneToMany(() => CartItem, (cartItem) => cartItem.user)
  cartItems: CartItem[];

  @CreateDateColumn()
  createdAt: Date;

  @UpdateDateColumn()
  updatedAt: Date;
}
</file>

<file path="backend/src/users/entities/dealer-profile.entity.ts">
import { Entity, Column, PrimaryGeneratedColumn, OneToOne } from 'typeorm';
import { User } from './user.entity';

export enum DealerLevel {
  A = 'A',
  B = 'B',
  C = 'C',
}

export enum TradeType {
  DESIGN = 'design', 
  GLASS = 'glass',   
  WINDOW = 'window', 
  DECOR = 'decor',   
  OTHER = 'other',   
}

@Entity()
export class DealerProfile {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  companyName: string;

  @Column()
  taxId: string;

  @Column()
  contactPerson: string;

  @Column()
  phone: string;

  @Column()
  address: string;

  // ✨✨✨ 修正：加入 nullable: true 解決資料庫衝突 ✨✨✨
  @Column({
    type: 'enum',
    enum: TradeType,
    default: TradeType.OTHER,
    nullable: true 
  })
  tradeType: TradeType;

  @Column({
    type: 'enum',
    enum: DealerLevel,
    default: DealerLevel.C,
  })
  level: DealerLevel;

  @Column({ default: false })
  isVerified: boolean;

  @Column({ type: 'decimal', precision: 12, scale: 2, default: 0 })
  walletBalance: number;

  @Column({ default: false })
  isUpgradeable: boolean;

  @OneToOne(() => User, (user) => user.dealerProfile)
  user: User;
}
</file>

<file path="backend/src/users/users.service.ts">
import { Injectable, ConflictException, InternalServerErrorException, NotFoundException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import * as bcrypt from 'bcrypt';
import { User, UserRole } from './entities/user.entity';
import { CreateUserDto } from './dto/create-user.dto';
import { UpdateUserDto } from './dto/update-user.dto';
import { TradeCategory } from './entities/trade-category.entity';
import { DealerProfile, DealerLevel, TradeType } from './entities/dealer-profile.entity'; 
import { NotificationsService } from '../notifications/notifications.service';

// ✨✨✨ 硬性規則 (Hardcoded Rules) 定義區 ✨✨✨
export const DEALER_LIMITS = {
  [DealerLevel.A]: 200000, // A 級 20萬
  [DealerLevel.B]: 100000, // B 級 10萬
  [DealerLevel.C]: 0,      // C 級不可儲值
};

@Injectable()
export class UsersService {
  constructor(
    @InjectRepository(User)
    private usersRepository: Repository<User>,
    @InjectRepository(TradeCategory)
    private tradeCategoriesRepository: Repository<TradeCategory>,
    @InjectRepository(DealerProfile)
    private dealerProfileRepository: Repository<DealerProfile>,
    private notificationsService: NotificationsService,
  ) {}

  // 1. 註冊 (Create)
  async create(createUserDto: CreateUserDto) {
    const existingUser = await this.usersRepository.findOne({ 
      where: { email: createUserDto.email } 
    });
    
    if (existingUser) {
      throw new ConflictException('此 Email 已經被註冊');
    }

    const user = new User();
    user.email = createUserDto.email;
    user.name = createUserDto.name;
    
    const salt = await bcrypt.genSalt();
    user.password = await bcrypt.hash(createUserDto.password, salt);

    if (createUserDto.tradeCategoryId && createUserDto.tradeCategoryId.trim() !== '') {
      const tradeCategory = await this.tradeCategoriesRepository.findOneBy({ 
        id: createUserDto.tradeCategoryId 
      });
      if (!tradeCategory) throw new NotFoundException('選擇的營業類別無效');
      user.tradeCategory = tradeCategory;
    } else {
      // ✨ Fix: 強制轉型為 any 以解決 TypeScript 對 null 的嚴格檢查
      user.tradeCategory = null as any;
    }

    if (createUserDto.dealerProfile) {
      const profile = new DealerProfile();
      Object.assign(profile, createUserDto.dealerProfile);
      profile.level = DealerLevel.C; 
      profile.isVerified = false;
      profile.walletBalance = 0;
      profile.isUpgradeable = false; 
      
      user.dealerProfile = profile;
    }

    try {
      user.isActive = false;
      return await this.usersRepository.save(user);
    } catch (error: any) {
      console.error('Registration Error:', error);
      if (error.code === '23505') { 
        throw new ConflictException('資料重複 (Email 或統編已存在)');
      }
      throw new InternalServerErrorException('註冊失敗，請稍後再試');
    }
  }

  // 2. 查詢所有用戶
  async findAll() {
    return this.usersRepository.find({
      relations: ['tradeCategory', 'dealerProfile'],
    });
  }

  // 3. 查詢單一用戶
  async findOne(id: string) {
    const user = await this.usersRepository.findOne({
      where: { id },
      relations: ['tradeCategory', 'dealerProfile'],
    });
    if (!user) throw new NotFoundException(`找不到用戶 #${id}`);
    return user;
  }

  // 4. 透過 Email 查詢
  async findByEmail(email: string) {
    return this.usersRepository.findOne({
      where: { email },
      relations: ['tradeCategory', 'dealerProfile'],
    });
  }

  // 5. 更新基本資料 (管理員用)
  async update(id: string, updateUserDto: UpdateUserDto) {
    await this.usersRepository.update(id, {
      isActive: updateUserDto.isActive,
      role: updateUserDto.role,
    });
    return this.findOne(id);
  }

  // 6. 刪除用戶
  async remove(id: string) {
    const user = await this.findOne(id);
    return this.usersRepository.remove(user);
  }

  // 7. 切換啟用狀態
  async toggleActive(id: string, isActive: boolean) {
    const user = await this.findOne(id);
    user.isActive = isActive;
    return this.usersRepository.save(user);
  }

  // 8. 更新會員等級
  async updateLevel(id: string, level: DealerLevel) {
    const user = await this.findOne(id);
    if (user.dealerProfile) {
      user.dealerProfile.level = level;
      await this.dealerProfileRepository.save(user.dealerProfile); 
    }
    return this.usersRepository.save(user); 
  }

  // 9. 錢包儲值 (引用 Hardcoded Rules)
  async deposit(id: string, amount: number) {
    const user = await this.findOne(id);
    if (!user.dealerProfile) {
      throw new NotFoundException('此用戶沒有經銷商檔案，無法儲值');
    }
    
    const currentBalance = Number(user.dealerProfile.walletBalance || 0);
    const addAmount = Number(amount);
    const newBalance = currentBalance + addAmount;
    
    // 取得該等級的上限
    const limit = DEALER_LIMITS[user.dealerProfile.level] || 0;

    // 檢查 C 級
    if (user.dealerProfile.level === DealerLevel.C) {
      throw new ConflictException('C 級會員不可進行儲值');
    }

    // 檢查單筆上限
    if (addAmount > limit) {
        throw new ConflictException(`單筆儲值金額超過 ${user.dealerProfile.level} 級上限 (${limit})`);
    }
    
    user.dealerProfile.walletBalance = newBalance;
    
    await this.dealerProfileRepository.save(user.dealerProfile);
    return user;
  }

  // 10. 升級為管理員
  async makeAdmin(email: string) {
    const user = await this.findByEmail(email);
    if (!user) {
      throw new NotFoundException(`找不到用戶: ${email}`);
    }
    
    user.role = UserRole.ADMIN; 
    return this.usersRepository.save(user);
  }

  // 11. 更新個人資料邏輯
  async updateProfile(userId: string, data: any) {
    const user = await this.findOne(userId);
    
    // 1. 更新基本資料
    if (data.name) user.name = data.name;
    
    // 2. 更新密碼 (如果有填)
    if (data.password) {
      const salt = await bcrypt.genSalt();
      user.password = await bcrypt.hash(data.password, salt);
    }

    // 3. 更新經銷商資料 (DealerProfile)
    if (data.dealerProfile && user.dealerProfile) {
      if (data.dealerProfile.companyName) user.dealerProfile.companyName = data.dealerProfile.companyName;
      if (data.dealerProfile.taxId) user.dealerProfile.taxId = data.dealerProfile.taxId;
      if (data.dealerProfile.contactPerson) user.dealerProfile.contactPerson = data.dealerProfile.contactPerson;
      if (data.dealerProfile.phone) user.dealerProfile.phone = data.dealerProfile.phone;
      if (data.dealerProfile.address) user.dealerProfile.address = data.dealerProfile.address;
      
      // 儲存關聯資料
      await this.dealerProfileRepository.save(user.dealerProfile);
    }

    // 儲存 User 本體
    const savedUser = await this.usersRepository.save(user);

    // 4. 發送 Line 通知給管理員
    try {
      const dealerName = savedUser.dealerProfile?.companyName || savedUser.email;
      const msg = `🔔 會員資料變更通知\n客戶：${dealerName}\n狀態：已在後台自行更新資料，請確認。`;
      this.notificationsService.sendLineNotify(msg).catch(err => console.log('Line 通知略過 (開發模式)'));
    } catch (e) {
      console.error('發送通知失敗', e);
    }

    return savedUser;
  }
}
</file>

<file path="admin/src/lib/api.ts">
import axios from 'axios';

const API_URL = process.env.NEXT_PUBLIC_API_URL || 'https://somalink-backend.onrender.com';

export interface OrderItem {
  id: string;
  product: { name: string; images?: string[]; imageUrl?: string; };
  serviceType: string;
  widthMatrix: { top: number; mid: number; bot: number };
  heightData: any;
  isCeilingMounted: boolean;
  siteConditions?: any;
  colorName: string;
  materialName: string;
  openingDirection: string;
  hasThreshold: boolean;
  quantity: number;
  subtotal: number;
  priceSnapshot?: any;
}

export enum OrderStatus {
  PENDING = 'pending',       
  PROCESSING = 'processing', 
  SHIPPED = 'shipped',       
  COMPLETED = 'completed',   
  CANCELLED = 'cancelled',   
}

export interface Order {
  id: string;
  orderNumber: string;
  status: OrderStatus | string;
  totalAmount: number;
  createdAt: string;
  projectName: string;
  shippingAddress?: string;
  siteContactPerson?: string;
  siteContactPhone?: string;
  
  // ✨✨✨ 補上這個欄位以解決 TS 錯誤 ✨✨✨
  attachments?: string[];

  user: {
    id: string;
    email: string;
    name: string;
    dealerProfile?: {
      companyName: string;
      contactPerson: string;
      phone: string;
      address: string;
    };
  };
  items: OrderItem[]; 
  adminNote?: string;
  customerNote?: string;
}

const axiosInstance = axios.create({
  baseURL: API_URL,
  headers: {
    'Content-Type': 'application/json',
  },
});

axiosInstance.interceptors.request.use((config) => {
  if (typeof window !== 'undefined') {
    const token = localStorage.getItem('somalink_admin_token');
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
  }
  return config;
});

export const api = {
  get: async (url: string) => {
    const response = await axiosInstance.get(url);
    return response.data;
  },
  post: async (url: string, data: any) => {
    const response = await axiosInstance.post(url, data);
    return response.data;
  },
  patch: async (url: string, data: any) => {
    const response = await axiosInstance.patch(url, data);
    return response.data;
  },
  delete: async (url: string) => {
    const response = await axiosInstance.delete(url);
    return response.data;
  },
  uploadImage: async (file: File) => {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', 'yasou70731'); 
    const res = await axios.post(
      'https://api.cloudinary.com/v1_1/dnibj8za6/image/upload', 
      formData
    );
    return res.data.secure_url;
  }
};
</file>

<file path="backend/src/auth/auth.service.ts">
import { Injectable, UnauthorizedException } from '@nestjs/common';
import { JwtService } from '@nestjs/jwt';
import { UsersService } from '../users/users.service';
import * as bcrypt from 'bcrypt';

@Injectable()
export class AuthService {
  constructor(
    private usersService: UsersService,
    private jwtService: JwtService,
  ) {}

  async validateUser(email: string, pass: string): Promise<any> {
    console.log(`[AuthDebug] 正在嘗試登入 Email: ${email}`);
    
    const user = await this.usersService.findByEmail(email);
    
    if (!user) {
      console.log(`[AuthDebug] ❌ 找不到使用者 (User Not Found)`);
      return null;
    }

    console.log(`[AuthDebug] ✅ 找到使用者 ID: ${user.id}, 角色: ${user.role}, IsActive: ${user.isActive}`);
    
    if (!user.password) {
      console.log(`[AuthDebug] ❌ 資料庫中的密碼欄位是空的`);
      return null;
    }

    if (!pass) {
      console.log(`[AuthDebug] ❌ 介面沒有傳送密碼過來 (輸入 密碼 為 空)`);
      return null;
    }

    const isMatch = await bcrypt.compare(pass, user.password);
    console.log(`[AuthDebug] 🔐 密碼比對結果: ${isMatch ? '成功 (Match)' : '失敗 (Mismatch)'}`);

    if (isMatch) {
      // 這裡會把密碼拿掉，只回傳安全資料
      const { password, ...result } = user;
      return result;
    }

    return null;
  }

  // ✨ Fix: 修改這裡，直接接收已經驗證過的 user 物件
  async login(user: any) {
    // 🛑 刪除這段：不要再驗證一次，因為 user 物件裡已經沒有原始密碼了，再驗證會失敗
    // const validatedUser = await this.validateUser(...)
    
    // 直接發放 Token
    const payload = { email: user.email, sub: user.id, role: user.role };

    const safeUser = {
      id: user.id,
      email: user.email,
      name: user.name,
      role: user.role,
      isActive: user.isActive,
    };

    return {
      access_token: this.jwtService.sign(payload),
      user: safeUser,
    };
  }
}
</file>

<file path="admin/src/app/page.tsx">
'use client';

import { useEffect, useState, useCallback, useMemo } from 'react';
import { useRouter } from 'next/navigation';
import { 
  LayoutDashboard, Bell, Search, Filter, 
  CheckCircle, Clock, Info, ChevronRight, FileSpreadsheet, Calendar, User, Truck, Hammer
} from 'lucide-react';
import clsx from 'clsx';
import * as XLSX from 'xlsx';
import { api, Order } from '@/lib/api';
import OrderDetailModal from '@/components/OrderDetailModal';

export default function AdminDashboard() {
  const router = useRouter();
  
  // ✨ Fix 1: 確保初始值為空陣列，避免 undefined
  const [orders, setOrders] = useState<Order[]>([]);
  const [loading, setLoading] = useState(true);
  const [selectedOrder, setSelectedOrder] = useState<Order | null>(null);
  
  const [searchTerm, setSearchTerm] = useState('');
  const [dealerFilter, setDealerFilter] = useState('');
  const [dateFilter, setDateFilter] = useState('');
  const [statusFilter, setStatusFilter] = useState('all');

  useEffect(() => {
    const token = localStorage.getItem('somalink_admin_token');
    if (!token) { router.push('/login'); }
  }, [router]);

  const fetchOrders = useCallback(async () => {
    try {
      setLoading(true);
      const res = await api.get('/orders');
      
      // ✨ Fix 2: 嚴格檢查 res 是否為陣列 (因為 api.ts 已經解構過 response.data)
      if (Array.isArray(res)) {
        setOrders(res);
      } else {
        console.warn('API 回傳格式異常 (預期為陣列):', res);
        setOrders([]); // 格式不對時，強制設為空陣列
      }
    } catch (err) {
      console.error('無法取得訂單列表:', err);
      setOrders([]); // 發生錯誤時，強制設為空陣列
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    // 只有在瀏覽器端且有 Token 時才撈資料
    if (typeof window !== 'undefined' && localStorage.getItem('somalink_admin_token')) {
      fetchOrders();
    }
  }, [fetchOrders]);

  // 過濾邏輯
  const filteredOrders = useMemo(() => {
    // ✨ Fix 3: 加入 (orders || []) 保護，防止 orders 為 undefined 時 filter 報錯
    return (orders || []).filter(order => {
      if (!order) return false;
      
      const matchesSearch = 
        (order.orderNumber || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
        (order.projectName && order.projectName.toLowerCase().includes(searchTerm.toLowerCase()));
      
      const dealerName = order.user?.dealerProfile?.companyName || order.user?.name || '';
      
      const matchesDealer = dealerName.toLowerCase().includes(dealerFilter.toLowerCase());
      const orderDate = order.createdAt ? new Date(order.createdAt).toISOString().split('T')[0] : '';
      const matchesDate = dateFilter ? orderDate === dateFilter : true;
      const matchesStatus = statusFilter === 'all' ? true : order.status === statusFilter;

      return matchesSearch && matchesDealer && matchesDate && matchesStatus;
    });
  }, [orders, searchTerm, dealerFilter, dateFilter, statusFilter]);

  // Excel 匯出
  const handleExportExcel = () => {
    const dataToExport = filteredOrders.map(o => ({
      '訂單編號': o.orderNumber,
      '建立日期': new Date(o.createdAt).toLocaleDateString(),
      '案場名稱': o.projectName,
      '經銷商': o.user?.dealerProfile?.companyName || o.user?.email,
      '產品名稱': o.items?.[0]?.product?.name || '多品項',
      '總金額': Number(o.totalAmount),
      '訂單狀態': o.status === 'pending' ? '待審核' : 
                  o.status === 'processing' ? '生產中' : 
                  o.status === 'shipped' ? '已出貨' : o.status,
    }));

    const worksheet = XLSX.utils.json_to_sheet(dataToExport);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "SomaLink訂單");
    XLSX.writeFile(workbook, `SomaLink_Orders_${new Date().toISOString().slice(0,10)}.xlsx`);
  };

  const statusMap: Record<string, any> = {
    pending: { label: '待審核', color: 'bg-yellow-100 text-yellow-800', icon: Clock },
    processing: { label: '生產中', color: 'bg-blue-100 text-blue-800', icon: Hammer },
    shipped: { label: '已出貨', color: 'bg-purple-100 text-purple-800', icon: Truck }, 
    completed: { label: '已完成', color: 'bg-green-100 text-green-800', icon: CheckCircle },
    cancelled: { label: '已取消', color: 'bg-gray-100 text-gray-600', icon: Info },
  };

  const getActionButton = (status: string) => {
    switch (status) {
      case 'pending': return { text: '審核', style: 'text-blue-600 hover:text-blue-800' };
      case 'processing': return { text: '管理', style: 'text-purple-600 hover:text-purple-800' }; 
      case 'shipped': return { text: '追蹤', style: 'text-green-600 hover:text-green-800' };    
      default: return { text: '詳情', style: 'text-gray-500 hover:text-gray-700' };
    }
  };

  return (
    <main className="flex-1 flex flex-col min-w-0 overflow-hidden">
      
      <header className="bg-white shadow-sm border-b border-gray-200 h-16 flex items-center justify-between px-8 sticky top-0 z-10">
        <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
          <LayoutDashboard className="w-5 h-5 text-gray-500" />
          訂單戰情室
        </h2>
        <div className="flex items-center gap-4">
          <button className="p-2 text-gray-400 hover:bg-gray-100 rounded-full relative">
            <Bell className="w-5 h-5" /><span className="absolute top-1.5 right-1.5 w-2 h-2 bg-red-500 rounded-full"></span>
          </button>
        </div>
      </header>

      <div className="flex-1 overflow-y-auto p-8">
        
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <p className="text-sm text-gray-500 font-medium uppercase tracking-wider">篩選結果筆數</p>
            <div className="flex items-end justify-between mt-2">
              <p className="text-4xl font-bold text-gray-900">{filteredOrders.length}</p>
              <span className="text-xs text-gray-400 px-2 py-1">筆訂單</span>
            </div>
          </div>
          <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <p className="text-sm text-gray-500 font-medium uppercase tracking-wider">待審核 (篩選內)</p>
            <div className="flex items-end justify-between mt-2">
              <p className="text-4xl font-bold text-yellow-600">{filteredOrders.filter(o => o.status === 'pending').length}</p>
              <span className="text-xs text-yellow-700 bg-yellow-50 px-2 py-1 rounded font-medium">需處理</span>
            </div>
          </div>
          <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <p className="text-sm text-gray-500 font-medium uppercase tracking-wider">累積金額 (篩選內)</p>
            <div className="flex items-end justify-between mt-2">
              <p className="text-4xl font-bold text-blue-600">${filteredOrders.reduce((sum, o) => sum + Number(o.totalAmount), 0).toLocaleString()}</p>
            </div>
          </div>
        </div>

        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
          
          <div className="p-5 border-b border-gray-100 bg-gray-50/50 flex flex-wrap items-center gap-4">
            
            <div className="relative w-64">
              <Search className="absolute left-3 top-2.5 w-4 h-4 text-gray-400" />
              <input 
                type="text" 
                placeholder="搜尋單號、案名..." 
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" 
              />
            </div>

            <div className="relative w-48">
              <User className="absolute left-3 top-2.5 w-4 h-4 text-gray-400" />
              <input 
                type="text" 
                placeholder="篩選經銷商名稱" 
                value={dealerFilter}
                onChange={(e) => setDealerFilter(e.target.value)}
                className="w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" 
              />
            </div>

            <div className="relative w-48">
              <Calendar className="absolute left-3 top-2.5 w-4 h-4 text-gray-400" />
              <input 
                type="date" 
                value={dateFilter}
                onChange={(e) => setDateFilter(e.target.value)}
                className="w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none text-gray-600" 
              />
            </div>

            <div className="relative w-40">
              <Filter className="absolute left-3 top-2.5 w-4 h-4 text-gray-400" />
              <select 
                value={statusFilter}
                onChange={(e) => setStatusFilter(e.target.value)}
                className="w-full pl-9 pr-8 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none appearance-none bg-white text-gray-600 cursor-pointer"
              >
                <option value="all">全部狀態</option>
                <option value="pending">待審核</option>
                <option value="processing">生產中</option>
                <option value="shipped">已出貨</option>
                <option value="completed">已完成</option>
                <option value="cancelled">已取消</option>
              </select>
              <div className="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                <svg className="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
              </div>
            </div>

            {(searchTerm || dealerFilter || dateFilter || statusFilter !== 'all') && (
              <button 
                onClick={() => {
                  setSearchTerm('');
                  setDealerFilter('');
                  setDateFilter('');
                  setStatusFilter('all');
                }}
                className="text-xs text-red-500 hover:underline px-2"
              >
                清除篩選
              </button>
            )}

            <div className="ml-auto">
              <button 
                onClick={handleExportExcel}
                className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-bold hover:bg-green-700 shadow-sm transition-all"
              >
                <FileSpreadsheet className="w-4 h-4" /> 匯出 Excel
              </button>
            </div>
          </div>

          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">單號 / 案場</th>
                  <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">經銷商</th>
                  <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">產品概要</th>
                  <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">金額</th>
                  <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">日期</th>
                  <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">狀態</th>
                  <th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">動作</th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {loading ? (
                  <tr><td colSpan={7} className="text-center py-12 text-gray-500">資料載入中...</td></tr>
                ) : filteredOrders.length === 0 ? (
                  <tr><td colSpan={7} className="text-center py-12 text-gray-500">查無符合條件的訂單</td></tr>
                ) : (
                  filteredOrders.map((order) => {
                    const status = statusMap[order.status as string] || { label: order.status, color: 'bg-gray-100', icon: Info };
                    const StatusIcon = status.icon;
                    const action = getActionButton(order.status as string); 

                    const firstItem = order.items?.[0];
                    const productSummary = firstItem ? (
                        <>
                            {firstItem.product?.name || '未知產品'} 
                            {order.items.length > 1 && <span className="text-xs text-gray-400 ml-1">+{order.items.length - 1}</span>}
                        </>
                    ) : '無商品';

                    return (
                      <tr key={order.id} className="hover:bg-blue-50/30 transition-colors group">
                        <td className="px-6 py-4">
                          <div className="flex flex-col">
                            <span className="text-sm font-bold text-gray-900 group-hover:text-blue-600">{order.orderNumber}</span>
                            <span className="text-xs text-gray-500 mt-0.5">{order.projectName || '未命名案場'}</span>
                          </div>
                        </td>
                        <td className="px-6 py-4">
                          <div className="flex flex-col">
                            <span className="text-sm text-gray-900 font-medium">{order.user?.dealerProfile?.companyName || '未知'}</span>
                          </div>
                        </td>
                        <td className="px-6 py-4 text-sm text-gray-600">{productSummary}</td>
                        <td className="px-6 py-4 text-sm font-bold text-blue-600">${Number(order.totalAmount).toLocaleString()}</td>
                        <td className="px-6 py-4 text-xs text-gray-500">{new Date(order.createdAt).toLocaleDateString()}</td>
                        <td className="px-6 py-4">
                          <span className={clsx("px-2.5 py-1 rounded-full text-xs font-bold flex items-center w-fit gap-1.5 border", status.color, "border-transparent")}>
                            <StatusIcon className="w-3.5 h-3.5" />
                            {status.label}
                          </span>
                        </td>
                        <td className="px-6 py-4 text-right">
                          <button 
                            onClick={() => setSelectedOrder(order)} 
                            className={clsx("font-medium text-sm flex items-center justify-end gap-1 transition-colors", action.style)}
                          >
                            {action.text} <ChevronRight className="w-4 h-4" />
                          </button>
                        </td>
                      </tr>
                    );
                  })
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <OrderDetailModal 
        order={selectedOrder}
        isOpen={!!selectedOrder}
        onClose={() => setSelectedOrder(null)}
        onStatusUpdate={fetchOrders} 
      />
    </main>
  );
}
</file>

</files>
